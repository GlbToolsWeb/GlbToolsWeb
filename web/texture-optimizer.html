<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="glb.tools | Texture Optimizer — re-encode and resize GLB textures without atlasing." />
  <title>glb.tools | Texture Optimizer</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="page">
    <h1>Texture Optimizer</h1>
    <p class="lead">Re-encode and resize textures inside a GLB. No atlasing, no merges—just smaller textures.</p>

    <form id="opt-form" class="card" autocomplete="off">
      <label class="uploader">
        <strong>Click or drop your .GLB file</strong>
        <input style="display:none" type="file" name="model" accept=".glb" required />
        <div class="chips" id="file-chip"><span class="chip">No file selected</span></div>
      </label>

      <div class="row">
        <label>Texture format
          <select name="format">
            <option value="webp" selected>webp</option>
            <option value="png">png (lossless)</option>
            <option value="jpeg">jpeg (lossy, no alpha)</option>
          </select>
        </label>
        <label>Quality (jpeg/webp)
          <input type="number" name="quality" value="85" min="1" max="100" />
        </label>
      </div>

      <div class="row" style="margin-top:8px;">
        <label>Max texture size (px)
          <select name="maxSize">
            <option value="4096" selected>4096</option>
            <option value="2048">2048</option>
            <option value="1024">1024</option>
            <option value="512">512</option>
          </select>
        </label>
      </div>

      <div class="actions">
        <button class="primary" type="submit" id="submit-btn">Optimize</button>
      </div>
      <div class="status" id="status">Idle</div>
    </form>
  </div>

  <script type="module">
    const form = document.getElementById('opt-form');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');
    const fileInput = form.elements['model'];
    const chipEl = document.getElementById('file-chip');
    let worker = null;
    let downloadUrl = null;

    const dropZone = form.querySelector('.uploader');
    ['dragenter','dragover','dragleave','drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    ['dragenter','dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'));
    });
    ['dragleave','drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'));
    });
    dropZone.addEventListener('drop', (e) => {
      const dt = new DataTransfer();
      Array.from(e.dataTransfer.files || []).forEach((f) => {
        if (f.name.toLowerCase().endsWith('.glb')) dt.items.add(f);
      });
      if (dt.files.length) {
        fileInput.files = dt.files;
        updateChip(fileInput.files[0]);
        resetButton();
      }
    });

    function updateChip(file) {
      chipEl.innerHTML = '';
      if (!file) {
        chipEl.innerHTML = '<span class="chip">No file selected</span>';
        return;
      }
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = file.name;
      chipEl.appendChild(span);
    }

    function resetButton() {
      downloadUrl = null;
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Optimize';
      submitBtn.disabled = false;
      submitBtn.onclick = null;
    }

    function setDownloadButton(url, name) {
      downloadUrl = url;
      submitBtn.type = 'button';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Download optimized GLB';
      submitBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        a.download = name || 'optimized.glb';
        a.click();
      };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.className = 'status';
      statusEl.textContent = '';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      if (!fileInput.files.length) {
        statusEl.textContent = 'Please choose a GLB file.';
        statusEl.classList.add('error');
        resetButton();
        return;
      }

      const fmt = form.elements['format']?.value || 'webp';
      const quality = form.elements['quality']?.value || '85';
      const maxSize = form.elements['maxSize']?.value || '4096';
      const opts = { format: fmt, quality, maxSize };

      try {
        if (!worker) {
          worker = new Worker(new URL('./src/texture-optimizer-worker.js', import.meta.url), { type: 'module' });
        }
        const file = fileInput.files[0];
        const result = await new Promise((resolve, reject) => {
          const timer = setTimeout(() => reject(new Error('Worker timed out')), 120000);
          worker.onmessage = (ev) => {
            clearTimeout(timer);
            const { error, glb } = ev.data || {};
            if (error) return reject(new Error(error));
            resolve({ glb });
          };
          worker.onerror = (err) => {
            clearTimeout(timer);
            reject(err);
          };
          worker.postMessage({ file, opts });
        });

        const glbBuffer = Uint8Array.from(atob(result.glb), c => c.charCodeAt(0));
        const blob = new Blob([glbBuffer], { type: 'model/gltf-binary' });
        const url = URL.createObjectURL(blob);
        const name = (file.name.replace(/\.glb$/i, '') || 'optimized') + '.optimized.glb';
        statusEl.textContent = 'Done.';
        statusEl.classList.add('success');
        setDownloadButton(url, name);
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.classList.add('error');
        resetButton();
      }
    });

    fileInput.addEventListener('change', () => updateChip(fileInput.files[0]));
  </script>
</body>
</html>

