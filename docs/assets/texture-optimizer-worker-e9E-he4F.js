(function(){"use strict";class wt{constructor(){this._listeners={}}addEventListener(e,t){const n=this._listeners;return n[e]===void 0&&(n[e]=[]),n[e].indexOf(t)===-1&&n[e].push(t),this}removeEventListener(e,t){const s=this._listeners[e];if(s!==void 0){const r=s.indexOf(t);r!==-1&&s.splice(r,1)}return this}dispatchEvent(e){const n=this._listeners[e.type];if(n!==void 0){const s=n.slice(0);for(let r=0,o=s.length;r<o;r++)s[r].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class Be{constructor(e,t,n,s={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=n,this._attributes=s,!t.isOnGraph(n))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}}class Bs extends wt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){const t=new Set;for(const n of this.listParentEdges(e))t.add(n.getParent());return Array.from(t)}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){const t=new Set;for(const n of this.listChildEdges(e))t.add(n.getChild());return Array.from(t)}disconnectParents(e,t){for(const n of this.listParentEdges(e))(!t||t(n.getParent()))&&n.dispose();return this}_createEdge(e,t,n,s){const r=new Be(e,t,n,s);this._edges.add(r);const o=r.getParent();this._parentEdges.has(o)||this._parentEdges.set(o,new Set),this._parentEdges.get(o).add(r);const a=r.getChild();return this._childEdges.has(a)||this._childEdges.set(a,new Set),this._childEdges.get(a).add(r),r}_destroyEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function ze(){return ze=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},ze.apply(this,arguments)}class _e{constructor(e){if(this.list=[],e)for(const t of e)this.list.push(t)}add(e){this.list.push(e)}remove(e){const t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)}removeChild(e){const t=[];for(const n of this.list)n.getChild()===e&&t.push(n);for(const n of t)this.remove(n);return t}listRefsByChild(e){const t=[];for(const n of this.list)n.getChild()===e&&t.push(n);return t}values(){return this.list}}class P{constructor(e){if(this.set=new Set,this.map=new Map,e)for(const t of e)this.add(t)}add(e){const t=e.getChild();this.removeChild(t),this.set.add(e),this.map.set(t,e)}remove(e){this.set.delete(e),this.map.delete(e.getChild())}removeChild(e){const t=this.map.get(e)||null;return t&&this.remove(t),t}getRefByChild(e){return this.map.get(e)||null}values(){return Array.from(this.set)}}class ce{constructor(e){this.map={},e&&Object.assign(this.map,e)}set(e,t){this.map[e]=t}delete(e){delete this.map[e]}get(e){return this.map[e]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}}const B=Symbol("attributes"),Oe=Symbol("immutableKeys");class gt extends wt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[B]=void 0,this[Oe]=void 0,this.graph=e,this[Oe]=new Set,this[B]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const n in e){const s=e[n];if(s instanceof gt){const r=this.graph._createEdge(n,this,s);this[Oe].add(n),t[n]=r}else t[n]=s}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const n in this[B]){const s=this[B][n];if(s instanceof Be){const r=s;r.getChild()===e&&this.setRef(n,t,r.getAttributes())}else if(s instanceof _e)for(const r of s.listRefsByChild(e)){const o=r.getAttributes();this.removeRef(n,e),this.addRef(n,t,o)}else if(s instanceof P){const r=s.getRefByChild(e);if(r){const o=r.getAttributes();this.removeRef(n,e),this.addRef(n,t,o)}}else if(s instanceof ce)for(const r of s.keys()){const o=s.get(r);o.getChild()===e&&this.setRefMap(n,r,t,o.getAttributes())}}return this}get(e){return this[B][e]}set(e,t){return this[B][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[B][e];return t?t.getChild():null}setRef(e,t,n){if(this[Oe].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const s=this[B][e];if(s&&s.dispose(),!t)return this;const r=this.graph._createEdge(e,this,t,n);return this[B][e]=r,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this.assertRefList(e).values().map(n=>n.getChild())}addRef(e,t,n){const s=this.graph._createEdge(e,this,t,n);return this.assertRefList(e).add(s),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){const n=this.assertRefList(e);if(n instanceof _e)for(const s of n.listRefsByChild(t))s.dispose();else{const s=n.getRefByChild(t);s&&s.dispose()}return this}assertRefList(e){const t=this[B][e];if(t instanceof _e||t instanceof P)return t;throw new Error(`Expected RefList or RefSet for attribute "${e}"`)}listRefMapKeys(e){return this.assertRefMap(e).keys()}listRefMapValues(e){return this.assertRefMap(e).values().map(t=>t.getChild())}getRefMap(e,t){const s=this.assertRefMap(e).get(t);return s?s.getChild():null}setRefMap(e,t,n,s){const r=this.assertRefMap(e),o=r.get(t);if(o&&o.dispose(),!n)return this;s=Object.assign(s||{},{key:t});const a=this.graph._createEdge(e,this,n,ze({},s,{key:t}));return r.set(t,a),this.dispatchEvent({type:"change",attribute:e,key:t})}assertRefMap(e){const t=this[B][e];if(t instanceof ce)return t;throw new Error(`Expected RefMap for attribute "${e}"`)}dispatchEvent(e){return super.dispatchEvent(ze({},e,{target:this})),this.graph.dispatchEvent(ze({},e,{target:this,type:`node:${e.type}`})),this}_destroyRef(e){const t=e.getName();if(this[B][t]===e)this[B][t]=null,this[Oe].has(t)&&e.getChild().dispose();else if(this[B][t]instanceof _e)this[B][t].remove(e);else if(this[B][t]instanceof P)this[B][t].remove(e);else if(this[B][t]instanceof ce){const n=this[B][t];for(const s of n.keys())n.get(s)===e&&n.delete(s)}else return;this.graph._destroyEdge(e),this.dispatchEvent({type:"change",attribute:t})}}const Ct="v4.2.1",Le="@glb.bin";var p;(function(i){i.ACCESSOR="Accessor",i.ANIMATION="Animation",i.ANIMATION_CHANNEL="AnimationChannel",i.ANIMATION_SAMPLER="AnimationSampler",i.BUFFER="Buffer",i.CAMERA="Camera",i.MATERIAL="Material",i.MESH="Mesh",i.PRIMITIVE="Primitive",i.PRIMITIVE_TARGET="PrimitiveTarget",i.NODE="Node",i.ROOT="Root",i.SCENE="Scene",i.SKIN="Skin",i.TEXTURE="Texture",i.TEXTURE_INFO="TextureInfo"})(p||(p={}));var tt;(function(i){i.INTERLEAVED="interleaved",i.SEPARATE="separate"})(tt||(tt={}));var ee;(function(i){i.ARRAY_BUFFER="ARRAY_BUFFER",i.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",i.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",i.OTHER="OTHER",i.SPARSE="SPARSE"})(ee||(ee={}));var se;(function(i){i[i.R=4096]="R",i[i.G=256]="G",i[i.B=16]="B",i[i.A=1]="A"})(se||(se={}));var Me;(function(i){i.GLTF="GLTF",i.GLB="GLB"})(Me||(Me={}));const st={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};class D{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n}else{const t=e.split(",")[1],n=e.indexOf("base64")>=0;return Buffer.from(t,n?"base64":"utf8")}}static encodeText(e){return new TextEncoder().encode(e)}static decodeText(e){return new TextDecoder().decode(e)}static concat(e){let t=0;for(const r of e)t+=r.byteLength;const n=new Uint8Array(t);let s=0;for(const r of e)n.set(r,s),s+=r.byteLength;return n}static pad(e,t=0){const n=this.padNumber(e.byteLength);if(n===e.byteLength)return e;const s=new Uint8Array(n);if(s.set(e),t!==0)for(let r=e.byteLength;r<n;r++)s[r]=t;return s}static padNumber(e){return Math.ceil(e/4)*4}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let n=e.byteLength;for(;n--;)if(e[n]!==t[n])return!1;return!0}static toView(e,t=0,n=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,n))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class Ls{match(e){return e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255}getSize(e){let t=new DataView(e.buffer,e.byteOffset+4),n,s;for(;t.byteLength;){if(n=t.getUint16(0,!1),js(t,n),s=t.getUint8(n+1),s===192||s===193||s===194)return[t.getUint16(n+7,!1),t.getUint16(n+5,!1)];t=new DataView(e.buffer,t.byteOffset+n+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}}class nt{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return D.decodeText(e.slice(12,16))===nt.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}nt.PNG_FRIED_CHUNK_NAME="CgBI";class ue{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let n=0;const s=4,r=this.getSize(e,t);if(!r)return null;for(;r[0]>1||r[1]>1;)n+=r[0]*r[1]*s,r[0]=Math.max(Math.floor(r[0]/2),1),r[1]=Math.max(Math.floor(r[1]/2),1);return n+=1*1*s,n}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}ue.impls={"image/jpeg":new Ls,"image/png":new nt};function js(i,e){if(e>i.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(i.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return i}class je{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return ue.mimeTypeToExtension(t)}else{if(e.startsWith("data:model/gltf+json"))return"gltf";if(e.startsWith("data:model/gltf-binary"))return"glb";if(e.startsWith("data:application/"))return"bin"}return e.split(/[\\/]/).pop().split(/[.]/).pop()}}var pt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});function Ps(){var i=new pt(3);return pt!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function dt(i){var e=i[0],t=i[1],n=i[2];return Math.hypot(e,t,n)}function Vs(i,e,t){var n=e[0],s=e[1],r=e[2],o=t[3]*n+t[7]*s+t[11]*r+t[15];return o=o||1,i[0]=(t[0]*n+t[4]*s+t[8]*r+t[12])/o,i[1]=(t[1]*n+t[5]*s+t[9]*r+t[13])/o,i[2]=(t[2]*n+t[6]*s+t[10]*r+t[14])/o,i}(function(){var i=Ps();return function(e,t,n,s,r,o){var a,c;for(t||(t=3),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,a=n;a<c;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],r(i,i,o),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2];return e}})();function ks(i){const e=Ot(),t=i.propertyType===p.NODE?[i]:i.listChildren();for(const n of t)n.traverse(s=>{const r=s.getMesh();if(!r)return;const o=Gs(r,s.getWorldMatrix());o.min.every(isFinite)&&o.max.every(isFinite)&&(Tt(o.min,e),Tt(o.max,e))});return e}function Gs(i,e){const t=Ot();for(const n of i.listPrimitives()){const s=n.getAttribute("POSITION"),r=n.getIndices();if(!s)continue;let o=[0,0,0],a=[0,0,0];for(let c=0,u=r?r.getCount():s.getCount();c<u;c++){const h=r?r.getScalar(c):c;o=s.getElement(h,o),a=Vs(a,o,e),Tt(a,t)}}return t}function Tt(i,e){for(let t=0;t<3;t++)e.min[t]=Math.min(i[t],e.min[t]),e.max[t]=Math.max(i[t],e.max[t])}function Ot(){return{min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]}}const Dt="https://null.example";class Xe{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return je.basename(new URL(e,Dt).pathname)}static extension(e){return je.extension(new URL(e,Dt).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const n=e.split("/"),s=t.split("/");n.pop();for(let r=0;r<s.length;r++)s[r]!=="."&&(s[r]===".."?n.pop():n.push(s[r]));return n.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}Xe.DEFAULT_INIT={},Xe.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;function Ft(i){return Object.prototype.toString.call(i)==="[object Object]"}function De(i){if(Ft(i)===!1)return!1;const e=i.constructor;if(e===void 0)return!0;const t=e.prototype;return!(Ft(t)===!1||Object.hasOwn(t,"isPrototypeOf")===!1)}var mt,xt;(function(i){i[i.SILENT=4]="SILENT",i[i.ERROR=3]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=1]="INFO",i[i.DEBUG=0]="DEBUG"})(xt||(xt={}));class ne{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=ne.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=ne.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=ne.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=ne.Verbosity.ERROR&&console.error(e)}}mt=ne,ne.Verbosity=xt,ne.DEFAULT_INSTANCE=new mt(mt.Verbosity.INFO);function Hs(i){var e=i[0],t=i[1],n=i[2],s=i[3],r=i[4],o=i[5],a=i[6],c=i[7],u=i[8],h=i[9],g=i[10],m=i[11],x=i[12],S=i[13],M=i[14],_=i[15],l=e*o-t*r,b=e*a-n*r,T=e*c-s*r,R=t*a-n*o,E=t*c-s*o,I=n*c-s*a,f=u*S-h*x,d=u*M-g*x,y=u*_-m*x,A=h*M-g*S,C=h*_-m*S,O=g*_-m*M;return l*O-b*C+T*A+R*y-E*d+I*f}function zs(i,e,t){var n=e[0],s=e[1],r=e[2],o=e[3],a=e[4],c=e[5],u=e[6],h=e[7],g=e[8],m=e[9],x=e[10],S=e[11],M=e[12],_=e[13],l=e[14],b=e[15],T=t[0],R=t[1],E=t[2],I=t[3];return i[0]=T*n+R*a+E*g+I*M,i[1]=T*s+R*c+E*m+I*_,i[2]=T*r+R*u+E*x+I*l,i[3]=T*o+R*h+E*S+I*b,T=t[4],R=t[5],E=t[6],I=t[7],i[4]=T*n+R*a+E*g+I*M,i[5]=T*s+R*c+E*m+I*_,i[6]=T*r+R*u+E*x+I*l,i[7]=T*o+R*h+E*S+I*b,T=t[8],R=t[9],E=t[10],I=t[11],i[8]=T*n+R*a+E*g+I*M,i[9]=T*s+R*c+E*m+I*_,i[10]=T*r+R*u+E*x+I*l,i[11]=T*o+R*h+E*S+I*b,T=t[12],R=t[13],E=t[14],I=t[15],i[12]=T*n+R*a+E*g+I*M,i[13]=T*s+R*c+E*m+I*_,i[14]=T*r+R*u+E*x+I*l,i[15]=T*o+R*h+E*S+I*b,i}function Xs(i,e){var t=e[0],n=e[1],s=e[2],r=e[4],o=e[5],a=e[6],c=e[8],u=e[9],h=e[10];return i[0]=Math.hypot(t,n,s),i[1]=Math.hypot(r,o,a),i[2]=Math.hypot(c,u,h),i}function Ks(i,e){var t=new pt(3);Xs(t,e);var n=1/t[0],s=1/t[1],r=1/t[2],o=e[0]*n,a=e[1]*s,c=e[2]*r,u=e[4]*n,h=e[5]*s,g=e[6]*r,m=e[8]*n,x=e[9]*s,S=e[10]*r,M=o+h+S,_=0;return M>0?(_=Math.sqrt(M+1)*2,i[3]=.25*_,i[0]=(g-x)/_,i[1]=(m-c)/_,i[2]=(a-u)/_):o>h&&o>S?(_=Math.sqrt(1+o-h-S)*2,i[3]=(g-x)/_,i[0]=.25*_,i[1]=(a+u)/_,i[2]=(m+c)/_):h>S?(_=Math.sqrt(1+h-o-S)*2,i[3]=(m-c)/_,i[0]=(a+u)/_,i[1]=.25*_,i[2]=(g+x)/_):(_=Math.sqrt(1+S-o-h)*2,i[3]=(a-u)/_,i[0]=(m+c)/_,i[1]=(g+x)/_,i[2]=.25*_),i}class L{static identity(e){return e}static eq(e,t,n=1e-5){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(Math.abs(e[s]-t[s])>n)return!1;return!0}static clamp(e,t,n){return e<t?t:e>n?n:e}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(L.clamp(e,0,1)*65535);case 5121:return Math.round(L.clamp(e,0,1)*255);case 5122:return Math.round(L.clamp(e,-1,1)*32767);case 5120:return Math.round(L.clamp(e,-1,1)*127);default:throw new Error("Invalid component type.")}}static decompose(e,t,n,s){let r=dt([e[0],e[1],e[2]]);const o=dt([e[4],e[5],e[6]]),a=dt([e[8],e[9],e[10]]);Hs(e)<0&&(r=-r),t[0]=e[12],t[1]=e[13],t[2]=e[14];const u=e.slice(),h=1/r,g=1/o,m=1/a;u[0]*=h,u[1]*=h,u[2]*=h,u[4]*=g,u[5]*=g,u[6]*=g,u[8]*=m,u[9]*=m,u[10]*=m,Ks(n,u),s[0]=r,s[1]=o,s[2]=a}static compose(e,t,n,s){const r=s,o=t[0],a=t[1],c=t[2],u=t[3],h=o+o,g=a+a,m=c+c,x=o*h,S=o*g,M=o*m,_=a*g,l=a*m,b=c*m,T=u*h,R=u*g,E=u*m,I=n[0],f=n[1],d=n[2];return r[0]=(1-(_+b))*I,r[1]=(S+E)*I,r[2]=(M-R)*I,r[3]=0,r[4]=(S-E)*f,r[5]=(1-(x+b))*f,r[6]=(l+T)*f,r[7]=0,r[8]=(M+R)*d,r[9]=(l-T)*d,r[10]=(1-(x+_))*d,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}}function $s(i,e){if(!!i!=!!e)return!1;const t=i.getChild(),n=e.getChild();return t===n||t.equals(n)}function qs(i,e){if(!!i!=!!e)return!1;const t=i.values(),n=e.values();if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++){const r=t[s],o=n[s];if(r.getChild()!==o.getChild()&&!r.getChild().equals(o.getChild()))return!1}return!0}function Ys(i,e){if(!!i!=!!e)return!1;const t=i.keys(),n=e.keys();if(t.length!==n.length)return!1;for(const s of t){const r=i.get(s),o=e.get(s);if(!!r!=!!o)return!1;const a=r.getChild(),c=o.getChild();if(a!==c&&!a.equals(c))return!1}return!0}function vt(i,e){if(i===e)return!0;if(!!i!=!!e||!i||!e||i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}function Ut(i,e){if(i===e)return!0;if(!!i!=!!e)return!1;if(!De(i)||!De(e))return i===e;const t=i,n=e;let s=0,r=0,o;for(o in t)s++;for(o in n)r++;if(s!==r)return!1;for(o in t){const a=t[o],c=n[o];if(rt(a)&&rt(c)){if(!vt(a,c))return!1}else if(De(a)&&De(c)){if(!Ut(a,c))return!1}else if(a!==c)return!1}return!0}function rt(i){return Array.isArray(i)||ArrayBuffer.isView(i)}const Bt="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",Ws=999,Js=6,Lt=new Set,Qs=function(){let e="";for(let t=0;t<Js;t++)e+=Bt.charAt(Math.floor(Math.random()*Bt.length));return e},Zs=function(){for(let e=0;e<Ws;e++){const t=Qs();if(!Lt.has(t))return Lt.add(t),t}return""},be=i=>i,en=new Set;class Et extends gt{constructor(e,t=""){super(e),this[B].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){const e=this.constructor;return new e(this.graph).copy(this,be)}copy(e,t=be){for(const n in this[B]){const s=this[B][n];if(s instanceof Be)this[Oe].has(n)||s.dispose();else if(s instanceof _e||s instanceof P)for(const r of s.values())r.dispose();else if(s instanceof ce)for(const r of s.values())r.dispose()}for(const n in e[B]){const s=this[B][n],r=e[B][n];if(r instanceof Be)this[Oe].has(n)?s.getChild().copy(t(r.getChild()),t):this.setRef(n,t(r.getChild()),r.getAttributes());else if(r instanceof P||r instanceof _e)for(const o of r.values())this.addRef(n,t(o.getChild()),o.getAttributes());else if(r instanceof ce)for(const o of r.keys()){const a=r.get(o);this.setRefMap(n,o,t(a.getChild()),a.getAttributes())}else De(r)?this[B][n]=JSON.parse(JSON.stringify(r)):Array.isArray(r)||r instanceof ArrayBuffer||ArrayBuffer.isView(r)?this[B][n]=r.slice():this[B][n]=r}return this}equals(e,t=en){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const n in this[B]){if(t.has(n))continue;const s=this[B][n],r=e[B][n];if(s instanceof Be||r instanceof Be){if(!$s(s,r))return!1}else if(s instanceof P||r instanceof P||s instanceof _e||r instanceof _e){if(!qs(s,r))return!1}else if(s instanceof ce||r instanceof ce){if(!Ys(s,r))return!1}else if(De(s)||De(r)){if(!Ut(s,r))return!1}else if(rt(s)||rt(r)){if(!vt(s,r))return!1}else if(s!==r)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}class Y extends Et{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new ce})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t._validateParent(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}}class N extends Y{init(){this.propertyType=p.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:N.Type.SCALAR,componentType:N.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(e){switch(e){case N.Type.SCALAR:return 1;case N.Type.VEC2:return 2;case N.Type.VEC3:return 3;case N.Type.VEC4:return 4;case N.Type.MAT2:return 4;case N.Type.MAT3:return 9;case N.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case N.ComponentType.BYTE:return 1;case N.ComponentType.UNSIGNED_BYTE:return 1;case N.ComponentType.SHORT:return 2;case N.ComponentType.UNSIGNED_SHORT:return 2;case N.ComponentType.UNSIGNED_INT:return 4;case N.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getNormalized(),n=this.getElementSize(),s=this.getComponentType();if(this.getMin(e),t)for(let r=0;r<n;r++)e[r]=L.decodeNormalizedInt(e[r],s);return e}getMin(e){const t=this.getArray(),n=this.getCount(),s=this.getElementSize();for(let r=0;r<s;r++)e[r]=1/0;for(let r=0;r<n*s;r+=s)for(let o=0;o<s;o++){const a=t[r+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getNormalized(),n=this.getElementSize(),s=this.getComponentType();if(this.getMax(e),t)for(let r=0;r<n;r++)e[r]=L.decodeNormalizedInt(e[r],s);return e}getMax(e){const t=this.get("array"),n=this.getCount(),s=this.getElementSize();for(let r=0;r<s;r++)e[r]=-1/0;for(let r=0;r<n*s;r+=s)for(let o=0;o<s;o++){const a=t[r+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return N.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e)}getScalar(e){const t=this.getElementSize(),n=this.getComponentType(),s=this.getArray();return this.getNormalized()?L.decodeNormalizedInt(s[e*t],n):s[e*t]}setScalar(e,t){const n=this.getElementSize(),s=this.getComponentType(),r=this.getArray();return this.getNormalized()?r[e*n]=L.encodeNormalizedInt(t,s):r[e*n]=t,this}getElement(e,t){const n=this.getNormalized(),s=this.getElementSize(),r=this.getComponentType(),o=this.getArray();for(let a=0;a<s;a++)n?t[a]=L.decodeNormalizedInt(o[e*s+a],r):t[a]=o[e*s+a];return t}setElement(e,t){const n=this.getNormalized(),s=this.getElementSize(),r=this.getComponentType(),o=this.getArray();for(let a=0;a<s;a++)n?o[e*s+a]=L.encodeNormalizedInt(t[a],r):o[e*s+a]=t[a];return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?tn(e):N.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}N.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},N.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};function tn(i){switch(i.constructor){case Float32Array:return N.ComponentType.FLOAT;case Uint32Array:return N.ComponentType.UNSIGNED_INT;case Uint16Array:return N.ComponentType.UNSIGNED_SHORT;case Uint8Array:return N.ComponentType.UNSIGNED_BYTE;case Int16Array:return N.ComponentType.SHORT;case Int8Array:return N.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}class jt extends Y{init(){this.propertyType=p.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:new P,samplers:new P})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}class yt extends Y{init(){this.propertyType=p.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}yt.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class Pe extends Y{init(){this.propertyType=p.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Pe.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:ee.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:ee.OTHER})}}Pe.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Pt extends Y{init(){this.propertyType=p.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}class Fe extends Y{init(){this.propertyType=p.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Fe.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:Math.PI*2*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}}Fe.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class H extends Et{_validateParent(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}H.EXTENSION_NAME=void 0;class j extends Y{init(){this.propertyType=p.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:j.WrapMode.REPEAT,wrapT:j.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}}j.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},j.MagFilter={NEAREST:9728,LINEAR:9729},j.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:it,G:ot,B:at,A:sn}=se;class ve extends Y{init(){this.propertyType=p.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:ve.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new j(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new j(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new j(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new j(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new j(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:it|ot|at|sn,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:it|ot|at,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:it|ot|at})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:it})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:ot|at})}}ve.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class Vt extends Y{init(){this.propertyType=p.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:new P})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}class kt extends Y{init(){this.propertyType=p.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:new P})}copy(e,t=be){if(t===be)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return L.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),n=this.get("rotation").slice(),s=this.get("scale").slice();return L.decompose(e,t,n,s),this.set("translation",t).set("rotation",n).set("scale",s)}getWorldTranslation(){const e=[0,0,0];return L.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return L.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return L.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let s=this;s!=null;s=s.getParentNode())e.push(s);let t;const n=e.pop().getMatrix();for(;t=e.pop();)zs(n,n,t.getMatrix());return n}addChild(e){const t=e.getParentNode();t&&t.removeChild(e);for(const n of e.listParents())n.propertyType===p.SCENE&&n.removeChild(e);return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParentNode(){for(const e of this.listParents())if(e.propertyType===p.NODE)return e;return null}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}}class Ue extends Y{init(){this.propertyType=p.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:Ue.Mode.TRIANGLES,material:null,indices:null,attributes:new ce,targets:new P})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:ee.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:ee.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}Ue.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class nn extends Et{init(){this.propertyType=p.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new ce})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:ee.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function W(){return W=Object.assign?Object.assign.bind():function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)({}).hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},W.apply(null,arguments)}class Gt extends Y{init(){this.propertyType=p.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:new P})}copy(e,t=be){if(t===be)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){const t=e.getParentNode();return t&&t.removeChild(e),this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}}class Ht extends Y{init(){this.propertyType=p.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:new P})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:ee.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}class zt extends Y{init(){this.propertyType=p.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||ue.extensionToMimeType(je.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=ue.extensionToMimeType(je.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",D.assertView(e))}getSize(){const e=this.get("image");return e?ue.getSize(e,this.getMimeType()):null}}class Xt extends Y{init(){this.propertyType=p.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${Ct}`,version:"2.0"},defaultScene:null,accessors:new P,animations:new P,buffers:new P,cameras:new P,materials:new P,meshes:new P,nodes:new P,scenes:new P,skins:new P,textures:new P})}constructor(e){super(e),this._extensions=new Set,e.addEventListener("node:create",t=>{this._addChildOfRoot(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=be){if(t===be)throw new Error("Root cannot be copied.");this.set("asset",W({},e.get("asset"))),this.setName(e.getName()),this.setExtras(W({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const n of e.listRefMapKeys("extensions")){const s=e.getExtension(n);this.setExtension(n,t(s))}return this}_addChildOfRoot(e){return e instanceof Gt?this.addRef("scenes",e):e instanceof kt?this.addRef("nodes",e):e instanceof Fe?this.addRef("cameras",e):e instanceof Ht?this.addRef("skins",e):e instanceof Vt?this.addRef("meshes",e):e instanceof ve?this.addRef("materials",e):e instanceof zt?this.addRef("textures",e):e instanceof jt?this.addRef("animations",e):e instanceof N?this.addRef("accessors",e):e instanceof Pt&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this._extensions)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}_enableExtension(e){return this._extensions.add(e),this}_disableExtension(e){return this._extensions.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class Ke{static fromGraph(e){return Ke._GRAPH_DOCUMENTS.get(e)||null}constructor(){this._graph=new Bs,this._root=new Xt(this._graph),this._logger=ne.DEFAULT_INSTANCE,Ke._GRAPH_DOCUMENTS.set(this._graph,this)}getRoot(){return this._root}getGraph(){return this._graph}getLogger(){return this._logger}setLogger(e){return this._logger=e,this}clone(){throw new Error("Use 'cloneDocument(source)' from '@gltf-transform/functions'.")}merge(e){throw new Error("Use 'mergeDocuments(target, source)' from '@gltf-transform/functions'.")}async transform(...e){const t=e.map(n=>n.name);for(const n of e)await n(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(s=>s.extensionName===t)||new e(this)}createScene(e=""){return new Gt(this._graph,e)}createNode(e=""){return new kt(this._graph,e)}createCamera(e=""){return new Fe(this._graph,e)}createSkin(e=""){return new Ht(this._graph,e)}createMesh(e=""){return new Vt(this._graph,e)}createPrimitive(){return new Ue(this._graph)}createPrimitiveTarget(e=""){return new nn(this._graph,e)}createMaterial(e=""){return new ve(this._graph,e)}createTexture(e=""){return new zt(this._graph,e)}createAnimation(e=""){return new jt(this._graph,e)}createAnimationChannel(e=""){return new yt(this._graph,e)}createAnimationSampler(e=""){return new Pe(this._graph,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new N(this._graph,e).setBuffer(t)}createBuffer(e=""){return new Pt(this._graph,e)}}Ke._GRAPH_DOCUMENTS=new WeakMap;class k{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=e,e.getRoot()._enableExtension(this),this._listener=n=>{const s=n,r=s.target;r instanceof H&&r.extensionName===this.extensionName&&(s.type==="node:create"&&this._addExtensionProperty(r),s.type==="node:dispose"&&this._removeExtensionProperty(r))};const t=e.getGraph();t.addEventListener("node:create",this._listener),t.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const e=this.document.getGraph();e.removeEventListener("node:create",this._listener),e.removeEventListener("node:dispose",this._listener);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(e){return this.properties.add(e),this}_removeExtensionProperty(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}k.EXTENSION_NAME=void 0;class rn{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const n=this.jsonDoc.json.textures[t.index];if(n.sampler===void 0)return;const s=this.jsonDoc.json.samplers[n.sampler];s.magFilter!==void 0&&e.setMagFilter(s.magFilter),s.minFilter!==void 0&&e.setMinFilter(s.minFilter),s.wrapS!==void 0&&e.setWrapS(s.wrapS),s.wrapT!==void 0&&e.setWrapT(s.wrapT)}}const Kt={logger:ne.DEFAULT_INSTANCE,extensions:[],dependencies:{}},on=new Set([p.BUFFER,p.TEXTURE,p.MATERIAL,p.MESH,p.PRIMITIVE,p.NODE,p.SCENE]);class an{static read(e,t=Kt){const n=W({},Kt,t),{json:s}=e,r=new Ke().setLogger(n.logger);this.validate(e,n);const o=new rn(e),a=s.asset,c=r.getRoot().getAsset();a.copyright&&(c.copyright=a.copyright),a.extras&&(c.extras=a.extras),s.extras!==void 0&&r.getRoot().setExtras(W({},s.extras));const u=s.extensionsUsed||[],h=s.extensionsRequired||[];n.extensions.sort((f,d)=>f.EXTENSION_NAME>d.EXTENSION_NAME?1:-1);for(const f of n.extensions)if(u.includes(f.EXTENSION_NAME)){const d=r.createExtension(f).setRequired(h.includes(f.EXTENSION_NAME)),y=d.prereadTypes.filter(A=>!on.has(A));y.length&&n.logger.warn(`Preread hooks for some types (${y.join()}), requested by extension ${d.extensionName}, are unsupported. Please file an issue or a PR.`);for(const A of d.readDependencies)d.install(A,n.dependencies[A])}const g=s.buffers||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.BUFFER)).forEach(f=>f.preread(o,p.BUFFER)),o.buffers=g.map(f=>{const d=r.createBuffer(f.name);return f.extras&&d.setExtras(f.extras),f.uri&&f.uri.indexOf("__")!==0&&d.setURI(f.uri),d});const m=s.bufferViews||[];o.bufferViewBuffers=m.map((f,d)=>{if(!o.bufferViews[d]){const y=e.json.buffers[f.buffer],A=y.uri?e.resources[y.uri]:e.resources[Le],C=f.byteOffset||0;o.bufferViews[d]=D.toView(A,C,f.byteLength)}return o.buffers[f.buffer]});const x=s.accessors||[];o.accessors=x.map(f=>{const d=o.bufferViewBuffers[f.bufferView],y=r.createAccessor(f.name,d).setType(f.type);return f.extras&&y.setExtras(f.extras),f.normalized!==void 0&&y.setNormalized(f.normalized),f.bufferView===void 0||y.setArray(ct(f,o)),y});const S=s.images||[],M=s.textures||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.TEXTURE)).forEach(f=>f.preread(o,p.TEXTURE)),o.textures=S.map(f=>{const d=r.createTexture(f.name);if(f.extras&&d.setExtras(f.extras),f.bufferView!==void 0){const y=s.bufferViews[f.bufferView],A=e.json.buffers[y.buffer],C=A.uri?e.resources[A.uri]:e.resources[Le],O=y.byteOffset||0,w=y.byteLength,v=C.slice(O,O+w);d.setImage(v)}else f.uri!==void 0&&(d.setImage(e.resources[f.uri]),f.uri.indexOf("__")!==0&&d.setURI(f.uri));if(f.mimeType!==void 0)d.setMimeType(f.mimeType);else if(f.uri){const y=je.extension(f.uri);d.setMimeType(ue.extensionToMimeType(y))}return d}),r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.MATERIAL)).forEach(f=>f.preread(o,p.MATERIAL));const _=s.materials||[];o.materials=_.map(f=>{const d=r.createMaterial(f.name);f.extras&&d.setExtras(f.extras),f.alphaMode!==void 0&&d.setAlphaMode(f.alphaMode),f.alphaCutoff!==void 0&&d.setAlphaCutoff(f.alphaCutoff),f.doubleSided!==void 0&&d.setDoubleSided(f.doubleSided);const y=f.pbrMetallicRoughness||{};if(y.baseColorFactor!==void 0&&d.setBaseColorFactor(y.baseColorFactor),f.emissiveFactor!==void 0&&d.setEmissiveFactor(f.emissiveFactor),y.metallicFactor!==void 0&&d.setMetallicFactor(y.metallicFactor),y.roughnessFactor!==void 0&&d.setRoughnessFactor(y.roughnessFactor),y.baseColorTexture!==void 0){const A=y.baseColorTexture,C=o.textures[M[A.index].source];d.setBaseColorTexture(C),o.setTextureInfo(d.getBaseColorTextureInfo(),A)}if(f.emissiveTexture!==void 0){const A=f.emissiveTexture,C=o.textures[M[A.index].source];d.setEmissiveTexture(C),o.setTextureInfo(d.getEmissiveTextureInfo(),A)}if(f.normalTexture!==void 0){const A=f.normalTexture,C=o.textures[M[A.index].source];d.setNormalTexture(C),o.setTextureInfo(d.getNormalTextureInfo(),A),f.normalTexture.scale!==void 0&&d.setNormalScale(f.normalTexture.scale)}if(f.occlusionTexture!==void 0){const A=f.occlusionTexture,C=o.textures[M[A.index].source];d.setOcclusionTexture(C),o.setTextureInfo(d.getOcclusionTextureInfo(),A),f.occlusionTexture.strength!==void 0&&d.setOcclusionStrength(f.occlusionTexture.strength)}if(y.metallicRoughnessTexture!==void 0){const A=y.metallicRoughnessTexture,C=o.textures[M[A.index].source];d.setMetallicRoughnessTexture(C),o.setTextureInfo(d.getMetallicRoughnessTextureInfo(),A)}return d}),r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.MESH)).forEach(f=>f.preread(o,p.MESH));const l=s.meshes||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.PRIMITIVE)).forEach(f=>f.preread(o,p.PRIMITIVE)),o.meshes=l.map(f=>{const d=r.createMesh(f.name);return f.extras&&d.setExtras(f.extras),f.weights!==void 0&&d.setWeights(f.weights),(f.primitives||[]).forEach(A=>{const C=r.createPrimitive();A.extras&&C.setExtras(A.extras),A.material!==void 0&&C.setMaterial(o.materials[A.material]),A.mode!==void 0&&C.setMode(A.mode);for(const[v,F]of Object.entries(A.attributes||{}))C.setAttribute(v,o.accessors[F]);A.indices!==void 0&&C.setIndices(o.accessors[A.indices]);const O=f.extras&&f.extras.targetNames||[];(A.targets||[]).forEach((v,F)=>{const U=O[F]||F.toString(),V=r.createPrimitiveTarget(U);for(const[Q,q]of Object.entries(v))V.setAttribute(Q,o.accessors[q]);C.addTarget(V)}),d.addPrimitive(C)}),d});const b=s.cameras||[];o.cameras=b.map(f=>{const d=r.createCamera(f.name).setType(f.type);if(f.extras&&d.setExtras(f.extras),f.type===Fe.Type.PERSPECTIVE){const y=f.perspective;d.setYFov(y.yfov),d.setZNear(y.znear),y.zfar!==void 0&&d.setZFar(y.zfar),y.aspectRatio!==void 0&&d.setAspectRatio(y.aspectRatio)}else{const y=f.orthographic;d.setZNear(y.znear).setZFar(y.zfar).setXMag(y.xmag).setYMag(y.ymag)}return d});const T=s.nodes||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.NODE)).forEach(f=>f.preread(o,p.NODE)),o.nodes=T.map(f=>{const d=r.createNode(f.name);if(f.extras&&d.setExtras(f.extras),f.translation!==void 0&&d.setTranslation(f.translation),f.rotation!==void 0&&d.setRotation(f.rotation),f.scale!==void 0&&d.setScale(f.scale),f.matrix!==void 0){const y=[0,0,0],A=[0,0,0,1],C=[1,1,1];L.decompose(f.matrix,y,A,C),d.setTranslation(y),d.setRotation(A),d.setScale(C)}return f.weights!==void 0&&d.setWeights(f.weights),d});const R=s.skins||[];o.skins=R.map(f=>{const d=r.createSkin(f.name);f.extras&&d.setExtras(f.extras),f.inverseBindMatrices!==void 0&&d.setInverseBindMatrices(o.accessors[f.inverseBindMatrices]),f.skeleton!==void 0&&d.setSkeleton(o.nodes[f.skeleton]);for(const y of f.joints)d.addJoint(o.nodes[y]);return d}),T.map((f,d)=>{const y=o.nodes[d];(f.children||[]).forEach(C=>y.addChild(o.nodes[C])),f.mesh!==void 0&&y.setMesh(o.meshes[f.mesh]),f.camera!==void 0&&y.setCamera(o.cameras[f.camera]),f.skin!==void 0&&y.setSkin(o.skins[f.skin])});const E=s.animations||[];o.animations=E.map(f=>{const d=r.createAnimation(f.name);f.extras&&d.setExtras(f.extras);const A=(f.samplers||[]).map(O=>{const w=r.createAnimationSampler().setInput(o.accessors[O.input]).setOutput(o.accessors[O.output]).setInterpolation(O.interpolation||Pe.Interpolation.LINEAR);return O.extras&&w.setExtras(O.extras),d.addSampler(w),w});return(f.channels||[]).forEach(O=>{const w=r.createAnimationChannel().setSampler(A[O.sampler]).setTargetPath(O.target.path);O.target.node!==void 0&&w.setTargetNode(o.nodes[O.target.node]),O.extras&&w.setExtras(O.extras),d.addChannel(w)}),d});const I=s.scenes||[];return r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(p.SCENE)).forEach(f=>f.preread(o,p.SCENE)),o.scenes=I.map(f=>{const d=r.createScene(f.name);return f.extras&&d.setExtras(f.extras),(f.nodes||[]).map(A=>o.nodes[A]).forEach(A=>d.addChild(A)),d}),s.scene!==void 0&&r.getRoot().setDefaultScene(o.scenes[s.scene]),r.getRoot().listExtensionsUsed().forEach(f=>f.read(o)),x.forEach((f,d)=>{const y=o.accessors[d],A=!!f.sparse,C=!f.bufferView&&!y.getArray();(A||C)&&y.setSparse(!0).setArray(un(f,o))}),r}static validate(e,t){const n=e.json;if(n.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${n.asset.version}".`);if(n.extensionsRequired){for(const s of n.extensionsRequired)if(!t.extensions.find(r=>r.EXTENSION_NAME===s))throw new Error(`Missing required extension, "${s}".`)}if(n.extensionsUsed)for(const s of n.extensionsUsed)t.extensions.find(r=>r.EXTENSION_NAME===s)||t.logger.warn(`Missing optional extension, "${s}".`)}}function cn(i,e){const t=e.jsonDoc,n=e.bufferViews[i.bufferView],s=t.json.bufferViews[i.bufferView],r=st[i.componentType],o=N.getElementSize(i.type),a=r.BYTES_PER_ELEMENT,c=i.byteOffset||0,u=new r(i.count*o),h=new DataView(n.buffer,n.byteOffset,n.byteLength),g=s.byteStride;for(let m=0;m<i.count;m++)for(let x=0;x<o;x++){const S=c+m*g+x*a;let M;switch(i.componentType){case N.ComponentType.FLOAT:M=h.getFloat32(S,!0);break;case N.ComponentType.UNSIGNED_INT:M=h.getUint32(S,!0);break;case N.ComponentType.UNSIGNED_SHORT:M=h.getUint16(S,!0);break;case N.ComponentType.UNSIGNED_BYTE:M=h.getUint8(S);break;case N.ComponentType.SHORT:M=h.getInt16(S,!0);break;case N.ComponentType.BYTE:M=h.getInt8(S);break;default:throw new Error(`Unexpected componentType "${i.componentType}".`)}u[m*o+x]=M}return u}function ct(i,e){const t=e.jsonDoc,n=e.bufferViews[i.bufferView],s=t.json.bufferViews[i.bufferView],r=st[i.componentType],o=N.getElementSize(i.type),a=r.BYTES_PER_ELEMENT,c=o*a;if(s.byteStride!==void 0&&s.byteStride!==c)return cn(i,e);const u=n.byteOffset+(i.byteOffset||0),h=i.count*o*a;return new r(n.buffer.slice(u,u+h))}function un(i,e){const t=st[i.componentType],n=N.getElementSize(i.type);let s;i.bufferView!==void 0?s=ct(i,e):s=new t(i.count*n);const r=i.sparse;if(!r)return s;const o=r.count,a=W({},i,r.indices,{count:o,type:"SCALAR"}),c=W({},i,r.values,{count:o}),u=ct(a,e),h=ct(c,e);for(let g=0;g<a.count;g++)for(let m=0;m<n;m++)s[u[g]*n+m]=h[g*n+m];return s}var $e;(function(i){i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})($e||($e={}));class fe{constructor(e,t,n){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=e,this.jsonDoc=t,this.options=n;const s=e.getRoot(),r=s.listBuffers().length,o=s.listTextures().length;this.bufferURIGenerator=new $t(r>1,()=>n.basename||"buffer"),this.imageURIGenerator=new $t(o>1,a=>fn(e,a)||n.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const n={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},s=JSON.stringify(n);this.samplerDefIndexMap.has(s)||(this.samplerDefIndexMap.set(s,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(n));const r={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(s)},o=JSON.stringify(r);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(r));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this._doc.getGraph().listParentEdges(e).some(s=>s.getName()==="attributes"&&s.getAttributes().key==="POSITION"||s.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,n){if(this.options.format===Me.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const s=ue.mimeTypeToExtension(n.getMimeType());e.uri=this.imageURIGenerator.createURI(n,s),this.assignResourceURI(e.uri,t,!1)}}assignResourceURI(e,t,n){const s=this.jsonDoc.resources;if(!(e in s)){s[e]=t;return}if(t===s[e]){this.logger.warn(`Duplicate resource URI, "${e}".`);return}const r=`Resource URI "${e}" already assigned to different data.`;if(!n){this.logger.warn(r);return}throw new Error(r)}getAccessorUsage(e){const t=this._accessorUsageMap.get(e);if(t)return t;if(e.getSparse())return ee.SPARSE;for(const n of this._doc.getGraph().listParentEdges(e)){const{usage:s}=n.getAttributes();if(s)return s;n.getParent().propertyType!==p.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${n.getName()}".`)}return ee.OTHER}addAccessorToUsageGroup(e,t){const n=this._accessorUsageMap.get(e);if(n&&n!==t)throw new Error(`Accessor with usage "${n}" cannot be reused as "${t}".`);return this._accessorUsageMap.set(e,t),this}}fe.BufferViewTarget=$e,fe.BufferViewUsage=ee,fe.USAGE_TO_TARGET={[ee.ARRAY_BUFFER]:$e.ARRAY_BUFFER,[ee.ELEMENT_ARRAY_BUFFER]:$e.ELEMENT_ARRAY_BUFFER};class $t{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const n=this.basename(e);return this.counter[n]=this.counter[n]||1,`${n}_${this.counter[n]++}.${t}`}else return`${this.basename(e)}.${t}`}}function fn(i,e){const t=i.getGraph().listParentEdges(e).find(n=>n.getParent()!==i.getRoot());return t?t.getName().replace(/texture$/i,""):""}const{BufferViewUsage:ut}=fe,{UNSIGNED_INT:ln,UNSIGNED_SHORT:hn,UNSIGNED_BYTE:gn}=N.ComponentType,pn=new Set([p.ACCESSOR,p.BUFFER,p.MATERIAL,p.MESH]);class dn{static write(e,t){const n=e.getGraph(),s=e.getRoot(),r={asset:W({generator:`glTF-Transform ${Ct}`},s.getAsset()),extras:W({},s.getExtras())},o={json:r,resources:{}},a=new fe(e,o,t),c=t.logger||ne.DEFAULT_INSTANCE,u=new Set(t.extensions.map(l=>l.EXTENSION_NAME)),h=e.getRoot().listExtensionsUsed().filter(l=>u.has(l.extensionName)).sort((l,b)=>l.extensionName>b.extensionName?1:-1),g=e.getRoot().listExtensionsRequired().filter(l=>u.has(l.extensionName)).sort((l,b)=>l.extensionName>b.extensionName?1:-1);h.length<e.getRoot().listExtensionsUsed().length&&c.warn("Some extensions were not registered for I/O, and will not be written.");for(const l of h){const b=l.prewriteTypes.filter(T=>!pn.has(T));b.length&&c.warn(`Prewrite hooks for some types (${b.join()}), requested by extension ${l.extensionName}, are unsupported. Please file an issue or a PR.`);for(const T of l.writeDependencies)l.install(T,t.dependencies[T])}function m(l,b,T,R){const E=[];let I=0;for(const y of l){const A=a.createAccessorDef(y);A.bufferView=r.bufferViews.length;const C=y.getArray(),O=D.pad(D.toView(C));A.byteOffset=I,I+=O.byteLength,E.push(O),a.accessorIndexMap.set(y,r.accessors.length),r.accessors.push(A)}const f=D.concat(E),d={buffer:b,byteOffset:T,byteLength:f.byteLength};return R&&(d.target=R),r.bufferViews.push(d),{buffers:E,byteLength:I}}function x(l,b,T){const R=l[0].getCount();let E=0;for(const A of l){const C=a.createAccessorDef(A);C.bufferView=r.bufferViews.length,C.byteOffset=E;const O=A.getElementSize(),w=A.getComponentSize();E+=D.padNumber(O*w),a.accessorIndexMap.set(A,r.accessors.length),r.accessors.push(C)}const I=R*E,f=new ArrayBuffer(I),d=new DataView(f);for(let A=0;A<R;A++){let C=0;for(const O of l){const w=O.getElementSize(),v=O.getComponentSize(),F=O.getComponentType(),U=O.getArray();for(let V=0;V<w;V++){const Q=A*E+C+V*v,q=U[A*w+V];switch(F){case N.ComponentType.FLOAT:d.setFloat32(Q,q,!0);break;case N.ComponentType.BYTE:d.setInt8(Q,q);break;case N.ComponentType.SHORT:d.setInt16(Q,q,!0);break;case N.ComponentType.UNSIGNED_BYTE:d.setUint8(Q,q);break;case N.ComponentType.UNSIGNED_SHORT:d.setUint16(Q,q,!0);break;case N.ComponentType.UNSIGNED_INT:d.setUint32(Q,q,!0);break;default:throw new Error("Unexpected component type: "+F)}}C+=D.padNumber(w*v)}}const y={buffer:b,byteOffset:T,byteLength:I,byteStride:E,target:fe.BufferViewTarget.ARRAY_BUFFER};return r.bufferViews.push(y),{byteLength:I,buffers:[new Uint8Array(f)]}}function S(l,b,T){const R=[];let E=0;const I=new Map;let f=-1/0,d=!1;for(const F of l){const U=a.createAccessorDef(F);r.accessors.push(U),a.accessorIndexMap.set(F,r.accessors.length-1);const V=[],Q=[],q=[],Mt=new Array(F.getElementSize()).fill(0);for(let Ce=0,bt=F.getCount();Ce<bt;Ce++)if(F.getElement(Ce,q),!L.eq(q,Mt,0)){f=Math.max(Ce,f),V.push(Ce);for(let et=0;et<q.length;et++)Q.push(q[et])}const Ge=V.length,He={accessorDef:U,count:Ge};if(I.set(F,He),Ge===0)continue;Ge>F.getCount()/2&&(d=!0);const lt=st[F.getComponentType()];He.indices=V,He.values=new lt(Q)}if(!Number.isFinite(f))return{buffers:R,byteLength:E};d&&c.warn("Some sparse accessors have >50% non-zero elements, which may increase file size.");const y=f<255?Uint8Array:f<65535?Uint16Array:Uint32Array,A=f<255?gn:f<65535?hn:ln,C={buffer:b,byteOffset:T+E,byteLength:0};for(const F of l){const U=I.get(F);if(U.count===0)continue;U.indicesByteOffset=C.byteLength;const V=D.pad(D.toView(new y(U.indices)));R.push(V),E+=V.byteLength,C.byteLength+=V.byteLength}r.bufferViews.push(C);const O=r.bufferViews.length-1,w={buffer:b,byteOffset:T+E,byteLength:0};for(const F of l){const U=I.get(F);if(U.count===0)continue;U.valuesByteOffset=w.byteLength;const V=D.pad(D.toView(U.values));R.push(V),E+=V.byteLength,w.byteLength+=V.byteLength}r.bufferViews.push(w);const v=r.bufferViews.length-1;for(const F of l){const U=I.get(F);U.count!==0&&(U.accessorDef.sparse={count:U.count,indices:{bufferView:O,byteOffset:U.indicesByteOffset,componentType:A},values:{bufferView:v,byteOffset:U.valuesByteOffset}})}return{buffers:R,byteLength:E}}if(r.accessors=[],r.bufferViews=[],r.samplers=[],r.textures=[],r.images=s.listTextures().map((l,b)=>{const T=a.createPropertyDef(l);l.getMimeType()&&(T.mimeType=l.getMimeType());const R=l.getImage();return R&&a.createImageData(T,R,l),a.imageIndexMap.set(l,b),T}),h.filter(l=>l.prewriteTypes.includes(p.ACCESSOR)).forEach(l=>l.prewrite(a,p.ACCESSOR)),s.listAccessors().forEach(l=>{const b=a.accessorUsageGroupedByParent,T=a.accessorParents;if(a.accessorIndexMap.has(l))return;const R=a.getAccessorUsage(l);if(a.addAccessorToUsageGroup(l,R),b.has(R)){const E=n.listParents(l).find(I=>I.propertyType!==p.ROOT);T.set(l,E)}}),h.filter(l=>l.prewriteTypes.includes(p.BUFFER)).forEach(l=>l.prewrite(a,p.BUFFER)),(s.listAccessors().length>0||a.otherBufferViews.size>0||s.listTextures().length>0&&t.format===Me.GLB)&&s.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");r.buffers=[],s.listBuffers().forEach((l,b)=>{const T=a.createPropertyDef(l),R=a.accessorUsageGroupedByParent,E=l.listParents().filter(w=>w instanceof N),I=new Set(E.map(w=>a.accessorParents.get(w))),f=new Map(Array.from(I).map((w,v)=>[w,v])),d={};for(const w of E){var y;if(a.accessorIndexMap.has(w))continue;const v=a.getAccessorUsage(w);let F=v;if(R.has(v)){const U=a.accessorParents.get(w);F+=`:${f.get(U)}`}d[y=F]||(d[y]={usage:v,accessors:[]}),d[F].accessors.push(w)}const A=[],C=r.buffers.length;let O=0;for(const{usage:w,accessors:v}of Object.values(d))if(w===ut.ARRAY_BUFFER&&t.vertexLayout===tt.INTERLEAVED){const F=x(v,C,O);O+=F.byteLength;for(const U of F.buffers)A.push(U)}else if(w===ut.ARRAY_BUFFER)for(const F of v){const U=x([F],C,O);O+=U.byteLength;for(const V of U.buffers)A.push(V)}else if(w===ut.SPARSE){const F=S(v,C,O);O+=F.byteLength;for(const U of F.buffers)A.push(U)}else if(w===ut.ELEMENT_ARRAY_BUFFER){const F=fe.BufferViewTarget.ELEMENT_ARRAY_BUFFER,U=m(v,C,O,F);O+=U.byteLength;for(const V of U.buffers)A.push(V)}else{const F=m(v,C,O);O+=F.byteLength;for(const U of F.buffers)A.push(U)}if(a.imageBufferViews.length&&b===0){for(let w=0;w<a.imageBufferViews.length;w++)if(r.bufferViews[r.images[w].bufferView].byteOffset=O,O+=a.imageBufferViews[w].byteLength,A.push(a.imageBufferViews[w]),O%8){const v=8-O%8;O+=v,A.push(new Uint8Array(v))}}if(a.otherBufferViews.has(l))for(const w of a.otherBufferViews.get(l))r.bufferViews.push({buffer:C,byteOffset:O,byteLength:w.byteLength}),a.otherBufferViewsIndexMap.set(w,r.bufferViews.length-1),O+=w.byteLength,A.push(w);if(O){let w;t.format===Me.GLB?w=Le:(w=a.bufferURIGenerator.createURI(l,"bin"),T.uri=w),T.byteLength=O,a.assignResourceURI(w,D.concat(A),!0)}r.buffers.push(T),a.bufferIndexMap.set(l,b)}),s.listAccessors().find(l=>!l.getBuffer())&&c.warn("Skipped writing one or more Accessors: no Buffer assigned."),h.filter(l=>l.prewriteTypes.includes(p.MATERIAL)).forEach(l=>l.prewrite(a,p.MATERIAL)),r.materials=s.listMaterials().map((l,b)=>{const T=a.createPropertyDef(l);if(l.getAlphaMode()!==ve.AlphaMode.OPAQUE&&(T.alphaMode=l.getAlphaMode()),l.getAlphaMode()===ve.AlphaMode.MASK&&(T.alphaCutoff=l.getAlphaCutoff()),l.getDoubleSided()&&(T.doubleSided=!0),T.pbrMetallicRoughness={},L.eq(l.getBaseColorFactor(),[1,1,1,1])||(T.pbrMetallicRoughness.baseColorFactor=l.getBaseColorFactor()),L.eq(l.getEmissiveFactor(),[0,0,0])||(T.emissiveFactor=l.getEmissiveFactor()),l.getRoughnessFactor()!==1&&(T.pbrMetallicRoughness.roughnessFactor=l.getRoughnessFactor()),l.getMetallicFactor()!==1&&(T.pbrMetallicRoughness.metallicFactor=l.getMetallicFactor()),l.getBaseColorTexture()){const R=l.getBaseColorTexture(),E=l.getBaseColorTextureInfo();T.pbrMetallicRoughness.baseColorTexture=a.createTextureInfoDef(R,E)}if(l.getEmissiveTexture()){const R=l.getEmissiveTexture(),E=l.getEmissiveTextureInfo();T.emissiveTexture=a.createTextureInfoDef(R,E)}if(l.getNormalTexture()){const R=l.getNormalTexture(),E=l.getNormalTextureInfo(),I=a.createTextureInfoDef(R,E);l.getNormalScale()!==1&&(I.scale=l.getNormalScale()),T.normalTexture=I}if(l.getOcclusionTexture()){const R=l.getOcclusionTexture(),E=l.getOcclusionTextureInfo(),I=a.createTextureInfoDef(R,E);l.getOcclusionStrength()!==1&&(I.strength=l.getOcclusionStrength()),T.occlusionTexture=I}if(l.getMetallicRoughnessTexture()){const R=l.getMetallicRoughnessTexture(),E=l.getMetallicRoughnessTextureInfo();T.pbrMetallicRoughness.metallicRoughnessTexture=a.createTextureInfoDef(R,E)}return a.materialIndexMap.set(l,b),T}),h.filter(l=>l.prewriteTypes.includes(p.MESH)).forEach(l=>l.prewrite(a,p.MESH)),r.meshes=s.listMeshes().map((l,b)=>{const T=a.createPropertyDef(l);let R=null;return T.primitives=l.listPrimitives().map(E=>{const I={attributes:{}};I.mode=E.getMode();const f=E.getMaterial();f&&(I.material=a.materialIndexMap.get(f)),Object.keys(E.getExtras()).length&&(I.extras=E.getExtras());const d=E.getIndices();d&&(I.indices=a.accessorIndexMap.get(d));for(const y of E.listSemantics())I.attributes[y]=a.accessorIndexMap.get(E.getAttribute(y));for(const y of E.listTargets()){const A={};for(const C of y.listSemantics())A[C]=a.accessorIndexMap.get(y.getAttribute(C));I.targets=I.targets||[],I.targets.push(A)}return E.listTargets().length&&!R&&(R=E.listTargets().map(y=>y.getName())),I}),l.getWeights().length&&(T.weights=l.getWeights()),R&&(T.extras=T.extras||{},T.extras.targetNames=R),a.meshIndexMap.set(l,b),T}),r.cameras=s.listCameras().map((l,b)=>{const T=a.createPropertyDef(l);if(T.type=l.getType(),T.type===Fe.Type.PERSPECTIVE){T.perspective={znear:l.getZNear(),zfar:l.getZFar(),yfov:l.getYFov()};const R=l.getAspectRatio();R!==null&&(T.perspective.aspectRatio=R)}else T.orthographic={znear:l.getZNear(),zfar:l.getZFar(),xmag:l.getXMag(),ymag:l.getYMag()};return a.cameraIndexMap.set(l,b),T}),r.nodes=s.listNodes().map((l,b)=>{const T=a.createPropertyDef(l);return L.eq(l.getTranslation(),[0,0,0])||(T.translation=l.getTranslation()),L.eq(l.getRotation(),[0,0,0,1])||(T.rotation=l.getRotation()),L.eq(l.getScale(),[1,1,1])||(T.scale=l.getScale()),l.getWeights().length&&(T.weights=l.getWeights()),a.nodeIndexMap.set(l,b),T}),r.skins=s.listSkins().map((l,b)=>{const T=a.createPropertyDef(l),R=l.getInverseBindMatrices();R&&(T.inverseBindMatrices=a.accessorIndexMap.get(R));const E=l.getSkeleton();return E&&(T.skeleton=a.nodeIndexMap.get(E)),T.joints=l.listJoints().map(I=>a.nodeIndexMap.get(I)),a.skinIndexMap.set(l,b),T}),s.listNodes().forEach((l,b)=>{const T=r.nodes[b],R=l.getMesh();R&&(T.mesh=a.meshIndexMap.get(R));const E=l.getCamera();E&&(T.camera=a.cameraIndexMap.get(E));const I=l.getSkin();I&&(T.skin=a.skinIndexMap.get(I)),l.listChildren().length>0&&(T.children=l.listChildren().map(f=>a.nodeIndexMap.get(f)))}),r.animations=s.listAnimations().map((l,b)=>{const T=a.createPropertyDef(l),R=new Map;return T.samplers=l.listSamplers().map((E,I)=>{const f=a.createPropertyDef(E);return f.input=a.accessorIndexMap.get(E.getInput()),f.output=a.accessorIndexMap.get(E.getOutput()),f.interpolation=E.getInterpolation(),R.set(E,I),f}),T.channels=l.listChannels().map(E=>{const I=a.createPropertyDef(E);return I.sampler=R.get(E.getSampler()),I.target={node:a.nodeIndexMap.get(E.getTargetNode()),path:E.getTargetPath()},I}),a.animationIndexMap.set(l,b),T}),r.scenes=s.listScenes().map((l,b)=>{const T=a.createPropertyDef(l);return T.nodes=l.listChildren().map(R=>a.nodeIndexMap.get(R)),a.sceneIndexMap.set(l,b),T});const _=s.getDefaultScene();return _&&(r.scene=s.listScenes().indexOf(_)),r.extensionsUsed=h.map(l=>l.extensionName),r.extensionsRequired=g.map(l=>l.extensionName),h.forEach(l=>l.write(a)),Tn(r),o}}function Tn(i){const e=[];for(const t in i){const n=i[t];(Array.isArray(n)&&n.length===0||n===null||n===""||n&&typeof n=="object"&&Object.keys(n).length===0)&&e.push(t)}for(const t of e)delete i[t]}var ft;(function(i){i[i.JSON=1313821514]="JSON",i[i.BIN=5130562]="BIN"})(ft||(ft={}));class mn{constructor(){this._logger=ne.DEFAULT_INSTANCE,this._extensions=new Set,this._dependencies={},this._vertexLayout=tt.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this._logger=e,this}registerExtensions(e){for(const t of e)this._extensions.add(t),t.register();return this}registerDependencies(e){return Object.assign(this._dependencies,e),this}setVertexLayout(e){return this._vertexLayout=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const n=qt(t)?this._binaryToJSON(t):{json:JSON.parse(D.decodeText(t)),resources:{}};return await this._readResourcesExternal(n,this.dirname(e)),this._readResourcesInternal(n),n}async readJSON(e){return e=this._copyJSON(e),this._readResourcesInternal(e),an.read(e,{extensions:Array.from(this._extensions),dependencies:this._dependencies,logger:this._logger})}async binaryToJSON(e){const t=this._binaryToJSON(D.assertView(e));this._readResourcesInternal(t);const n=t.json;if(n.buffers&&n.buffers.some(s=>xn(t,s)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(n.images&&n.images.some(s=>En(t,s)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(D.assertView(e)))}async writeJSON(e,t={}){if(t.format===Me.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return dn.write(e,{format:t.format||Me.GLTF,basename:t.basename||"",logger:this._logger,vertexLayout:this._vertexLayout,dependencies:W({},this._dependencies),extensions:Array.from(this._extensions)})}async writeBinary(e){const{json:t,resources:n}=await this.writeJSON(e,{format:Me.GLB}),s=new Uint32Array([1179937895,2,12]),r=JSON.stringify(t),o=D.pad(D.encodeText(r),32),a=D.toView(new Uint32Array([o.byteLength,1313821514])),c=D.concat([a,o]);s[s.length-1]+=c.byteLength;const u=Object.values(n)[0];if(!u||!u.byteLength)return D.concat([D.toView(s),c]);const h=D.pad(u,0),g=D.toView(new Uint32Array([h.byteLength,5130562])),m=D.concat([g,h]);return s[s.length-1]+=m.byteLength,D.concat([D.toView(s),c,m])}async _readResourcesExternal(e,t){var n=this;const s=e.json.images||[],r=e.json.buffers||[],o=[...s,...r].map(async function(a){const c=a.uri;if(!c||c.match(/data:/))return Promise.resolve();e.resources[c]=await n.readURI(n.resolve(t,c),"view"),n.lastReadBytes+=e.resources[c].byteLength});await Promise.all(o)}_readResourcesInternal(e){function t(r){if(r.uri){if(r.uri in e.resources){D.assertView(e.resources[r.uri]);return}if(r.uri.match(/data:/)){const o=`__${Zs()}.${je.extension(r.uri)}`;e.resources[o]=D.createBufferFromDataURI(r.uri),r.uri=o}}}(e.json.images||[]).forEach(r=>{if(r.bufferView===void 0&&r.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(r)}),(e.json.buffers||[]).forEach(t)}_copyJSON(e){const{images:t,buffers:n}=e.json;return e={json:W({},e.json),resources:W({},e.resources)},t&&(e.json.images=t.map(s=>W({},s))),n&&(e.json.buffers=n.map(s=>W({},s))),e}_binaryToJSON(e){if(!qt(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==ft.JSON)throw new Error("Missing required GLB JSON chunk.");const n=20,s=t[0],r=D.decodeText(D.toView(e,n,s)),o=JSON.parse(r),a=n+s;if(e.byteLength<=a)return{json:o,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+a,2);if(c[1]!==ft.BIN)return{json:o,resources:{}};const u=c[0],h=D.toView(e,a+8,u);return{json:o,resources:{[Le]:h}}}}function xn(i,e){return e.uri!==void 0&&!(e.uri in i.resources)}function En(i,e){return e.uri!==void 0&&!(e.uri in i.resources)&&e.bufferView===void 0}function qt(i){if(i.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(i.buffer,i.byteOffset,3);return e[0]===1179937895&&e[1]===2}class yn extends mn{constructor(e=Xe.DEFAULT_INIT){super(),this._fetchConfig=void 0,this._fetchConfig=e}async readURI(e,t){const n=await fetch(e,this._fetchConfig);switch(t){case"view":return new Uint8Array(await n.arrayBuffer());case"text":return n.text()}}resolve(e,t){return Xe.resolve(e,t)}dirname(e){return Xe.dirname(e)}}const Rn=0,In=0,An=0,Nn=2,Sn=0,_n=163,Mn=166,bn=0,wn=2,Cn=1,On=64,Dn=0;function Fn(){return{vkFormat:Dn,typeSize:1,pixelWidth:0,pixelHeight:0,pixelDepth:0,layerCount:0,faceCount:1,levelCount:0,supercompressionScheme:Rn,levels:[],dataFormatDescriptor:[{vendorId:An,descriptorType:In,versionNumber:Nn,colorModel:Sn,colorPrimaries:Cn,transferFunction:wn,flags:bn,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],keyValue:{},globalData:null}}class qe{constructor(e,t,n,s){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=s,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),n=e+2**32*t;return this._offset+=8,n}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){const n=this._offset;let s=0;for(;this._dataView.getUint8(this._offset)!==t&&s<e;)s++,this._offset++;return s<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,s)}}const J=[171,75,84,88,32,50,48,187,13,10,26,10];function Yt(i){return new TextDecoder().decode(i)}function Rt(i){const e=new Uint8Array(i.buffer,i.byteOffset,J.length);if(e[0]!==J[0]||e[1]!==J[1]||e[2]!==J[2]||e[3]!==J[3]||e[4]!==J[4]||e[5]!==J[5]||e[6]!==J[6]||e[7]!==J[7]||e[8]!==J[8]||e[9]!==J[9]||e[10]!==J[10]||e[11]!==J[11])throw new Error("Missing KTX 2.0 identifier.");const t=Fn(),n=17*Uint32Array.BYTES_PER_ELEMENT,s=new qe(i,J.length,n,!0);t.vkFormat=s._nextUint32(),t.typeSize=s._nextUint32(),t.pixelWidth=s._nextUint32(),t.pixelHeight=s._nextUint32(),t.pixelDepth=s._nextUint32(),t.layerCount=s._nextUint32(),t.faceCount=s._nextUint32(),t.levelCount=s._nextUint32(),t.supercompressionScheme=s._nextUint32();const r=s._nextUint32(),o=s._nextUint32(),a=s._nextUint32(),c=s._nextUint32(),u=s._nextUint64(),h=s._nextUint64(),g=Math.max(t.levelCount,1)*3*8,m=new qe(i,J.length+n,g,!0);for(let Z=0,te=Math.max(t.levelCount,1);Z<te;Z++)t.levels.push({levelData:new Uint8Array(i.buffer,i.byteOffset+m._nextUint64(),m._nextUint64()),uncompressedByteLength:m._nextUint64()});const x=new qe(i,r,o,!0);x._skip(4);const S=x._nextUint16(),M=x._nextUint16(),_=x._nextUint16(),l=x._nextUint16(),b=x._nextUint8(),T=x._nextUint8(),R=x._nextUint8(),E=x._nextUint8(),I=[x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8()],f=[x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8()],y={vendorId:S,descriptorType:M,versionNumber:_,colorModel:b,colorPrimaries:T,transferFunction:R,flags:E,texelBlockDimension:I,bytesPlane:f,samples:[]},O=(l/4-6)/4;for(let Z=0;Z<O;Z++){const te={bitOffset:x._nextUint16(),bitLength:x._nextUint8(),channelType:x._nextUint8(),samplePosition:[x._nextUint8(),x._nextUint8(),x._nextUint8(),x._nextUint8()],sampleLower:Number.NEGATIVE_INFINITY,sampleUpper:Number.POSITIVE_INFINITY};te.channelType&On?(te.sampleLower=x._nextInt32(),te.sampleUpper=x._nextInt32()):(te.sampleLower=x._nextUint32(),te.sampleUpper=x._nextUint32()),y.samples[Z]=te}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(y);const w=new qe(i,a,c,!0);for(;w._offset<c;){const Z=w._nextUint32(),te=w._scan(Z),ht=Yt(te);if(t.keyValue[ht]=w._nextUint8Array(Z-te.byteLength-1),ht.match(/^ktx/i)){const Us=Yt(t.keyValue[ht]);t.keyValue[ht]=Us.substring(0,Us.lastIndexOf("\0"))}const Jr=Z%4?4-Z%4:0;w._skip(Jr)}if(h<=0)return t;const v=new qe(i,u,h,!0),F=v._nextUint16(),U=v._nextUint16(),V=v._nextUint32(),Q=v._nextUint32(),q=v._nextUint32(),Mt=v._nextUint32(),Ge=[];for(let Z=0,te=Math.max(t.levelCount,1);Z<te;Z++)Ge.push({imageFlags:v._nextUint32(),rgbSliceByteOffset:v._nextUint32(),rgbSliceByteLength:v._nextUint32(),alphaSliceByteOffset:v._nextUint32(),alphaSliceByteLength:v._nextUint32()});const He=u+v._offset,lt=He+V,Ce=lt+Q,bt=Ce+q,et=new Uint8Array(i.buffer,i.byteOffset+He,V),qr=new Uint8Array(i.buffer,i.byteOffset+lt,Q),Yr=new Uint8Array(i.buffer,i.byteOffset+Ce,q),Wr=new Uint8Array(i.buffer,i.byteOffset+bt,Mt);return t.globalData={endpointCount:F,selectorCount:U,imageDescs:Ge,endpointsData:et,selectorsData:qr,tablesData:Yr,extendedData:Wr},t}const le="EXT_mesh_gpu_instancing",K="EXT_meshopt_compression",Ye="EXT_texture_webp",We="EXT_texture_avif",G="KHR_draco_mesh_compression",re="KHR_lights_punctual",he="KHR_materials_anisotropy",ge="KHR_materials_clearcoat",pe="KHR_materials_diffuse_transmission",de="KHR_materials_dispersion",Te="KHR_materials_emissive_strength",me="KHR_materials_ior",xe="KHR_materials_iridescence",Ee="KHR_materials_pbrSpecularGlossiness",ye="KHR_materials_sheen",Re="KHR_materials_specular",Ie="KHR_materials_transmission",we="KHR_materials_unlit",Ae="KHR_materials_volume",$="KHR_materials_variants",Wt="KHR_mesh_quantization",Je="KHR_texture_basisu",Ne="KHR_texture_transform",ie="KHR_xmp_json_ld",It="INSTANCE_ATTRIBUTE";class Jt extends H{init(){this.extensionName=le,this.propertyType="InstancedMesh",this.parentTypes=[p.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new ce})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:It})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}Jt.EXTENSION_NAME=le;class vn extends k{constructor(...e){super(...e),this.extensionName=le,this.provideTypes=[p.NODE],this.prewriteTypes=[p.ACCESSOR]}createInstancedMesh(){return new Jt(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[le])return;const o=s.extensions[le],a=this.createInstancedMesh();for(const c in o.attributes)a.setAttribute(c,e.accessors[o.attributes[c]]);e.nodes[r].setExtension(le,a)}),this}prewrite(e){e.accessorUsageGroupedByParent.add(It);for(const t of this.properties)for(const n of t.listAttributes())e.addAccessorToUsageGroup(n,It);return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach(n=>{const s=n.getExtension(le);if(s){const r=e.nodeIndexMap.get(n),o=t.json.nodes[r],a={attributes:{}};s.listSemantics().forEach(c=>{const u=s.getAttribute(c);a.attributes[c]=e.accessorIndexMap.get(u)}),o.extensions=o.extensions||{},o.extensions[le]=a}}),this}}vn.EXTENSION_NAME=le;function Se(){return Se=Object.assign?Object.assign.bind():function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)({}).hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},Se.apply(null,arguments)}var Qe;(function(i){i.QUANTIZE="quantize",i.FILTER="filter"})(Qe||(Qe={}));var Ve;(function(i){i.ATTRIBUTES="ATTRIBUTES",i.TRIANGLES="TRIANGLES",i.INDICES="INDICES"})(Ve||(Ve={}));var z;(function(i){i.NONE="NONE",i.OCTAHEDRAL="OCTAHEDRAL",i.QUATERNION="QUATERNION",i.EXPONENTIAL="EXPONENTIAL"})(z||(z={}));function Un(i){return!i.extensions||!i.extensions[K]?!1:!!i.extensions[K].fallback}const{BYTE:Bn,SHORT:Qt,FLOAT:Ln}=N.ComponentType,{encodeNormalizedInt:Zt,decodeNormalizedInt:At}=L;function jn(i,e,t,n){const{filter:s,bits:r}=n,o={array:i.getArray(),byteStride:i.getElementSize()*i.getComponentSize(),componentType:i.getComponentType(),normalized:i.getNormalized()};if(t!==Ve.ATTRIBUTES)return o;if(s!==z.NONE){let a=i.getNormalized()?Pn(i):new Float32Array(o.array);switch(s){case z.EXPONENTIAL:o.byteStride=i.getElementSize()*4,o.componentType=Ln,o.normalized=!1,o.array=e.encodeFilterExp(a,i.getCount(),o.byteStride,r);break;case z.OCTAHEDRAL:o.byteStride=r>8?8:4,o.componentType=r>8?Qt:Bn,o.normalized=!0,a=i.getElementSize()===3?kn(a):a,o.array=e.encodeFilterOct(a,i.getCount(),o.byteStride,r);break;case z.QUATERNION:o.byteStride=8,o.componentType=Qt,o.normalized=!0,o.array=e.encodeFilterQuat(a,i.getCount(),o.byteStride,r);break;default:throw new Error("Invalid filter.")}o.min=i.getMin([]),o.max=i.getMax([]),i.getNormalized()&&(o.min=o.min.map(c=>At(c,i.getComponentType())),o.max=o.max.map(c=>At(c,i.getComponentType()))),o.normalized&&(o.min=o.min.map(c=>Zt(c,o.componentType)),o.max=o.max.map(c=>Zt(c,o.componentType)))}else o.byteStride%4&&(o.array=Vn(o.array,i.getElementSize()),o.byteStride=o.array.byteLength/i.getCount());return o}function Pn(i){const e=i.getComponentType(),t=i.getArray(),n=new Float32Array(t.length);for(let s=0;s<t.length;s++)n[s]=At(t[s],e);return n}function Vn(i,e){const n=D.padNumber(i.BYTES_PER_ELEMENT*e)/i.BYTES_PER_ELEMENT,s=i.length/e,r=new i.constructor(s*n);for(let o=0;o*e<i.length;o++)for(let a=0;a<e;a++)r[o*n+a]=i[o*e+a];return r}function kn(i){const e=new Float32Array(i.length*4/3);for(let t=0,n=i.length/3;t<n;t++)e[t*4]=i[t*3],e[t*4+1]=i[t*3+1],e[t*4+2]=i[t*3+2];return e}function Gn(i,e){return e===fe.BufferViewUsage.ELEMENT_ARRAY_BUFFER?i.listParents().some(n=>n instanceof Ue&&n.getMode()===Ue.Mode.TRIANGLES)?Ve.TRIANGLES:Ve.INDICES:Ve.ATTRIBUTES}function Hn(i,e){const t=e.getGraph().listParentEdges(i).filter(n=>!(n.getParent()instanceof Xt));for(const n of t){const s=n.getName(),r=n.getAttributes().key||"",o=n.getParent().propertyType===p.PRIMITIVE_TARGET;if(s==="indices")return{filter:z.NONE};if(s==="attributes"){if(r==="POSITION")return{filter:z.NONE};if(r==="TEXCOORD_0")return{filter:z.NONE};if(r.startsWith("JOINTS_"))return{filter:z.NONE};if(r.startsWith("WEIGHTS_"))return{filter:z.NONE};if(r==="NORMAL"||r==="TANGENT")return o?{filter:z.NONE}:{filter:z.OCTAHEDRAL,bits:8}}if(s==="output"){const a=es(i);return a==="rotation"?{filter:z.QUATERNION,bits:16}:a==="translation"?{filter:z.EXPONENTIAL,bits:12}:a==="scale"?{filter:z.EXPONENTIAL,bits:12}:{filter:z.NONE}}if(s==="input")return{filter:z.NONE};if(s==="inverseBindMatrices")return{filter:z.NONE}}return{filter:z.NONE}}function es(i){for(const e of i.listParents())if(e instanceof Pe){for(const t of e.listParents())if(t instanceof yt)return t.getTargetPath()}return null}const ts={method:Qe.QUANTIZE};class ss extends k{constructor(...e){super(...e),this.extensionName=K,this.prereadTypes=[p.BUFFER,p.PRIMITIVE],this.prewriteTypes=[p.BUFFER,p.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=ts,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return e==="meshopt.decoder"&&(this._decoder=t),e==="meshopt.encoder"&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=Se({},ts,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${K}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${K}]: Missing WASM support.`)}return t===p.BUFFER?this._prereadBuffers(e):t===p.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[K])return;const o=s.extensions[K],a=o.byteOffset||0,c=o.byteLength||0,u=o.count,h=o.byteStride,g=new Uint8Array(u*h),m=t.json.buffers[o.buffer],x=m.uri?t.resources[m.uri]:t.resources[Le],S=D.toView(x,a,c);this._decoder.decodeGltfBuffer(g,u,h,S,o.mode,o.filter),e.bufferViews[r]=g})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(s=>{if(!s.extensions||!s.extensions[K])return;const r=s.extensions[K],o=e.buffers[r.buffer],a=e.buffers[s.buffer],c=t.json.buffers[s.buffer];Un(c)&&this._decoderFallbackBufferMap.set(a,o)})}read(e){if(!this.isRequired())return this;for(const[t,n]of this._decoderFallbackBufferMap){for(const s of t.listParents())s instanceof N&&s.swap(t,n);t.dispose()}return this}prewrite(e,t){return t===p.ACCESSOR?this._prewriteAccessors(e):t===p.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,n=this._encoder,s=this._encoderOptions,r=this.document.getGraph(),o=this.document.createBuffer(),a=this.document.getRoot().listBuffers().indexOf(o);let c=1;const u=new Map,h=g=>{for(const m of r.listParents(g)){if(m.propertyType===p.ROOT)continue;let x=u.get(g);return x===void 0&&u.set(g,x=c++),x}return-1};this._encoderFallbackBuffer=o,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const g of this.document.getRoot().listAccessors()){if(es(g)==="weights"||g.getSparse())continue;const m=e.getAccessorUsage(g),x=e.accessorUsageGroupedByParent.has(m)?h(g):null,S=Gn(g,m),M=s.method===Qe.FILTER?Hn(g,this.document):{filter:z.NONE},_=jn(g,n,S,M),{array:l,byteStride:b}=_,T=g.getBuffer();if(!T)throw new Error(`${K}: Missing buffer for accessor.`);const R=this.document.getRoot().listBuffers().indexOf(T),E=[m,x,S,M.filter,b,R].join(":");let I=this._encoderBufferViews[E],f=this._encoderBufferViewData[E],d=this._encoderBufferViewAccessors[E];(!I||!f)&&(d=this._encoderBufferViewAccessors[E]=[],f=this._encoderBufferViewData[E]=[],I=this._encoderBufferViews[E]={buffer:a,target:fe.USAGE_TO_TARGET[m],byteOffset:0,byteLength:0,byteStride:m===fe.BufferViewUsage.ARRAY_BUFFER?b:void 0,extensions:{[K]:{buffer:R,byteOffset:0,byteLength:0,mode:S,filter:M.filter!==z.NONE?M.filter:void 0,byteStride:b,count:0}}});const y=e.createAccessorDef(g);y.componentType=_.componentType,y.normalized=_.normalized,y.byteOffset=I.byteLength,y.min&&_.min&&(y.min=_.min),y.max&&_.max&&(y.max=_.max),e.accessorIndexMap.set(g,t.accessors.length),t.accessors.push(y),d.push(y),f.push(new Uint8Array(l.buffer,l.byteOffset,l.byteLength)),I.byteLength+=l.byteLength,I.extensions.EXT_meshopt_compression.count+=g.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const n in this._encoderBufferViews){const s=this._encoderBufferViews[n],r=this._encoderBufferViewData[n],o=this.document.getRoot().listBuffers()[s.extensions[K].buffer],a=e.otherBufferViews.get(o)||[],{count:c,byteStride:u,mode:h}=s.extensions[K],g=D.concat(r),m=t.encodeGltfBuffer(g,c,u,h),x=D.pad(m);s.extensions[K].byteLength=m.byteLength,r.length=0,r.push(x),a.push(x),e.otherBufferViews.set(o,a)}}write(e){let t=0;for(const o in this._encoderBufferViews){const a=this._encoderBufferViews[o],c=this._encoderBufferViewData[o][0],u=e.otherBufferViewsIndexMap.get(c),h=this._encoderBufferViewAccessors[o];for(const S of h)S.bufferView=u;const g=e.jsonDoc.json.bufferViews[u],m=g.byteOffset||0;Object.assign(g,a),g.byteOffset=t;const x=g.extensions[K];x.byteOffset=m,t+=D.padNumber(a.byteLength)}const n=this._encoderFallbackBuffer,s=e.bufferIndexMap.get(n),r=e.jsonDoc.json.buffers[s];return r.byteLength=t,r.extensions={[K]:{fallback:!0}},n.dispose(),this}}ss.EXTENSION_NAME=K,ss.EncoderMethod=Qe;class zn{match(e){return e.length>=12&&D.decodeText(e.slice(4,12))==="ftypavif"}getSize(e){if(!this.match(e))return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=ns(t,0);if(!n)return null;let s=n.end;for(;n=ns(t,s);)if(n.type==="meta")s=n.start+4;else if(n.type==="iprp"||n.type==="ipco")s=n.start;else{if(n.type==="ispe")return[t.getUint32(n.start+4),t.getUint32(n.start+8)];if(n.type==="mdat")break;s=n.end}return null}getChannels(e){return 4}}class Xn extends k{constructor(...e){super(...e),this.extensionName=We,this.prereadTypes=[p.TEXTURE]}static register(){ue.registerFormat("image/avif",new zn)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(n=>{n.extensions&&n.extensions[We]&&(n.source=n.extensions[We].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(n=>{if(n.getMimeType()==="image/avif"){const s=e.imageIndexMap.get(n);(t.json.textures||[]).forEach(o=>{o.source===s&&(o.extensions=o.extensions||{},o.extensions[We]={source:o.source},delete o.source)})}}),this}}Xn.EXTENSION_NAME=We;function ns(i,e){if(i.byteLength<4+e)return null;const t=i.getUint32(e);return i.byteLength<t+e||t<8?null:{type:D.decodeText(new Uint8Array(i.buffer,i.byteOffset+e+4,4)),start:e+8,end:e+t}}class Kn{match(e){return e.length>=12&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80}getSize(e){const t=D.decodeText(e.slice(0,4)),n=D.decodeText(e.slice(8,12));if(t!=="RIFF"||n!=="WEBP")return null;const s=new DataView(e.buffer,e.byteOffset);let r=12;for(;r<s.byteLength;){const o=D.decodeText(new Uint8Array([s.getUint8(r),s.getUint8(r+1),s.getUint8(r+2),s.getUint8(r+3)])),a=s.getUint32(r+4,!0);if(o==="VP8 "){const c=s.getInt16(r+14,!0)&16383,u=s.getInt16(r+16,!0)&16383;return[c,u]}else if(o==="VP8L"){const c=s.getUint8(r+9),u=s.getUint8(r+10),h=s.getUint8(r+11),g=s.getUint8(r+12),m=1+((u&63)<<8|c),x=1+((g&15)<<10|h<<2|(u&192)>>6);return[m,x]}r+=8+a+a%2}return null}getChannels(e){return 4}}class $n extends k{constructor(...e){super(...e),this.extensionName=Ye,this.prereadTypes=[p.TEXTURE]}static register(){ue.registerFormat("image/webp",new Kn)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(n=>{n.extensions&&n.extensions[Ye]&&(n.source=n.extensions[Ye].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(n=>{if(n.getMimeType()==="image/webp"){const s=e.imageIndexMap.get(n);(t.json.textures||[]).forEach(o=>{o.source===s&&(o.extensions=o.extensions||{},o.extensions[Ye]={source:o.source},delete o.source)})}}),this}}$n.EXTENSION_NAME=Ye;let X,rs,is;function qn(i,e){const t=new X.DecoderBuffer;try{if(t.Init(e,e.length),i.GetEncodedGeometryType(t)!==X.TRIANGULAR_MESH)throw new Error(`[${G}] Unknown geometry type.`);const s=new X.Mesh;if(!i.DecodeBufferToMesh(t,s).ok()||s.ptr===0)throw new Error(`[${G}] Decoding failure.`);return s}finally{X.destroy(t)}}function Yn(i,e){const n=e.num_faces()*3;let s,r;if(e.num_points()<=65534){const o=n*Uint16Array.BYTES_PER_ELEMENT;s=X._malloc(o),i.GetTrianglesUInt16Array(e,o,s),r=new Uint16Array(X.HEAPU16.buffer,s,n).slice()}else{const o=n*Uint32Array.BYTES_PER_ELEMENT;s=X._malloc(o),i.GetTrianglesUInt32Array(e,o,s),r=new Uint32Array(X.HEAPU32.buffer,s,n).slice()}return X._free(s),r}function Wn(i,e,t,n){const s=is[n.componentType],r=rs[n.componentType],o=t.num_components(),c=e.num_points()*o,u=c*r.BYTES_PER_ELEMENT,h=X._malloc(u);i.GetAttributeDataArrayForAllPoints(e,t,s,u,h);const g=new r(X.HEAPF32.buffer,h,c).slice();return X._free(h),g}function Jn(i){X=i,rs={[N.ComponentType.FLOAT]:Float32Array,[N.ComponentType.UNSIGNED_INT]:Uint32Array,[N.ComponentType.UNSIGNED_SHORT]:Uint16Array,[N.ComponentType.UNSIGNED_BYTE]:Uint8Array,[N.ComponentType.SHORT]:Int16Array,[N.ComponentType.BYTE]:Int8Array},is={[N.ComponentType.FLOAT]:X.DT_FLOAT32,[N.ComponentType.UNSIGNED_INT]:X.DT_UINT32,[N.ComponentType.UNSIGNED_SHORT]:X.DT_UINT16,[N.ComponentType.UNSIGNED_BYTE]:X.DT_UINT8,[N.ComponentType.SHORT]:X.DT_INT16,[N.ComponentType.BYTE]:X.DT_INT8}}let oe;var Ze;(function(i){i[i.EDGEBREAKER=1]="EDGEBREAKER",i[i.SEQUENTIAL=0]="SEQUENTIAL"})(Ze||(Ze={}));var ae;(function(i){i.POSITION="POSITION",i.NORMAL="NORMAL",i.COLOR="COLOR",i.TEX_COORD="TEX_COORD",i.GENERIC="GENERIC"})(ae||(ae={}));const os={[ae.POSITION]:14,[ae.NORMAL]:10,[ae.COLOR]:8,[ae.TEX_COORD]:12,[ae.GENERIC]:12},as={decodeSpeed:5,encodeSpeed:5,method:Ze.EDGEBREAKER,quantizationBits:os,quantizationVolume:"mesh"};function Qn(i){oe=i}function Zn(i,e=as){const t=Se({},as,e);t.quantizationBits=Se({},os,e.quantizationBits);const n=new oe.MeshBuilder,s=new oe.Mesh,r=new oe.ExpertEncoder(s),o={},a=new oe.DracoInt8Array,c=i.listTargets().length>0;let u=!1;for(const M of i.listSemantics()){const _=i.getAttribute(M);if(_.getSparse()){u=!0;continue}const l=er(M),b=tr(n,_.getComponentType(),s,oe[l],_.getCount(),_.getElementSize(),_.getArray());if(b===-1)throw new Error(`Error compressing "${M}" attribute.`);if(o[M]=b,t.quantizationVolume==="mesh"||M!=="POSITION")r.SetAttributeQuantization(b,t.quantizationBits[l]);else if(typeof t.quantizationVolume=="object"){const{quantizationVolume:T}=t,R=Math.max(T.max[0]-T.min[0],T.max[1]-T.min[1],T.max[2]-T.min[2]);r.SetAttributeExplicitQuantization(b,t.quantizationBits[l],_.getElementSize(),T.min,R)}else throw new Error("Invalid quantization volume state.")}const h=i.getIndices();if(!h)throw new Nt("Primitive must have indices.");n.AddFacesToMesh(s,h.getCount()/3,h.getArray()),r.SetSpeedOptions(t.encodeSpeed,t.decodeSpeed),r.SetTrackEncodedProperties(!0),t.method===Ze.SEQUENTIAL||c||u?r.SetEncodingMethod(oe.MESH_SEQUENTIAL_ENCODING):r.SetEncodingMethod(oe.MESH_EDGEBREAKER_ENCODING);const g=r.EncodeToDracoBuffer(!(c||u),a);if(g<=0)throw new Nt("Error applying Draco compression.");const m=new Uint8Array(g);for(let M=0;M<g;++M)m[M]=a.GetValue(M);const x=r.GetNumberOfEncodedPoints(),S=r.GetNumberOfEncodedFaces()*3;return oe.destroy(a),oe.destroy(s),oe.destroy(n),oe.destroy(r),{numVertices:x,numIndices:S,data:m,attributeIDs:o}}function er(i){return i==="POSITION"?ae.POSITION:i==="NORMAL"?ae.NORMAL:i.startsWith("COLOR_")?ae.COLOR:i.startsWith("TEXCOORD_")?ae.TEX_COORD:ae.GENERIC}function tr(i,e,t,n,s,r,o){switch(e){case N.ComponentType.UNSIGNED_BYTE:return i.AddUInt8Attribute(t,n,s,r,o);case N.ComponentType.BYTE:return i.AddInt8Attribute(t,n,s,r,o);case N.ComponentType.UNSIGNED_SHORT:return i.AddUInt16Attribute(t,n,s,r,o);case N.ComponentType.SHORT:return i.AddInt16Attribute(t,n,s,r,o);case N.ComponentType.UNSIGNED_INT:return i.AddUInt32Attribute(t,n,s,r,o);case N.ComponentType.FLOAT:return i.AddFloatAttribute(t,n,s,r,o);default:throw new Error(`Unexpected component type, "${e}".`)}}class Nt extends Error{}class cs extends k{constructor(...e){super(...e),this.extensionName=G,this.prereadTypes=[p.PRIMITIVE],this.prewriteTypes=[p.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return e==="draco3d.decoder"&&(this._decoderModule=t,Jn(this._decoderModule)),e==="draco3d.encoder"&&(this._encoderModule=t,Qn(this._encoderModule)),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${G}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),n=e.jsonDoc,s=new Map;try{const r=n.json.meshes||[];for(const o of r)for(const a of o.primitives){if(!a.extensions||!a.extensions[G])continue;const c=a.extensions[G];let[u,h]=s.get(c.bufferView)||[];if(!h||!u){const g=n.json.bufferViews[c.bufferView],m=n.json.buffers[g.buffer],x=m.uri?n.resources[m.uri]:n.resources[Le],S=g.byteOffset||0,M=g.byteLength,_=D.toView(x,S,M);u=new this._decoderModule.Decoder,h=qn(u,_),s.set(c.bufferView,[u,h]),t.debug(`[${G}] Decompressed ${_.byteLength} bytes.`)}for(const g in c.attributes){const m=e.jsonDoc.json.accessors[a.attributes[g]],x=u.GetAttributeByUniqueId(h,c.attributes[g]),S=Wn(u,h,x,m);e.accessors[a.attributes[g]].setArray(S)}a.indices!==void 0&&e.accessors[a.indices].setArray(Yn(u,h))}}finally{for(const[r,o]of Array.from(s.values()))this._decoderModule.destroy(r),this._decoderModule.destroy(o)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${G}] Please install extension dependency, "draco3d.encoder".`);const n=this.document.getLogger();n.debug(`[${G}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const s=sr(this.document),r=new Map;let o="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?n.warn(`[${G}]: quantizationVolume=scene requires exactly 1 scene.`):o=ks(this.document.getRoot().listScenes().pop()));for(const a of Array.from(s.keys())){const c=s.get(a);if(!c)throw new Error("Unexpected primitive.");if(r.has(c)){r.set(c,r.get(c));continue}const u=a.getIndices(),h=e.jsonDoc.json.accessors;let g;try{g=Zn(a,Se({},this._encoderOptions,{quantizationVolume:o}))}catch(S){if(S instanceof Nt){n.warn(`[${G}]: ${S.message} Skipping primitive compression.`);continue}throw S}r.set(c,g);const m=e.createAccessorDef(u);m.count=g.numIndices,e.accessorIndexMap.set(u,h.length),h.push(m),g.numVertices>65534&&N.getComponentSize(m.componentType)<=2?m.componentType=N.ComponentType.UNSIGNED_INT:g.numVertices>254&&N.getComponentSize(m.componentType)<=1&&(m.componentType=N.ComponentType.UNSIGNED_SHORT);for(const S of a.listSemantics()){const M=a.getAttribute(S);if(g.attributeIDs[S]===void 0)continue;const _=e.createAccessorDef(M);_.count=g.numVertices,e.accessorIndexMap.set(M,h.length),h.push(_)}const x=a.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(x)||e.otherBufferViews.set(x,[]),e.otherBufferViews.get(x).push(g.data)}return n.debug(`[${G}] Compressed ${s.size} primitives.`),e.extensionData[G]={primitiveHashMap:s,primitiveEncodingMap:r},this}write(e){const t=e.extensionData[G];for(const n of this.document.getRoot().listMeshes()){const s=e.jsonDoc.json.meshes[e.meshIndexMap.get(n)];for(let r=0;r<n.listPrimitives().length;r++){const o=n.listPrimitives()[r],a=s.primitives[r],c=t.primitiveHashMap.get(o);if(!c)continue;const u=t.primitiveEncodingMap.get(c);u&&(a.extensions=a.extensions||{},a.extensions[G]={bufferView:e.otherBufferViewsIndexMap.get(u.data),attributes:u.attributeIDs})}}if(!t.primitiveHashMap.size){const n=e.jsonDoc.json;n.extensionsUsed=(n.extensionsUsed||[]).filter(s=>s!==G),n.extensionsRequired=(n.extensionsRequired||[]).filter(s=>s!==G)}return this}}cs.EXTENSION_NAME=G,cs.EncoderMethod=Ze;function sr(i){const e=i.getLogger(),t=new Set,n=new Set;let s=0,r=0;for(const g of i.getRoot().listMeshes())for(const m of g.listPrimitives())m.getIndices()?m.getMode()!==Ue.Mode.TRIANGLES?(n.add(m),r++):t.add(m):(n.add(m),s++);s>0&&e.warn(`[${G}] Skipping Draco compression of ${s} non-indexed primitives.`),r>0&&e.warn(`[${G}] Skipping Draco compression of ${r} non-TRIANGLES primitives.`);const o=i.getRoot().listAccessors(),a=new Map;for(let g=0;g<o.length;g++)a.set(o[g],g);const c=new Map,u=new Set,h=new Map;for(const g of Array.from(t)){let m=us(g,a);if(u.has(m)){h.set(g,m);continue}if(c.has(g.getIndices())){const x=g.getIndices(),S=x.clone();a.set(S,i.getRoot().listAccessors().length-1),g.swap(x,S)}for(const x of g.listAttributes())if(c.has(x)){const S=x.clone();a.set(S,i.getRoot().listAccessors().length-1),g.swap(x,S)}m=us(g,a),u.add(m),h.set(g,m),c.set(g.getIndices(),m);for(const x of g.listAttributes())c.set(x,m)}for(const g of Array.from(c.keys())){const m=new Set(g.listParents().map(x=>x.propertyType));if(m.size!==2||!m.has(p.PRIMITIVE)||!m.has(p.ROOT))throw new Error(`[${G}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const g of Array.from(t)){const m=h.get(g),x=g.getIndices();if(c.get(x)!==m||g.listAttributes().some(S=>c.get(S)!==m))throw new Error(`[${G}] Draco primitives must share all, or no, accessors.`)}for(const g of Array.from(n)){const m=g.getIndices();if(c.has(m)||g.listAttributes().some(x=>c.has(x)))throw new Error(`[${G}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return h}function us(i,e){const t=[],n=i.getIndices();t.push(e.get(n));for(const s of i.listAttributes())t.push(e.get(s));return t.sort().join("|")}class ke extends H{init(){this.extensionName=re,this.propertyType="Light",this.parentTypes=[p.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:ke.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}ke.EXTENSION_NAME=re,ke.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};class nr extends k{constructor(...e){super(...e),this.extensionName=re}createLight(e=""){return new ke(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[re])return this;const r=(t.json.extensions[re].lights||[]).map(o=>{var a,c;const u=this.createLight().setName(o.name||"").setType(o.type);return o.color!==void 0&&u.setColor(o.color),o.intensity!==void 0&&u.setIntensity(o.intensity),o.range!==void 0&&u.setRange(o.range),((a=o.spot)==null?void 0:a.innerConeAngle)!==void 0&&u.setInnerConeAngle(o.spot.innerConeAngle),((c=o.spot)==null?void 0:c.outerConeAngle)!==void 0&&u.setOuterConeAngle(o.spot.outerConeAngle),u});return t.json.nodes.forEach((o,a)=>{if(!o.extensions||!o.extensions[re])return;const c=o.extensions[re];e.nodes[a].setExtension(re,r[c.light])}),this}write(e){const t=e.jsonDoc;if(this.properties.size===0)return this;const n=[],s=new Map;for(const r of this.properties){const o=r,a={type:o.getType()};L.eq(o.getColor(),[1,1,1])||(a.color=o.getColor()),o.getIntensity()!==1&&(a.intensity=o.getIntensity()),o.getRange()!=null&&(a.range=o.getRange()),o.getName()&&(a.name=o.getName()),o.getType()===ke.Type.SPOT&&(a.spot={innerConeAngle:o.getInnerConeAngle(),outerConeAngle:o.getOuterConeAngle()}),n.push(a),s.set(o,n.length-1)}return this.document.getRoot().listNodes().forEach(r=>{const o=r.getExtension(re);if(o){const a=e.nodeIndexMap.get(r),c=t.json.nodes[a];c.extensions=c.extensions||{},c.extensions[re]={light:s.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[re]={lights:n},this}}nr.EXTENSION_NAME=re;const{R:rr,G:ir,B:or}=se;class fs extends H{init(){this.extensionName=he,this.propertyType="Anisotropy",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new j(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(e){return this.set("anisotropyStrength",e)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(e){return this.set("anisotropyRotation",e)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(e){return this.setRef("anisotropyTexture",e,{channels:rr|ir|or})}}fs.EXTENSION_NAME=he;class ar extends k{constructor(...e){super(...e),this.extensionName=he,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createAnisotropy(){return new fs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[he]){const a=this.createAnisotropy();e.materials[o].setExtension(he,a);const c=r.extensions[he];if(c.anisotropyStrength!==void 0&&a.setAnisotropyStrength(c.anisotropyStrength),c.anisotropyRotation!==void 0&&a.setAnisotropyRotation(c.anisotropyRotation),c.anisotropyTexture!==void 0){const u=c.anisotropyTexture,h=e.textures[s[u.index].source];a.setAnisotropyTexture(h),e.setTextureInfo(a.getAnisotropyTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(he);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[he]={};if(s.getAnisotropyStrength()>0&&(a.anisotropyStrength=s.getAnisotropyStrength()),s.getAnisotropyRotation()!==0&&(a.anisotropyRotation=s.getAnisotropyRotation()),s.getAnisotropyTexture()){const c=s.getAnisotropyTexture(),u=s.getAnisotropyTextureInfo();a.anisotropyTexture=e.createTextureInfoDef(c,u)}}}),this}}ar.EXTENSION_NAME=he;const{R:ls,G:hs,B:cr}=se;class gs extends H{init(){this.extensionName=ge,this.propertyType="Clearcoat",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new j(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new j(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new j(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:ls})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:hs})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:ls|hs|cr})}}gs.EXTENSION_NAME=ge;class ur extends k{constructor(...e){super(...e),this.extensionName=ge,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createClearcoat(){return new gs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[ge]){const a=this.createClearcoat();e.materials[o].setExtension(ge,a);const c=r.extensions[ge];if(c.clearcoatFactor!==void 0&&a.setClearcoatFactor(c.clearcoatFactor),c.clearcoatRoughnessFactor!==void 0&&a.setClearcoatRoughnessFactor(c.clearcoatRoughnessFactor),c.clearcoatTexture!==void 0){const u=c.clearcoatTexture,h=e.textures[s[u.index].source];a.setClearcoatTexture(h),e.setTextureInfo(a.getClearcoatTextureInfo(),u)}if(c.clearcoatRoughnessTexture!==void 0){const u=c.clearcoatRoughnessTexture,h=e.textures[s[u.index].source];a.setClearcoatRoughnessTexture(h),e.setTextureInfo(a.getClearcoatRoughnessTextureInfo(),u)}if(c.clearcoatNormalTexture!==void 0){const u=c.clearcoatNormalTexture,h=e.textures[s[u.index].source];a.setClearcoatNormalTexture(h),e.setTextureInfo(a.getClearcoatNormalTextureInfo(),u),u.scale!==void 0&&a.setClearcoatNormalScale(u.scale)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(ge);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[ge]={clearcoatFactor:s.getClearcoatFactor(),clearcoatRoughnessFactor:s.getClearcoatRoughnessFactor()};if(s.getClearcoatTexture()){const c=s.getClearcoatTexture(),u=s.getClearcoatTextureInfo();a.clearcoatTexture=e.createTextureInfoDef(c,u)}if(s.getClearcoatRoughnessTexture()){const c=s.getClearcoatRoughnessTexture(),u=s.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=e.createTextureInfoDef(c,u)}if(s.getClearcoatNormalTexture()){const c=s.getClearcoatNormalTexture(),u=s.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=e.createTextureInfoDef(c,u),s.getClearcoatNormalScale()!==1&&(a.clearcoatNormalTexture.scale=s.getClearcoatNormalScale())}}}),this}}ur.EXTENSION_NAME=ge;const{R:fr,G:lr,B:hr,A:gr}=se;class ps extends H{init(){this.extensionName=pe,this.propertyType="DiffuseTransmission",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseTransmissionFactor:0,diffuseTransmissionTexture:null,diffuseTransmissionTextureInfo:new j(this.graph,"diffuseTransmissionTextureInfo"),diffuseTransmissionColorFactor:[1,1,1],diffuseTransmissionColorTexture:null,diffuseTransmissionColorTextureInfo:new j(this.graph,"diffuseTransmissionColorTextureInfo")})}getDiffuseTransmissionFactor(){return this.get("diffuseTransmissionFactor")}setDiffuseTransmissionFactor(e){return this.set("diffuseTransmissionFactor",e)}getDiffuseTransmissionTexture(){return this.getRef("diffuseTransmissionTexture")}getDiffuseTransmissionTextureInfo(){return this.getRef("diffuseTransmissionTexture")?this.getRef("diffuseTransmissionTextureInfo"):null}setDiffuseTransmissionTexture(e){return this.setRef("diffuseTransmissionTexture",e,{channels:gr})}getDiffuseTransmissionColorFactor(){return this.get("diffuseTransmissionColorFactor")}setDiffuseTransmissionColorFactor(e){return this.set("diffuseTransmissionColorFactor",e)}getDiffuseTransmissionColorTexture(){return this.getRef("diffuseTransmissionColorTexture")}getDiffuseTransmissionColorTextureInfo(){return this.getRef("diffuseTransmissionColorTexture")?this.getRef("diffuseTransmissionColorTextureInfo"):null}setDiffuseTransmissionColorTexture(e){return this.setRef("diffuseTransmissionColorTexture",e,{channels:fr|lr|hr})}}ps.EXTENSION_NAME=pe;class pr extends k{constructor(...e){super(...e),this.extensionName=pe}createDiffuseTransmission(){return new ps(this.document.getGraph())}read(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[pe]){const a=this.createDiffuseTransmission();e.materials[o].setExtension(pe,a);const c=r.extensions[pe];if(c.diffuseTransmissionFactor!==void 0&&a.setDiffuseTransmissionFactor(c.diffuseTransmissionFactor),c.diffuseTransmissionColorFactor!==void 0&&a.setDiffuseTransmissionColorFactor(c.diffuseTransmissionColorFactor),c.diffuseTransmissionTexture!==void 0){const u=c.diffuseTransmissionTexture,h=e.textures[s[u.index].source];a.setDiffuseTransmissionTexture(h),e.setTextureInfo(a.getDiffuseTransmissionTextureInfo(),u)}if(c.diffuseTransmissionColorTexture!==void 0){const u=c.diffuseTransmissionColorTexture,h=e.textures[s[u.index].source];a.setDiffuseTransmissionColorTexture(h),e.setTextureInfo(a.getDiffuseTransmissionColorTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;for(const n of this.document.getRoot().listMaterials()){const s=n.getExtension(pe);if(!s)continue;const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[pe]={diffuseTransmissionFactor:s.getDiffuseTransmissionFactor(),diffuseTransmissionColorFactor:s.getDiffuseTransmissionColorFactor()};if(s.getDiffuseTransmissionTexture()){const c=s.getDiffuseTransmissionTexture(),u=s.getDiffuseTransmissionTextureInfo();a.diffuseTransmissionTexture=e.createTextureInfoDef(c,u)}if(s.getDiffuseTransmissionColorTexture()){const c=s.getDiffuseTransmissionColorTexture(),u=s.getDiffuseTransmissionColorTextureInfo();a.diffuseTransmissionColorTexture=e.createTextureInfoDef(c,u)}}return this}}pr.EXTENSION_NAME=pe;class ds extends H{init(){this.extensionName=de,this.propertyType="Dispersion",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{dispersion:0})}getDispersion(){return this.get("dispersion")}setDispersion(e){return this.set("dispersion",e)}}ds.EXTENSION_NAME=de;class dr extends k{constructor(...e){super(...e),this.extensionName=de,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createDispersion(){return new ds(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{if(s.extensions&&s.extensions[de]){const o=this.createDispersion();e.materials[r].setExtension(de,o);const a=s.extensions[de];a.dispersion!==void 0&&o.setDispersion(a.dispersion)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(de);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[de]={dispersion:s.getDispersion()}}}),this}}dr.EXTENSION_NAME=de;class Ts extends H{init(){this.extensionName=Te,this.propertyType="EmissiveStrength",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}}Ts.EXTENSION_NAME=Te;class Tr extends k{constructor(...e){super(...e),this.extensionName=Te,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createEmissiveStrength(){return new Ts(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{if(s.extensions&&s.extensions[Te]){const o=this.createEmissiveStrength();e.materials[r].setExtension(Te,o);const a=s.extensions[Te];a.emissiveStrength!==void 0&&o.setEmissiveStrength(a.emissiveStrength)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Te);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[Te]={emissiveStrength:s.getEmissiveStrength()}}}),this}}Tr.EXTENSION_NAME=Te;class ms extends H{init(){this.extensionName=me,this.propertyType="IOR",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}ms.EXTENSION_NAME=me;class mr extends k{constructor(...e){super(...e),this.extensionName=me,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createIOR(){return new ms(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{if(s.extensions&&s.extensions[me]){const o=this.createIOR();e.materials[r].setExtension(me,o);const a=s.extensions[me];a.ior!==void 0&&o.setIOR(a.ior)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(me);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[me]={ior:s.getIOR()}}}),this}}mr.EXTENSION_NAME=me;const{R:xr,G:Er}=se;class xs extends H{init(){this.extensionName=xe,this.propertyType="Iridescence",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new j(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new j(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:xr})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:Er})}}xs.EXTENSION_NAME=xe;class yr extends k{constructor(...e){super(...e),this.extensionName=xe,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createIridescence(){return new xs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[xe]){const a=this.createIridescence();e.materials[o].setExtension(xe,a);const c=r.extensions[xe];if(c.iridescenceFactor!==void 0&&a.setIridescenceFactor(c.iridescenceFactor),c.iridescenceIor!==void 0&&a.setIridescenceIOR(c.iridescenceIor),c.iridescenceThicknessMinimum!==void 0&&a.setIridescenceThicknessMinimum(c.iridescenceThicknessMinimum),c.iridescenceThicknessMaximum!==void 0&&a.setIridescenceThicknessMaximum(c.iridescenceThicknessMaximum),c.iridescenceTexture!==void 0){const u=c.iridescenceTexture,h=e.textures[s[u.index].source];a.setIridescenceTexture(h),e.setTextureInfo(a.getIridescenceTextureInfo(),u)}if(c.iridescenceThicknessTexture!==void 0){const u=c.iridescenceThicknessTexture,h=e.textures[s[u.index].source];a.setIridescenceThicknessTexture(h),e.setTextureInfo(a.getIridescenceThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(xe);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[xe]={};if(s.getIridescenceFactor()>0&&(a.iridescenceFactor=s.getIridescenceFactor()),s.getIridescenceIOR()!==1.3&&(a.iridescenceIor=s.getIridescenceIOR()),s.getIridescenceThicknessMinimum()!==100&&(a.iridescenceThicknessMinimum=s.getIridescenceThicknessMinimum()),s.getIridescenceThicknessMaximum()!==400&&(a.iridescenceThicknessMaximum=s.getIridescenceThicknessMaximum()),s.getIridescenceTexture()){const c=s.getIridescenceTexture(),u=s.getIridescenceTextureInfo();a.iridescenceTexture=e.createTextureInfoDef(c,u)}if(s.getIridescenceThicknessTexture()){const c=s.getIridescenceThicknessTexture(),u=s.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}yr.EXTENSION_NAME=xe;const{R:Es,G:ys,B:Rs,A:Is}=se;class As extends H{init(){this.extensionName=Ee,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new j(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new j(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:Es|ys|Rs|Is,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:Es|ys|Rs|Is})}}As.EXTENSION_NAME=Ee;class Rr extends k{constructor(...e){super(...e),this.extensionName=Ee,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createPBRSpecularGlossiness(){return new As(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Ee]){const a=this.createPBRSpecularGlossiness();e.materials[o].setExtension(Ee,a);const c=r.extensions[Ee];if(c.diffuseFactor!==void 0&&a.setDiffuseFactor(c.diffuseFactor),c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.glossinessFactor!==void 0&&a.setGlossinessFactor(c.glossinessFactor),c.diffuseTexture!==void 0){const u=c.diffuseTexture,h=e.textures[s[u.index].source];a.setDiffuseTexture(h),e.setTextureInfo(a.getDiffuseTextureInfo(),u)}if(c.specularGlossinessTexture!==void 0){const u=c.specularGlossinessTexture,h=e.textures[s[u.index].source];a.setSpecularGlossinessTexture(h),e.setTextureInfo(a.getSpecularGlossinessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ee);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Ee]={diffuseFactor:s.getDiffuseFactor(),specularFactor:s.getSpecularFactor(),glossinessFactor:s.getGlossinessFactor()};if(s.getDiffuseTexture()){const c=s.getDiffuseTexture(),u=s.getDiffuseTextureInfo();a.diffuseTexture=e.createTextureInfoDef(c,u)}if(s.getSpecularGlossinessTexture()){const c=s.getSpecularGlossinessTexture(),u=s.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=e.createTextureInfoDef(c,u)}}}),this}}Rr.EXTENSION_NAME=Ee;const{R:Ir,G:Ar,B:Nr,A:Sr}=se;class Ns extends H{init(){this.extensionName=ye,this.propertyType="Sheen",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new j(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new j(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:Ir|Ar|Nr,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:Sr})}}Ns.EXTENSION_NAME=ye;class _r extends k{constructor(...e){super(...e),this.extensionName=ye,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createSheen(){return new Ns(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[ye]){const a=this.createSheen();e.materials[o].setExtension(ye,a);const c=r.extensions[ye];if(c.sheenColorFactor!==void 0&&a.setSheenColorFactor(c.sheenColorFactor),c.sheenRoughnessFactor!==void 0&&a.setSheenRoughnessFactor(c.sheenRoughnessFactor),c.sheenColorTexture!==void 0){const u=c.sheenColorTexture,h=e.textures[s[u.index].source];a.setSheenColorTexture(h),e.setTextureInfo(a.getSheenColorTextureInfo(),u)}if(c.sheenRoughnessTexture!==void 0){const u=c.sheenRoughnessTexture,h=e.textures[s[u.index].source];a.setSheenRoughnessTexture(h),e.setTextureInfo(a.getSheenRoughnessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(ye);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[ye]={sheenColorFactor:s.getSheenColorFactor(),sheenRoughnessFactor:s.getSheenRoughnessFactor()};if(s.getSheenColorTexture()){const c=s.getSheenColorTexture(),u=s.getSheenColorTextureInfo();a.sheenColorTexture=e.createTextureInfoDef(c,u)}if(s.getSheenRoughnessTexture()){const c=s.getSheenRoughnessTexture(),u=s.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=e.createTextureInfoDef(c,u)}}}),this}}_r.EXTENSION_NAME=ye;const{R:Mr,G:br,B:wr,A:Cr}=se;class Ss extends H{init(){this.extensionName=Re,this.propertyType="Specular",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new j(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new j(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:Cr})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:Mr|br|wr,isColor:!0})}}Ss.EXTENSION_NAME=Re;class Or extends k{constructor(...e){super(...e),this.extensionName=Re,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createSpecular(){return new Ss(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Re]){const a=this.createSpecular();e.materials[o].setExtension(Re,a);const c=r.extensions[Re];if(c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.specularColorFactor!==void 0&&a.setSpecularColorFactor(c.specularColorFactor),c.specularTexture!==void 0){const u=c.specularTexture,h=e.textures[s[u.index].source];a.setSpecularTexture(h),e.setTextureInfo(a.getSpecularTextureInfo(),u)}if(c.specularColorTexture!==void 0){const u=c.specularColorTexture,h=e.textures[s[u.index].source];a.setSpecularColorTexture(h),e.setTextureInfo(a.getSpecularColorTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Re);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Re]={};if(s.getSpecularFactor()!==1&&(a.specularFactor=s.getSpecularFactor()),L.eq(s.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=s.getSpecularColorFactor()),s.getSpecularTexture()){const c=s.getSpecularTexture(),u=s.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(c,u)}if(s.getSpecularColorTexture()){const c=s.getSpecularColorTexture(),u=s.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(c,u)}}}),this}}Or.EXTENSION_NAME=Re;const{R:Dr}=se;class _s extends H{init(){this.extensionName=Ie,this.propertyType="Transmission",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new j(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:Dr})}}_s.EXTENSION_NAME=Ie;class Fr extends k{constructor(...e){super(...e),this.extensionName=Ie,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createTransmission(){return new _s(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Ie]){const a=this.createTransmission();e.materials[o].setExtension(Ie,a);const c=r.extensions[Ie];if(c.transmissionFactor!==void 0&&a.setTransmissionFactor(c.transmissionFactor),c.transmissionTexture!==void 0){const u=c.transmissionTexture,h=e.textures[s[u.index].source];a.setTransmissionTexture(h),e.setTextureInfo(a.getTransmissionTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ie);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Ie]={transmissionFactor:s.getTransmissionFactor()};if(s.getTransmissionTexture()){const c=s.getTransmissionTexture(),u=s.getTransmissionTextureInfo();a.transmissionTexture=e.createTextureInfoDef(c,u)}}}),this}}Fr.EXTENSION_NAME=Ie;class Ms extends H{init(){this.extensionName=we,this.propertyType="Unlit",this.parentTypes=[p.MATERIAL]}}Ms.EXTENSION_NAME=we;class vr extends k{constructor(...e){super(...e),this.extensionName=we,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createUnlit(){return new Ms(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((n,s)=>{n.extensions&&n.extensions[we]&&e.materials[s].setExtension(we,this.createUnlit())}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{if(n.getExtension(we)){const s=e.materialIndexMap.get(n),r=t.json.materials[s];r.extensions=r.extensions||{},r.extensions[we]={}}}),this}}vr.EXTENSION_NAME=we;class bs extends H{init(){this.extensionName=$,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:new P})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}bs.EXTENSION_NAME=$;class ws extends H{init(){this.extensionName=$,this.propertyType="MappingList",this.parentTypes=[p.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:new P})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}ws.EXTENSION_NAME=$;class St extends H{init(){this.extensionName=$,this.propertyType="Variant",this.parentTypes=["MappingList"]}}St.EXTENSION_NAME=$;class Ur extends k{constructor(...e){super(...e),this.extensionName=$}createMappingList(){return new ws(this.document.getGraph())}createVariant(e=""){return new St(this.document.getGraph(),e)}createMapping(){return new bs(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(e=>e instanceof St)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[$])return this;const r=(t.json.extensions[$].variants||[]).map(a=>this.createVariant().setName(a.name||""));return(t.json.meshes||[]).forEach((a,c)=>{const u=e.meshes[c];(a.primitives||[]).forEach((g,m)=>{if(!g.extensions||!g.extensions[$])return;const x=this.createMappingList(),S=g.extensions[$];for(const M of S.mappings){const _=this.createMapping();M.material!==void 0&&_.setMaterial(e.materials[M.material]);for(const l of M.variants||[])_.addVariant(r[l]);x.addMapping(_)}u.listPrimitives()[m].setExtension($,x)})}),this}write(e){const t=e.jsonDoc,n=this.listVariants();if(!n.length)return this;const s=[],r=new Map;for(const o of n)r.set(o,s.length),s.push(e.createPropertyDef(o));for(const o of this.document.getRoot().listMeshes()){const a=e.meshIndexMap.get(o);o.listPrimitives().forEach((c,u)=>{const h=c.getExtension($);if(!h)return;const g=e.jsonDoc.json.meshes[a].primitives[u],m=h.listMappings().map(x=>{const S=e.createPropertyDef(x),M=x.getMaterial();return M&&(S.material=e.materialIndexMap.get(M)),S.variants=x.listVariants().map(_=>r.get(_)),S});g.extensions=g.extensions||{},g.extensions[$]={mappings:m}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[$]={variants:s},this}}Ur.EXTENSION_NAME=$;const{G:Br}=se;class Cs extends H{init(){this.extensionName=Ae,this.propertyType="Volume",this.parentTypes=[p.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new j(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:Br})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}}Cs.EXTENSION_NAME=Ae;class Lr extends k{constructor(...e){super(...e),this.extensionName=Ae,this.prereadTypes=[p.MESH],this.prewriteTypes=[p.MESH]}createVolume(){return new Cs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Ae]){const a=this.createVolume();e.materials[o].setExtension(Ae,a);const c=r.extensions[Ae];if(c.thicknessFactor!==void 0&&a.setThicknessFactor(c.thicknessFactor),c.attenuationDistance!==void 0&&a.setAttenuationDistance(c.attenuationDistance),c.attenuationColor!==void 0&&a.setAttenuationColor(c.attenuationColor),c.thicknessTexture!==void 0){const u=c.thicknessTexture,h=e.textures[s[u.index].source];a.setThicknessTexture(h),e.setTextureInfo(a.getThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ae);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Ae]={};if(s.getThicknessFactor()>0&&(a.thicknessFactor=s.getThicknessFactor()),Number.isFinite(s.getAttenuationDistance())&&(a.attenuationDistance=s.getAttenuationDistance()),L.eq(s.getAttenuationColor(),[1,1,1])||(a.attenuationColor=s.getAttenuationColor()),s.getThicknessTexture()){const c=s.getThicknessTexture(),u=s.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}Lr.EXTENSION_NAME=Ae;class jr extends k{constructor(...e){super(...e),this.extensionName=Wt}read(e){return this}write(e){return this}}jr.EXTENSION_NAME=Wt;class Pr{match(e){return e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10}getSize(e){const t=Rt(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const n=Rt(e).dataFormatDescriptor[0];if(n.colorModel===_n)return n.samples.length===2&&(n.samples[1].channelType&15)===15?4:3;if(n.colorModel===Mn)return(n.samples[0].channelType&15)===3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${n.colorModel}".`)}getVRAMByteLength(e){const t=Rt(e),n=this.getChannels(e)>3;let s=0;for(let r=0;r<t.levels.length;r++){const o=t.levels[r];if(o.uncompressedByteLength)s+=o.uncompressedByteLength;else{const a=Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,r))),c=Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,r))),u=n?16:8;s+=a/4*(c/4)*u}}return s}}class Vr extends k{constructor(...e){super(...e),this.extensionName=Je,this.prereadTypes=[p.TEXTURE]}static register(){ue.registerFormat("image/ktx2",new Pr)}preread(e){return e.jsonDoc.json.textures.forEach(t=>{if(t.extensions&&t.extensions[Je]){const n=t.extensions[Je];t.source=n.source}}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(n=>{if(n.getMimeType()==="image/ktx2"){const s=e.imageIndexMap.get(n);t.json.textures.forEach(r=>{r.source===s&&(r.extensions=r.extensions||{},r.extensions[Je]={source:r.source},delete r.source)})}}),this}}Vr.EXTENSION_NAME=Je;class Os extends H{init(){this.extensionName=Ne,this.propertyType="Transform",this.parentTypes=[p.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}}Os.EXTENSION_NAME=Ne;class Ds extends k{constructor(...e){super(...e),this.extensionName=Ne}createTransform(){return new Os(this.document.getGraph())}read(e){for(const[t,n]of Array.from(e.textureInfos.entries())){if(!n.extensions||!n.extensions[Ne])continue;const s=this.createTransform(),r=n.extensions[Ne];r.offset!==void 0&&s.setOffset(r.offset),r.rotation!==void 0&&s.setRotation(r.rotation),r.scale!==void 0&&s.setScale(r.scale),r.texCoord!==void 0&&s.setTexCoord(r.texCoord),t.setExtension(Ne,s)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[n,s]of t){const r=n.getExtension(Ne);if(!r)continue;s.extensions=s.extensions||{};const o={},a=L.eq;a(r.getOffset(),[0,0])||(o.offset=r.getOffset()),r.getRotation()!==0&&(o.rotation=r.getRotation()),a(r.getScale(),[1,1])||(o.scale=r.getScale()),r.getTexCoord()!=null&&(o.texCoord=r.getTexCoord()),s.extensions[Ne]=o}return this}}Ds.EXTENSION_NAME=Ne;const kr=[p.ROOT,p.SCENE,p.NODE,p.MESH,p.MATERIAL,p.TEXTURE,p.ANIMATION];class Fs extends H{init(){this.extensionName=ie,this.propertyType="Packet",this.parentTypes=kr}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",Se({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const n=Se({},this.get("properties"));return t?n[e]=t:delete n[e],this.set("properties",n)}toJSONLD(){const e=_t(this.get("context")),t=_t(this.get("properties"));return Se({"@context":e},t)}fromJSONLD(e){e=_t(e);const t=e["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`${ie}: Missing context for term, "${e}".`)}}Fs.EXTENSION_NAME=ie;function _t(i){return JSON.parse(JSON.stringify(i))}class Gr extends k{constructor(...e){super(...e),this.extensionName=ie}createPacket(){return new Fs(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const n=(t=e.jsonDoc.json.extensions)==null?void 0:t[ie];if(!n||!n.packets)return this;const s=e.jsonDoc.json,r=this.document.getRoot(),o=n.packets.map(u=>this.createPacket().fromJSONLD(u)),a=[[s.asset],s.scenes,s.nodes,s.meshes,s.materials,s.images,s.animations],c=[[r],r.listScenes(),r.listNodes(),r.listMeshes(),r.listMaterials(),r.listTextures(),r.listAnimations()];for(let u=0;u<a.length;u++){const h=a[u]||[];for(let g=0;g<h.length;g++){const m=h[g];if(m.extensions&&m.extensions[ie]){const x=m.extensions[ie];c[u][g].setExtension(ie,o[x.packet])}}}return this}write(e){const{json:t}=e.jsonDoc,n=[];for(const s of this.properties){n.push(s.toJSONLD());for(const r of s.listParents()){let o;switch(r.propertyType){case p.ROOT:o=t.asset;break;case p.SCENE:o=t.scenes[e.sceneIndexMap.get(r)];break;case p.NODE:o=t.nodes[e.nodeIndexMap.get(r)];break;case p.MESH:o=t.meshes[e.meshIndexMap.get(r)];break;case p.MATERIAL:o=t.materials[e.materialIndexMap.get(r)];break;case p.TEXTURE:o=t.images[e.imageIndexMap.get(r)];break;case p.ANIMATION:o=t.animations[e.animationIndexMap.get(r)];break;default:o=null,this.document.getLogger().warn(`[${ie}]: Unsupported parent property, "${r.propertyType}"`);break}o&&(o.extensions=o.extensions||{},o.extensions[ie]={packet:n.length-1})}}return n.length>0&&(t.extensions=t.extensions||{},t.extensions[ie]={packets:n}),this}}Gr.EXTENSION_NAME=ie,self.onmessage=async i=>{const{file:e,opts:t={}}=i.data||{};if(!e){vs("No file provided");return}try{const n=new Uint8Array(await e.arrayBuffer()),s=new yn().registerExtensions([Ds]),r=await s.readBinary(n);await Xr(r,t);const o=await s.writeBinary(r),a=zr(o);self.postMessage({glb:a})}catch(n){vs(Hr(n))}};function vs(i){self.postMessage({error:i})}function Hr(i){if(!i)return"Unknown error";if(i instanceof Error){const e=i.constructor?.name||"Error",t=i.stack?` | stack: ${i.stack}`:"";return`[${e}] ${i.message}${t}`}return String(i)}function zr(i){const e=new Uint8Array(i);let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function Xr(i,e){const t=(e.format||"webp").toLowerCase(),n=Number(e.quality??85),s=Number(e.maxSize||4096),r=t==="png"?"image/png":t==="jpeg"||t==="jpg"?"image/jpeg":"image/webp",o=i.getRoot().listTextures();for(const a of o){const c=a.getImage();if(!c)continue;const u=await Kr(c,s,r,n);a.setImage(u),a.setMimeType(r)}}async function Kr(i,e,t,n){const s=i instanceof Blob?i:new Blob([i]),r=await createImageBitmap(s);let{width:o,height:a}=r;const c=Math.min(1,e/Math.max(o,a)),u=Math.max(1,Math.floor(o*c)),h=Math.max(1,Math.floor(a*c)),g=new OffscreenCanvas(u,h),m=g.getContext("2d");m.clearRect(0,0,u,h),m.drawImage(r,0,0,u,h);const x=t==="image/jpeg"||t==="image/webp",S=await g.convertToBlob({type:t,quality:x?$r(n/100):void 0});r.close();const M=await S.arrayBuffer();return new Uint8Array(M)}function $r(i){return Math.min(1,Math.max(0,i))}})();
