(function(){"use strict";class kt{constructor(){this._listeners={}}addEventListener(e,t){const r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(t)===-1&&r[e].push(t),this}removeEventListener(e,t){const n=this._listeners[e];if(n!==void 0){const i=n.indexOf(t);i!==-1&&n.splice(i,1)}return this}dispatchEvent(e){const r=this._listeners[e.type];if(r!==void 0){const n=r.slice(0);for(let i=0,o=n.length;i<o;i++)n[i].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class Be{constructor(e,t,r,n={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=r,this._attributes=n,!t.isOnGraph(r))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}}class ln extends kt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){const t=new Set;for(const r of this.listParentEdges(e))t.add(r.getParent());return Array.from(t)}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){const t=new Set;for(const r of this.listChildEdges(e))t.add(r.getChild());return Array.from(t)}disconnectParents(e,t){for(const r of this.listParentEdges(e))(!t||t(r.getParent()))&&r.dispose();return this}_createEdge(e,t,r,n){const i=new Be(e,t,r,n);this._edges.add(i);const o=i.getParent();this._parentEdges.has(o)||this._parentEdges.set(o,new Set),this._parentEdges.get(o).add(i);const a=i.getChild();return this._childEdges.has(a)||this._childEdges.set(a,new Set),this._childEdges.get(a).add(i),i}_destroyEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function Xe(){return Xe=Object.assign||function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},Xe.apply(this,arguments)}class Me{constructor(e){if(this.list=[],e)for(const t of e)this.list.push(t)}add(e){this.list.push(e)}remove(e){const t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)}removeChild(e){const t=[];for(const r of this.list)r.getChild()===e&&t.push(r);for(const r of t)this.remove(r);return t}listRefsByChild(e){const t=[];for(const r of this.list)r.getChild()===e&&t.push(r);return t}values(){return this.list}}class P{constructor(e){if(this.set=new Set,this.map=new Map,e)for(const t of e)this.add(t)}add(e){const t=e.getChild();this.removeChild(t),this.set.add(e),this.map.set(t,e)}remove(e){this.set.delete(e),this.map.delete(e.getChild())}removeChild(e){const t=this.map.get(e)||null;return t&&this.remove(t),t}getRefByChild(e){return this.map.get(e)||null}values(){return Array.from(this.set)}}class fe{constructor(e){this.map={},e&&Object.assign(this.map,e)}set(e,t){this.map[e]=t}delete(e){delete this.map[e]}get(e){return this.map[e]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}}const U=Symbol("attributes"),Fe=Symbol("immutableKeys");class Et extends kt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[U]=void 0,this[Fe]=void 0,this.graph=e,this[Fe]=new Set,this[U]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const r in e){const n=e[r];if(n instanceof Et){const i=this.graph._createEdge(r,this,n);this[Fe].add(r),t[r]=i}else t[r]=n}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const r in this[U]){const n=this[U][r];if(n instanceof Be){const i=n;i.getChild()===e&&this.setRef(r,t,i.getAttributes())}else if(n instanceof Me)for(const i of n.listRefsByChild(e)){const o=i.getAttributes();this.removeRef(r,e),this.addRef(r,t,o)}else if(n instanceof P){const i=n.getRefByChild(e);if(i){const o=i.getAttributes();this.removeRef(r,e),this.addRef(r,t,o)}}else if(n instanceof fe)for(const i of n.keys()){const o=n.get(i);o.getChild()===e&&this.setRefMap(r,i,t,o.getAttributes())}}return this}get(e){return this[U][e]}set(e,t){return this[U][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[U][e];return t?t.getChild():null}setRef(e,t,r){if(this[Fe].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const n=this[U][e];if(n&&n.dispose(),!t)return this;const i=this.graph._createEdge(e,this,t,r);return this[U][e]=i,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this.assertRefList(e).values().map(r=>r.getChild())}addRef(e,t,r){const n=this.graph._createEdge(e,this,t,r);return this.assertRefList(e).add(n),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){const r=this.assertRefList(e);if(r instanceof Me)for(const n of r.listRefsByChild(t))n.dispose();else{const n=r.getRefByChild(t);n&&n.dispose()}return this}assertRefList(e){const t=this[U][e];if(t instanceof Me||t instanceof P)return t;throw new Error(`Expected RefList or RefSet for attribute "${e}"`)}listRefMapKeys(e){return this.assertRefMap(e).keys()}listRefMapValues(e){return this.assertRefMap(e).values().map(t=>t.getChild())}getRefMap(e,t){const n=this.assertRefMap(e).get(t);return n?n.getChild():null}setRefMap(e,t,r,n){const i=this.assertRefMap(e),o=i.get(t);if(o&&o.dispose(),!r)return this;n=Object.assign(n||{},{key:t});const a=this.graph._createEdge(e,this,r,Xe({},n,{key:t}));return i.set(t,a),this.dispatchEvent({type:"change",attribute:e,key:t})}assertRefMap(e){const t=this[U][e];if(t instanceof fe)return t;throw new Error(`Expected RefMap for attribute "${e}"`)}dispatchEvent(e){return super.dispatchEvent(Xe({},e,{target:this})),this.graph.dispatchEvent(Xe({},e,{target:this,type:`node:${e.type}`})),this}_destroyRef(e){const t=e.getName();if(this[U][t]===e)this[U][t]=null,this[Fe].has(t)&&e.getChild().dispose();else if(this[U][t]instanceof Me)this[U][t].remove(e);else if(this[U][t]instanceof P)this[U][t].remove(e);else if(this[U][t]instanceof fe){const r=this[U][t];for(const n of r.keys())r.get(n)===e&&r.delete(n)}else return;this.graph._destroyEdge(e),this.dispatchEvent({type:"change",attribute:t})}}const Gt="v4.2.1",je="@glb.bin";var m;(function(s){s.ACCESSOR="Accessor",s.ANIMATION="Animation",s.ANIMATION_CHANNEL="AnimationChannel",s.ANIMATION_SAMPLER="AnimationSampler",s.BUFFER="Buffer",s.CAMERA="Camera",s.MATERIAL="Material",s.MESH="Mesh",s.PRIMITIVE="Primitive",s.PRIMITIVE_TARGET="PrimitiveTarget",s.NODE="Node",s.ROOT="Root",s.SCENE="Scene",s.SKIN="Skin",s.TEXTURE="Texture",s.TEXTURE_INFO="TextureInfo"})(m||(m={}));var it;(function(s){s.INTERLEAVED="interleaved",s.SEPARATE="separate"})(it||(it={}));var ee;(function(s){s.ARRAY_BUFFER="ARRAY_BUFFER",s.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",s.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",s.OTHER="OTHER",s.SPARSE="SPARSE"})(ee||(ee={}));var se;(function(s){s[s.R=4096]="R",s[s.G=256]="G",s[s.B=16]="B",s[s.A=1]="A"})(se||(se={}));var ve;(function(s){s.GLTF="GLTF",s.GLB="GLB"})(ve||(ve={}));const ot={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};class O{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}else{const t=e.split(",")[1],r=e.indexOf("base64")>=0;return Buffer.from(t,r?"base64":"utf8")}}static encodeText(e){return new TextEncoder().encode(e)}static decodeText(e){return new TextDecoder().decode(e)}static concat(e){let t=0;for(const i of e)t+=i.byteLength;const r=new Uint8Array(t);let n=0;for(const i of e)r.set(i,n),n+=i.byteLength;return r}static pad(e,t=0){const r=this.padNumber(e.byteLength);if(r===e.byteLength)return e;const n=new Uint8Array(r);if(n.set(e),t!==0)for(let i=e.byteLength;i<r;i++)n[i]=t;return n}static padNumber(e){return Math.ceil(e/4)*4}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let r=e.byteLength;for(;r--;)if(e[r]!==t[r])return!1;return!0}static toView(e,t=0,r=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,r))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class hn{static hexToFactor(e,t){e=Math.floor(e);const r=t;return r[0]=(e>>16&255)/255,r[1]=(e>>8&255)/255,r[2]=(e&255)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[r,n,i]=this.convertLinearToSRGB(e,t);return r*255<<16^n*255<<8^i*255<<0}static convertSRGBToLinear(e,t){const r=e,n=t;for(let i=0;i<3;i++)n[i]=r[i]<.04045?r[i]*.0773993808:Math.pow(r[i]*.9478672986+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const r=e,n=t;for(let i=0;i<3;i++)n[i]=r[i]<.0031308?r[i]*12.92:1.055*Math.pow(r[i],.41666)-.055;return t}}class gn{match(e){return e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255}getSize(e){let t=new DataView(e.buffer,e.byteOffset+4),r,n;for(;t.byteLength;){if(r=t.getUint16(0,!1),pn(t,r),n=t.getUint8(r+1),n===192||n===193||n===194)return[t.getUint16(r+7,!1),t.getUint16(r+5,!1)];t=new DataView(e.buffer,t.byteOffset+r+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}}class at{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return O.decodeText(e.slice(12,16))===at.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}at.PNG_FRIED_CHUNK_NAME="CgBI";class le{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let r=0;const n=4,i=this.getSize(e,t);if(!i)return null;for(;i[0]>1||i[1]>1;)r+=i[0]*i[1]*n,i[0]=Math.max(Math.floor(i[0]/2),1),i[1]=Math.max(Math.floor(i[1]/2),1);return r+=1*1*n,r}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}le.impls={"image/jpeg":new gn,"image/png":new at};function pn(s,e){if(e>s.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(s.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return s}class Pe{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return le.mimeTypeToExtension(t)}else{if(e.startsWith("data:model/gltf+json"))return"gltf";if(e.startsWith("data:model/gltf-binary"))return"glb";if(e.startsWith("data:application/"))return"bin"}return e.split(/[\\/]/).pop().split(/[.]/).pop()}}var It=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});function dn(){var s=new It(3);return It!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Rt(s){var e=s[0],t=s[1],r=s[2];return Math.hypot(e,t,r)}function mn(s,e,t){var r=e[0],n=e[1],i=e[2],o=t[3]*r+t[7]*n+t[11]*i+t[15];return o=o||1,s[0]=(t[0]*r+t[4]*n+t[8]*i+t[12])/o,s[1]=(t[1]*r+t[5]*n+t[9]*i+t[13])/o,s[2]=(t[2]*r+t[6]*n+t[10]*i+t[14])/o,s}(function(){var s=dn();return function(e,t,r,n,i,o){var a,c;for(t||(t=3),r||(r=0),n?c=Math.min(n*t+r,e.length):c=e.length,a=r;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();function Tn(s){const e=Ht(),t=s.propertyType===m.NODE?[s]:s.listChildren();for(const r of t)r.traverse(n=>{const i=n.getMesh();if(!i)return;const o=xn(i,n.getWorldMatrix());o.min.every(isFinite)&&o.max.every(isFinite)&&(_t(o.min,e),_t(o.max,e))});return e}function xn(s,e){const t=Ht();for(const r of s.listPrimitives()){const n=r.getAttribute("POSITION"),i=r.getIndices();if(!n)continue;let o=[0,0,0],a=[0,0,0];for(let c=0,u=i?i.getCount():n.getCount();c<u;c++){const l=i?i.getScalar(c):c;o=n.getElement(l,o),a=mn(a,o,e),_t(a,t)}}return t}function _t(s,e){for(let t=0;t<3;t++)e.min[t]=Math.min(s[t],e.min[t]),e.max[t]=Math.max(s[t],e.max[t])}function Ht(){return{min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]}}const zt="https://null.example";class Ke{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return Pe.basename(new URL(e,zt).pathname)}static extension(e){return Pe.extension(new URL(e,zt).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const r=e.split("/"),n=t.split("/");r.pop();for(let i=0;i<n.length;i++)n[i]!=="."&&(n[i]===".."?r.pop():r.push(n[i]));return r.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}Ke.DEFAULT_INIT={},Ke.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;function $t(s){return Object.prototype.toString.call(s)==="[object Object]"}function Le(s){if($t(s)===!1)return!1;const e=s.constructor;if(e===void 0)return!0;const t=e.prototype;return!($t(t)===!1||Object.hasOwn(t,"isPrototypeOf")===!1)}var At,bt;(function(s){s[s.SILENT=4]="SILENT",s[s.ERROR=3]="ERROR",s[s.WARN=2]="WARN",s[s.INFO=1]="INFO",s[s.DEBUG=0]="DEBUG"})(bt||(bt={}));class ne{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=ne.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=ne.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=ne.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=ne.Verbosity.ERROR&&console.error(e)}}At=ne,ne.Verbosity=bt,ne.DEFAULT_INSTANCE=new At(At.Verbosity.INFO);function yn(s){var e=s[0],t=s[1],r=s[2],n=s[3],i=s[4],o=s[5],a=s[6],c=s[7],u=s[8],l=s[9],d=s[10],f=s[11],h=s[12],E=s[13],_=s[14],T=s[15],p=e*o-t*i,w=e*a-r*i,y=e*c-n*i,A=t*a-r*o,I=t*c-n*o,b=r*c-n*a,g=u*E-l*h,x=u*_-d*h,R=u*T-f*h,N=l*_-d*E,v=l*T-f*E,C=d*T-f*_;return p*C-w*v+y*N+A*R-I*x+b*g}function En(s,e,t){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],c=e[5],u=e[6],l=e[7],d=e[8],f=e[9],h=e[10],E=e[11],_=e[12],T=e[13],p=e[14],w=e[15],y=t[0],A=t[1],I=t[2],b=t[3];return s[0]=y*r+A*a+I*d+b*_,s[1]=y*n+A*c+I*f+b*T,s[2]=y*i+A*u+I*h+b*p,s[3]=y*o+A*l+I*E+b*w,y=t[4],A=t[5],I=t[6],b=t[7],s[4]=y*r+A*a+I*d+b*_,s[5]=y*n+A*c+I*f+b*T,s[6]=y*i+A*u+I*h+b*p,s[7]=y*o+A*l+I*E+b*w,y=t[8],A=t[9],I=t[10],b=t[11],s[8]=y*r+A*a+I*d+b*_,s[9]=y*n+A*c+I*f+b*T,s[10]=y*i+A*u+I*h+b*p,s[11]=y*o+A*l+I*E+b*w,y=t[12],A=t[13],I=t[14],b=t[15],s[12]=y*r+A*a+I*d+b*_,s[13]=y*n+A*c+I*f+b*T,s[14]=y*i+A*u+I*h+b*p,s[15]=y*o+A*l+I*E+b*w,s}function In(s,e){var t=e[0],r=e[1],n=e[2],i=e[4],o=e[5],a=e[6],c=e[8],u=e[9],l=e[10];return s[0]=Math.hypot(t,r,n),s[1]=Math.hypot(i,o,a),s[2]=Math.hypot(c,u,l),s}function Rn(s,e){var t=new It(3);In(t,e);var r=1/t[0],n=1/t[1],i=1/t[2],o=e[0]*r,a=e[1]*n,c=e[2]*i,u=e[4]*r,l=e[5]*n,d=e[6]*i,f=e[8]*r,h=e[9]*n,E=e[10]*i,_=o+l+E,T=0;return _>0?(T=Math.sqrt(_+1)*2,s[3]=.25*T,s[0]=(d-h)/T,s[1]=(f-c)/T,s[2]=(a-u)/T):o>l&&o>E?(T=Math.sqrt(1+o-l-E)*2,s[3]=(d-h)/T,s[0]=.25*T,s[1]=(a+u)/T,s[2]=(f+c)/T):l>E?(T=Math.sqrt(1+l-o-E)*2,s[3]=(f-c)/T,s[0]=(a+u)/T,s[1]=.25*T,s[2]=(d+h)/T):(T=Math.sqrt(1+E-o-l)*2,s[3]=(a-u)/T,s[0]=(f+c)/T,s[1]=(d+h)/T,s[2]=.25*T),s}class j{static identity(e){return e}static eq(e,t,r=1e-5){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(Math.abs(e[n]-t[n])>r)return!1;return!0}static clamp(e,t,r){return e<t?t:e>r?r:e}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(j.clamp(e,0,1)*65535);case 5121:return Math.round(j.clamp(e,0,1)*255);case 5122:return Math.round(j.clamp(e,-1,1)*32767);case 5120:return Math.round(j.clamp(e,-1,1)*127);default:throw new Error("Invalid component type.")}}static decompose(e,t,r,n){let i=Rt([e[0],e[1],e[2]]);const o=Rt([e[4],e[5],e[6]]),a=Rt([e[8],e[9],e[10]]);yn(e)<0&&(i=-i),t[0]=e[12],t[1]=e[13],t[2]=e[14];const u=e.slice(),l=1/i,d=1/o,f=1/a;u[0]*=l,u[1]*=l,u[2]*=l,u[4]*=d,u[5]*=d,u[6]*=d,u[8]*=f,u[9]*=f,u[10]*=f,Rn(r,u),n[0]=i,n[1]=o,n[2]=a}static compose(e,t,r,n){const i=n,o=t[0],a=t[1],c=t[2],u=t[3],l=o+o,d=a+a,f=c+c,h=o*l,E=o*d,_=o*f,T=a*d,p=a*f,w=c*f,y=u*l,A=u*d,I=u*f,b=r[0],g=r[1],x=r[2];return i[0]=(1-(T+w))*b,i[1]=(E+I)*b,i[2]=(_-A)*b,i[3]=0,i[4]=(E-I)*g,i[5]=(1-(h+w))*g,i[6]=(p+y)*g,i[7]=0,i[8]=(_+A)*x,i[9]=(p-y)*x,i[10]=(1-(h+T))*x,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}}function _n(s,e){if(!!s!=!!e)return!1;const t=s.getChild(),r=e.getChild();return t===r||t.equals(r)}function An(s,e){if(!!s!=!!e)return!1;const t=s.values(),r=e.values();if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++){const i=t[n],o=r[n];if(i.getChild()!==o.getChild()&&!i.getChild().equals(o.getChild()))return!1}return!0}function bn(s,e){if(!!s!=!!e)return!1;const t=s.keys(),r=e.keys();if(t.length!==r.length)return!1;for(const n of t){const i=s.get(n),o=e.get(n);if(!!i!=!!o)return!1;const a=i.getChild(),c=o.getChild();if(a!==c&&!a.equals(c))return!1}return!0}function qt(s,e){if(s===e)return!0;if(!!s!=!!e||!s||!e||s.length!==e.length)return!1;for(let t=0;t<s.length;t++)if(s[t]!==e[t])return!1;return!0}function Xt(s,e){if(s===e)return!0;if(!!s!=!!e)return!1;if(!Le(s)||!Le(e))return s===e;const t=s,r=e;let n=0,i=0,o;for(o in t)n++;for(o in r)i++;if(n!==i)return!1;for(o in t){const a=t[o],c=r[o];if(ct(a)&&ct(c)){if(!qt(a,c))return!1}else if(Le(a)&&Le(c)){if(!Xt(a,c))return!1}else if(a!==c)return!1}return!0}function ct(s){return Array.isArray(s)||ArrayBuffer.isView(s)}const Kt="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",Nn=999,Sn=6,Yt=new Set,wn=function(){let e="";for(let t=0;t<Sn;t++)e+=Kt.charAt(Math.floor(Math.random()*Kt.length));return e},Mn=function(){for(let e=0;e<Nn;e++){const t=wn();if(!Yt.has(t))return Yt.add(t),t}return""},Ce=s=>s,vn=new Set;class Nt extends Et{constructor(e,t=""){super(e),this[U].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){const e=this.constructor;return new e(this.graph).copy(this,Ce)}copy(e,t=Ce){for(const r in this[U]){const n=this[U][r];if(n instanceof Be)this[Fe].has(r)||n.dispose();else if(n instanceof Me||n instanceof P)for(const i of n.values())i.dispose();else if(n instanceof fe)for(const i of n.values())i.dispose()}for(const r in e[U]){const n=this[U][r],i=e[U][r];if(i instanceof Be)this[Fe].has(r)?n.getChild().copy(t(i.getChild()),t):this.setRef(r,t(i.getChild()),i.getAttributes());else if(i instanceof P||i instanceof Me)for(const o of i.values())this.addRef(r,t(o.getChild()),o.getAttributes());else if(i instanceof fe)for(const o of i.keys()){const a=i.get(o);this.setRefMap(r,o,t(a.getChild()),a.getAttributes())}else Le(i)?this[U][r]=JSON.parse(JSON.stringify(i)):Array.isArray(i)||i instanceof ArrayBuffer||ArrayBuffer.isView(i)?this[U][r]=i.slice():this[U][r]=i}return this}equals(e,t=vn){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const r in this[U]){if(t.has(r))continue;const n=this[U][r],i=e[U][r];if(n instanceof Be||i instanceof Be){if(!_n(n,i))return!1}else if(n instanceof P||i instanceof P||n instanceof Me||i instanceof Me){if(!An(n,i))return!1}else if(n instanceof fe||i instanceof fe){if(!bn(n,i))return!1}else if(Le(n)||Le(i)){if(!Xt(n,i))return!1}else if(ct(n)||ct(i)){if(!qt(n,i))return!1}else if(n!==i)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}class Y extends Nt{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new fe})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t._validateParent(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}}class S extends Y{init(){this.propertyType=m.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:S.Type.SCALAR,componentType:S.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(e){switch(e){case S.Type.SCALAR:return 1;case S.Type.VEC2:return 2;case S.Type.VEC3:return 3;case S.Type.VEC4:return 4;case S.Type.MAT2:return 4;case S.Type.MAT3:return 9;case S.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case S.ComponentType.BYTE:return 1;case S.ComponentType.UNSIGNED_BYTE:return 1;case S.ComponentType.SHORT:return 2;case S.ComponentType.UNSIGNED_SHORT:return 2;case S.ComponentType.UNSIGNED_INT:return 4;case S.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getNormalized(),r=this.getElementSize(),n=this.getComponentType();if(this.getMin(e),t)for(let i=0;i<r;i++)e[i]=j.decodeNormalizedInt(e[i],n);return e}getMin(e){const t=this.getArray(),r=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=1/0;for(let i=0;i<r*n;i+=n)for(let o=0;o<n;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getNormalized(),r=this.getElementSize(),n=this.getComponentType();if(this.getMax(e),t)for(let i=0;i<r;i++)e[i]=j.decodeNormalizedInt(e[i],n);return e}getMax(e){const t=this.get("array"),r=this.getCount(),n=this.getElementSize();for(let i=0;i<n;i++)e[i]=-1/0;for(let i=0;i<r*n;i+=n)for(let o=0;o<n;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return S.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e)}getScalar(e){const t=this.getElementSize(),r=this.getComponentType(),n=this.getArray();return this.getNormalized()?j.decodeNormalizedInt(n[e*t],r):n[e*t]}setScalar(e,t){const r=this.getElementSize(),n=this.getComponentType(),i=this.getArray();return this.getNormalized()?i[e*r]=j.encodeNormalizedInt(t,n):i[e*r]=t,this}getElement(e,t){const r=this.getNormalized(),n=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<n;a++)r?t[a]=j.decodeNormalizedInt(o[e*n+a],i):t[a]=o[e*n+a];return t}setElement(e,t){const r=this.getNormalized(),n=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<n;a++)r?o[e*n+a]=j.encodeNormalizedInt(t[a],i):o[e*n+a]=t[a];return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?Cn(e):S.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}S.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},S.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};function Cn(s){switch(s.constructor){case Float32Array:return S.ComponentType.FLOAT;case Uint32Array:return S.ComponentType.UNSIGNED_INT;case Uint16Array:return S.ComponentType.UNSIGNED_SHORT;case Uint8Array:return S.ComponentType.UNSIGNED_BYTE;case Int16Array:return S.ComponentType.SHORT;case Int8Array:return S.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}class Wt extends Y{init(){this.propertyType=m.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:new P,samplers:new P})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}class Ye extends Y{init(){this.propertyType=m.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}Ye.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class Ve extends Y{init(){this.propertyType=m.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Ve.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:ee.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:ee.OTHER})}}Ve.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Jt extends Y{init(){this.propertyType=m.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}class Ue extends Y{init(){this.propertyType=m.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Ue.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:Math.PI*2*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}}Ue.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class G extends Nt{_validateParent(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}G.EXTENSION_NAME=void 0;class B extends Y{init(){this.propertyType=m.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:B.WrapMode.REPEAT,wrapT:B.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}}B.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},B.MagFilter={NEAREST:9728,LINEAR:9729},B.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:ut,G:ft,B:lt,A:On}=se;class ge extends Y{init(){this.propertyType=m.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:ge.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new B(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new B(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new B(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new B(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new B(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:ut|ft|lt|On,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:ut|ft|lt,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:ut|ft|lt})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:ut})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:ft|lt})}}ge.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class Zt extends Y{init(){this.propertyType=m.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:new P})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}class Qt extends Y{init(){this.propertyType=m.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:new P})}copy(e,t=Ce){if(t===Ce)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return j.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),r=this.get("rotation").slice(),n=this.get("scale").slice();return j.decompose(e,t,r,n),this.set("translation",t).set("rotation",r).set("scale",n)}getWorldTranslation(){const e=[0,0,0];return j.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return j.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return j.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let n=this;n!=null;n=n.getParentNode())e.push(n);let t;const r=e.pop().getMatrix();for(;t=e.pop();)En(r,r,t.getMatrix());return r}addChild(e){const t=e.getParentNode();t&&t.removeChild(e);for(const r of e.listParents())r.propertyType===m.SCENE&&r.removeChild(e);return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParentNode(){for(const e of this.listParents())if(e.propertyType===m.NODE)return e;return null}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}}class re extends Y{init(){this.propertyType=m.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:re.Mode.TRIANGLES,material:null,indices:null,attributes:new fe,targets:new P})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:ee.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:ee.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}re.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class Dn extends Nt{init(){this.propertyType=m.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new fe})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:ee.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function W(){return W=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},W.apply(null,arguments)}class St extends Y{init(){this.propertyType=m.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:new P})}copy(e,t=Ce){if(t===Ce)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){const t=e.getParentNode();return t&&t.removeChild(e),this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}}class es extends Y{init(){this.propertyType=m.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:new P})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:ee.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}class We extends Y{init(){this.propertyType=m.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||le.extensionToMimeType(Pe.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=le.extensionToMimeType(Pe.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",O.assertView(e))}getSize(){const e=this.get("image");return e?le.getSize(e,this.getMimeType()):null}}class wt extends Y{init(){this.propertyType=m.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${Gt}`,version:"2.0"},defaultScene:null,accessors:new P,animations:new P,buffers:new P,cameras:new P,materials:new P,meshes:new P,nodes:new P,scenes:new P,skins:new P,textures:new P})}constructor(e){super(e),this._extensions=new Set,e.addEventListener("node:create",t=>{this._addChildOfRoot(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=Ce){if(t===Ce)throw new Error("Root cannot be copied.");this.set("asset",W({},e.get("asset"))),this.setName(e.getName()),this.setExtras(W({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const r of e.listRefMapKeys("extensions")){const n=e.getExtension(r);this.setExtension(r,t(n))}return this}_addChildOfRoot(e){return e instanceof St?this.addRef("scenes",e):e instanceof Qt?this.addRef("nodes",e):e instanceof Ue?this.addRef("cameras",e):e instanceof es?this.addRef("skins",e):e instanceof Zt?this.addRef("meshes",e):e instanceof ge?this.addRef("materials",e):e instanceof We?this.addRef("textures",e):e instanceof Wt?this.addRef("animations",e):e instanceof S?this.addRef("accessors",e):e instanceof Jt&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this._extensions)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}_enableExtension(e){return this._extensions.add(e),this}_disableExtension(e){return this._extensions.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class ke{static fromGraph(e){return ke._GRAPH_DOCUMENTS.get(e)||null}constructor(){this._graph=new ln,this._root=new wt(this._graph),this._logger=ne.DEFAULT_INSTANCE,ke._GRAPH_DOCUMENTS.set(this._graph,this)}getRoot(){return this._root}getGraph(){return this._graph}getLogger(){return this._logger}setLogger(e){return this._logger=e,this}clone(){throw new Error("Use 'cloneDocument(source)' from '@gltf-transform/functions'.")}merge(e){throw new Error("Use 'mergeDocuments(target, source)' from '@gltf-transform/functions'.")}async transform(...e){const t=e.map(r=>r.name);for(const r of e)await r(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(n=>n.extensionName===t)||new e(this)}createScene(e=""){return new St(this._graph,e)}createNode(e=""){return new Qt(this._graph,e)}createCamera(e=""){return new Ue(this._graph,e)}createSkin(e=""){return new es(this._graph,e)}createMesh(e=""){return new Zt(this._graph,e)}createPrimitive(){return new re(this._graph)}createPrimitiveTarget(e=""){return new Dn(this._graph,e)}createMaterial(e=""){return new ge(this._graph,e)}createTexture(e=""){return new We(this._graph,e)}createAnimation(e=""){return new Wt(this._graph,e)}createAnimationChannel(e=""){return new Ye(this._graph,e)}createAnimationSampler(e=""){return new Ve(this._graph,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new S(this._graph,e).setBuffer(t)}createBuffer(e=""){return new Jt(this._graph,e)}}ke._GRAPH_DOCUMENTS=new WeakMap;class k{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=e,e.getRoot()._enableExtension(this),this._listener=r=>{const n=r,i=n.target;i instanceof G&&i.extensionName===this.extensionName&&(n.type==="node:create"&&this._addExtensionProperty(i),n.type==="node:dispose"&&this._removeExtensionProperty(i))};const t=e.getGraph();t.addEventListener("node:create",this._listener),t.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const e=this.document.getGraph();e.removeEventListener("node:create",this._listener),e.removeEventListener("node:dispose",this._listener);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(e){return this.properties.add(e),this}_removeExtensionProperty(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}k.EXTENSION_NAME=void 0;class Fn{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const r=this.jsonDoc.json.textures[t.index];if(r.sampler===void 0)return;const n=this.jsonDoc.json.samplers[r.sampler];n.magFilter!==void 0&&e.setMagFilter(n.magFilter),n.minFilter!==void 0&&e.setMinFilter(n.minFilter),n.wrapS!==void 0&&e.setWrapS(n.wrapS),n.wrapT!==void 0&&e.setWrapT(n.wrapT)}}const ts={logger:ne.DEFAULT_INSTANCE,extensions:[],dependencies:{}},Ln=new Set([m.BUFFER,m.TEXTURE,m.MATERIAL,m.MESH,m.PRIMITIVE,m.NODE,m.SCENE]);class Un{static read(e,t=ts){const r=W({},ts,t),{json:n}=e,i=new ke().setLogger(r.logger);this.validate(e,r);const o=new Fn(e),a=n.asset,c=i.getRoot().getAsset();a.copyright&&(c.copyright=a.copyright),a.extras&&(c.extras=a.extras),n.extras!==void 0&&i.getRoot().setExtras(W({},n.extras));const u=n.extensionsUsed||[],l=n.extensionsRequired||[];r.extensions.sort((g,x)=>g.EXTENSION_NAME>x.EXTENSION_NAME?1:-1);for(const g of r.extensions)if(u.includes(g.EXTENSION_NAME)){const x=i.createExtension(g).setRequired(l.includes(g.EXTENSION_NAME)),R=x.prereadTypes.filter(N=>!Ln.has(N));R.length&&r.logger.warn(`Preread hooks for some types (${R.join()}), requested by extension ${x.extensionName}, are unsupported. Please file an issue or a PR.`);for(const N of x.readDependencies)x.install(N,r.dependencies[N])}const d=n.buffers||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.BUFFER)).forEach(g=>g.preread(o,m.BUFFER)),o.buffers=d.map(g=>{const x=i.createBuffer(g.name);return g.extras&&x.setExtras(g.extras),g.uri&&g.uri.indexOf("__")!==0&&x.setURI(g.uri),x});const f=n.bufferViews||[];o.bufferViewBuffers=f.map((g,x)=>{if(!o.bufferViews[x]){const R=e.json.buffers[g.buffer],N=R.uri?e.resources[R.uri]:e.resources[je],v=g.byteOffset||0;o.bufferViews[x]=O.toView(N,v,g.byteLength)}return o.buffers[g.buffer]});const h=n.accessors||[];o.accessors=h.map(g=>{const x=o.bufferViewBuffers[g.bufferView],R=i.createAccessor(g.name,x).setType(g.type);return g.extras&&R.setExtras(g.extras),g.normalized!==void 0&&R.setNormalized(g.normalized),g.bufferView===void 0||R.setArray(ht(g,o)),R});const E=n.images||[],_=n.textures||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.TEXTURE)).forEach(g=>g.preread(o,m.TEXTURE)),o.textures=E.map(g=>{const x=i.createTexture(g.name);if(g.extras&&x.setExtras(g.extras),g.bufferView!==void 0){const R=n.bufferViews[g.bufferView],N=e.json.buffers[R.buffer],v=N.uri?e.resources[N.uri]:e.resources[je],C=R.byteOffset||0,M=R.byteLength,F=v.slice(C,C+M);x.setImage(F)}else g.uri!==void 0&&(x.setImage(e.resources[g.uri]),g.uri.indexOf("__")!==0&&x.setURI(g.uri));if(g.mimeType!==void 0)x.setMimeType(g.mimeType);else if(g.uri){const R=Pe.extension(g.uri);x.setMimeType(le.extensionToMimeType(R))}return x}),i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.MATERIAL)).forEach(g=>g.preread(o,m.MATERIAL));const T=n.materials||[];o.materials=T.map(g=>{const x=i.createMaterial(g.name);g.extras&&x.setExtras(g.extras),g.alphaMode!==void 0&&x.setAlphaMode(g.alphaMode),g.alphaCutoff!==void 0&&x.setAlphaCutoff(g.alphaCutoff),g.doubleSided!==void 0&&x.setDoubleSided(g.doubleSided);const R=g.pbrMetallicRoughness||{};if(R.baseColorFactor!==void 0&&x.setBaseColorFactor(R.baseColorFactor),g.emissiveFactor!==void 0&&x.setEmissiveFactor(g.emissiveFactor),R.metallicFactor!==void 0&&x.setMetallicFactor(R.metallicFactor),R.roughnessFactor!==void 0&&x.setRoughnessFactor(R.roughnessFactor),R.baseColorTexture!==void 0){const N=R.baseColorTexture,v=o.textures[_[N.index].source];x.setBaseColorTexture(v),o.setTextureInfo(x.getBaseColorTextureInfo(),N)}if(g.emissiveTexture!==void 0){const N=g.emissiveTexture,v=o.textures[_[N.index].source];x.setEmissiveTexture(v),o.setTextureInfo(x.getEmissiveTextureInfo(),N)}if(g.normalTexture!==void 0){const N=g.normalTexture,v=o.textures[_[N.index].source];x.setNormalTexture(v),o.setTextureInfo(x.getNormalTextureInfo(),N),g.normalTexture.scale!==void 0&&x.setNormalScale(g.normalTexture.scale)}if(g.occlusionTexture!==void 0){const N=g.occlusionTexture,v=o.textures[_[N.index].source];x.setOcclusionTexture(v),o.setTextureInfo(x.getOcclusionTextureInfo(),N),g.occlusionTexture.strength!==void 0&&x.setOcclusionStrength(g.occlusionTexture.strength)}if(R.metallicRoughnessTexture!==void 0){const N=R.metallicRoughnessTexture,v=o.textures[_[N.index].source];x.setMetallicRoughnessTexture(v),o.setTextureInfo(x.getMetallicRoughnessTextureInfo(),N)}return x}),i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.MESH)).forEach(g=>g.preread(o,m.MESH));const p=n.meshes||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.PRIMITIVE)).forEach(g=>g.preread(o,m.PRIMITIVE)),o.meshes=p.map(g=>{const x=i.createMesh(g.name);return g.extras&&x.setExtras(g.extras),g.weights!==void 0&&x.setWeights(g.weights),(g.primitives||[]).forEach(N=>{const v=i.createPrimitive();N.extras&&v.setExtras(N.extras),N.material!==void 0&&v.setMaterial(o.materials[N.material]),N.mode!==void 0&&v.setMode(N.mode);for(const[F,D]of Object.entries(N.attributes||{}))v.setAttribute(F,o.accessors[D]);N.indices!==void 0&&v.setIndices(o.accessors[N.indices]);const C=g.extras&&g.extras.targetNames||[];(N.targets||[]).forEach((F,D)=>{const L=C[D]||D.toString(),V=i.createPrimitiveTarget(L);for(const[Z,K]of Object.entries(F))V.setAttribute(Z,o.accessors[K]);v.addTarget(V)}),x.addPrimitive(v)}),x});const w=n.cameras||[];o.cameras=w.map(g=>{const x=i.createCamera(g.name).setType(g.type);if(g.extras&&x.setExtras(g.extras),g.type===Ue.Type.PERSPECTIVE){const R=g.perspective;x.setYFov(R.yfov),x.setZNear(R.znear),R.zfar!==void 0&&x.setZFar(R.zfar),R.aspectRatio!==void 0&&x.setAspectRatio(R.aspectRatio)}else{const R=g.orthographic;x.setZNear(R.znear).setZFar(R.zfar).setXMag(R.xmag).setYMag(R.ymag)}return x});const y=n.nodes||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.NODE)).forEach(g=>g.preread(o,m.NODE)),o.nodes=y.map(g=>{const x=i.createNode(g.name);if(g.extras&&x.setExtras(g.extras),g.translation!==void 0&&x.setTranslation(g.translation),g.rotation!==void 0&&x.setRotation(g.rotation),g.scale!==void 0&&x.setScale(g.scale),g.matrix!==void 0){const R=[0,0,0],N=[0,0,0,1],v=[1,1,1];j.decompose(g.matrix,R,N,v),x.setTranslation(R),x.setRotation(N),x.setScale(v)}return g.weights!==void 0&&x.setWeights(g.weights),x});const A=n.skins||[];o.skins=A.map(g=>{const x=i.createSkin(g.name);g.extras&&x.setExtras(g.extras),g.inverseBindMatrices!==void 0&&x.setInverseBindMatrices(o.accessors[g.inverseBindMatrices]),g.skeleton!==void 0&&x.setSkeleton(o.nodes[g.skeleton]);for(const R of g.joints)x.addJoint(o.nodes[R]);return x}),y.map((g,x)=>{const R=o.nodes[x];(g.children||[]).forEach(v=>R.addChild(o.nodes[v])),g.mesh!==void 0&&R.setMesh(o.meshes[g.mesh]),g.camera!==void 0&&R.setCamera(o.cameras[g.camera]),g.skin!==void 0&&R.setSkin(o.skins[g.skin])});const I=n.animations||[];o.animations=I.map(g=>{const x=i.createAnimation(g.name);g.extras&&x.setExtras(g.extras);const N=(g.samplers||[]).map(C=>{const M=i.createAnimationSampler().setInput(o.accessors[C.input]).setOutput(o.accessors[C.output]).setInterpolation(C.interpolation||Ve.Interpolation.LINEAR);return C.extras&&M.setExtras(C.extras),x.addSampler(M),M});return(g.channels||[]).forEach(C=>{const M=i.createAnimationChannel().setSampler(N[C.sampler]).setTargetPath(C.target.path);C.target.node!==void 0&&M.setTargetNode(o.nodes[C.target.node]),C.extras&&M.setExtras(C.extras),x.addChannel(M)}),x});const b=n.scenes||[];return i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.SCENE)).forEach(g=>g.preread(o,m.SCENE)),o.scenes=b.map(g=>{const x=i.createScene(g.name);return g.extras&&x.setExtras(g.extras),(g.nodes||[]).map(N=>o.nodes[N]).forEach(N=>x.addChild(N)),x}),n.scene!==void 0&&i.getRoot().setDefaultScene(o.scenes[n.scene]),i.getRoot().listExtensionsUsed().forEach(g=>g.read(o)),h.forEach((g,x)=>{const R=o.accessors[x],N=!!g.sparse,v=!g.bufferView&&!R.getArray();(N||v)&&R.setSparse(!0).setArray(jn(g,o))}),i}static validate(e,t){const r=e.json;if(r.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${r.asset.version}".`);if(r.extensionsRequired){for(const n of r.extensionsRequired)if(!t.extensions.find(i=>i.EXTENSION_NAME===n))throw new Error(`Missing required extension, "${n}".`)}if(r.extensionsUsed)for(const n of r.extensionsUsed)t.extensions.find(i=>i.EXTENSION_NAME===n)||t.logger.warn(`Missing optional extension, "${n}".`)}}function Bn(s,e){const t=e.jsonDoc,r=e.bufferViews[s.bufferView],n=t.json.bufferViews[s.bufferView],i=ot[s.componentType],o=S.getElementSize(s.type),a=i.BYTES_PER_ELEMENT,c=s.byteOffset||0,u=new i(s.count*o),l=new DataView(r.buffer,r.byteOffset,r.byteLength),d=n.byteStride;for(let f=0;f<s.count;f++)for(let h=0;h<o;h++){const E=c+f*d+h*a;let _;switch(s.componentType){case S.ComponentType.FLOAT:_=l.getFloat32(E,!0);break;case S.ComponentType.UNSIGNED_INT:_=l.getUint32(E,!0);break;case S.ComponentType.UNSIGNED_SHORT:_=l.getUint16(E,!0);break;case S.ComponentType.UNSIGNED_BYTE:_=l.getUint8(E);break;case S.ComponentType.SHORT:_=l.getInt16(E,!0);break;case S.ComponentType.BYTE:_=l.getInt8(E);break;default:throw new Error(`Unexpected componentType "${s.componentType}".`)}u[f*o+h]=_}return u}function ht(s,e){const t=e.jsonDoc,r=e.bufferViews[s.bufferView],n=t.json.bufferViews[s.bufferView],i=ot[s.componentType],o=S.getElementSize(s.type),a=i.BYTES_PER_ELEMENT,c=o*a;if(n.byteStride!==void 0&&n.byteStride!==c)return Bn(s,e);const u=r.byteOffset+(s.byteOffset||0),l=s.count*o*a;return new i(r.buffer.slice(u,u+l))}function jn(s,e){const t=ot[s.componentType],r=S.getElementSize(s.type);let n;s.bufferView!==void 0?n=ht(s,e):n=new t(s.count*r);const i=s.sparse;if(!i)return n;const o=i.count,a=W({},s,i.indices,{count:o,type:"SCALAR"}),c=W({},s,i.values,{count:o}),u=ht(a,e),l=ht(c,e);for(let d=0;d<a.count;d++)for(let f=0;f<r;f++)n[u[d]*r+f]=l[d*r+f];return n}var Je;(function(s){s[s.ARRAY_BUFFER=34962]="ARRAY_BUFFER",s[s.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(Je||(Je={}));class he{constructor(e,t,r){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=e,this.jsonDoc=t,this.options=r;const n=e.getRoot(),i=n.listBuffers().length,o=n.listTextures().length;this.bufferURIGenerator=new ss(i>1,()=>r.basename||"buffer"),this.imageURIGenerator=new ss(o>1,a=>Pn(e,a)||r.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const r={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},n=JSON.stringify(r);this.samplerDefIndexMap.has(n)||(this.samplerDefIndexMap.set(n,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(r));const i={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(n)},o=JSON.stringify(i);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(i));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this._doc.getGraph().listParentEdges(e).some(n=>n.getName()==="attributes"&&n.getAttributes().key==="POSITION"||n.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,r){if(this.options.format===ve.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const n=le.mimeTypeToExtension(r.getMimeType());e.uri=this.imageURIGenerator.createURI(r,n),this.assignResourceURI(e.uri,t,!1)}}assignResourceURI(e,t,r){const n=this.jsonDoc.resources;if(!(e in n)){n[e]=t;return}if(t===n[e]){this.logger.warn(`Duplicate resource URI, "${e}".`);return}const i=`Resource URI "${e}" already assigned to different data.`;if(!r){this.logger.warn(i);return}throw new Error(i)}getAccessorUsage(e){const t=this._accessorUsageMap.get(e);if(t)return t;if(e.getSparse())return ee.SPARSE;for(const r of this._doc.getGraph().listParentEdges(e)){const{usage:n}=r.getAttributes();if(n)return n;r.getParent().propertyType!==m.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${r.getName()}".`)}return ee.OTHER}addAccessorToUsageGroup(e,t){const r=this._accessorUsageMap.get(e);if(r&&r!==t)throw new Error(`Accessor with usage "${r}" cannot be reused as "${t}".`);return this._accessorUsageMap.set(e,t),this}}he.BufferViewTarget=Je,he.BufferViewUsage=ee,he.USAGE_TO_TARGET={[ee.ARRAY_BUFFER]:Je.ARRAY_BUFFER,[ee.ELEMENT_ARRAY_BUFFER]:Je.ELEMENT_ARRAY_BUFFER};class ss{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const r=this.basename(e);return this.counter[r]=this.counter[r]||1,`${r}_${this.counter[r]++}.${t}`}else return`${this.basename(e)}.${t}`}}function Pn(s,e){const t=s.getGraph().listParentEdges(e).find(r=>r.getParent()!==s.getRoot());return t?t.getName().replace(/texture$/i,""):""}const{BufferViewUsage:gt}=he,{UNSIGNED_INT:Vn,UNSIGNED_SHORT:kn,UNSIGNED_BYTE:Gn}=S.ComponentType,Hn=new Set([m.ACCESSOR,m.BUFFER,m.MATERIAL,m.MESH]);class zn{static write(e,t){const r=e.getGraph(),n=e.getRoot(),i={asset:W({generator:`glTF-Transform ${Gt}`},n.getAsset()),extras:W({},n.getExtras())},o={json:i,resources:{}},a=new he(e,o,t),c=t.logger||ne.DEFAULT_INSTANCE,u=new Set(t.extensions.map(p=>p.EXTENSION_NAME)),l=e.getRoot().listExtensionsUsed().filter(p=>u.has(p.extensionName)).sort((p,w)=>p.extensionName>w.extensionName?1:-1),d=e.getRoot().listExtensionsRequired().filter(p=>u.has(p.extensionName)).sort((p,w)=>p.extensionName>w.extensionName?1:-1);l.length<e.getRoot().listExtensionsUsed().length&&c.warn("Some extensions were not registered for I/O, and will not be written.");for(const p of l){const w=p.prewriteTypes.filter(y=>!Hn.has(y));w.length&&c.warn(`Prewrite hooks for some types (${w.join()}), requested by extension ${p.extensionName}, are unsupported. Please file an issue or a PR.`);for(const y of p.writeDependencies)p.install(y,t.dependencies[y])}function f(p,w,y,A){const I=[];let b=0;for(const R of p){const N=a.createAccessorDef(R);N.bufferView=i.bufferViews.length;const v=R.getArray(),C=O.pad(O.toView(v));N.byteOffset=b,b+=C.byteLength,I.push(C),a.accessorIndexMap.set(R,i.accessors.length),i.accessors.push(N)}const g=O.concat(I),x={buffer:w,byteOffset:y,byteLength:g.byteLength};return A&&(x.target=A),i.bufferViews.push(x),{buffers:I,byteLength:b}}function h(p,w,y){const A=p[0].getCount();let I=0;for(const N of p){const v=a.createAccessorDef(N);v.bufferView=i.bufferViews.length,v.byteOffset=I;const C=N.getElementSize(),M=N.getComponentSize();I+=O.padNumber(C*M),a.accessorIndexMap.set(N,i.accessors.length),i.accessors.push(v)}const b=A*I,g=new ArrayBuffer(b),x=new DataView(g);for(let N=0;N<A;N++){let v=0;for(const C of p){const M=C.getElementSize(),F=C.getComponentSize(),D=C.getComponentType(),L=C.getArray();for(let V=0;V<M;V++){const Z=N*I+v+V*F,K=L[N*M+V];switch(D){case S.ComponentType.FLOAT:x.setFloat32(Z,K,!0);break;case S.ComponentType.BYTE:x.setInt8(Z,K);break;case S.ComponentType.SHORT:x.setInt16(Z,K,!0);break;case S.ComponentType.UNSIGNED_BYTE:x.setUint8(Z,K);break;case S.ComponentType.UNSIGNED_SHORT:x.setUint16(Z,K,!0);break;case S.ComponentType.UNSIGNED_INT:x.setUint32(Z,K,!0);break;default:throw new Error("Unexpected component type: "+D)}}v+=O.padNumber(M*F)}}const R={buffer:w,byteOffset:y,byteLength:b,byteStride:I,target:he.BufferViewTarget.ARRAY_BUFFER};return i.bufferViews.push(R),{byteLength:b,buffers:[new Uint8Array(g)]}}function E(p,w,y){const A=[];let I=0;const b=new Map;let g=-1/0,x=!1;for(const D of p){const L=a.createAccessorDef(D);i.accessors.push(L),a.accessorIndexMap.set(D,i.accessors.length-1);const V=[],Z=[],K=[],Pt=new Array(D.getElementSize()).fill(0);for(let De=0,Vt=D.getCount();De<Vt;De++)if(D.getElement(De,K),!j.eq(K,Pt,0)){g=Math.max(De,g),V.push(De);for(let rt=0;rt<K.length;rt++)Z.push(K[rt])}const $e=V.length,qe={accessorDef:L,count:$e};if(b.set(D,qe),$e===0)continue;$e>D.getCount()/2&&(x=!0);const xt=ot[D.getComponentType()];qe.indices=V,qe.values=new xt(Z)}if(!Number.isFinite(g))return{buffers:A,byteLength:I};x&&c.warn("Some sparse accessors have >50% non-zero elements, which may increase file size.");const R=g<255?Uint8Array:g<65535?Uint16Array:Uint32Array,N=g<255?Gn:g<65535?kn:Vn,v={buffer:w,byteOffset:y+I,byteLength:0};for(const D of p){const L=b.get(D);if(L.count===0)continue;L.indicesByteOffset=v.byteLength;const V=O.pad(O.toView(new R(L.indices)));A.push(V),I+=V.byteLength,v.byteLength+=V.byteLength}i.bufferViews.push(v);const C=i.bufferViews.length-1,M={buffer:w,byteOffset:y+I,byteLength:0};for(const D of p){const L=b.get(D);if(L.count===0)continue;L.valuesByteOffset=M.byteLength;const V=O.pad(O.toView(L.values));A.push(V),I+=V.byteLength,M.byteLength+=V.byteLength}i.bufferViews.push(M);const F=i.bufferViews.length-1;for(const D of p){const L=b.get(D);L.count!==0&&(L.accessorDef.sparse={count:L.count,indices:{bufferView:C,byteOffset:L.indicesByteOffset,componentType:N},values:{bufferView:F,byteOffset:L.valuesByteOffset}})}return{buffers:A,byteLength:I}}if(i.accessors=[],i.bufferViews=[],i.samplers=[],i.textures=[],i.images=n.listTextures().map((p,w)=>{const y=a.createPropertyDef(p);p.getMimeType()&&(y.mimeType=p.getMimeType());const A=p.getImage();return A&&a.createImageData(y,A,p),a.imageIndexMap.set(p,w),y}),l.filter(p=>p.prewriteTypes.includes(m.ACCESSOR)).forEach(p=>p.prewrite(a,m.ACCESSOR)),n.listAccessors().forEach(p=>{const w=a.accessorUsageGroupedByParent,y=a.accessorParents;if(a.accessorIndexMap.has(p))return;const A=a.getAccessorUsage(p);if(a.addAccessorToUsageGroup(p,A),w.has(A)){const I=r.listParents(p).find(b=>b.propertyType!==m.ROOT);y.set(p,I)}}),l.filter(p=>p.prewriteTypes.includes(m.BUFFER)).forEach(p=>p.prewrite(a,m.BUFFER)),(n.listAccessors().length>0||a.otherBufferViews.size>0||n.listTextures().length>0&&t.format===ve.GLB)&&n.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");i.buffers=[],n.listBuffers().forEach((p,w)=>{const y=a.createPropertyDef(p),A=a.accessorUsageGroupedByParent,I=p.listParents().filter(M=>M instanceof S),b=new Set(I.map(M=>a.accessorParents.get(M))),g=new Map(Array.from(b).map((M,F)=>[M,F])),x={};for(const M of I){var R;if(a.accessorIndexMap.has(M))continue;const F=a.getAccessorUsage(M);let D=F;if(A.has(F)){const L=a.accessorParents.get(M);D+=`:${g.get(L)}`}x[R=D]||(x[R]={usage:F,accessors:[]}),x[D].accessors.push(M)}const N=[],v=i.buffers.length;let C=0;for(const{usage:M,accessors:F}of Object.values(x))if(M===gt.ARRAY_BUFFER&&t.vertexLayout===it.INTERLEAVED){const D=h(F,v,C);C+=D.byteLength;for(const L of D.buffers)N.push(L)}else if(M===gt.ARRAY_BUFFER)for(const D of F){const L=h([D],v,C);C+=L.byteLength;for(const V of L.buffers)N.push(V)}else if(M===gt.SPARSE){const D=E(F,v,C);C+=D.byteLength;for(const L of D.buffers)N.push(L)}else if(M===gt.ELEMENT_ARRAY_BUFFER){const D=he.BufferViewTarget.ELEMENT_ARRAY_BUFFER,L=f(F,v,C,D);C+=L.byteLength;for(const V of L.buffers)N.push(V)}else{const D=f(F,v,C);C+=D.byteLength;for(const L of D.buffers)N.push(L)}if(a.imageBufferViews.length&&w===0){for(let M=0;M<a.imageBufferViews.length;M++)if(i.bufferViews[i.images[M].bufferView].byteOffset=C,C+=a.imageBufferViews[M].byteLength,N.push(a.imageBufferViews[M]),C%8){const F=8-C%8;C+=F,N.push(new Uint8Array(F))}}if(a.otherBufferViews.has(p))for(const M of a.otherBufferViews.get(p))i.bufferViews.push({buffer:v,byteOffset:C,byteLength:M.byteLength}),a.otherBufferViewsIndexMap.set(M,i.bufferViews.length-1),C+=M.byteLength,N.push(M);if(C){let M;t.format===ve.GLB?M=je:(M=a.bufferURIGenerator.createURI(p,"bin"),y.uri=M),y.byteLength=C,a.assignResourceURI(M,O.concat(N),!0)}i.buffers.push(y),a.bufferIndexMap.set(p,w)}),n.listAccessors().find(p=>!p.getBuffer())&&c.warn("Skipped writing one or more Accessors: no Buffer assigned."),l.filter(p=>p.prewriteTypes.includes(m.MATERIAL)).forEach(p=>p.prewrite(a,m.MATERIAL)),i.materials=n.listMaterials().map((p,w)=>{const y=a.createPropertyDef(p);if(p.getAlphaMode()!==ge.AlphaMode.OPAQUE&&(y.alphaMode=p.getAlphaMode()),p.getAlphaMode()===ge.AlphaMode.MASK&&(y.alphaCutoff=p.getAlphaCutoff()),p.getDoubleSided()&&(y.doubleSided=!0),y.pbrMetallicRoughness={},j.eq(p.getBaseColorFactor(),[1,1,1,1])||(y.pbrMetallicRoughness.baseColorFactor=p.getBaseColorFactor()),j.eq(p.getEmissiveFactor(),[0,0,0])||(y.emissiveFactor=p.getEmissiveFactor()),p.getRoughnessFactor()!==1&&(y.pbrMetallicRoughness.roughnessFactor=p.getRoughnessFactor()),p.getMetallicFactor()!==1&&(y.pbrMetallicRoughness.metallicFactor=p.getMetallicFactor()),p.getBaseColorTexture()){const A=p.getBaseColorTexture(),I=p.getBaseColorTextureInfo();y.pbrMetallicRoughness.baseColorTexture=a.createTextureInfoDef(A,I)}if(p.getEmissiveTexture()){const A=p.getEmissiveTexture(),I=p.getEmissiveTextureInfo();y.emissiveTexture=a.createTextureInfoDef(A,I)}if(p.getNormalTexture()){const A=p.getNormalTexture(),I=p.getNormalTextureInfo(),b=a.createTextureInfoDef(A,I);p.getNormalScale()!==1&&(b.scale=p.getNormalScale()),y.normalTexture=b}if(p.getOcclusionTexture()){const A=p.getOcclusionTexture(),I=p.getOcclusionTextureInfo(),b=a.createTextureInfoDef(A,I);p.getOcclusionStrength()!==1&&(b.strength=p.getOcclusionStrength()),y.occlusionTexture=b}if(p.getMetallicRoughnessTexture()){const A=p.getMetallicRoughnessTexture(),I=p.getMetallicRoughnessTextureInfo();y.pbrMetallicRoughness.metallicRoughnessTexture=a.createTextureInfoDef(A,I)}return a.materialIndexMap.set(p,w),y}),l.filter(p=>p.prewriteTypes.includes(m.MESH)).forEach(p=>p.prewrite(a,m.MESH)),i.meshes=n.listMeshes().map((p,w)=>{const y=a.createPropertyDef(p);let A=null;return y.primitives=p.listPrimitives().map(I=>{const b={attributes:{}};b.mode=I.getMode();const g=I.getMaterial();g&&(b.material=a.materialIndexMap.get(g)),Object.keys(I.getExtras()).length&&(b.extras=I.getExtras());const x=I.getIndices();x&&(b.indices=a.accessorIndexMap.get(x));for(const R of I.listSemantics())b.attributes[R]=a.accessorIndexMap.get(I.getAttribute(R));for(const R of I.listTargets()){const N={};for(const v of R.listSemantics())N[v]=a.accessorIndexMap.get(R.getAttribute(v));b.targets=b.targets||[],b.targets.push(N)}return I.listTargets().length&&!A&&(A=I.listTargets().map(R=>R.getName())),b}),p.getWeights().length&&(y.weights=p.getWeights()),A&&(y.extras=y.extras||{},y.extras.targetNames=A),a.meshIndexMap.set(p,w),y}),i.cameras=n.listCameras().map((p,w)=>{const y=a.createPropertyDef(p);if(y.type=p.getType(),y.type===Ue.Type.PERSPECTIVE){y.perspective={znear:p.getZNear(),zfar:p.getZFar(),yfov:p.getYFov()};const A=p.getAspectRatio();A!==null&&(y.perspective.aspectRatio=A)}else y.orthographic={znear:p.getZNear(),zfar:p.getZFar(),xmag:p.getXMag(),ymag:p.getYMag()};return a.cameraIndexMap.set(p,w),y}),i.nodes=n.listNodes().map((p,w)=>{const y=a.createPropertyDef(p);return j.eq(p.getTranslation(),[0,0,0])||(y.translation=p.getTranslation()),j.eq(p.getRotation(),[0,0,0,1])||(y.rotation=p.getRotation()),j.eq(p.getScale(),[1,1,1])||(y.scale=p.getScale()),p.getWeights().length&&(y.weights=p.getWeights()),a.nodeIndexMap.set(p,w),y}),i.skins=n.listSkins().map((p,w)=>{const y=a.createPropertyDef(p),A=p.getInverseBindMatrices();A&&(y.inverseBindMatrices=a.accessorIndexMap.get(A));const I=p.getSkeleton();return I&&(y.skeleton=a.nodeIndexMap.get(I)),y.joints=p.listJoints().map(b=>a.nodeIndexMap.get(b)),a.skinIndexMap.set(p,w),y}),n.listNodes().forEach((p,w)=>{const y=i.nodes[w],A=p.getMesh();A&&(y.mesh=a.meshIndexMap.get(A));const I=p.getCamera();I&&(y.camera=a.cameraIndexMap.get(I));const b=p.getSkin();b&&(y.skin=a.skinIndexMap.get(b)),p.listChildren().length>0&&(y.children=p.listChildren().map(g=>a.nodeIndexMap.get(g)))}),i.animations=n.listAnimations().map((p,w)=>{const y=a.createPropertyDef(p),A=new Map;return y.samplers=p.listSamplers().map((I,b)=>{const g=a.createPropertyDef(I);return g.input=a.accessorIndexMap.get(I.getInput()),g.output=a.accessorIndexMap.get(I.getOutput()),g.interpolation=I.getInterpolation(),A.set(I,b),g}),y.channels=p.listChannels().map(I=>{const b=a.createPropertyDef(I);return b.sampler=A.get(I.getSampler()),b.target={node:a.nodeIndexMap.get(I.getTargetNode()),path:I.getTargetPath()},b}),a.animationIndexMap.set(p,w),y}),i.scenes=n.listScenes().map((p,w)=>{const y=a.createPropertyDef(p);return y.nodes=p.listChildren().map(A=>a.nodeIndexMap.get(A)),a.sceneIndexMap.set(p,w),y});const T=n.getDefaultScene();return T&&(i.scene=n.listScenes().indexOf(T)),i.extensionsUsed=l.map(p=>p.extensionName),i.extensionsRequired=d.map(p=>p.extensionName),l.forEach(p=>p.write(a)),$n(i),o}}function $n(s){const e=[];for(const t in s){const r=s[t];(Array.isArray(r)&&r.length===0||r===null||r===""||r&&typeof r=="object"&&Object.keys(r).length===0)&&e.push(t)}for(const t of e)delete s[t]}var pt;(function(s){s[s.JSON=1313821514]="JSON",s[s.BIN=5130562]="BIN"})(pt||(pt={}));class qn{constructor(){this._logger=ne.DEFAULT_INSTANCE,this._extensions=new Set,this._dependencies={},this._vertexLayout=it.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this._logger=e,this}registerExtensions(e){for(const t of e)this._extensions.add(t),t.register();return this}registerDependencies(e){return Object.assign(this._dependencies,e),this}setVertexLayout(e){return this._vertexLayout=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const r=ns(t)?this._binaryToJSON(t):{json:JSON.parse(O.decodeText(t)),resources:{}};return await this._readResourcesExternal(r,this.dirname(e)),this._readResourcesInternal(r),r}async readJSON(e){return e=this._copyJSON(e),this._readResourcesInternal(e),Un.read(e,{extensions:Array.from(this._extensions),dependencies:this._dependencies,logger:this._logger})}async binaryToJSON(e){const t=this._binaryToJSON(O.assertView(e));this._readResourcesInternal(t);const r=t.json;if(r.buffers&&r.buffers.some(n=>Xn(t,n)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(r.images&&r.images.some(n=>Kn(t,n)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(O.assertView(e)))}async writeJSON(e,t={}){if(t.format===ve.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return zn.write(e,{format:t.format||ve.GLTF,basename:t.basename||"",logger:this._logger,vertexLayout:this._vertexLayout,dependencies:W({},this._dependencies),extensions:Array.from(this._extensions)})}async writeBinary(e){const{json:t,resources:r}=await this.writeJSON(e,{format:ve.GLB}),n=new Uint32Array([1179937895,2,12]),i=JSON.stringify(t),o=O.pad(O.encodeText(i),32),a=O.toView(new Uint32Array([o.byteLength,1313821514])),c=O.concat([a,o]);n[n.length-1]+=c.byteLength;const u=Object.values(r)[0];if(!u||!u.byteLength)return O.concat([O.toView(n),c]);const l=O.pad(u,0),d=O.toView(new Uint32Array([l.byteLength,5130562])),f=O.concat([d,l]);return n[n.length-1]+=f.byteLength,O.concat([O.toView(n),c,f])}async _readResourcesExternal(e,t){var r=this;const n=e.json.images||[],i=e.json.buffers||[],o=[...n,...i].map(async function(a){const c=a.uri;if(!c||c.match(/data:/))return Promise.resolve();e.resources[c]=await r.readURI(r.resolve(t,c),"view"),r.lastReadBytes+=e.resources[c].byteLength});await Promise.all(o)}_readResourcesInternal(e){function t(i){if(i.uri){if(i.uri in e.resources){O.assertView(e.resources[i.uri]);return}if(i.uri.match(/data:/)){const o=`__${Mn()}.${Pe.extension(i.uri)}`;e.resources[o]=O.createBufferFromDataURI(i.uri),i.uri=o}}}(e.json.images||[]).forEach(i=>{if(i.bufferView===void 0&&i.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(i)}),(e.json.buffers||[]).forEach(t)}_copyJSON(e){const{images:t,buffers:r}=e.json;return e={json:W({},e.json),resources:W({},e.resources)},t&&(e.json.images=t.map(n=>W({},n))),r&&(e.json.buffers=r.map(n=>W({},n))),e}_binaryToJSON(e){if(!ns(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==pt.JSON)throw new Error("Missing required GLB JSON chunk.");const r=20,n=t[0],i=O.decodeText(O.toView(e,r,n)),o=JSON.parse(i),a=r+n;if(e.byteLength<=a)return{json:o,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+a,2);if(c[1]!==pt.BIN)return{json:o,resources:{}};const u=c[0],l=O.toView(e,a+8,u);return{json:o,resources:{[je]:l}}}}function Xn(s,e){return e.uri!==void 0&&!(e.uri in s.resources)}function Kn(s,e){return e.uri!==void 0&&!(e.uri in s.resources)&&e.bufferView===void 0}function ns(s){if(s.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(s.buffer,s.byteOffset,3);return e[0]===1179937895&&e[1]===2}class Yn extends qn{constructor(e=Ke.DEFAULT_INIT){super(),this._fetchConfig=void 0,this._fetchConfig=e}async readURI(e,t){const r=await fetch(e,this._fetchConfig);switch(t){case"view":return new Uint8Array(await r.arrayBuffer());case"text":return r.text()}}resolve(e,t){return Ke.resolve(e,t)}dirname(e){return Ke.dirname(e)}}const Wn=0,Jn=0,Zn=0,Qn=2,er=0,tr=163,sr=166,nr=0,rr=2,ir=1,or=64,ar=0;function cr(){return{vkFormat:ar,typeSize:1,pixelWidth:0,pixelHeight:0,pixelDepth:0,layerCount:0,faceCount:1,levelCount:0,supercompressionScheme:Wn,levels:[],dataFormatDescriptor:[{vendorId:Zn,descriptorType:Jn,versionNumber:Qn,colorModel:er,colorPrimaries:ir,transferFunction:rr,flags:nr,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],keyValue:{},globalData:null}}class Ze{constructor(e,t,r,n){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,r),this._littleEndian=n,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),r=e+2**32*t;return this._offset+=8,r}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){const r=this._offset;let n=0;for(;this._dataView.getUint8(this._offset)!==t&&n<e;)n++,this._offset++;return n<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+r,n)}}const J=[171,75,84,88,32,50,48,187,13,10,26,10];function rs(s){return new TextDecoder().decode(s)}function Mt(s){const e=new Uint8Array(s.buffer,s.byteOffset,J.length);if(e[0]!==J[0]||e[1]!==J[1]||e[2]!==J[2]||e[3]!==J[3]||e[4]!==J[4]||e[5]!==J[5]||e[6]!==J[6]||e[7]!==J[7]||e[8]!==J[8]||e[9]!==J[9]||e[10]!==J[10]||e[11]!==J[11])throw new Error("Missing KTX 2.0 identifier.");const t=cr(),r=17*Uint32Array.BYTES_PER_ELEMENT,n=new Ze(s,J.length,r,!0);t.vkFormat=n._nextUint32(),t.typeSize=n._nextUint32(),t.pixelWidth=n._nextUint32(),t.pixelHeight=n._nextUint32(),t.pixelDepth=n._nextUint32(),t.layerCount=n._nextUint32(),t.faceCount=n._nextUint32(),t.levelCount=n._nextUint32(),t.supercompressionScheme=n._nextUint32();const i=n._nextUint32(),o=n._nextUint32(),a=n._nextUint32(),c=n._nextUint32(),u=n._nextUint64(),l=n._nextUint64(),d=Math.max(t.levelCount,1)*3*8,f=new Ze(s,J.length+r,d,!0);for(let Q=0,te=Math.max(t.levelCount,1);Q<te;Q++)t.levels.push({levelData:new Uint8Array(s.buffer,s.byteOffset+f._nextUint64(),f._nextUint64()),uncompressedByteLength:f._nextUint64()});const h=new Ze(s,i,o,!0);h._skip(4);const E=h._nextUint16(),_=h._nextUint16(),T=h._nextUint16(),p=h._nextUint16(),w=h._nextUint8(),y=h._nextUint8(),A=h._nextUint8(),I=h._nextUint8(),b=[h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8()],g=[h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8()],R={vendorId:E,descriptorType:_,versionNumber:T,colorModel:w,colorPrimaries:y,transferFunction:A,flags:I,texelBlockDimension:b,bytesPlane:g,samples:[]},C=(p/4-6)/4;for(let Q=0;Q<C;Q++){const te={bitOffset:h._nextUint16(),bitLength:h._nextUint8(),channelType:h._nextUint8(),samplePosition:[h._nextUint8(),h._nextUint8(),h._nextUint8(),h._nextUint8()],sampleLower:Number.NEGATIVE_INFINITY,sampleUpper:Number.POSITIVE_INFINITY};te.channelType&or?(te.sampleLower=h._nextInt32(),te.sampleUpper=h._nextInt32()):(te.sampleLower=h._nextUint32(),te.sampleUpper=h._nextUint32()),R.samples[Q]=te}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(R);const M=new Ze(s,a,c,!0);for(;M._offset<c;){const Q=M._nextUint32(),te=M._scan(Q),yt=rs(te);if(t.keyValue[yt]=M._nextUint8Array(Q-te.byteLength-1),yt.match(/^ktx/i)){const fn=rs(t.keyValue[yt]);t.keyValue[yt]=fn.substring(0,fn.lastIndexOf("\0"))}const Uo=Q%4?4-Q%4:0;M._skip(Uo)}if(l<=0)return t;const F=new Ze(s,u,l,!0),D=F._nextUint16(),L=F._nextUint16(),V=F._nextUint32(),Z=F._nextUint32(),K=F._nextUint32(),Pt=F._nextUint32(),$e=[];for(let Q=0,te=Math.max(t.levelCount,1);Q<te;Q++)$e.push({imageFlags:F._nextUint32(),rgbSliceByteOffset:F._nextUint32(),rgbSliceByteLength:F._nextUint32(),alphaSliceByteOffset:F._nextUint32(),alphaSliceByteLength:F._nextUint32()});const qe=u+F._offset,xt=qe+V,De=xt+Z,Vt=De+K,rt=new Uint8Array(s.buffer,s.byteOffset+qe,V),Do=new Uint8Array(s.buffer,s.byteOffset+xt,Z),Fo=new Uint8Array(s.buffer,s.byteOffset+De,K),Lo=new Uint8Array(s.buffer,s.byteOffset+Vt,Pt);return t.globalData={endpointCount:D,selectorCount:L,imageDescs:$e,endpointsData:rt,selectorsData:Do,tablesData:Fo,extendedData:Lo},t}const pe="EXT_mesh_gpu_instancing",q="EXT_meshopt_compression",Qe="EXT_texture_webp",et="EXT_texture_avif",H="KHR_draco_mesh_compression",ie="KHR_lights_punctual",de="KHR_materials_anisotropy",me="KHR_materials_clearcoat",Te="KHR_materials_diffuse_transmission",xe="KHR_materials_dispersion",ye="KHR_materials_emissive_strength",Ee="KHR_materials_ior",Ie="KHR_materials_iridescence",Re="KHR_materials_pbrSpecularGlossiness",_e="KHR_materials_sheen",Ae="KHR_materials_specular",be="KHR_materials_transmission",Oe="KHR_materials_unlit",Ne="KHR_materials_volume",X="KHR_materials_variants",is="KHR_mesh_quantization",tt="KHR_texture_basisu",Se="KHR_texture_transform",oe="KHR_xmp_json_ld",vt="INSTANCE_ATTRIBUTE";class os extends G{init(){this.extensionName=pe,this.propertyType="InstancedMesh",this.parentTypes=[m.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new fe})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:vt})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}os.EXTENSION_NAME=pe;class ur extends k{constructor(...e){super(...e),this.extensionName=pe,this.provideTypes=[m.NODE],this.prewriteTypes=[m.ACCESSOR]}createInstancedMesh(){return new os(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach((n,i)=>{if(!n.extensions||!n.extensions[pe])return;const o=n.extensions[pe],a=this.createInstancedMesh();for(const c in o.attributes)a.setAttribute(c,e.accessors[o.attributes[c]]);e.nodes[i].setExtension(pe,a)}),this}prewrite(e){e.accessorUsageGroupedByParent.add(vt);for(const t of this.properties)for(const r of t.listAttributes())e.addAccessorToUsageGroup(r,vt);return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach(r=>{const n=r.getExtension(pe);if(n){const i=e.nodeIndexMap.get(r),o=t.json.nodes[i],a={attributes:{}};n.listSemantics().forEach(c=>{const u=n.getAttribute(c);a.attributes[c]=e.accessorIndexMap.get(u)}),o.extensions=o.extensions||{},o.extensions[pe]=a}}),this}}ur.EXTENSION_NAME=pe;function we(){return we=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},we.apply(null,arguments)}var st;(function(s){s.QUANTIZE="quantize",s.FILTER="filter"})(st||(st={}));var Ge;(function(s){s.ATTRIBUTES="ATTRIBUTES",s.TRIANGLES="TRIANGLES",s.INDICES="INDICES"})(Ge||(Ge={}));var z;(function(s){s.NONE="NONE",s.OCTAHEDRAL="OCTAHEDRAL",s.QUATERNION="QUATERNION",s.EXPONENTIAL="EXPONENTIAL"})(z||(z={}));function fr(s){return!s.extensions||!s.extensions[q]?!1:!!s.extensions[q].fallback}const{BYTE:lr,SHORT:as,FLOAT:hr}=S.ComponentType,{encodeNormalizedInt:cs,decodeNormalizedInt:Ct}=j;function gr(s,e,t,r){const{filter:n,bits:i}=r,o={array:s.getArray(),byteStride:s.getElementSize()*s.getComponentSize(),componentType:s.getComponentType(),normalized:s.getNormalized()};if(t!==Ge.ATTRIBUTES)return o;if(n!==z.NONE){let a=s.getNormalized()?pr(s):new Float32Array(o.array);switch(n){case z.EXPONENTIAL:o.byteStride=s.getElementSize()*4,o.componentType=hr,o.normalized=!1,o.array=e.encodeFilterExp(a,s.getCount(),o.byteStride,i);break;case z.OCTAHEDRAL:o.byteStride=i>8?8:4,o.componentType=i>8?as:lr,o.normalized=!0,a=s.getElementSize()===3?mr(a):a,o.array=e.encodeFilterOct(a,s.getCount(),o.byteStride,i);break;case z.QUATERNION:o.byteStride=8,o.componentType=as,o.normalized=!0,o.array=e.encodeFilterQuat(a,s.getCount(),o.byteStride,i);break;default:throw new Error("Invalid filter.")}o.min=s.getMin([]),o.max=s.getMax([]),s.getNormalized()&&(o.min=o.min.map(c=>Ct(c,s.getComponentType())),o.max=o.max.map(c=>Ct(c,s.getComponentType()))),o.normalized&&(o.min=o.min.map(c=>cs(c,o.componentType)),o.max=o.max.map(c=>cs(c,o.componentType)))}else o.byteStride%4&&(o.array=dr(o.array,s.getElementSize()),o.byteStride=o.array.byteLength/s.getCount());return o}function pr(s){const e=s.getComponentType(),t=s.getArray(),r=new Float32Array(t.length);for(let n=0;n<t.length;n++)r[n]=Ct(t[n],e);return r}function dr(s,e){const r=O.padNumber(s.BYTES_PER_ELEMENT*e)/s.BYTES_PER_ELEMENT,n=s.length/e,i=new s.constructor(n*r);for(let o=0;o*e<s.length;o++)for(let a=0;a<e;a++)i[o*r+a]=s[o*e+a];return i}function mr(s){const e=new Float32Array(s.length*4/3);for(let t=0,r=s.length/3;t<r;t++)e[t*4]=s[t*3],e[t*4+1]=s[t*3+1],e[t*4+2]=s[t*3+2];return e}function Tr(s,e){return e===he.BufferViewUsage.ELEMENT_ARRAY_BUFFER?s.listParents().some(r=>r instanceof re&&r.getMode()===re.Mode.TRIANGLES)?Ge.TRIANGLES:Ge.INDICES:Ge.ATTRIBUTES}function xr(s,e){const t=e.getGraph().listParentEdges(s).filter(r=>!(r.getParent()instanceof wt));for(const r of t){const n=r.getName(),i=r.getAttributes().key||"",o=r.getParent().propertyType===m.PRIMITIVE_TARGET;if(n==="indices")return{filter:z.NONE};if(n==="attributes"){if(i==="POSITION")return{filter:z.NONE};if(i==="TEXCOORD_0")return{filter:z.NONE};if(i.startsWith("JOINTS_"))return{filter:z.NONE};if(i.startsWith("WEIGHTS_"))return{filter:z.NONE};if(i==="NORMAL"||i==="TANGENT")return o?{filter:z.NONE}:{filter:z.OCTAHEDRAL,bits:8}}if(n==="output"){const a=us(s);return a==="rotation"?{filter:z.QUATERNION,bits:16}:a==="translation"?{filter:z.EXPONENTIAL,bits:12}:a==="scale"?{filter:z.EXPONENTIAL,bits:12}:{filter:z.NONE}}if(n==="input")return{filter:z.NONE};if(n==="inverseBindMatrices")return{filter:z.NONE}}return{filter:z.NONE}}function us(s){for(const e of s.listParents())if(e instanceof Ve){for(const t of e.listParents())if(t instanceof Ye)return t.getTargetPath()}return null}const fs={method:st.QUANTIZE};class ls extends k{constructor(...e){super(...e),this.extensionName=q,this.prereadTypes=[m.BUFFER,m.PRIMITIVE],this.prewriteTypes=[m.BUFFER,m.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=fs,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return e==="meshopt.decoder"&&(this._decoder=t),e==="meshopt.encoder"&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=we({},fs,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${q}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${q}]: Missing WASM support.`)}return t===m.BUFFER?this._prereadBuffers(e):t===m.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((n,i)=>{if(!n.extensions||!n.extensions[q])return;const o=n.extensions[q],a=o.byteOffset||0,c=o.byteLength||0,u=o.count,l=o.byteStride,d=new Uint8Array(u*l),f=t.json.buffers[o.buffer],h=f.uri?t.resources[f.uri]:t.resources[je],E=O.toView(h,a,c);this._decoder.decodeGltfBuffer(d,u,l,E,o.mode,o.filter),e.bufferViews[i]=d})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(n=>{if(!n.extensions||!n.extensions[q])return;const i=n.extensions[q],o=e.buffers[i.buffer],a=e.buffers[n.buffer],c=t.json.buffers[n.buffer];fr(c)&&this._decoderFallbackBufferMap.set(a,o)})}read(e){if(!this.isRequired())return this;for(const[t,r]of this._decoderFallbackBufferMap){for(const n of t.listParents())n instanceof S&&n.swap(t,r);t.dispose()}return this}prewrite(e,t){return t===m.ACCESSOR?this._prewriteAccessors(e):t===m.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,r=this._encoder,n=this._encoderOptions,i=this.document.getGraph(),o=this.document.createBuffer(),a=this.document.getRoot().listBuffers().indexOf(o);let c=1;const u=new Map,l=d=>{for(const f of i.listParents(d)){if(f.propertyType===m.ROOT)continue;let h=u.get(d);return h===void 0&&u.set(d,h=c++),h}return-1};this._encoderFallbackBuffer=o,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const d of this.document.getRoot().listAccessors()){if(us(d)==="weights"||d.getSparse())continue;const f=e.getAccessorUsage(d),h=e.accessorUsageGroupedByParent.has(f)?l(d):null,E=Tr(d,f),_=n.method===st.FILTER?xr(d,this.document):{filter:z.NONE},T=gr(d,r,E,_),{array:p,byteStride:w}=T,y=d.getBuffer();if(!y)throw new Error(`${q}: Missing buffer for accessor.`);const A=this.document.getRoot().listBuffers().indexOf(y),I=[f,h,E,_.filter,w,A].join(":");let b=this._encoderBufferViews[I],g=this._encoderBufferViewData[I],x=this._encoderBufferViewAccessors[I];(!b||!g)&&(x=this._encoderBufferViewAccessors[I]=[],g=this._encoderBufferViewData[I]=[],b=this._encoderBufferViews[I]={buffer:a,target:he.USAGE_TO_TARGET[f],byteOffset:0,byteLength:0,byteStride:f===he.BufferViewUsage.ARRAY_BUFFER?w:void 0,extensions:{[q]:{buffer:A,byteOffset:0,byteLength:0,mode:E,filter:_.filter!==z.NONE?_.filter:void 0,byteStride:w,count:0}}});const R=e.createAccessorDef(d);R.componentType=T.componentType,R.normalized=T.normalized,R.byteOffset=b.byteLength,R.min&&T.min&&(R.min=T.min),R.max&&T.max&&(R.max=T.max),e.accessorIndexMap.set(d,t.accessors.length),t.accessors.push(R),x.push(R),g.push(new Uint8Array(p.buffer,p.byteOffset,p.byteLength)),b.byteLength+=p.byteLength,b.extensions.EXT_meshopt_compression.count+=d.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const r in this._encoderBufferViews){const n=this._encoderBufferViews[r],i=this._encoderBufferViewData[r],o=this.document.getRoot().listBuffers()[n.extensions[q].buffer],a=e.otherBufferViews.get(o)||[],{count:c,byteStride:u,mode:l}=n.extensions[q],d=O.concat(i),f=t.encodeGltfBuffer(d,c,u,l),h=O.pad(f);n.extensions[q].byteLength=f.byteLength,i.length=0,i.push(h),a.push(h),e.otherBufferViews.set(o,a)}}write(e){let t=0;for(const o in this._encoderBufferViews){const a=this._encoderBufferViews[o],c=this._encoderBufferViewData[o][0],u=e.otherBufferViewsIndexMap.get(c),l=this._encoderBufferViewAccessors[o];for(const E of l)E.bufferView=u;const d=e.jsonDoc.json.bufferViews[u],f=d.byteOffset||0;Object.assign(d,a),d.byteOffset=t;const h=d.extensions[q];h.byteOffset=f,t+=O.padNumber(a.byteLength)}const r=this._encoderFallbackBuffer,n=e.bufferIndexMap.get(r),i=e.jsonDoc.json.buffers[n];return i.byteLength=t,i.extensions={[q]:{fallback:!0}},r.dispose(),this}}ls.EXTENSION_NAME=q,ls.EncoderMethod=st;class yr{match(e){return e.length>=12&&O.decodeText(e.slice(4,12))==="ftypavif"}getSize(e){if(!this.match(e))return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=hs(t,0);if(!r)return null;let n=r.end;for(;r=hs(t,n);)if(r.type==="meta")n=r.start+4;else if(r.type==="iprp"||r.type==="ipco")n=r.start;else{if(r.type==="ispe")return[t.getUint32(r.start+4),t.getUint32(r.start+8)];if(r.type==="mdat")break;n=r.end}return null}getChannels(e){return 4}}class Er extends k{constructor(...e){super(...e),this.extensionName=et,this.prereadTypes=[m.TEXTURE]}static register(){le.registerFormat("image/avif",new yr)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(r=>{r.extensions&&r.extensions[et]&&(r.source=r.extensions[et].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getMimeType()==="image/avif"){const n=e.imageIndexMap.get(r);(t.json.textures||[]).forEach(o=>{o.source===n&&(o.extensions=o.extensions||{},o.extensions[et]={source:o.source},delete o.source)})}}),this}}Er.EXTENSION_NAME=et;function hs(s,e){if(s.byteLength<4+e)return null;const t=s.getUint32(e);return s.byteLength<t+e||t<8?null:{type:O.decodeText(new Uint8Array(s.buffer,s.byteOffset+e+4,4)),start:e+8,end:e+t}}class Ir{match(e){return e.length>=12&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80}getSize(e){const t=O.decodeText(e.slice(0,4)),r=O.decodeText(e.slice(8,12));if(t!=="RIFF"||r!=="WEBP")return null;const n=new DataView(e.buffer,e.byteOffset);let i=12;for(;i<n.byteLength;){const o=O.decodeText(new Uint8Array([n.getUint8(i),n.getUint8(i+1),n.getUint8(i+2),n.getUint8(i+3)])),a=n.getUint32(i+4,!0);if(o==="VP8 "){const c=n.getInt16(i+14,!0)&16383,u=n.getInt16(i+16,!0)&16383;return[c,u]}else if(o==="VP8L"){const c=n.getUint8(i+9),u=n.getUint8(i+10),l=n.getUint8(i+11),d=n.getUint8(i+12),f=1+((u&63)<<8|c),h=1+((d&15)<<10|l<<2|(u&192)>>6);return[f,h]}i+=8+a+a%2}return null}getChannels(e){return 4}}class Rr extends k{constructor(...e){super(...e),this.extensionName=Qe,this.prereadTypes=[m.TEXTURE]}static register(){le.registerFormat("image/webp",new Ir)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(r=>{r.extensions&&r.extensions[Qe]&&(r.source=r.extensions[Qe].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getMimeType()==="image/webp"){const n=e.imageIndexMap.get(r);(t.json.textures||[]).forEach(o=>{o.source===n&&(o.extensions=o.extensions||{},o.extensions[Qe]={source:o.source},delete o.source)})}}),this}}Rr.EXTENSION_NAME=Qe;let $,gs,ps;function _r(s,e){const t=new $.DecoderBuffer;try{if(t.Init(e,e.length),s.GetEncodedGeometryType(t)!==$.TRIANGULAR_MESH)throw new Error(`[${H}] Unknown geometry type.`);const n=new $.Mesh;if(!s.DecodeBufferToMesh(t,n).ok()||n.ptr===0)throw new Error(`[${H}] Decoding failure.`);return n}finally{$.destroy(t)}}function Ar(s,e){const r=e.num_faces()*3;let n,i;if(e.num_points()<=65534){const o=r*Uint16Array.BYTES_PER_ELEMENT;n=$._malloc(o),s.GetTrianglesUInt16Array(e,o,n),i=new Uint16Array($.HEAPU16.buffer,n,r).slice()}else{const o=r*Uint32Array.BYTES_PER_ELEMENT;n=$._malloc(o),s.GetTrianglesUInt32Array(e,o,n),i=new Uint32Array($.HEAPU32.buffer,n,r).slice()}return $._free(n),i}function br(s,e,t,r){const n=ps[r.componentType],i=gs[r.componentType],o=t.num_components(),c=e.num_points()*o,u=c*i.BYTES_PER_ELEMENT,l=$._malloc(u);s.GetAttributeDataArrayForAllPoints(e,t,n,u,l);const d=new i($.HEAPF32.buffer,l,c).slice();return $._free(l),d}function Nr(s){$=s,gs={[S.ComponentType.FLOAT]:Float32Array,[S.ComponentType.UNSIGNED_INT]:Uint32Array,[S.ComponentType.UNSIGNED_SHORT]:Uint16Array,[S.ComponentType.UNSIGNED_BYTE]:Uint8Array,[S.ComponentType.SHORT]:Int16Array,[S.ComponentType.BYTE]:Int8Array},ps={[S.ComponentType.FLOAT]:$.DT_FLOAT32,[S.ComponentType.UNSIGNED_INT]:$.DT_UINT32,[S.ComponentType.UNSIGNED_SHORT]:$.DT_UINT16,[S.ComponentType.UNSIGNED_BYTE]:$.DT_UINT8,[S.ComponentType.SHORT]:$.DT_INT16,[S.ComponentType.BYTE]:$.DT_INT8}}let ae;var nt;(function(s){s[s.EDGEBREAKER=1]="EDGEBREAKER",s[s.SEQUENTIAL=0]="SEQUENTIAL"})(nt||(nt={}));var ce;(function(s){s.POSITION="POSITION",s.NORMAL="NORMAL",s.COLOR="COLOR",s.TEX_COORD="TEX_COORD",s.GENERIC="GENERIC"})(ce||(ce={}));const ds={[ce.POSITION]:14,[ce.NORMAL]:10,[ce.COLOR]:8,[ce.TEX_COORD]:12,[ce.GENERIC]:12},ms={decodeSpeed:5,encodeSpeed:5,method:nt.EDGEBREAKER,quantizationBits:ds,quantizationVolume:"mesh"};function Sr(s){ae=s}function wr(s,e=ms){const t=we({},ms,e);t.quantizationBits=we({},ds,e.quantizationBits);const r=new ae.MeshBuilder,n=new ae.Mesh,i=new ae.ExpertEncoder(n),o={},a=new ae.DracoInt8Array,c=s.listTargets().length>0;let u=!1;for(const _ of s.listSemantics()){const T=s.getAttribute(_);if(T.getSparse()){u=!0;continue}const p=Mr(_),w=vr(r,T.getComponentType(),n,ae[p],T.getCount(),T.getElementSize(),T.getArray());if(w===-1)throw new Error(`Error compressing "${_}" attribute.`);if(o[_]=w,t.quantizationVolume==="mesh"||_!=="POSITION")i.SetAttributeQuantization(w,t.quantizationBits[p]);else if(typeof t.quantizationVolume=="object"){const{quantizationVolume:y}=t,A=Math.max(y.max[0]-y.min[0],y.max[1]-y.min[1],y.max[2]-y.min[2]);i.SetAttributeExplicitQuantization(w,t.quantizationBits[p],T.getElementSize(),y.min,A)}else throw new Error("Invalid quantization volume state.")}const l=s.getIndices();if(!l)throw new Ot("Primitive must have indices.");r.AddFacesToMesh(n,l.getCount()/3,l.getArray()),i.SetSpeedOptions(t.encodeSpeed,t.decodeSpeed),i.SetTrackEncodedProperties(!0),t.method===nt.SEQUENTIAL||c||u?i.SetEncodingMethod(ae.MESH_SEQUENTIAL_ENCODING):i.SetEncodingMethod(ae.MESH_EDGEBREAKER_ENCODING);const d=i.EncodeToDracoBuffer(!(c||u),a);if(d<=0)throw new Ot("Error applying Draco compression.");const f=new Uint8Array(d);for(let _=0;_<d;++_)f[_]=a.GetValue(_);const h=i.GetNumberOfEncodedPoints(),E=i.GetNumberOfEncodedFaces()*3;return ae.destroy(a),ae.destroy(n),ae.destroy(r),ae.destroy(i),{numVertices:h,numIndices:E,data:f,attributeIDs:o}}function Mr(s){return s==="POSITION"?ce.POSITION:s==="NORMAL"?ce.NORMAL:s.startsWith("COLOR_")?ce.COLOR:s.startsWith("TEXCOORD_")?ce.TEX_COORD:ce.GENERIC}function vr(s,e,t,r,n,i,o){switch(e){case S.ComponentType.UNSIGNED_BYTE:return s.AddUInt8Attribute(t,r,n,i,o);case S.ComponentType.BYTE:return s.AddInt8Attribute(t,r,n,i,o);case S.ComponentType.UNSIGNED_SHORT:return s.AddUInt16Attribute(t,r,n,i,o);case S.ComponentType.SHORT:return s.AddInt16Attribute(t,r,n,i,o);case S.ComponentType.UNSIGNED_INT:return s.AddUInt32Attribute(t,r,n,i,o);case S.ComponentType.FLOAT:return s.AddFloatAttribute(t,r,n,i,o);default:throw new Error(`Unexpected component type, "${e}".`)}}class Ot extends Error{}class Ts extends k{constructor(...e){super(...e),this.extensionName=H,this.prereadTypes=[m.PRIMITIVE],this.prewriteTypes=[m.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return e==="draco3d.decoder"&&(this._decoderModule=t,Nr(this._decoderModule)),e==="draco3d.encoder"&&(this._encoderModule=t,Sr(this._encoderModule)),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${H}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),r=e.jsonDoc,n=new Map;try{const i=r.json.meshes||[];for(const o of i)for(const a of o.primitives){if(!a.extensions||!a.extensions[H])continue;const c=a.extensions[H];let[u,l]=n.get(c.bufferView)||[];if(!l||!u){const d=r.json.bufferViews[c.bufferView],f=r.json.buffers[d.buffer],h=f.uri?r.resources[f.uri]:r.resources[je],E=d.byteOffset||0,_=d.byteLength,T=O.toView(h,E,_);u=new this._decoderModule.Decoder,l=_r(u,T),n.set(c.bufferView,[u,l]),t.debug(`[${H}] Decompressed ${T.byteLength} bytes.`)}for(const d in c.attributes){const f=e.jsonDoc.json.accessors[a.attributes[d]],h=u.GetAttributeByUniqueId(l,c.attributes[d]),E=br(u,l,h,f);e.accessors[a.attributes[d]].setArray(E)}a.indices!==void 0&&e.accessors[a.indices].setArray(Ar(u,l))}}finally{for(const[i,o]of Array.from(n.values()))this._decoderModule.destroy(i),this._decoderModule.destroy(o)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${H}] Please install extension dependency, "draco3d.encoder".`);const r=this.document.getLogger();r.debug(`[${H}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const n=Cr(this.document),i=new Map;let o="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?r.warn(`[${H}]: quantizationVolume=scene requires exactly 1 scene.`):o=Tn(this.document.getRoot().listScenes().pop()));for(const a of Array.from(n.keys())){const c=n.get(a);if(!c)throw new Error("Unexpected primitive.");if(i.has(c)){i.set(c,i.get(c));continue}const u=a.getIndices(),l=e.jsonDoc.json.accessors;let d;try{d=wr(a,we({},this._encoderOptions,{quantizationVolume:o}))}catch(E){if(E instanceof Ot){r.warn(`[${H}]: ${E.message} Skipping primitive compression.`);continue}throw E}i.set(c,d);const f=e.createAccessorDef(u);f.count=d.numIndices,e.accessorIndexMap.set(u,l.length),l.push(f),d.numVertices>65534&&S.getComponentSize(f.componentType)<=2?f.componentType=S.ComponentType.UNSIGNED_INT:d.numVertices>254&&S.getComponentSize(f.componentType)<=1&&(f.componentType=S.ComponentType.UNSIGNED_SHORT);for(const E of a.listSemantics()){const _=a.getAttribute(E);if(d.attributeIDs[E]===void 0)continue;const T=e.createAccessorDef(_);T.count=d.numVertices,e.accessorIndexMap.set(_,l.length),l.push(T)}const h=a.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(h)||e.otherBufferViews.set(h,[]),e.otherBufferViews.get(h).push(d.data)}return r.debug(`[${H}] Compressed ${n.size} primitives.`),e.extensionData[H]={primitiveHashMap:n,primitiveEncodingMap:i},this}write(e){const t=e.extensionData[H];for(const r of this.document.getRoot().listMeshes()){const n=e.jsonDoc.json.meshes[e.meshIndexMap.get(r)];for(let i=0;i<r.listPrimitives().length;i++){const o=r.listPrimitives()[i],a=n.primitives[i],c=t.primitiveHashMap.get(o);if(!c)continue;const u=t.primitiveEncodingMap.get(c);u&&(a.extensions=a.extensions||{},a.extensions[H]={bufferView:e.otherBufferViewsIndexMap.get(u.data),attributes:u.attributeIDs})}}if(!t.primitiveHashMap.size){const r=e.jsonDoc.json;r.extensionsUsed=(r.extensionsUsed||[]).filter(n=>n!==H),r.extensionsRequired=(r.extensionsRequired||[]).filter(n=>n!==H)}return this}}Ts.EXTENSION_NAME=H,Ts.EncoderMethod=nt;function Cr(s){const e=s.getLogger(),t=new Set,r=new Set;let n=0,i=0;for(const d of s.getRoot().listMeshes())for(const f of d.listPrimitives())f.getIndices()?f.getMode()!==re.Mode.TRIANGLES?(r.add(f),i++):t.add(f):(r.add(f),n++);n>0&&e.warn(`[${H}] Skipping Draco compression of ${n} non-indexed primitives.`),i>0&&e.warn(`[${H}] Skipping Draco compression of ${i} non-TRIANGLES primitives.`);const o=s.getRoot().listAccessors(),a=new Map;for(let d=0;d<o.length;d++)a.set(o[d],d);const c=new Map,u=new Set,l=new Map;for(const d of Array.from(t)){let f=xs(d,a);if(u.has(f)){l.set(d,f);continue}if(c.has(d.getIndices())){const h=d.getIndices(),E=h.clone();a.set(E,s.getRoot().listAccessors().length-1),d.swap(h,E)}for(const h of d.listAttributes())if(c.has(h)){const E=h.clone();a.set(E,s.getRoot().listAccessors().length-1),d.swap(h,E)}f=xs(d,a),u.add(f),l.set(d,f),c.set(d.getIndices(),f);for(const h of d.listAttributes())c.set(h,f)}for(const d of Array.from(c.keys())){const f=new Set(d.listParents().map(h=>h.propertyType));if(f.size!==2||!f.has(m.PRIMITIVE)||!f.has(m.ROOT))throw new Error(`[${H}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const d of Array.from(t)){const f=l.get(d),h=d.getIndices();if(c.get(h)!==f||d.listAttributes().some(E=>c.get(E)!==f))throw new Error(`[${H}] Draco primitives must share all, or no, accessors.`)}for(const d of Array.from(r)){const f=d.getIndices();if(c.has(f)||d.listAttributes().some(h=>c.has(h)))throw new Error(`[${H}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return l}function xs(s,e){const t=[],r=s.getIndices();t.push(e.get(r));for(const n of s.listAttributes())t.push(e.get(n));return t.sort().join("|")}class He extends G{init(){this.extensionName=ie,this.propertyType="Light",this.parentTypes=[m.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:He.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}He.EXTENSION_NAME=ie,He.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};class Or extends k{constructor(...e){super(...e),this.extensionName=ie}createLight(e=""){return new He(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ie])return this;const i=(t.json.extensions[ie].lights||[]).map(o=>{var a,c;const u=this.createLight().setName(o.name||"").setType(o.type);return o.color!==void 0&&u.setColor(o.color),o.intensity!==void 0&&u.setIntensity(o.intensity),o.range!==void 0&&u.setRange(o.range),((a=o.spot)==null?void 0:a.innerConeAngle)!==void 0&&u.setInnerConeAngle(o.spot.innerConeAngle),((c=o.spot)==null?void 0:c.outerConeAngle)!==void 0&&u.setOuterConeAngle(o.spot.outerConeAngle),u});return t.json.nodes.forEach((o,a)=>{if(!o.extensions||!o.extensions[ie])return;const c=o.extensions[ie];e.nodes[a].setExtension(ie,i[c.light])}),this}write(e){const t=e.jsonDoc;if(this.properties.size===0)return this;const r=[],n=new Map;for(const i of this.properties){const o=i,a={type:o.getType()};j.eq(o.getColor(),[1,1,1])||(a.color=o.getColor()),o.getIntensity()!==1&&(a.intensity=o.getIntensity()),o.getRange()!=null&&(a.range=o.getRange()),o.getName()&&(a.name=o.getName()),o.getType()===He.Type.SPOT&&(a.spot={innerConeAngle:o.getInnerConeAngle(),outerConeAngle:o.getOuterConeAngle()}),r.push(a),n.set(o,r.length-1)}return this.document.getRoot().listNodes().forEach(i=>{const o=i.getExtension(ie);if(o){const a=e.nodeIndexMap.get(i),c=t.json.nodes[a];c.extensions=c.extensions||{},c.extensions[ie]={light:n.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[ie]={lights:r},this}}Or.EXTENSION_NAME=ie;const{R:Dr,G:Fr,B:Lr}=se;class ys extends G{init(){this.extensionName=de,this.propertyType="Anisotropy",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new B(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(e){return this.set("anisotropyStrength",e)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(e){return this.set("anisotropyRotation",e)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(e){return this.setRef("anisotropyTexture",e,{channels:Dr|Fr|Lr})}}ys.EXTENSION_NAME=de;class Ur extends k{constructor(...e){super(...e),this.extensionName=de,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createAnisotropy(){return new ys(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[de]){const a=this.createAnisotropy();e.materials[o].setExtension(de,a);const c=i.extensions[de];if(c.anisotropyStrength!==void 0&&a.setAnisotropyStrength(c.anisotropyStrength),c.anisotropyRotation!==void 0&&a.setAnisotropyRotation(c.anisotropyRotation),c.anisotropyTexture!==void 0){const u=c.anisotropyTexture,l=e.textures[n[u.index].source];a.setAnisotropyTexture(l),e.setTextureInfo(a.getAnisotropyTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(de);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[de]={};if(n.getAnisotropyStrength()>0&&(a.anisotropyStrength=n.getAnisotropyStrength()),n.getAnisotropyRotation()!==0&&(a.anisotropyRotation=n.getAnisotropyRotation()),n.getAnisotropyTexture()){const c=n.getAnisotropyTexture(),u=n.getAnisotropyTextureInfo();a.anisotropyTexture=e.createTextureInfoDef(c,u)}}}),this}}Ur.EXTENSION_NAME=de;const{R:Es,G:Is,B:Br}=se;class Rs extends G{init(){this.extensionName=me,this.propertyType="Clearcoat",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new B(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new B(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new B(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:Es})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:Is})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:Es|Is|Br})}}Rs.EXTENSION_NAME=me;class jr extends k{constructor(...e){super(...e),this.extensionName=me,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createClearcoat(){return new Rs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[me]){const a=this.createClearcoat();e.materials[o].setExtension(me,a);const c=i.extensions[me];if(c.clearcoatFactor!==void 0&&a.setClearcoatFactor(c.clearcoatFactor),c.clearcoatRoughnessFactor!==void 0&&a.setClearcoatRoughnessFactor(c.clearcoatRoughnessFactor),c.clearcoatTexture!==void 0){const u=c.clearcoatTexture,l=e.textures[n[u.index].source];a.setClearcoatTexture(l),e.setTextureInfo(a.getClearcoatTextureInfo(),u)}if(c.clearcoatRoughnessTexture!==void 0){const u=c.clearcoatRoughnessTexture,l=e.textures[n[u.index].source];a.setClearcoatRoughnessTexture(l),e.setTextureInfo(a.getClearcoatRoughnessTextureInfo(),u)}if(c.clearcoatNormalTexture!==void 0){const u=c.clearcoatNormalTexture,l=e.textures[n[u.index].source];a.setClearcoatNormalTexture(l),e.setTextureInfo(a.getClearcoatNormalTextureInfo(),u),u.scale!==void 0&&a.setClearcoatNormalScale(u.scale)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(me);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[me]={clearcoatFactor:n.getClearcoatFactor(),clearcoatRoughnessFactor:n.getClearcoatRoughnessFactor()};if(n.getClearcoatTexture()){const c=n.getClearcoatTexture(),u=n.getClearcoatTextureInfo();a.clearcoatTexture=e.createTextureInfoDef(c,u)}if(n.getClearcoatRoughnessTexture()){const c=n.getClearcoatRoughnessTexture(),u=n.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=e.createTextureInfoDef(c,u)}if(n.getClearcoatNormalTexture()){const c=n.getClearcoatNormalTexture(),u=n.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=e.createTextureInfoDef(c,u),n.getClearcoatNormalScale()!==1&&(a.clearcoatNormalTexture.scale=n.getClearcoatNormalScale())}}}),this}}jr.EXTENSION_NAME=me;const{R:Pr,G:Vr,B:kr,A:Gr}=se;class _s extends G{init(){this.extensionName=Te,this.propertyType="DiffuseTransmission",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseTransmissionFactor:0,diffuseTransmissionTexture:null,diffuseTransmissionTextureInfo:new B(this.graph,"diffuseTransmissionTextureInfo"),diffuseTransmissionColorFactor:[1,1,1],diffuseTransmissionColorTexture:null,diffuseTransmissionColorTextureInfo:new B(this.graph,"diffuseTransmissionColorTextureInfo")})}getDiffuseTransmissionFactor(){return this.get("diffuseTransmissionFactor")}setDiffuseTransmissionFactor(e){return this.set("diffuseTransmissionFactor",e)}getDiffuseTransmissionTexture(){return this.getRef("diffuseTransmissionTexture")}getDiffuseTransmissionTextureInfo(){return this.getRef("diffuseTransmissionTexture")?this.getRef("diffuseTransmissionTextureInfo"):null}setDiffuseTransmissionTexture(e){return this.setRef("diffuseTransmissionTexture",e,{channels:Gr})}getDiffuseTransmissionColorFactor(){return this.get("diffuseTransmissionColorFactor")}setDiffuseTransmissionColorFactor(e){return this.set("diffuseTransmissionColorFactor",e)}getDiffuseTransmissionColorTexture(){return this.getRef("diffuseTransmissionColorTexture")}getDiffuseTransmissionColorTextureInfo(){return this.getRef("diffuseTransmissionColorTexture")?this.getRef("diffuseTransmissionColorTextureInfo"):null}setDiffuseTransmissionColorTexture(e){return this.setRef("diffuseTransmissionColorTexture",e,{channels:Pr|Vr|kr})}}_s.EXTENSION_NAME=Te;class Hr extends k{constructor(...e){super(...e),this.extensionName=Te}createDiffuseTransmission(){return new _s(this.document.getGraph())}read(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[Te]){const a=this.createDiffuseTransmission();e.materials[o].setExtension(Te,a);const c=i.extensions[Te];if(c.diffuseTransmissionFactor!==void 0&&a.setDiffuseTransmissionFactor(c.diffuseTransmissionFactor),c.diffuseTransmissionColorFactor!==void 0&&a.setDiffuseTransmissionColorFactor(c.diffuseTransmissionColorFactor),c.diffuseTransmissionTexture!==void 0){const u=c.diffuseTransmissionTexture,l=e.textures[n[u.index].source];a.setDiffuseTransmissionTexture(l),e.setTextureInfo(a.getDiffuseTransmissionTextureInfo(),u)}if(c.diffuseTransmissionColorTexture!==void 0){const u=c.diffuseTransmissionColorTexture,l=e.textures[n[u.index].source];a.setDiffuseTransmissionColorTexture(l),e.setTextureInfo(a.getDiffuseTransmissionColorTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;for(const r of this.document.getRoot().listMaterials()){const n=r.getExtension(Te);if(!n)continue;const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Te]={diffuseTransmissionFactor:n.getDiffuseTransmissionFactor(),diffuseTransmissionColorFactor:n.getDiffuseTransmissionColorFactor()};if(n.getDiffuseTransmissionTexture()){const c=n.getDiffuseTransmissionTexture(),u=n.getDiffuseTransmissionTextureInfo();a.diffuseTransmissionTexture=e.createTextureInfoDef(c,u)}if(n.getDiffuseTransmissionColorTexture()){const c=n.getDiffuseTransmissionColorTexture(),u=n.getDiffuseTransmissionColorTextureInfo();a.diffuseTransmissionColorTexture=e.createTextureInfoDef(c,u)}}return this}}Hr.EXTENSION_NAME=Te;class As extends G{init(){this.extensionName=xe,this.propertyType="Dispersion",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{dispersion:0})}getDispersion(){return this.get("dispersion")}setDispersion(e){return this.set("dispersion",e)}}As.EXTENSION_NAME=xe;class zr extends k{constructor(...e){super(...e),this.extensionName=xe,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createDispersion(){return new As(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((n,i)=>{if(n.extensions&&n.extensions[xe]){const o=this.createDispersion();e.materials[i].setExtension(xe,o);const a=n.extensions[xe];a.dispersion!==void 0&&o.setDispersion(a.dispersion)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(xe);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{},o.extensions[xe]={dispersion:n.getDispersion()}}}),this}}zr.EXTENSION_NAME=xe;class bs extends G{init(){this.extensionName=ye,this.propertyType="EmissiveStrength",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}}bs.EXTENSION_NAME=ye;class $r extends k{constructor(...e){super(...e),this.extensionName=ye,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createEmissiveStrength(){return new bs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((n,i)=>{if(n.extensions&&n.extensions[ye]){const o=this.createEmissiveStrength();e.materials[i].setExtension(ye,o);const a=n.extensions[ye];a.emissiveStrength!==void 0&&o.setEmissiveStrength(a.emissiveStrength)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(ye);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{},o.extensions[ye]={emissiveStrength:n.getEmissiveStrength()}}}),this}}$r.EXTENSION_NAME=ye;class Ns extends G{init(){this.extensionName=Ee,this.propertyType="IOR",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}Ns.EXTENSION_NAME=Ee;class qr extends k{constructor(...e){super(...e),this.extensionName=Ee,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createIOR(){return new Ns(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((n,i)=>{if(n.extensions&&n.extensions[Ee]){const o=this.createIOR();e.materials[i].setExtension(Ee,o);const a=n.extensions[Ee];a.ior!==void 0&&o.setIOR(a.ior)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(Ee);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{},o.extensions[Ee]={ior:n.getIOR()}}}),this}}qr.EXTENSION_NAME=Ee;const{R:Xr,G:Kr}=se;class Ss extends G{init(){this.extensionName=Ie,this.propertyType="Iridescence",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new B(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new B(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:Xr})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:Kr})}}Ss.EXTENSION_NAME=Ie;class Yr extends k{constructor(...e){super(...e),this.extensionName=Ie,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createIridescence(){return new Ss(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[Ie]){const a=this.createIridescence();e.materials[o].setExtension(Ie,a);const c=i.extensions[Ie];if(c.iridescenceFactor!==void 0&&a.setIridescenceFactor(c.iridescenceFactor),c.iridescenceIor!==void 0&&a.setIridescenceIOR(c.iridescenceIor),c.iridescenceThicknessMinimum!==void 0&&a.setIridescenceThicknessMinimum(c.iridescenceThicknessMinimum),c.iridescenceThicknessMaximum!==void 0&&a.setIridescenceThicknessMaximum(c.iridescenceThicknessMaximum),c.iridescenceTexture!==void 0){const u=c.iridescenceTexture,l=e.textures[n[u.index].source];a.setIridescenceTexture(l),e.setTextureInfo(a.getIridescenceTextureInfo(),u)}if(c.iridescenceThicknessTexture!==void 0){const u=c.iridescenceThicknessTexture,l=e.textures[n[u.index].source];a.setIridescenceThicknessTexture(l),e.setTextureInfo(a.getIridescenceThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(Ie);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Ie]={};if(n.getIridescenceFactor()>0&&(a.iridescenceFactor=n.getIridescenceFactor()),n.getIridescenceIOR()!==1.3&&(a.iridescenceIor=n.getIridescenceIOR()),n.getIridescenceThicknessMinimum()!==100&&(a.iridescenceThicknessMinimum=n.getIridescenceThicknessMinimum()),n.getIridescenceThicknessMaximum()!==400&&(a.iridescenceThicknessMaximum=n.getIridescenceThicknessMaximum()),n.getIridescenceTexture()){const c=n.getIridescenceTexture(),u=n.getIridescenceTextureInfo();a.iridescenceTexture=e.createTextureInfoDef(c,u)}if(n.getIridescenceThicknessTexture()){const c=n.getIridescenceThicknessTexture(),u=n.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}Yr.EXTENSION_NAME=Ie;const{R:ws,G:Ms,B:vs,A:Cs}=se;class Os extends G{init(){this.extensionName=Re,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new B(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new B(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:ws|Ms|vs|Cs,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:ws|Ms|vs|Cs})}}Os.EXTENSION_NAME=Re;class Wr extends k{constructor(...e){super(...e),this.extensionName=Re,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createPBRSpecularGlossiness(){return new Os(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[Re]){const a=this.createPBRSpecularGlossiness();e.materials[o].setExtension(Re,a);const c=i.extensions[Re];if(c.diffuseFactor!==void 0&&a.setDiffuseFactor(c.diffuseFactor),c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.glossinessFactor!==void 0&&a.setGlossinessFactor(c.glossinessFactor),c.diffuseTexture!==void 0){const u=c.diffuseTexture,l=e.textures[n[u.index].source];a.setDiffuseTexture(l),e.setTextureInfo(a.getDiffuseTextureInfo(),u)}if(c.specularGlossinessTexture!==void 0){const u=c.specularGlossinessTexture,l=e.textures[n[u.index].source];a.setSpecularGlossinessTexture(l),e.setTextureInfo(a.getSpecularGlossinessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(Re);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Re]={diffuseFactor:n.getDiffuseFactor(),specularFactor:n.getSpecularFactor(),glossinessFactor:n.getGlossinessFactor()};if(n.getDiffuseTexture()){const c=n.getDiffuseTexture(),u=n.getDiffuseTextureInfo();a.diffuseTexture=e.createTextureInfoDef(c,u)}if(n.getSpecularGlossinessTexture()){const c=n.getSpecularGlossinessTexture(),u=n.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=e.createTextureInfoDef(c,u)}}}),this}}Wr.EXTENSION_NAME=Re;const{R:Jr,G:Zr,B:Qr,A:ei}=se;class Ds extends G{init(){this.extensionName=_e,this.propertyType="Sheen",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new B(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new B(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:Jr|Zr|Qr,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:ei})}}Ds.EXTENSION_NAME=_e;class ti extends k{constructor(...e){super(...e),this.extensionName=_e,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createSheen(){return new Ds(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[_e]){const a=this.createSheen();e.materials[o].setExtension(_e,a);const c=i.extensions[_e];if(c.sheenColorFactor!==void 0&&a.setSheenColorFactor(c.sheenColorFactor),c.sheenRoughnessFactor!==void 0&&a.setSheenRoughnessFactor(c.sheenRoughnessFactor),c.sheenColorTexture!==void 0){const u=c.sheenColorTexture,l=e.textures[n[u.index].source];a.setSheenColorTexture(l),e.setTextureInfo(a.getSheenColorTextureInfo(),u)}if(c.sheenRoughnessTexture!==void 0){const u=c.sheenRoughnessTexture,l=e.textures[n[u.index].source];a.setSheenRoughnessTexture(l),e.setTextureInfo(a.getSheenRoughnessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(_e);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[_e]={sheenColorFactor:n.getSheenColorFactor(),sheenRoughnessFactor:n.getSheenRoughnessFactor()};if(n.getSheenColorTexture()){const c=n.getSheenColorTexture(),u=n.getSheenColorTextureInfo();a.sheenColorTexture=e.createTextureInfoDef(c,u)}if(n.getSheenRoughnessTexture()){const c=n.getSheenRoughnessTexture(),u=n.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=e.createTextureInfoDef(c,u)}}}),this}}ti.EXTENSION_NAME=_e;const{R:si,G:ni,B:ri,A:ii}=se;class Fs extends G{init(){this.extensionName=Ae,this.propertyType="Specular",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new B(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new B(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:ii})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:si|ni|ri,isColor:!0})}}Fs.EXTENSION_NAME=Ae;class oi extends k{constructor(...e){super(...e),this.extensionName=Ae,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createSpecular(){return new Fs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[Ae]){const a=this.createSpecular();e.materials[o].setExtension(Ae,a);const c=i.extensions[Ae];if(c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.specularColorFactor!==void 0&&a.setSpecularColorFactor(c.specularColorFactor),c.specularTexture!==void 0){const u=c.specularTexture,l=e.textures[n[u.index].source];a.setSpecularTexture(l),e.setTextureInfo(a.getSpecularTextureInfo(),u)}if(c.specularColorTexture!==void 0){const u=c.specularColorTexture,l=e.textures[n[u.index].source];a.setSpecularColorTexture(l),e.setTextureInfo(a.getSpecularColorTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(Ae);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Ae]={};if(n.getSpecularFactor()!==1&&(a.specularFactor=n.getSpecularFactor()),j.eq(n.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=n.getSpecularColorFactor()),n.getSpecularTexture()){const c=n.getSpecularTexture(),u=n.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(c,u)}if(n.getSpecularColorTexture()){const c=n.getSpecularColorTexture(),u=n.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(c,u)}}}),this}}oi.EXTENSION_NAME=Ae;const{R:ai}=se;class Ls extends G{init(){this.extensionName=be,this.propertyType="Transmission",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new B(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:ai})}}Ls.EXTENSION_NAME=be;class ci extends k{constructor(...e){super(...e),this.extensionName=be,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createTransmission(){return new Ls(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[be]){const a=this.createTransmission();e.materials[o].setExtension(be,a);const c=i.extensions[be];if(c.transmissionFactor!==void 0&&a.setTransmissionFactor(c.transmissionFactor),c.transmissionTexture!==void 0){const u=c.transmissionTexture,l=e.textures[n[u.index].source];a.setTransmissionTexture(l),e.setTextureInfo(a.getTransmissionTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(be);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[be]={transmissionFactor:n.getTransmissionFactor()};if(n.getTransmissionTexture()){const c=n.getTransmissionTexture(),u=n.getTransmissionTextureInfo();a.transmissionTexture=e.createTextureInfoDef(c,u)}}}),this}}ci.EXTENSION_NAME=be;class Us extends G{init(){this.extensionName=Oe,this.propertyType="Unlit",this.parentTypes=[m.MATERIAL]}}Us.EXTENSION_NAME=Oe;class ui extends k{constructor(...e){super(...e),this.extensionName=Oe,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createUnlit(){return new Us(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((r,n)=>{r.extensions&&r.extensions[Oe]&&e.materials[n].setExtension(Oe,this.createUnlit())}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{if(r.getExtension(Oe)){const n=e.materialIndexMap.get(r),i=t.json.materials[n];i.extensions=i.extensions||{},i.extensions[Oe]={}}}),this}}ui.EXTENSION_NAME=Oe;class Bs extends G{init(){this.extensionName=X,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:new P})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}Bs.EXTENSION_NAME=X;class js extends G{init(){this.extensionName=X,this.propertyType="MappingList",this.parentTypes=[m.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:new P})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}js.EXTENSION_NAME=X;class Dt extends G{init(){this.extensionName=X,this.propertyType="Variant",this.parentTypes=["MappingList"]}}Dt.EXTENSION_NAME=X;class fi extends k{constructor(...e){super(...e),this.extensionName=X}createMappingList(){return new js(this.document.getGraph())}createVariant(e=""){return new Dt(this.document.getGraph(),e)}createMapping(){return new Bs(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(e=>e instanceof Dt)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[X])return this;const i=(t.json.extensions[X].variants||[]).map(a=>this.createVariant().setName(a.name||""));return(t.json.meshes||[]).forEach((a,c)=>{const u=e.meshes[c];(a.primitives||[]).forEach((d,f)=>{if(!d.extensions||!d.extensions[X])return;const h=this.createMappingList(),E=d.extensions[X];for(const _ of E.mappings){const T=this.createMapping();_.material!==void 0&&T.setMaterial(e.materials[_.material]);for(const p of _.variants||[])T.addVariant(i[p]);h.addMapping(T)}u.listPrimitives()[f].setExtension(X,h)})}),this}write(e){const t=e.jsonDoc,r=this.listVariants();if(!r.length)return this;const n=[],i=new Map;for(const o of r)i.set(o,n.length),n.push(e.createPropertyDef(o));for(const o of this.document.getRoot().listMeshes()){const a=e.meshIndexMap.get(o);o.listPrimitives().forEach((c,u)=>{const l=c.getExtension(X);if(!l)return;const d=e.jsonDoc.json.meshes[a].primitives[u],f=l.listMappings().map(h=>{const E=e.createPropertyDef(h),_=h.getMaterial();return _&&(E.material=e.materialIndexMap.get(_)),E.variants=h.listVariants().map(T=>i.get(T)),E});d.extensions=d.extensions||{},d.extensions[X]={mappings:f}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[X]={variants:n},this}}fi.EXTENSION_NAME=X;const{G:li}=se;class Ps extends G{init(){this.extensionName=Ne,this.propertyType="Volume",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new B(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:li})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}}Ps.EXTENSION_NAME=Ne;class hi extends k{constructor(...e){super(...e),this.extensionName=Ne,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createVolume(){return new Ps(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,r=t.json.materials||[],n=t.json.textures||[];return r.forEach((i,o)=>{if(i.extensions&&i.extensions[Ne]){const a=this.createVolume();e.materials[o].setExtension(Ne,a);const c=i.extensions[Ne];if(c.thicknessFactor!==void 0&&a.setThicknessFactor(c.thicknessFactor),c.attenuationDistance!==void 0&&a.setAttenuationDistance(c.attenuationDistance),c.attenuationColor!==void 0&&a.setAttenuationColor(c.attenuationColor),c.thicknessTexture!==void 0){const u=c.thicknessTexture,l=e.textures[n[u.index].source];a.setThicknessTexture(l),e.setTextureInfo(a.getThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(r=>{const n=r.getExtension(Ne);if(n){const i=e.materialIndexMap.get(r),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Ne]={};if(n.getThicknessFactor()>0&&(a.thicknessFactor=n.getThicknessFactor()),Number.isFinite(n.getAttenuationDistance())&&(a.attenuationDistance=n.getAttenuationDistance()),j.eq(n.getAttenuationColor(),[1,1,1])||(a.attenuationColor=n.getAttenuationColor()),n.getThicknessTexture()){const c=n.getThicknessTexture(),u=n.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}hi.EXTENSION_NAME=Ne;class gi extends k{constructor(...e){super(...e),this.extensionName=is}read(e){return this}write(e){return this}}gi.EXTENSION_NAME=is;class pi{match(e){return e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10}getSize(e){const t=Mt(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const r=Mt(e).dataFormatDescriptor[0];if(r.colorModel===tr)return r.samples.length===2&&(r.samples[1].channelType&15)===15?4:3;if(r.colorModel===sr)return(r.samples[0].channelType&15)===3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${r.colorModel}".`)}getVRAMByteLength(e){const t=Mt(e),r=this.getChannels(e)>3;let n=0;for(let i=0;i<t.levels.length;i++){const o=t.levels[i];if(o.uncompressedByteLength)n+=o.uncompressedByteLength;else{const a=Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,i))),c=Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,i))),u=r?16:8;n+=a/4*(c/4)*u}}return n}}class di extends k{constructor(...e){super(...e),this.extensionName=tt,this.prereadTypes=[m.TEXTURE]}static register(){le.registerFormat("image/ktx2",new pi)}preread(e){return e.jsonDoc.json.textures.forEach(t=>{if(t.extensions&&t.extensions[tt]){const r=t.extensions[tt];t.source=r.source}}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(r=>{if(r.getMimeType()==="image/ktx2"){const n=e.imageIndexMap.get(r);t.json.textures.forEach(i=>{i.source===n&&(i.extensions=i.extensions||{},i.extensions[tt]={source:i.source},delete i.source)})}}),this}}di.EXTENSION_NAME=tt;class Vs extends G{init(){this.extensionName=Se,this.propertyType="Transform",this.parentTypes=[m.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}}Vs.EXTENSION_NAME=Se;class ks extends k{constructor(...e){super(...e),this.extensionName=Se}createTransform(){return new Vs(this.document.getGraph())}read(e){for(const[t,r]of Array.from(e.textureInfos.entries())){if(!r.extensions||!r.extensions[Se])continue;const n=this.createTransform(),i=r.extensions[Se];i.offset!==void 0&&n.setOffset(i.offset),i.rotation!==void 0&&n.setRotation(i.rotation),i.scale!==void 0&&n.setScale(i.scale),i.texCoord!==void 0&&n.setTexCoord(i.texCoord),t.setExtension(Se,n)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[r,n]of t){const i=r.getExtension(Se);if(!i)continue;n.extensions=n.extensions||{};const o={},a=j.eq;a(i.getOffset(),[0,0])||(o.offset=i.getOffset()),i.getRotation()!==0&&(o.rotation=i.getRotation()),a(i.getScale(),[1,1])||(o.scale=i.getScale()),i.getTexCoord()!=null&&(o.texCoord=i.getTexCoord()),n.extensions[Se]=o}return this}}ks.EXTENSION_NAME=Se;const mi=[m.ROOT,m.SCENE,m.NODE,m.MESH,m.MATERIAL,m.TEXTURE,m.ANIMATION];class Gs extends G{init(){this.extensionName=oe,this.propertyType="Packet",this.parentTypes=mi}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",we({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const r=we({},this.get("properties"));return t?r[e]=t:delete r[e],this.set("properties",r)}toJSONLD(){const e=Ft(this.get("context")),t=Ft(this.get("properties"));return we({"@context":e},t)}fromJSONLD(e){e=Ft(e);const t=e["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`${oe}: Missing context for term, "${e}".`)}}Gs.EXTENSION_NAME=oe;function Ft(s){return JSON.parse(JSON.stringify(s))}class Ti extends k{constructor(...e){super(...e),this.extensionName=oe}createPacket(){return new Gs(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const r=(t=e.jsonDoc.json.extensions)==null?void 0:t[oe];if(!r||!r.packets)return this;const n=e.jsonDoc.json,i=this.document.getRoot(),o=r.packets.map(u=>this.createPacket().fromJSONLD(u)),a=[[n.asset],n.scenes,n.nodes,n.meshes,n.materials,n.images,n.animations],c=[[i],i.listScenes(),i.listNodes(),i.listMeshes(),i.listMaterials(),i.listTextures(),i.listAnimations()];for(let u=0;u<a.length;u++){const l=a[u]||[];for(let d=0;d<l.length;d++){const f=l[d];if(f.extensions&&f.extensions[oe]){const h=f.extensions[oe];c[u][d].setExtension(oe,o[h.packet])}}}return this}write(e){const{json:t}=e.jsonDoc,r=[];for(const n of this.properties){r.push(n.toJSONLD());for(const i of n.listParents()){let o;switch(i.propertyType){case m.ROOT:o=t.asset;break;case m.SCENE:o=t.scenes[e.sceneIndexMap.get(i)];break;case m.NODE:o=t.nodes[e.nodeIndexMap.get(i)];break;case m.MESH:o=t.meshes[e.meshIndexMap.get(i)];break;case m.MATERIAL:o=t.materials[e.materialIndexMap.get(i)];break;case m.TEXTURE:o=t.images[e.imageIndexMap.get(i)];break;case m.ANIMATION:o=t.animations[e.animationIndexMap.get(i)];break;default:o=null,this.document.getLogger().warn(`[${oe}]: Unsupported parent property, "${i.propertyType}"`);break}o&&(o.extensions=o.extensions||{},o.extensions[oe]={packet:r.length-1})}}return r.length>0&&(t.extensions=t.extensions||{},t.extensions[oe]={packets:r}),this}}Ti.EXTENSION_NAME=oe;function xi(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}function yi(s){for(var e=new Array(s),t=0;t<s;++t)e[t]=t;return e}var Ei=yi;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var Ii=function(s){return s!=null&&(Hs(s)||Ri(s)||!!s._isBuffer)};function Hs(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function Ri(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&Hs(s.slice(0,0))}var _i=Ei,Ai=Ii,bi=typeof Float64Array<"u";function Ni(s,e){return s[0]-e[0]}function Si(){var s=this.stride,e=new Array(s.length),t;for(t=0;t<e.length;++t)e[t]=[Math.abs(s[t]),t];e.sort(Ni);var r=new Array(e.length);for(t=0;t<r.length;++t)r[t]=e[t][1];return r}function wi(s,e){var t=["View",e,"d",s].join("");e<0&&(t="View_Nil"+s);var r=s==="generic";if(e===-1){var n="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+s+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}",_=new Function(n);return _()}else if(e===0){var n="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+s+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(r?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(r?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}",_=new Function("TrivialArray",n);return _(dt[s][0])}var n=["'use strict'"],i=_i(e),o=i.map(function(T){return"i"+T}),a="this.offset+"+i.map(function(T){return"this.stride["+T+"]*i"+T}).join("+"),c=i.map(function(T){return"b"+T}).join(","),u=i.map(function(T){return"c"+T}).join(",");n.push("function "+t+"(a,"+c+","+u+",d){this.data=a","this.shape=["+c+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+s+"'","proto.dimension="+e),n.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+i.map(function(T){return"this.shape["+T+"]"}).join("*"),"}})"),e===1?n.push("proto.order=[0]"):(n.push("Object.defineProperty(proto,'order',{get:"),e<4?(n.push("function "+t+"_order(){"),e===2?n.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):e===3&&n.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):n.push("ORDER})")),n.push("proto.set=function "+t+"_set("+o.join(",")+",v){"),r?n.push("return this.data.set("+a+",v)}"):n.push("return this.data["+a+"]=v}"),n.push("proto.get=function "+t+"_get("+o.join(",")+"){"),r?n.push("return this.data.get("+a+")}"):n.push("return this.data["+a+"]}"),n.push("proto.index=function "+t+"_index(",o.join(),"){return "+a+"}"),n.push("proto.hi=function "+t+"_hi("+o.join(",")+"){return new "+t+"(this.data,"+i.map(function(T){return["(typeof i",T,"!=='number'||i",T,"<0)?this.shape[",T,"]:i",T,"|0"].join("")}).join(",")+","+i.map(function(T){return"this.stride["+T+"]"}).join(",")+",this.offset)}");var l=i.map(function(T){return"a"+T+"=this.shape["+T+"]"}),d=i.map(function(T){return"c"+T+"=this.stride["+T+"]"});n.push("proto.lo=function "+t+"_lo("+o.join(",")+"){var b=this.offset,d=0,"+l.join(",")+","+d.join(","));for(var f=0;f<e;++f)n.push("if(typeof i"+f+"==='number'&&i"+f+">=0){d=i"+f+"|0;b+=c"+f+"*d;a"+f+"-=d}");n.push("return new "+t+"(this.data,"+i.map(function(T){return"a"+T}).join(",")+","+i.map(function(T){return"c"+T}).join(",")+",b)}"),n.push("proto.step=function "+t+"_step("+o.join(",")+"){var "+i.map(function(T){return"a"+T+"=this.shape["+T+"]"}).join(",")+","+i.map(function(T){return"b"+T+"=this.stride["+T+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var f=0;f<e;++f)n.push("if(typeof i"+f+"==='number'){d=i"+f+"|0;if(d<0){c+=b"+f+"*(a"+f+"-1);a"+f+"=ceil(-a"+f+"/d)}else{a"+f+"=ceil(a"+f+"/d)}b"+f+"*=d}");n.push("return new "+t+"(this.data,"+i.map(function(T){return"a"+T}).join(",")+","+i.map(function(T){return"b"+T}).join(",")+",c)}");for(var h=new Array(e),E=new Array(e),f=0;f<e;++f)h[f]="a[i"+f+"]",E[f]="b[i"+f+"]";n.push("proto.transpose=function "+t+"_transpose("+o+"){"+o.map(function(T,p){return T+"=("+T+"===undefined?"+p+":"+T+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+h.join(",")+","+E.join(",")+",this.offset)}"),n.push("proto.pick=function "+t+"_pick("+o+"){var a=[],b=[],c=this.offset");for(var f=0;f<e;++f)n.push("if(typeof i"+f+"==='number'&&i"+f+">=0){c=(c+this.stride["+f+"]*i"+f+")|0}else{a.push(this.shape["+f+"]);b.push(this.stride["+f+"])}");n.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),n.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+i.map(function(T){return"shape["+T+"]"}).join(",")+","+i.map(function(T){return"stride["+T+"]"}).join(",")+",offset)}");var _=new Function("CTOR_LIST","ORDER",n.join(`
`));return _(dt[s],Si)}function Mi(s){if(Ai(s))return"buffer";if(bi)switch(Object.prototype.toString.call(s)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(s)?"array":"generic"}var dt={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function vi(s,e,t,r){if(s===void 0){var u=dt.array[0];return u([])}else typeof s=="number"&&(s=[s]);e===void 0&&(e=[s.length]);var n=e.length;if(t===void 0){t=new Array(n);for(var i=n-1,o=1;i>=0;--i)t[i]=o,o*=e[i]}if(r===void 0){r=0;for(var i=0;i<n;++i)t[i]<0&&(r-=(e[i]-1)*t[i])}for(var a=Mi(s),c=dt[a];c.length<=n+1;)c.push(wi(a,c.length-1));var u=c[n+1];return u(s,e,t,r)}var Ci=vi,Oi=xi(Ci),Di={};function Fi(s,e){for(var t=1,r=s.length,n=s[0],i=s[0],o=1;o<r;++o)if(i=n,n=s[o],e(n,i)){if(o===t){t++;continue}s[t++]=n}return s.length=t,s}function Li(s){for(var e=1,t=s.length,r=s[0],n=s[0],i=1;i<t;++i,n=r)if(n=r,r=s[i],r!==n){if(i===e){e++;continue}s[e++]=r}return s.length=e,s}function Ui(s,e,t){return s.length===0?s:e?(t||s.sort(e),Fi(s,e)):(t||s.sort(),Li(s))}var Bi=Ui,ji=Bi;function zs(s,e,t){var r=s.length,n=e.arrayArgs.length,i=e.indexArgs.length>0,o=[],a=[],c=0,u=0,l,d;for(l=0;l<r;++l)a.push(["i",l,"=0"].join(""));for(d=0;d<n;++d)for(l=0;l<r;++l)u=c,c=s[l],l===0?a.push(["d",d,"s",l,"=t",d,"p",c].join("")):a.push(["d",d,"s",l,"=(t",d,"p",c,"-s",u,"*t",d,"p",u,")"].join(""));for(a.length>0&&o.push("var "+a.join(",")),l=r-1;l>=0;--l)c=s[l],o.push(["for(i",l,"=0;i",l,"<s",c,";++i",l,"){"].join(""));for(o.push(t),l=0;l<r;++l){for(u=c,c=s[l],d=0;d<n;++d)o.push(["p",d,"+=d",d,"s",l].join(""));i&&(l>0&&o.push(["index[",u,"]-=s",u].join("")),o.push(["++index[",c,"]"].join(""))),o.push("}")}return o.join(`
`)}function Pi(s,e,t,r){for(var n=e.length,i=t.arrayArgs.length,o=t.blockSize,a=t.indexArgs.length>0,c=[],u=0;u<i;++u)c.push(["var offset",u,"=p",u].join(""));for(var u=s;u<n;++u)c.push(["for(var j"+u+"=SS[",e[u],"]|0;j",u,">0;){"].join("")),c.push(["if(j",u,"<",o,"){"].join("")),c.push(["s",e[u],"=j",u].join("")),c.push(["j",u,"=0"].join("")),c.push(["}else{s",e[u],"=",o].join("")),c.push(["j",u,"-=",o,"}"].join("")),a&&c.push(["index[",e[u],"]=j",u].join(""));for(var u=0;u<i;++u){for(var l=["offset"+u],d=s;d<n;++d)l.push(["j",d,"*t",u,"p",e[d]].join(""));c.push(["p",u,"=(",l.join("+"),")"].join(""))}c.push(zs(e,t,r));for(var u=s;u<n;++u)c.push("}");return c.join(`
`)}function Vi(s){for(var e=0,t=s[0].length;e<t;){for(var r=1;r<s.length;++r)if(s[r][e]!==s[0][e])return e;++e}return e}function Lt(s,e,t){for(var r=s.body,n=[],i=[],o=0;o<s.args.length;++o){var a=s.args[o];if(!(a.count<=0)){var c=new RegExp(a.name,"g"),u="",l=e.arrayArgs.indexOf(o);switch(e.argTypes[o]){case"offset":var d=e.offsetArgIndex.indexOf(o),f=e.offsetArgs[d];l=f.array,u="+q"+d;case"array":u="p"+l+u;var h="l"+o,E="a"+l;if(e.arrayBlockIndices[l]===0)a.count===1?t[l]==="generic"?a.lvalue?(n.push(["var ",h,"=",E,".get(",u,")"].join("")),r=r.replace(c,h),i.push([E,".set(",u,",",h,")"].join(""))):r=r.replace(c,[E,".get(",u,")"].join("")):r=r.replace(c,[E,"[",u,"]"].join("")):t[l]==="generic"?(n.push(["var ",h,"=",E,".get(",u,")"].join("")),r=r.replace(c,h),a.lvalue&&i.push([E,".set(",u,",",h,")"].join(""))):(n.push(["var ",h,"=",E,"[",u,"]"].join("")),r=r.replace(c,h),a.lvalue&&i.push([E,"[",u,"]=",h].join("")));else{for(var _=[a.name],T=[u],p=0;p<Math.abs(e.arrayBlockIndices[l]);p++)_.push("\\s*\\[([^\\]]+)\\]"),T.push("$"+(p+1)+"*t"+l+"b"+p);if(c=new RegExp(_.join(""),"g"),u=T.join("+"),t[l]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");r=r.replace(c,[E,"[",u,"]"].join(""))}break;case"scalar":r=r.replace(c,"Y"+e.scalarArgs.indexOf(o));break;case"index":r=r.replace(c,"index");break;case"shape":r=r.replace(c,"shape");break}}}return[n.join(`
`),r,i.join(`
`)].join(`
`).trim()}function ki(s){for(var e=new Array(s.length),t=!0,r=0;r<s.length;++r){var n=s[r],i=n.match(/\d+/);i?i=i[0]:i="",n.charAt(0)===0?e[r]="u"+n.charAt(1)+i:e[r]=n.charAt(0)+i,r>0&&(t=t&&e[r]===e[r-1])}return t?e[0]:e.join("")}function Gi(s,e){for(var t=e[1].length-Math.abs(s.arrayBlockIndices[0])|0,r=new Array(s.arrayArgs.length),n=new Array(s.arrayArgs.length),i=0;i<s.arrayArgs.length;++i)n[i]=e[2*i],r[i]=e[2*i+1];for(var o=[],a=[],c=[],u=[],l=[],i=0;i<s.arrayArgs.length;++i){s.arrayBlockIndices[i]<0?(c.push(0),u.push(t),o.push(t),a.push(t+s.arrayBlockIndices[i])):(c.push(s.arrayBlockIndices[i]),u.push(s.arrayBlockIndices[i]+t),o.push(0),a.push(s.arrayBlockIndices[i]));for(var d=[],f=0;f<r[i].length;f++)c[i]<=r[i][f]&&r[i][f]<u[i]&&d.push(r[i][f]-c[i]);l.push(d)}for(var h=["SS"],E=["'use strict'"],_=[],f=0;f<t;++f)_.push(["s",f,"=SS[",f,"]"].join(""));for(var i=0;i<s.arrayArgs.length;++i){h.push("a"+i),h.push("t"+i),h.push("p"+i);for(var f=0;f<t;++f)_.push(["t",i,"p",f,"=t",i,"[",c[i]+f,"]"].join(""));for(var f=0;f<Math.abs(s.arrayBlockIndices[i]);++f)_.push(["t",i,"b",f,"=t",i,"[",o[i]+f,"]"].join(""))}for(var i=0;i<s.scalarArgs.length;++i)h.push("Y"+i);if(s.shapeArgs.length>0&&_.push("shape=SS.slice(0)"),s.indexArgs.length>0){for(var T=new Array(t),i=0;i<t;++i)T[i]="0";_.push(["index=[",T.join(","),"]"].join(""))}for(var i=0;i<s.offsetArgs.length;++i){for(var p=s.offsetArgs[i],w=[],f=0;f<p.offset.length;++f)p.offset[f]!==0&&(p.offset[f]===1?w.push(["t",p.array,"p",f].join("")):w.push([p.offset[f],"*t",p.array,"p",f].join("")));w.length===0?_.push("q"+i+"=0"):_.push(["q",i,"=",w.join("+")].join(""))}var y=ji([].concat(s.pre.thisVars).concat(s.body.thisVars).concat(s.post.thisVars));_=_.concat(y),_.length>0&&E.push("var "+_.join(","));for(var i=0;i<s.arrayArgs.length;++i)E.push("p"+i+"|=0");s.pre.body.length>3&&E.push(Lt(s.pre,s,n));var A=Lt(s.body,s,n),I=Vi(l);I<t?E.push(Pi(I,l[0],s,A)):E.push(zs(l[0],s,A)),s.post.body.length>3&&E.push(Lt(s.post,s,n)),s.debug&&console.log("-----Generated cwise routine for ",e,`:
`+E.join(`
`)+`
----------`);var b=[s.funcName||"unnamed","_cwise_loop_",r[0].join("s"),"m",I,ki(n)].join(""),g=new Function(["function ",b,"(",h.join(","),"){",E.join(`
`),"} return ",b].join(""));return g()}var Hi=Gi,zi=Hi;function $i(s){var e=["'use strict'","var CACHED={}"],t=[],r=s.funcName+"_cwise_thunk";e.push(["return function ",r,"(",s.shimArgs.join(","),"){"].join(""));for(var n=[],i=[],o=[["array",s.arrayArgs[0],".shape.slice(",Math.max(0,s.arrayBlockIndices[0]),s.arrayBlockIndices[0]<0?","+s.arrayBlockIndices[0]+")":")"].join("")],a=[],c=[],u=0;u<s.arrayArgs.length;++u){var l=s.arrayArgs[u];t.push(["t",l,"=array",l,".dtype,","r",l,"=array",l,".order"].join("")),n.push("t"+l),n.push("r"+l),i.push("t"+l),i.push("r"+l+".join()"),o.push("array"+l+".data"),o.push("array"+l+".stride"),o.push("array"+l+".offset|0"),u>0&&(a.push("array"+s.arrayArgs[0]+".shape.length===array"+l+".shape.length+"+(Math.abs(s.arrayBlockIndices[0])-Math.abs(s.arrayBlockIndices[u]))),c.push("array"+s.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,s.arrayBlockIndices[0])+"]===array"+l+".shape[shapeIndex+"+Math.max(0,s.arrayBlockIndices[u])+"]"))}s.arrayArgs.length>1&&(e.push("if (!("+a.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+s.arrayArgs[0]+".shape.length-"+Math.abs(s.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),e.push("if (!("+c.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}"));for(var u=0;u<s.scalarArgs.length;++u)o.push("scalar"+s.scalarArgs[u]);t.push(["type=[",i.join(","),"].join()"].join("")),t.push("proc=CACHED[type]"),e.push("var "+t.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",n.join(","),"])}","return proc(",o.join(","),")}"].join("")),s.debug&&console.log(`-----Generated thunk:
`+e.join(`
`)+`
----------`);var d=new Function("compile",e.join(`
`));return d(zi.bind(void 0,s))}var qi=$i,Xi=qi;function Ki(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function Yi(s){var e=new Ki;e.pre=s.pre,e.body=s.body,e.post=s.post;var t=s.args.slice(0);e.argTypes=t;for(var r=0;r<t.length;++r){var n=t[r];if(n==="array"||typeof n=="object"&&n.blockIndices){if(e.argTypes[r]="array",e.arrayArgs.push(r),e.arrayBlockIndices.push(n.blockIndices?n.blockIndices:0),e.shimArgs.push("array"+r),r<e.pre.args.length&&e.pre.args[r].count>0)throw new Error("cwise: pre() block may not reference array args");if(r<e.post.args.length&&e.post.args[r].count>0)throw new Error("cwise: post() block may not reference array args")}else if(n==="scalar")e.scalarArgs.push(r),e.shimArgs.push("scalar"+r);else if(n==="index"){if(e.indexArgs.push(r),r<e.pre.args.length&&e.pre.args[r].count>0)throw new Error("cwise: pre() block may not reference array index");if(r<e.body.args.length&&e.body.args[r].lvalue)throw new Error("cwise: body() block may not write to array index");if(r<e.post.args.length&&e.post.args[r].count>0)throw new Error("cwise: post() block may not reference array index")}else if(n==="shape"){if(e.shapeArgs.push(r),r<e.pre.args.length&&e.pre.args[r].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(r<e.body.args.length&&e.body.args[r].lvalue)throw new Error("cwise: body() block may not write to array shape");if(r<e.post.args.length&&e.post.args[r].lvalue)throw new Error("cwise: post() block may not write to array shape")}else if(typeof n=="object"&&n.offset)e.argTypes[r]="offset",e.offsetArgs.push({array:n.array,offset:n.offset}),e.offsetArgIndex.push(r);else throw new Error("cwise: Unknown argument type "+t[r])}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>t.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>t.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>t.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!s.printCode||!!s.debug,e.funcName=s.funcName||"cwise",e.blockSize=s.blockSize||64,Xi(e)}var Wi=Yi;(function(s){var e=Wi,t={body:"",args:[],thisVars:[],localVars:[]};function r(f){if(!f)return t;for(var h=0;h<f.args.length;++h){var E=f.args[h];h===0?f.args[h]={name:E,lvalue:!0,rvalue:!!f.rvalue,count:f.count||1}:f.args[h]={name:E,lvalue:!1,rvalue:!0,count:1}}return f.thisVars||(f.thisVars=[]),f.localVars||(f.localVars=[]),f}function n(f){return e({args:f.args,pre:r(f.pre),body:r(f.body),post:r(f.proc),funcName:f.funcName})}function i(f){for(var h=[],E=0;E<f.args.length;++E)h.push("a"+E);var _=new Function("P",["return function ",f.funcName,"_ndarrayops(",h.join(","),") {P(",h.join(","),");return a0}"].join(""));return _(n(f))}var o={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};(function(){for(var f in o){var h=o[f];s[f]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+h+"c"},funcName:f}),s[f+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a"+h+"=b"},funcName:f+"eq"}),s[f+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+h+"s"},funcName:f+"s"}),s[f+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a"+h+"=s"},funcName:f+"seq"})}})();var a={not:"!",bnot:"~",neg:"-",recip:"1.0/"};(function(){for(var f in a){var h=a[f];s[f]=i({args:["array","array"],body:{args:["a","b"],body:"a="+h+"b"},funcName:f}),s[f+"eq"]=i({args:["array"],body:{args:["a"],body:"a="+h+"a"},funcName:f+"eq"})}})();var c={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};(function(){for(var f in c){var h=c[f];s[f]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+h+"c"},funcName:f}),s[f+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+h+"s"},funcName:f+"s"}),s[f+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a=a"+h+"b"},funcName:f+"eq"}),s[f+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+h+"s"},funcName:f+"seq"})}})();var u=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];(function(){for(var f=0;f<u.length;++f){var h=u[f];s[h]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:h}),s[h+"eq"]=i({args:["array"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},funcName:h+"eq"})}})();var l=["max","min","atan2","pow"];(function(){for(var f=0;f<l.length;++f){var h=l[f];s[h]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:h}),s[h+"s"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:h+"s"}),s[h+"eq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:h+"eq"}),s[h+"seq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:h+"seq"})}})();var d=["atan2","pow"];(function(){for(var f=0;f<d.length;++f){var h=d[f];s[h+"op"]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:h+"op"}),s[h+"ops"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:h+"ops"}),s[h+"opeq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:h+"opeq"}),s[h+"opseq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+h,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:h+"opseq"})}})(),s.any=e({args:["array"],pre:t,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),s.all=e({args:["array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),s.sum=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),s.prod=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),s.norm2squared=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),s.norm2=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),s.norminf=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),s.norm1=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),s.sup=e({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),s.inf=e({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),s.argmin=e({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),s.argmax=e({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),s.random=i({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),s.assign=i({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),s.assigns=i({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),s.equals=e({args:["array","array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})})(Di);function Ji(s,e){if(!(s instanceof Uint8Array))throw new Error("[ndarray-pixels] Input must be Uint8Array or Buffer.");const t=new Blob([s],{type:e});return createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(r=>{const i=new OffscreenCanvas(r.width,r.height).getContext("2d");i.drawImage(r,0,0);const o=i.getImageData(0,0,r.width,r.height);return Oi(new Uint8Array(o.data),[r.width,r.height,4],[4,4*r.width,1],0)})}async function Zi(s,e){return Ji(s,e)}function mt(){return mt=Object.assign?Object.assign.bind():function(s){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(s[r]=t[r])}return s},mt.apply(null,arguments)}const{POINTS:Bo,LINES:jo,LINE_STRIP:Po,LINE_LOOP:Vo,TRIANGLES:ko,TRIANGLE_STRIP:Go,TRIANGLE_FAN:Ho}=re.Mode;function $s(s,e){return Object.defineProperty(e,"name",{value:s}),e}function Qi(s,e){const t=mt({},s);for(const r in e)e[r]!==void 0&&(t[r]=e[r]);return t}function qs(s){for(const e in s)return!1;return!0}var Tt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,e=arguments.length;e--;)s+=arguments[e]*arguments[e];return Math.sqrt(s)});var Xs;(function(s){s.RENDER="render",s.RENDER_CACHED="render-cached",s.UPLOAD="upload",s.UPLOAD_NAIVE="upload-naive",s.DISTINCT="distinct",s.DISTINCT_POSITION="distinct-position",s.UNUSED="unused"})(Xs||(Xs={}));function eo(){var s=new Tt(3);return Tt!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function to(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s}var so=to;(function(){var s=eo();return function(e,t,r,n,i,o){var a,c;for(t||(t=3),r||(r=0),n?c=Math.min(n*t+r,e.length):c=e.length,a=r;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();const{FLOAT:zo}=S.ComponentType,{LINES:$o,LINE_STRIP:qo,LINE_LOOP:Xo,TRIANGLES:Ko,TRIANGLE_STRIP:Yo,TRIANGLE_FAN:Wo}=re.Mode;m.ACCESSOR,m.MESH,m.TEXTURE,m.MATERIAL,m.SKIN;const{TEXTURE_INFO:Jo,ROOT:Zo}=m;function Ks(){var s=new Tt(4);return Tt!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function no(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s[3]=e[3]+t[3],s}function ro(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s[3]=e[3]-t[3],s}function io(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s[3]=e[3]*t[3],s}function oo(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function ao(s){var e=s[0],t=s[1],r=s[2],n=s[3];return Math.hypot(e,t,r,n)}var Ys=ro,co=io,Ws=ao;(function(){var s=Ks();return function(e,t,r,n,i,o){var a,c;for(t||(t=4),r||(r=0),n?c=Math.min(n*t+r,e.length):c=e.length,a=r;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],s[3]=e[a+3],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2],e[a+3]=s[3];return e}})();const uo=/color|emissive|diffuse/i;function fo(s){return s.getGraph().listParentEdges(s).some(n=>n.getAttributes().isColor||uo.test(n.getName()))?"srgb":null}function lo(s){const e=s.getGraph(),t=new Set,r=new Set;function n(i){const o=new Set;for(const a of e.listChildEdges(i))a.getChild()instanceof We&&o.add(a.getName()+"Info");for(const a of e.listChildEdges(i)){const c=a.getChild();t.has(c)||(t.add(c),c instanceof B&&o.has(a.getName())?r.add(c):c instanceof G&&n(c))}}return n(s),Array.from(r)}function ho(s){const t=ke.fromGraph(s.getGraph()).getRoot(),r=s.getGraph().listParentEdges(s).filter(n=>n.getParent()!==t).map(n=>n.getName());return Array.from(new Set(r))}const ze="prune",Ut=3/255,Js={propertyTypes:[m.NODE,m.SKIN,m.MESH,m.CAMERA,m.PRIMITIVE,m.PRIMITIVE_TARGET,m.ANIMATION,m.MATERIAL,m.TEXTURE,m.ACCESSOR,m.BUFFER],keepLeaves:!1,keepAttributes:!1,keepIndices:!1,keepSolidTextures:!1,keepExtras:!1};function go(s=Js){const e=Qi(Js,s),t=new Set(e.propertyTypes),r=e.keepExtras;return $s(ze,async n=>{const i=n.getLogger(),o=n.getRoot(),a=n.getGraph(),c=new po,u=l=>c.dispose(l.target);if(a.addEventListener("node:dispose",u),t.has(m.MESH))for(const l of o.listMeshes())l.listPrimitives().length>0||l.dispose();if(t.has(m.NODE)){if(!e.keepLeaves)for(const l of o.listScenes())Qs(a,l,r);for(const l of o.listNodes())ue(l,r)}if(t.has(m.SKIN))for(const l of o.listSkins())ue(l,r);if(t.has(m.MESH))for(const l of o.listMeshes())ue(l,r);if(t.has(m.CAMERA))for(const l of o.listCameras())ue(l,r);if(t.has(m.PRIMITIVE)&&Zs(a,m.PRIMITIVE,r),t.has(m.PRIMITIVE_TARGET)&&Zs(a,m.PRIMITIVE_TARGET,r),!e.keepAttributes&&t.has(m.ACCESSOR)){const l=new Map;for(const d of o.listMeshes())for(const f of d.listPrimitives()){const h=f.getMaterial();if(!h)continue;const E=tn(n,f,h),_=mo(f,E);en(f,_),f.listTargets().forEach(T=>en(T,_)),l.has(h)?l.get(h).add(f):l.set(h,new Set([f]))}for(const[d,f]of l)To(d,Array.from(f))}if(t.has(m.ANIMATION))for(const l of o.listAnimations()){for(const d of l.listChannels())d.getTargetNode()||d.dispose();if(l.listChannels().length)l.listSamplers().forEach(d=>ue(d,r));else{const d=l.listSamplers();ue(l,r),d.forEach(f=>ue(f,r))}}if(t.has(m.MATERIAL)&&o.listMaterials().forEach(l=>ue(l,r)),t.has(m.TEXTURE)&&(o.listTextures().forEach(l=>ue(l,r)),e.keepSolidTextures||await xo(n)),t.has(m.ACCESSOR)&&o.listAccessors().forEach(l=>ue(l,r)),t.has(m.BUFFER)&&o.listBuffers().forEach(l=>ue(l,r)),a.removeEventListener("node:dispose",u),c.empty())i.debug(`${ze}: No unused properties found.`);else{const l=c.entries().map(([d,f])=>`${d} (${f})`).join(", ");i.info(`${ze}: Removed types... ${l}`)}i.debug(`${ze}: Complete.`)})}class po{constructor(){this.disposed={}}empty(){for(const e in this.disposed)return!1;return!0}entries(){return Object.entries(this.disposed)}dispose(e){this.disposed[e.propertyType]=this.disposed[e.propertyType]||0,this.disposed[e.propertyType]++}}function ue(s,e){const t=s.listParents().filter(n=>!(n instanceof wt||n instanceof Ye)),r=e&&!qs(s.getExtras());!t.length&&!r&&s.dispose()}function Zs(s,e,t){for(const r of s.listEdges()){const n=r.getParent();n.propertyType===e&&ue(n,t)}}function Qs(s,e,t){if(e.listChildren().forEach(o=>Qs(s,o,t)),e instanceof St)return;const r=s.listParentEdges(e).some(o=>{const a=o.getParent().propertyType;return a!==m.ROOT&&a!==m.SCENE&&a!==m.NODE}),n=s.listChildren(e).length===0,i=t&&!qs(e.getExtras());n&&!r&&!i&&e.dispose()}function en(s,e){for(const t of e)s.setAttribute(t,null)}function mo(s,e){const t=[];for(const r of s.listSemantics())(r==="NORMAL"&&!e.has(r)||r==="TANGENT"&&!e.has(r)||r.startsWith("TEXCOORD_")&&!e.has(r)||r.startsWith("COLOR_")&&r!=="COLOR_0")&&t.push(r);return t}function tn(s,e,t,r=new Set){const i=s.getGraph().listChildEdges(t),o=new Set;for(const u of i)u.getChild()instanceof We&&o.add(u.getName());for(const u of i){const l=u.getName(),d=u.getChild();d instanceof B&&o.has(l.replace(/Info$/,""))&&r.add(`TEXCOORD_${d.getTexCoord()}`),d instanceof We&&l.match(/normalTexture/i)&&r.add("TANGENT"),d instanceof G&&tn(s,e,d,r)}const a=t instanceof ge&&!t.getExtension("KHR_materials_unlit"),c=e.getMode()===re.Mode.POINTS;return a&&!c&&r.add("NORMAL"),r}function To(s,e){const t=lo(s),r=new Set(t.map(c=>c.getTexCoord())),n=Array.from(r).sort(),i=new Map(n.map((c,u)=>[c,u])),o=new Map(n.map((c,u)=>[`TEXCOORD_${c}`,`TEXCOORD_${u}`]));for(const c of t){const u=c.getTexCoord();c.setTexCoord(i.get(u))}for(const c of e){const u=c.listSemantics().filter(l=>l.startsWith("TEXCOORD_")).sort();a(c,u),c.listTargets().forEach(l=>a(l,u))}function a(c,u){for(const l of u){const d=c.getAttribute(l);if(!d)continue;const f=o.get(l);f!==l&&(c.setAttribute(f,d),c.setAttribute(l,null))}}}async function xo(s){const e=s.getRoot(),t=s.getGraph(),r=s.getLogger(),i=e.listTextures().map(async o=>{var a;const c=await Eo(o);if(!c)return;fo(o)==="srgb"&&hn.convertSRGBToLinear(c,c);const u=o.getName()||o.getURI(),l=(a=o.getSize())==null?void 0:a.join("x"),d=ho(o);for(const f of t.listParentEdges(o)){const h=f.getParent();h!==e&&yo(h,c,f.getName(),r)&&f.dispose()}o.listParents().length===1&&(o.dispose(),r.debug(`${ze}: Removed solid-color texture "${u}" (${l}px ${d.join(", ")})`))});await Promise.all(i)}function yo(s,e,t,r){if(s instanceof ge)switch(t){case"baseColorTexture":return s.setBaseColorFactor(co(e,e,s.getBaseColorFactor())),!0;case"emissiveTexture":return s.setEmissiveFactor(so([0,0,0],e.slice(0,3),s.getEmissiveFactor())),!0;case"occlusionTexture":return Math.abs(e[0]-1)<=Ut;case"metallicRoughnessTexture":return s.setRoughnessFactor(e[1]*s.getRoughnessFactor()),s.setMetallicFactor(e[2]*s.getMetallicFactor()),!0;case"normalTexture":return Ws(Ys(Ks(),e,[.5,.5,1,1]))<=Ut}return r.warn(`${ze}: Detected single-color ${t} texture. Pruning ${t} not yet supported.`),!1}async function Eo(s){const e=await Io(s);if(!e)return null;const t=[1/0,1/0,1/0,1/0],r=[-1/0,-1/0,-1/0,-1/0],n=[0,0,0,0],[i,o]=e.shape;for(let a=0;a<i;a++){for(let c=0;c<o;c++)for(let u=0;u<4;u++)t[u]=Math.min(t[u],e.get(a,c,u)),r[u]=Math.max(r[u],e.get(a,c,u));if(Ws(Ys(n,r,t))/255>Ut)return null}return oo(n,no(n,r,t),.5/255)}async function Io(s){try{return await Zi(s.getImage(),s.getMimeType())}catch{return null}}const{LINE_STRIP:Qo,LINE_LOOP:ea,TRIANGLE_STRIP:ta,TRIANGLE_FAN:sa}=re.Mode,{ROOT:na,NODE:ra,MESH:ia,PRIMITIVE:oa,ACCESSOR:aa}=m,{TRANSLATION:ca,ROTATION:ua,SCALE:fa,WEIGHTS:la}=Ye.TargetPath;mt({level:"high"},{pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0,cleanup:!0});var sn;(function(s){s[s.STEP=0]="STEP",s[s.LERP=1]="LERP",s[s.SLERP=2]="SLERP"})(sn||(sn={})),Promise.resolve();const{POINTS:ga,LINES:pa,LINE_STRIP:da,LINE_LOOP:ma,TRIANGLES:Ta,TRIANGLE_STRIP:xa,TRIANGLE_FAN:ya}=re.Mode;var Bt;(function(s){s.LANCZOS3="lanczos3",s.LANCZOS2="lanczos2"})(Bt||(Bt={})),Bt.LANCZOS3;const nn="unpartition",Ro={};function _o(s=Ro){return $s(nn,async e=>{const t=e.getLogger(),r=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(n=>n.setBuffer(r)),e.getRoot().listBuffers().forEach((n,i)=>i>0?n.dispose():null),t.debug(`${nn}: Complete.`)})}self.onmessage=async s=>{const{file:e}=s.data||{};if(!e){rn("No file provided");return}try{const t=new Uint8Array(await e.arrayBuffer()),r=new Yn().registerExtensions([ks]),n=await r.readBinary(t);await No(n),await n.transform(_o()),await n.transform(go());const i=await r.writeBinary(n),o=bo(i);self.postMessage({glb:o})}catch(t){rn(Ao(t))}};function rn(s){self.postMessage({error:s})}function Ao(s){if(!s)return"Unknown error";if(s instanceof Error){const e=s.constructor?.name||"Error",t=s.stack?` | stack: ${s.stack}`:"";return`[${e}] ${s.message}${t}`}return String(s)}function bo(s){const e=new Uint8Array(s);let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)}async function No(s){const e=s.getRoot(),t=e.listScenes(),r=t[0]||e.createScene("Scene"),n=s.createMesh("MergedMesh"),i=s.createNode("MergedNode").setMesh(n);for(const o of t){const a=o.listChildren().slice();for(const c of a)on(c,n,s,null),o.removeChild(c)}r.addChild(i);for(const o of e.listMeshes())o!==n&&o.dispose();for(const o of e.listNodes())o!==i&&o.dispose();t.forEach((o,a)=>{a!==0&&o.dispose()})}function on(s,e,t,r){const n=s.getMatrix?s.getMatrix():null,i=r?Oo(r,n||jt()):n||jt(),o=s.getMesh?s.getMesh():null;if(o)for(const a of o.listPrimitives()){const c=So(a,i,t);e.addPrimitive(c)}for(const a of s.listChildren?s.listChildren():[])on(a,e,t,i)}function So(s,e,t){const r=t.createPrimitive(),n=s.getIndices();n&&r.setIndices(n.clone()),["POSITION","NORMAL","TANGENT","TEXCOORD_0","TEXCOORD_1","COLOR_0"].forEach(a=>{const c=s.getAttribute(a);if(!c)return;let u=c;a==="POSITION"?u=wo(c,e,t):a==="NORMAL"?u=Mo(c,e,t):a==="TANGENT"?u=vo(c,e,t):u=c.clone(),r.setAttribute(a,u)});const o=s.getMaterial();return o&&r.setMaterial(o),r}function wo(s,e,t){const r=s.getArray(),n=new Float32Array(r.length);for(let i=0;i<r.length;i+=3){const o=Co([r[i],r[i+1],r[i+2]],e);n[i]=o[0],n[i+1]=o[1],n[i+2]=o[2]}return t.createAccessor().setType("VEC3").setArray(n)}function Mo(s,e,t){const r=s.getArray(),n=cn(e),i=new Float32Array(r.length);for(let o=0;o<r.length;o+=3){const a=an([r[o],r[o+1],r[o+2]],n);un(a),i[o]=a[0],i[o+1]=a[1],i[o+2]=a[2]}return t.createAccessor().setType("VEC3").setArray(i)}function vo(s,e,t){const r=s.getArray(),n=cn(e),i=new Float32Array(r.length);for(let o=0;o<r.length;o+=4){const a=an([r[o],r[o+1],r[o+2]],n);un(a),i[o]=a[0],i[o+1]=a[1],i[o+2]=a[2],i[o+3]=r[o+3]}return t.createAccessor().setType("VEC4").setArray(i)}function Co(s,e){const t=s[0],r=s[1],n=s[2],i=1/(e[3]*t+e[7]*r+e[11]*n+e[15]);return[(e[0]*t+e[4]*r+e[8]*n+e[12])*i,(e[1]*t+e[5]*r+e[9]*n+e[13])*i,(e[2]*t+e[6]*r+e[10]*n+e[14])*i]}function an(s,e){const t=s[0],r=s[1],n=s[2];return[e[0]*t+e[4]*r+e[8]*n,e[1]*t+e[5]*r+e[9]*n,e[2]*t+e[6]*r+e[10]*n]}function cn(s){const e=s[0],t=s[1],r=s[2],n=s[4],i=s[5],o=s[6],a=s[8],c=s[9],u=s[10],l=u*i-o*c,d=-u*n+o*a,f=c*n-i*a;let h=e*l+t*d+r*f;if(!h)return jt();h=1/h;const E=new Float32Array(16);return E[0]=l*h,E[1]=(-u*t+r*c)*h,E[2]=(o*t-r*i)*h,E[3]=0,E[4]=d*h,E[5]=(u*e-r*a)*h,E[6]=(-o*e+r*n)*h,E[7]=0,E[8]=f*h,E[9]=(-c*e+t*a)*h,E[10]=(i*e-t*n)*h,E[11]=0,E[12]=0,E[13]=0,E[14]=0,E[15]=1,E}function Oo(s,e){const t=new Float32Array(16);for(let r=0;r<4;r++)for(let n=0;n<4;n++)t[r*4+n]=s[0*4+n]*e[r*4+0]+s[1*4+n]*e[r*4+1]+s[2*4+n]*e[r*4+2]+s[3*4+n]*e[r*4+3];return t}function un(s){const e=Math.hypot(s[0],s[1],s[2])||1;s[0]/=e,s[1]/=e,s[2]/=e}function jt(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}})();
