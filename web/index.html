<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Combine your GLB textures into a single optimized atlas, remap UVs safely, and download a lighter GLB—right in your browser." />
  <title>AtlasGen | Texture Atlas Lab</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171b22;
      --card: #1f2530;
      --text: #e8ecf2;
      --muted: #a9b3c1;
      --accent: #4f8bff;
      --accent-strong: #3a73e0;
      --border: #2a3040;
      --success: #3dd598;
      --error: #ff6b6b;
      --radius: 12px;
      --shadow: 0 16px 40px rgba(0,0,0,0.35);
      --mono: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", "Segoe UI", -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 10% 20%, rgba(79,139,255,0.08), transparent),
                  radial-gradient(120% 120% at 90% 10%, rgba(61,213,152,0.07), transparent),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: var(--accent); }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 120px;
    }
    header.hero {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 28px;
    }
    .section { margin: 32px 0; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(79,139,255,0.12);
      color: var(--accent);
      font-weight: 600;
      width: fit-content;
    }
    h1 {
      margin: 0;
      font-size: 36px;
      letter-spacing: -0.4px;
    }
    h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
      letter-spacing: -0.2px;
    }
    p.lead {
      margin: 0;
      max-width: 760px;
      color: var(--muted);
      line-height: 1.5;
    }
    .cta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .grid {
      max-width: 780px;
      margin: 0 auto;
    }
    .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .card h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      letter-spacing: 0.2px;
      color: #f7f9fc;
    }
    .card h2 { color: #f7f9fc; }
    .subtext {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 10px;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #11141a;
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79,139,255,0.2);
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
    }
    .uploader {
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 18px;
      background: #11141a;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }
    .uploader:hover {
      border-color: var(--accent);
      background: #141924;
    }
    .uploader.dragover {
      border-color: var(--accent);
      background: rgba(79,139,255,0.08);
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      font-size: 12px;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 8px;
    }
    button.primary {
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      font-weight: 700;
      letter-spacing: 0.2px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(79,139,255,0.35);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button.primary:hover { transform: translateY(-1px); }
    button.primary:active { transform: translateY(0); box-shadow: 0 6px 16px rgba(79,139,255,0.35); }
    .ghost {
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
    }
    .status {
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .status.success { color: var(--success); }
    .status.error { color: var(--error); }
    .steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    .step {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      background: #11141a;
    }
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }
    .feature-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      background: #11141a;
      min-height: 140px;
    }
    .trust-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .faq details {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      background: #11141a;
    }
    .faq summary {
      cursor: pointer;
      color: #f7f9fc;
      font-weight: 600;
    }
    .faq p {
      color: var(--muted);
      margin: 8px 0 0 0;
    }
    .sticky-bar {
      position: fixed;
      bottom: 12px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      pointer-events: none;
      padding: 0 12px;
    }
    .sticky-inner {
      pointer-events: all;
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(17,20,26,0.9);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
      max-width: 640px;
      width: 100%;
      backdrop-filter: blur(6px);
    }
    .sticky-text {
      flex: 1;
      color: var(--muted);
      font-size: 14px;
    }
    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
      .page { padding: 20px 16px 64px; }
      h1 { font-size: 30px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div class="badge">Texture Atlasing • Web</div>
      <h1>Optimize your GLB textures in one click</h1>
      <p class="lead">Merge multiple GLBs, pack textures into a single atlas per map, and remap UVs automatically. Get a lighter, download-ready GLB without leaving your browser.</p>
      <div class="cta-row">
        <button class="primary" type="button" id="hero-upload">Upload GLB</button>
        <button class="ghost" type="button" id="hero-learn">How it works</button>
      </div>
      <div class="trust-bar">
        <span class="pill">Runs in your browser</span>
        <span class="pill">No signup</span>
        <span class="pill">BaseColor / Normal / ORM / Emissive</span>
        <span class="pill">Open source</span>
      </div>
    </header>

    <section class="section" id="how">
      <h2>How it works</h2>
      <div class="steps">
        <div class="step">
          <strong>1) Upload</strong>
          <p class="subtext">Drop one or many GLBs; we merge before atlasing.</p>
        </div>
        <div class="step">
          <strong>2) Configure</strong>
          <p class="subtext">Choose atlas size, format, and quality. Defaults are safe.</p>
        </div>
        <div class="step">
          <strong>3) Download</strong>
          <p class="subtext">Get a single GLB with remapped UVs and atlas textures.</p>
        </div>
      </div>
    </section>

    <section class="section">
      <h2>Why AtlasGen?</h2>
      <div class="feature-grid">
        <div class="feature-card">
          <strong>Single-GLB output</strong>
          <p class="subtext">Combines meshes and materials so your scene loads faster.</p>
        </div>
        <div class="feature-card">
          <strong>Per-map atlases</strong>
          <p class="subtext">BaseColor, Normal, ORM, and Emissive handled with correct color spaces.</p>
        </div>
        <div class="feature-card">
          <strong>UV-safe remap</strong>
          <p class="subtext">UVs are rewritten per atlas with padding and power-of-two layouts.</p>
        </div>
        <div class="feature-card">
          <strong>Browser-first</strong>
          <p class="subtext">Processing runs in a worker; no installs and no signup.</p>
        </div>
        <div class="feature-card">
          <strong>Configurable</strong>
          <p class="subtext">Pick atlas size, formats, and quality—keep lossless where it matters.</p>
        </div>
        <div class="feature-card">
          <strong>Debug-friendly</strong>
          <p class="subtext">Layout is logged to console for inspection if you need it.</p>
        </div>
      </div>
    </section>

    <section class="section card" id="start">
      <h2>Try it now</h2>
      <p class="subtext">Defaults are ready to go. Advanced options stay unchanged—upload and hit Generate.</p>

      <div class="grid">
        <form id="atlas-form" class="card" autocomplete="off">
          <h3>1) Upload models</h3>
          <p class="subtext">Drop one or multiple .glb files to merge before atlasing.</p>
          <label class="uploader">
            <strong>Click here or drag and drop your .GLB files</strong>
            <input style="display:none" type="file" name="models" accept=".glb" multiple required />
            <div class="chips" id="file-chips"><span class="chip">No files selected</span></div>
          </label>

          <div class="card" style="margin-top:14px; padding:14px;">
            <h3>2) Layout & sizing</h3>
            <div class="row">
              <label>Atlas size (px)
                <select name="maxSize">
                  <option value="4096" selected>4096</option>
                  <option value="2048">2048</option>
                  <option value="1024">1024</option>
                </select>
              </label>
            </div>
          </div>

          <div class="card" style="margin-top:14px; padding:14px;">
            <h3>3) Formats & quality</h3>
            <div class="row">
              <label>Atlas format
                <select name="formatAll">
                  <option value="webp" selected>webp</option>
                  <option value="png">png (lossless)</option>
                  <option value="jpeg">jpeg (lossy, no alpha)</option>
                </select>
              </label>
            </div>
            <label style="margin-top:8px;">Quality (jpeg/webp)
              <input type="number" name="quality" value="85" min="1" max="100" />
            </label>
          </div>

          <div class="actions">
            <button class="primary" type="submit" id="submit-btn">Generate Atlas</button>
          </div>
          <div class="status" id="status" style="text-align:center; margin-top:6px;">Idle</div>
        </form>
      </div>
    </section>

    <section class="section faq" id="faq">
      <h2>FAQ</h2>
      <div class="subtext" style="margin-bottom:10px;">Quick answers for common questions.</div>
      <div class="grid" style="max-width: 780px; margin: 0; gap: 10px;">
        <details>
          <summary>Do my files leave the browser?</summary>
          <p>Processing runs in a web worker. No account or server upload is required for the static build.</p>
        </details>
        <details>
          <summary>Which maps are packed?</summary>
          <p>BaseColor, Normal, ORM, and Emissive. Missing maps fall back to sensible defaults.</p>
        </details>
        <details>
          <summary>What formats are supported?</summary>
          <p>GLB input; output is a single GLB plus atlas textures embedded.</p>
        </details>
        <details>
          <summary>Recommended settings?</summary>
          <p>Keep 4096px for complex scenes, use webp, and leave quality at 85. Switch to png for lossless normals if needed.</p>
        </details>
      </div>
    </section>

    <section class="section">
      <div class="subtext">Privacy: your files stay in your browser when using the static Pages build. Check the console for atlas layout logs if you need to debug.</div>
    </section>
  </div>

  <div class="sticky-bar">
    <div class="sticky-inner">
      <div class="sticky-text">Ready to generate your atlas?</div>
      <button class="primary" type="button" id="sticky-submit">Generate</button>
    </div>
  </div>

  <script type="module">
    const form = document.getElementById('atlas-form');
    const statusEl = document.getElementById('status');
    const submitBtn = document.getElementById('submit-btn');
    const fileInput = form.elements['models'];
    const chipsEl = document.getElementById('file-chips');
    const dropZone = document.querySelector('.uploader');
    const heroUpload = document.getElementById('hero-upload');
    const heroLearn = document.getElementById('hero-learn');
    const stickySubmit = document.getElementById('sticky-submit');
    let downloadUrl = null;
    let worker = null;

    function updateChips(files) {
      chipsEl.innerHTML = '';
      if (!files.length) {
        chipsEl.innerHTML = '<span class="chip">No files selected</span>';
        return;
      }
      Array.from(files).forEach(f => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = f.name;
        chipsEl.appendChild(span);
      });
    }

    function resetButton() {
      downloadUrl = null;
      submitBtn.type = 'submit';
      submitBtn.textContent = 'Generate Atlas';
      submitBtn.disabled = false;
      submitBtn.onclick = null;
    }

    function smoothScrollTo(el) {
      if (el && el.scrollIntoView) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    if (heroUpload) {
      heroUpload.addEventListener('click', () => fileInput?.click());
    }
    if (heroLearn) {
      heroLearn.addEventListener('click', () => {
        const how = document.getElementById('how');
        smoothScrollTo(how);
      });
    }
    if (stickySubmit) {
      stickySubmit.addEventListener('click', () => form?.requestSubmit());
    }

    function setDownloadButton(url, name) {
      downloadUrl = url;
      submitBtn.type = 'button';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Download atlas GLB';
      submitBtn.onclick = () => {
        if (!downloadUrl) return;
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = name || 'output.atlas.glb';
        a.click();
      };
    }

    ['dragenter','dragover','dragleave','drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    ['dragenter','dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'));
    });
    ['dragleave','drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'));
    });
    dropZone.addEventListener('drop', (e) => {
      const dt = new DataTransfer();
      Array.from(e.dataTransfer.files || []).forEach((f) => {
        if (f.name.toLowerCase().endsWith('.glb')) dt.items.add(f);
      });
      if (dt.files.length) {
        fileInput.files = dt.files;
        updateChips(fileInput.files);
        resetButton();
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.className = 'status';
      statusEl.textContent = '';
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      if (!fileInput.files.length) {
        statusEl.textContent = 'Please choose at least one GLB file.';
        statusEl.classList.add('error');
        resetButton();
        return;
      }

      const opts = {};
      const maxSizeEl = form.elements['maxSize'];
      if (maxSizeEl && maxSizeEl.value) opts.maxSize = maxSizeEl.value;
      opts.padding = '0';
      opts.texcoord = '0';
      opts.maxBins = '1';
      opts.resizeMode = 'downscale';
      opts.resizeCeil = '4096';
      const fmt = form.elements['formatAll']?.value || 'webp';
      opts.formatBasecolor = fmt;
      opts.formatNormal = fmt;
      opts.formatOrm = fmt;
      opts.formatEmissive = fmt;
      const qualEl = form.elements['quality'];
      if (qualEl && qualEl.value) opts.quality = qualEl.value;
      opts.maps = ['baseColor','normal','orm','emissive'].join(',');

      try {
        if (!worker) {
          worker = new Worker(new URL('./src/atlas-worker.js', import.meta.url), { type: 'module' });
        }
        const files = Array.from(fileInput.files);
        const result = await new Promise((resolve, reject) => {
          const timer = setTimeout(() => reject(new Error('Worker timed out')), 120000);
          worker.onmessage = (ev) => {
            clearTimeout(timer);
            const { error, glb, layout } = ev.data || {};
            if (error) return reject(new Error(error));
            resolve({ glb, layout });
          };
          worker.onerror = (err) => {
            clearTimeout(timer);
            reject(err);
          };
          worker.postMessage({ files, opts });
        });

        const glbBuffer = Uint8Array.from(atob(result.glb), c => c.charCodeAt(0));
        const blob = new Blob([glbBuffer], { type: 'model/gltf-binary' });
        const url = URL.createObjectURL(blob);
        const name = (fileInput.files[0].name.replace(/\.glb$/i, '') || 'output') + '.atlas.glb';
        statusEl.textContent = 'Done.';
        statusEl.classList.add('success');
        setDownloadButton(url, name);
        if (result.layout) {
          console.log('[atlas] layout', result.layout);
          window.atlasLayout = result.layout;
        }
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.classList.add('error');
        resetButton();
      }
    });

    fileInput.addEventListener('change', () => updateChips(fileInput.files));
  </script>
</body>
</html>

