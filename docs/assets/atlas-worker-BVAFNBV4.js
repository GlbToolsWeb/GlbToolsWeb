(function(){"use strict";class jt{constructor(){this._listeners={}}addEventListener(e,t){const n=this._listeners;return n[e]===void 0&&(n[e]=[]),n[e].indexOf(t)===-1&&n[e].push(t),this}removeEventListener(e,t){const s=this._listeners[e];if(s!==void 0){const r=s.indexOf(t);r!==-1&&s.splice(r,1)}return this}dispatchEvent(e){const n=this._listeners[e.type];if(n!==void 0){const s=n.slice(0);for(let r=0,o=s.length;r<o;r++)s[r].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class Pe{constructor(e,t,n,s={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=n,this._attributes=s,!t.isOnGraph(n))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}}class rn extends jt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){const t=new Set;for(const n of this.listParentEdges(e))t.add(n.getParent());return Array.from(t)}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){const t=new Set;for(const n of this.listChildEdges(e))t.add(n.getChild());return Array.from(t)}disconnectParents(e,t){for(const n of this.listParentEdges(e))(!t||t(n.getParent()))&&n.dispose();return this}_createEdge(e,t,n,s){const r=new Pe(e,t,n,s);this._edges.add(r);const o=r.getParent();this._parentEdges.has(o)||this._parentEdges.set(o,new Set),this._parentEdges.get(o).add(r);const a=r.getChild();return this._childEdges.has(a)||this._childEdges.set(a,new Set),this._childEdges.get(a).add(r),r}_destroyEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function Ke(){return Ke=Object.assign||function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},Ke.apply(this,arguments)}class be{constructor(e){if(this.list=[],e)for(const t of e)this.list.push(t)}add(e){this.list.push(e)}remove(e){const t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)}removeChild(e){const t=[];for(const n of this.list)n.getChild()===e&&t.push(n);for(const n of t)this.remove(n);return t}listRefsByChild(e){const t=[];for(const n of this.list)n.getChild()===e&&t.push(n);return t}values(){return this.list}}class k{constructor(e){if(this.set=new Set,this.map=new Map,e)for(const t of e)this.add(t)}add(e){const t=e.getChild();this.removeChild(t),this.set.add(e),this.map.set(t,e)}remove(e){this.set.delete(e),this.map.delete(e.getChild())}removeChild(e){const t=this.map.get(e)||null;return t&&this.remove(t),t}getRefByChild(e){return this.map.get(e)||null}values(){return Array.from(this.set)}}class ue{constructor(e){this.map={},e&&Object.assign(this.map,e)}set(e,t){this.map[e]=t}delete(e){delete this.map[e]}get(e){return this.map[e]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}}const B=Symbol("attributes"),Fe=Symbol("immutableKeys");class Rt extends jt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[B]=void 0,this[Fe]=void 0,this.graph=e,this[Fe]=new Set,this[B]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const n in e){const s=e[n];if(s instanceof Rt){const r=this.graph._createEdge(n,this,s);this[Fe].add(n),t[n]=r}else t[n]=s}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const n in this[B]){const s=this[B][n];if(s instanceof Pe){const r=s;r.getChild()===e&&this.setRef(n,t,r.getAttributes())}else if(s instanceof be)for(const r of s.listRefsByChild(e)){const o=r.getAttributes();this.removeRef(n,e),this.addRef(n,t,o)}else if(s instanceof k){const r=s.getRefByChild(e);if(r){const o=r.getAttributes();this.removeRef(n,e),this.addRef(n,t,o)}}else if(s instanceof ue)for(const r of s.keys()){const o=s.get(r);o.getChild()===e&&this.setRefMap(n,r,t,o.getAttributes())}}return this}get(e){return this[B][e]}set(e,t){return this[B][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[B][e];return t?t.getChild():null}setRef(e,t,n){if(this[Fe].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const s=this[B][e];if(s&&s.dispose(),!t)return this;const r=this.graph._createEdge(e,this,t,n);return this[B][e]=r,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this.assertRefList(e).values().map(n=>n.getChild())}addRef(e,t,n){const s=this.graph._createEdge(e,this,t,n);return this.assertRefList(e).add(s),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){const n=this.assertRefList(e);if(n instanceof be)for(const s of n.listRefsByChild(t))s.dispose();else{const s=n.getRefByChild(t);s&&s.dispose()}return this}assertRefList(e){const t=this[B][e];if(t instanceof be||t instanceof k)return t;throw new Error(`Expected RefList or RefSet for attribute "${e}"`)}listRefMapKeys(e){return this.assertRefMap(e).keys()}listRefMapValues(e){return this.assertRefMap(e).values().map(t=>t.getChild())}getRefMap(e,t){const s=this.assertRefMap(e).get(t);return s?s.getChild():null}setRefMap(e,t,n,s){const r=this.assertRefMap(e),o=r.get(t);if(o&&o.dispose(),!n)return this;s=Object.assign(s||{},{key:t});const a=this.graph._createEdge(e,this,n,Ke({},s,{key:t}));return r.set(t,a),this.dispatchEvent({type:"change",attribute:e,key:t})}assertRefMap(e){const t=this[B][e];if(t instanceof ue)return t;throw new Error(`Expected RefMap for attribute "${e}"`)}dispatchEvent(e){return super.dispatchEvent(Ke({},e,{target:this})),this.graph.dispatchEvent(Ke({},e,{target:this,type:`node:${e.type}`})),this}_destroyRef(e){const t=e.getName();if(this[B][t]===e)this[B][t]=null,this[Fe].has(t)&&e.getChild().dispose();else if(this[B][t]instanceof be)this[B][t].remove(e);else if(this[B][t]instanceof k)this[B][t].remove(e);else if(this[B][t]instanceof ue){const n=this[B][t];for(const s of n.keys())n.get(s)===e&&n.delete(s)}else return;this.graph._destroyEdge(e),this.dispatchEvent({type:"change",attribute:t})}}const kt="v4.2.1",je="@glb.bin";var g;(function(i){i.ACCESSOR="Accessor",i.ANIMATION="Animation",i.ANIMATION_CHANNEL="AnimationChannel",i.ANIMATION_SAMPLER="AnimationSampler",i.BUFFER="Buffer",i.CAMERA="Camera",i.MATERIAL="Material",i.MESH="Mesh",i.PRIMITIVE="Primitive",i.PRIMITIVE_TARGET="PrimitiveTarget",i.NODE="Node",i.ROOT="Root",i.SCENE="Scene",i.SKIN="Skin",i.TEXTURE="Texture",i.TEXTURE_INFO="TextureInfo"})(g||(g={}));var it;(function(i){i.INTERLEAVED="interleaved",i.SEPARATE="separate"})(it||(it={}));var te;(function(i){i.ARRAY_BUFFER="ARRAY_BUFFER",i.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",i.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",i.OTHER="OTHER",i.SPARSE="SPARSE"})(te||(te={}));var ne;(function(i){i[i.R=4096]="R",i[i.G=256]="G",i[i.B=16]="B",i[i.A=1]="A"})(ne||(ne={}));var Me;(function(i){i.GLTF="GLTF",i.GLB="GLB"})(Me||(Me={}));const ot={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};class F{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),n=new Uint8Array(t.length);for(let s=0;s<t.length;s++)n[s]=t.charCodeAt(s);return n}else{const t=e.split(",")[1],n=e.indexOf("base64")>=0;return Buffer.from(t,n?"base64":"utf8")}}static encodeText(e){return new TextEncoder().encode(e)}static decodeText(e){return new TextDecoder().decode(e)}static concat(e){let t=0;for(const r of e)t+=r.byteLength;const n=new Uint8Array(t);let s=0;for(const r of e)n.set(r,s),s+=r.byteLength;return n}static pad(e,t=0){const n=this.padNumber(e.byteLength);if(n===e.byteLength)return e;const s=new Uint8Array(n);if(s.set(e),t!==0)for(let r=e.byteLength;r<n;r++)s[r]=t;return s}static padNumber(e){return Math.ceil(e/4)*4}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let n=e.byteLength;for(;n--;)if(e[n]!==t[n])return!1;return!0}static toView(e,t=0,n=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,n))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class on{match(e){return e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255}getSize(e){let t=new DataView(e.buffer,e.byteOffset+4),n,s;for(;t.byteLength;){if(n=t.getUint16(0,!1),an(t,n),s=t.getUint8(n+1),s===192||s===193||s===194)return[t.getUint16(n+7,!1),t.getUint16(n+5,!1)];t=new DataView(e.buffer,t.byteOffset+n+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}}class at{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return F.decodeText(e.slice(12,16))===at.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}at.PNG_FRIED_CHUNK_NAME="CgBI";class he{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let n=0;const s=4,r=this.getSize(e,t);if(!r)return null;for(;r[0]>1||r[1]>1;)n+=r[0]*r[1]*s,r[0]=Math.max(Math.floor(r[0]/2),1),r[1]=Math.max(Math.floor(r[1]/2),1);return n+=1*1*s,n}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}he.impls={"image/jpeg":new on,"image/png":new at};function an(i,e){if(e>i.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(i.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return i}class ke{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return he.mimeTypeToExtension(t)}else{if(e.startsWith("data:model/gltf+json"))return"gltf";if(e.startsWith("data:model/gltf-binary"))return"glb";if(e.startsWith("data:application/"))return"bin"}return e.split(/[\\/]/).pop().split(/[.]/).pop()}}var It=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});function cn(){var i=new It(3);return It!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function wt(i){var e=i[0],t=i[1],n=i[2];return Math.hypot(e,t,n)}function un(i,e,t){var n=e[0],s=e[1],r=e[2],o=t[3]*n+t[7]*s+t[11]*r+t[15];return o=o||1,i[0]=(t[0]*n+t[4]*s+t[8]*r+t[12])/o,i[1]=(t[1]*n+t[5]*s+t[9]*r+t[13])/o,i[2]=(t[2]*n+t[6]*s+t[10]*r+t[14])/o,i}(function(){var i=cn();return function(e,t,n,s,r,o){var a,c;for(t||(t=3),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,a=n;a<c;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],r(i,i,o),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2];return e}})();function fn(i){const e=Vt(),t=i.propertyType===g.NODE?[i]:i.listChildren();for(const n of t)n.traverse(s=>{const r=s.getMesh();if(!r)return;const o=hn(r,s.getWorldMatrix());o.min.every(isFinite)&&o.max.every(isFinite)&&(At(o.min,e),At(o.max,e))});return e}function hn(i,e){const t=Vt();for(const n of i.listPrimitives()){const s=n.getAttribute("POSITION"),r=n.getIndices();if(!s)continue;let o=[0,0,0],a=[0,0,0];for(let c=0,u=r?r.getCount():s.getCount();c<u;c++){const l=r?r.getScalar(c):c;o=s.getElement(l,o),a=un(a,o,e),At(a,t)}}return t}function At(i,e){for(let t=0;t<3;t++)e.min[t]=Math.min(i[t],e.min[t]),e.max[t]=Math.max(i[t],e.max[t])}function Vt(){return{min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]}}const Gt="https://null.example";class qe{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return ke.basename(new URL(e,Gt).pathname)}static extension(e){return ke.extension(new URL(e,Gt).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const n=e.split("/"),s=t.split("/");n.pop();for(let r=0;r<s.length;r++)s[r]!=="."&&(s[r]===".."?n.pop():n.push(s[r]));return n.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}qe.DEFAULT_INIT={},qe.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;function Ht(i){return Object.prototype.toString.call(i)==="[object Object]"}function Ue(i){if(Ht(i)===!1)return!1;const e=i.constructor;if(e===void 0)return!0;const t=e.prototype;return!(Ht(t)===!1||Object.hasOwn(t,"isPrototypeOf")===!1)}var Nt,_t;(function(i){i[i.SILENT=4]="SILENT",i[i.ERROR=3]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=1]="INFO",i[i.DEBUG=0]="DEBUG"})(_t||(_t={}));class re{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=re.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=re.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=re.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=re.Verbosity.ERROR&&console.error(e)}}Nt=re,re.Verbosity=_t,re.DEFAULT_INSTANCE=new Nt(Nt.Verbosity.INFO);function ln(i){var e=i[0],t=i[1],n=i[2],s=i[3],r=i[4],o=i[5],a=i[6],c=i[7],u=i[8],l=i[9],d=i[10],x=i[11],p=i[12],I=i[13],S=i[14],_=i[15],h=e*o-t*r,O=e*a-n*r,E=e*c-s*r,A=t*a-n*o,m=t*c-s*o,y=n*c-s*a,f=u*I-l*p,T=u*S-d*p,R=u*_-x*p,w=l*S-d*I,C=l*_-x*I,N=d*_-x*S;return h*N-O*C+E*w+A*R-m*T+y*f}function dn(i,e,t){var n=e[0],s=e[1],r=e[2],o=e[3],a=e[4],c=e[5],u=e[6],l=e[7],d=e[8],x=e[9],p=e[10],I=e[11],S=e[12],_=e[13],h=e[14],O=e[15],E=t[0],A=t[1],m=t[2],y=t[3];return i[0]=E*n+A*a+m*d+y*S,i[1]=E*s+A*c+m*x+y*_,i[2]=E*r+A*u+m*p+y*h,i[3]=E*o+A*l+m*I+y*O,E=t[4],A=t[5],m=t[6],y=t[7],i[4]=E*n+A*a+m*d+y*S,i[5]=E*s+A*c+m*x+y*_,i[6]=E*r+A*u+m*p+y*h,i[7]=E*o+A*l+m*I+y*O,E=t[8],A=t[9],m=t[10],y=t[11],i[8]=E*n+A*a+m*d+y*S,i[9]=E*s+A*c+m*x+y*_,i[10]=E*r+A*u+m*p+y*h,i[11]=E*o+A*l+m*I+y*O,E=t[12],A=t[13],m=t[14],y=t[15],i[12]=E*n+A*a+m*d+y*S,i[13]=E*s+A*c+m*x+y*_,i[14]=E*r+A*u+m*p+y*h,i[15]=E*o+A*l+m*I+y*O,i}function gn(i,e){var t=e[0],n=e[1],s=e[2],r=e[4],o=e[5],a=e[6],c=e[8],u=e[9],l=e[10];return i[0]=Math.hypot(t,n,s),i[1]=Math.hypot(r,o,a),i[2]=Math.hypot(c,u,l),i}function pn(i,e){var t=new It(3);gn(t,e);var n=1/t[0],s=1/t[1],r=1/t[2],o=e[0]*n,a=e[1]*s,c=e[2]*r,u=e[4]*n,l=e[5]*s,d=e[6]*r,x=e[8]*n,p=e[9]*s,I=e[10]*r,S=o+l+I,_=0;return S>0?(_=Math.sqrt(S+1)*2,i[3]=.25*_,i[0]=(d-p)/_,i[1]=(x-c)/_,i[2]=(a-u)/_):o>l&&o>I?(_=Math.sqrt(1+o-l-I)*2,i[3]=(d-p)/_,i[0]=.25*_,i[1]=(a+u)/_,i[2]=(x+c)/_):l>I?(_=Math.sqrt(1+l-o-I)*2,i[3]=(x-c)/_,i[0]=(a+u)/_,i[1]=.25*_,i[2]=(d+p)/_):(_=Math.sqrt(1+I-o-l)*2,i[3]=(a-u)/_,i[0]=(x+c)/_,i[1]=(d+p)/_,i[2]=.25*_),i}class L{static identity(e){return e}static eq(e,t,n=1e-5){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(Math.abs(e[s]-t[s])>n)return!1;return!0}static clamp(e,t,n){return e<t?t:e>n?n:e}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(L.clamp(e,0,1)*65535);case 5121:return Math.round(L.clamp(e,0,1)*255);case 5122:return Math.round(L.clamp(e,-1,1)*32767);case 5120:return Math.round(L.clamp(e,-1,1)*127);default:throw new Error("Invalid component type.")}}static decompose(e,t,n,s){let r=wt([e[0],e[1],e[2]]);const o=wt([e[4],e[5],e[6]]),a=wt([e[8],e[9],e[10]]);ln(e)<0&&(r=-r),t[0]=e[12],t[1]=e[13],t[2]=e[14];const u=e.slice(),l=1/r,d=1/o,x=1/a;u[0]*=l,u[1]*=l,u[2]*=l,u[4]*=d,u[5]*=d,u[6]*=d,u[8]*=x,u[9]*=x,u[10]*=x,pn(n,u),s[0]=r,s[1]=o,s[2]=a}static compose(e,t,n,s){const r=s,o=t[0],a=t[1],c=t[2],u=t[3],l=o+o,d=a+a,x=c+c,p=o*l,I=o*d,S=o*x,_=a*d,h=a*x,O=c*x,E=u*l,A=u*d,m=u*x,y=n[0],f=n[1],T=n[2];return r[0]=(1-(_+O))*y,r[1]=(I+m)*y,r[2]=(S-A)*y,r[3]=0,r[4]=(I-m)*f,r[5]=(1-(p+O))*f,r[6]=(h+E)*f,r[7]=0,r[8]=(S+A)*T,r[9]=(h-E)*T,r[10]=(1-(p+_))*T,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}}function mn(i,e){if(!!i!=!!e)return!1;const t=i.getChild(),n=e.getChild();return t===n||t.equals(n)}function xn(i,e){if(!!i!=!!e)return!1;const t=i.values(),n=e.values();if(t.length!==n.length)return!1;for(let s=0;s<t.length;s++){const r=t[s],o=n[s];if(r.getChild()!==o.getChild()&&!r.getChild().equals(o.getChild()))return!1}return!0}function Tn(i,e){if(!!i!=!!e)return!1;const t=i.keys(),n=e.keys();if(t.length!==n.length)return!1;for(const s of t){const r=i.get(s),o=e.get(s);if(!!r!=!!o)return!1;const a=r.getChild(),c=o.getChild();if(a!==c&&!a.equals(c))return!1}return!0}function zt(i,e){if(i===e)return!0;if(!!i!=!!e||!i||!e||i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}function $t(i,e){if(i===e)return!0;if(!!i!=!!e)return!1;if(!Ue(i)||!Ue(e))return i===e;const t=i,n=e;let s=0,r=0,o;for(o in t)s++;for(o in n)r++;if(s!==r)return!1;for(o in t){const a=t[o],c=n[o];if(ct(a)&&ct(c)){if(!zt(a,c))return!1}else if(Ue(a)&&Ue(c)){if(!$t(a,c))return!1}else if(a!==c)return!1}return!0}function ct(i){return Array.isArray(i)||ArrayBuffer.isView(i)}const Xt="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",En=999,yn=6,Kt=new Set,Rn=function(){let e="";for(let t=0;t<yn;t++)e+=Xt.charAt(Math.floor(Math.random()*Xt.length));return e},In=function(){for(let e=0;e<En;e++){const t=Rn();if(!Kt.has(t))return Kt.add(t),t}return""},Oe=i=>i,wn=new Set;class St extends Rt{constructor(e,t=""){super(e),this[B].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){const e=this.constructor;return new e(this.graph).copy(this,Oe)}copy(e,t=Oe){for(const n in this[B]){const s=this[B][n];if(s instanceof Pe)this[Fe].has(n)||s.dispose();else if(s instanceof be||s instanceof k)for(const r of s.values())r.dispose();else if(s instanceof ue)for(const r of s.values())r.dispose()}for(const n in e[B]){const s=this[B][n],r=e[B][n];if(r instanceof Pe)this[Fe].has(n)?s.getChild().copy(t(r.getChild()),t):this.setRef(n,t(r.getChild()),r.getAttributes());else if(r instanceof k||r instanceof be)for(const o of r.values())this.addRef(n,t(o.getChild()),o.getAttributes());else if(r instanceof ue)for(const o of r.keys()){const a=r.get(o);this.setRefMap(n,o,t(a.getChild()),a.getAttributes())}else Ue(r)?this[B][n]=JSON.parse(JSON.stringify(r)):Array.isArray(r)||r instanceof ArrayBuffer||ArrayBuffer.isView(r)?this[B][n]=r.slice():this[B][n]=r}return this}equals(e,t=wn){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const n in this[B]){if(t.has(n))continue;const s=this[B][n],r=e[B][n];if(s instanceof Pe||r instanceof Pe){if(!mn(s,r))return!1}else if(s instanceof k||r instanceof k||s instanceof be||r instanceof be){if(!xn(s,r))return!1}else if(s instanceof ue||r instanceof ue){if(!Tn(s,r))return!1}else if(Ue(s)||Ue(r)){if(!$t(s,r))return!1}else if(ct(s)||ct(r)){if(!zt(s,r))return!1}else if(s!==r)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}class Y extends St{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new ue})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t._validateParent(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}}class b extends Y{init(){this.propertyType=g.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:b.Type.SCALAR,componentType:b.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(e){switch(e){case b.Type.SCALAR:return 1;case b.Type.VEC2:return 2;case b.Type.VEC3:return 3;case b.Type.VEC4:return 4;case b.Type.MAT2:return 4;case b.Type.MAT3:return 9;case b.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case b.ComponentType.BYTE:return 1;case b.ComponentType.UNSIGNED_BYTE:return 1;case b.ComponentType.SHORT:return 2;case b.ComponentType.UNSIGNED_SHORT:return 2;case b.ComponentType.UNSIGNED_INT:return 4;case b.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getNormalized(),n=this.getElementSize(),s=this.getComponentType();if(this.getMin(e),t)for(let r=0;r<n;r++)e[r]=L.decodeNormalizedInt(e[r],s);return e}getMin(e){const t=this.getArray(),n=this.getCount(),s=this.getElementSize();for(let r=0;r<s;r++)e[r]=1/0;for(let r=0;r<n*s;r+=s)for(let o=0;o<s;o++){const a=t[r+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getNormalized(),n=this.getElementSize(),s=this.getComponentType();if(this.getMax(e),t)for(let r=0;r<n;r++)e[r]=L.decodeNormalizedInt(e[r],s);return e}getMax(e){const t=this.get("array"),n=this.getCount(),s=this.getElementSize();for(let r=0;r<s;r++)e[r]=-1/0;for(let r=0;r<n*s;r+=s)for(let o=0;o<s;o++){const a=t[r+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return b.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e)}getScalar(e){const t=this.getElementSize(),n=this.getComponentType(),s=this.getArray();return this.getNormalized()?L.decodeNormalizedInt(s[e*t],n):s[e*t]}setScalar(e,t){const n=this.getElementSize(),s=this.getComponentType(),r=this.getArray();return this.getNormalized()?r[e*n]=L.encodeNormalizedInt(t,s):r[e*n]=t,this}getElement(e,t){const n=this.getNormalized(),s=this.getElementSize(),r=this.getComponentType(),o=this.getArray();for(let a=0;a<s;a++)n?t[a]=L.decodeNormalizedInt(o[e*s+a],r):t[a]=o[e*s+a];return t}setElement(e,t){const n=this.getNormalized(),s=this.getElementSize(),r=this.getComponentType(),o=this.getArray();for(let a=0;a<s;a++)n?o[e*s+a]=L.encodeNormalizedInt(t[a],r):o[e*s+a]=t[a];return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?An(e):b.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}b.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},b.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};function An(i){switch(i.constructor){case Float32Array:return b.ComponentType.FLOAT;case Uint32Array:return b.ComponentType.UNSIGNED_INT;case Uint16Array:return b.ComponentType.UNSIGNED_SHORT;case Uint8Array:return b.ComponentType.UNSIGNED_BYTE;case Int16Array:return b.ComponentType.SHORT;case Int8Array:return b.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}class qt extends Y{init(){this.propertyType=g.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:new k,samplers:new k})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}class ut extends Y{init(){this.propertyType=g.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}ut.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class Ve extends Y{init(){this.propertyType=g.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Ve.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:te.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:te.OTHER})}}Ve.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class Wt extends Y{init(){this.propertyType=g.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}class Be extends Y{init(){this.propertyType=g.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:Be.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:Math.PI*2*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}}Be.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class H extends St{_validateParent(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}H.EXTENSION_NAME=void 0;class j extends Y{init(){this.propertyType=g.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:j.WrapMode.REPEAT,wrapT:j.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}}j.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},j.MagFilter={NEAREST:9728,LINEAR:9729},j.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:ft,G:ht,B:lt,A:Nn}=ne;class Le extends Y{init(){this.propertyType=g.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:Le.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new j(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new j(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new j(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new j(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new j(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:ft|ht|lt|Nn,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:ft|ht|lt,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:ft|ht|lt})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:ft})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:ht|lt})}}Le.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class Yt extends Y{init(){this.propertyType=g.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:new k})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}class Jt extends Y{init(){this.propertyType=g.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:new k})}copy(e,t=Oe){if(t===Oe)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return L.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),n=this.get("rotation").slice(),s=this.get("scale").slice();return L.decompose(e,t,n,s),this.set("translation",t).set("rotation",n).set("scale",s)}getWorldTranslation(){const e=[0,0,0];return L.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return L.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return L.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let s=this;s!=null;s=s.getParentNode())e.push(s);let t;const n=e.pop().getMatrix();for(;t=e.pop();)dn(n,n,t.getMatrix());return n}addChild(e){const t=e.getParentNode();t&&t.removeChild(e);for(const n of e.listParents())n.propertyType===g.SCENE&&n.removeChild(e);return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParentNode(){for(const e of this.listParents())if(e.propertyType===g.NODE)return e;return null}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}}class fe extends Y{init(){this.propertyType=g.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:fe.Mode.TRIANGLES,material:null,indices:null,attributes:new ue,targets:new k})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:te.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:te.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}fe.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class _n extends St{init(){this.propertyType=g.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new ue})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:te.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function J(){return J=Object.assign?Object.assign.bind():function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)({}).hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},J.apply(null,arguments)}class Zt extends Y{init(){this.propertyType=g.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:new k})}copy(e,t=Oe){if(t===Oe)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){const t=e.getParentNode();return t&&t.removeChild(e),this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}}class Qt extends Y{init(){this.propertyType=g.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:new k})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:te.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}class es extends Y{init(){this.propertyType=g.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||he.extensionToMimeType(ke.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=he.extensionToMimeType(ke.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",F.assertView(e))}getSize(){const e=this.get("image");return e?he.getSize(e,this.getMimeType()):null}}class ts extends Y{init(){this.propertyType=g.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${kt}`,version:"2.0"},defaultScene:null,accessors:new k,animations:new k,buffers:new k,cameras:new k,materials:new k,meshes:new k,nodes:new k,scenes:new k,skins:new k,textures:new k})}constructor(e){super(e),this._extensions=new Set,e.addEventListener("node:create",t=>{this._addChildOfRoot(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=Oe){if(t===Oe)throw new Error("Root cannot be copied.");this.set("asset",J({},e.get("asset"))),this.setName(e.getName()),this.setExtras(J({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const n of e.listRefMapKeys("extensions")){const s=e.getExtension(n);this.setExtension(n,t(s))}return this}_addChildOfRoot(e){return e instanceof Zt?this.addRef("scenes",e):e instanceof Jt?this.addRef("nodes",e):e instanceof Be?this.addRef("cameras",e):e instanceof Qt?this.addRef("skins",e):e instanceof Yt?this.addRef("meshes",e):e instanceof Le?this.addRef("materials",e):e instanceof es?this.addRef("textures",e):e instanceof qt?this.addRef("animations",e):e instanceof b?this.addRef("accessors",e):e instanceof Wt&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this._extensions)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}_enableExtension(e){return this._extensions.add(e),this}_disableExtension(e){return this._extensions.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class We{static fromGraph(e){return We._GRAPH_DOCUMENTS.get(e)||null}constructor(){this._graph=new rn,this._root=new ts(this._graph),this._logger=re.DEFAULT_INSTANCE,We._GRAPH_DOCUMENTS.set(this._graph,this)}getRoot(){return this._root}getGraph(){return this._graph}getLogger(){return this._logger}setLogger(e){return this._logger=e,this}clone(){throw new Error("Use 'cloneDocument(source)' from '@gltf-transform/functions'.")}merge(e){throw new Error("Use 'mergeDocuments(target, source)' from '@gltf-transform/functions'.")}async transform(...e){const t=e.map(n=>n.name);for(const n of e)await n(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(s=>s.extensionName===t)||new e(this)}createScene(e=""){return new Zt(this._graph,e)}createNode(e=""){return new Jt(this._graph,e)}createCamera(e=""){return new Be(this._graph,e)}createSkin(e=""){return new Qt(this._graph,e)}createMesh(e=""){return new Yt(this._graph,e)}createPrimitive(){return new fe(this._graph)}createPrimitiveTarget(e=""){return new _n(this._graph,e)}createMaterial(e=""){return new Le(this._graph,e)}createTexture(e=""){return new es(this._graph,e)}createAnimation(e=""){return new qt(this._graph,e)}createAnimationChannel(e=""){return new ut(this._graph,e)}createAnimationSampler(e=""){return new Ve(this._graph,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new b(this._graph,e).setBuffer(t)}createBuffer(e=""){return new Wt(this._graph,e)}}We._GRAPH_DOCUMENTS=new WeakMap;class V{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=e,e.getRoot()._enableExtension(this),this._listener=n=>{const s=n,r=s.target;r instanceof H&&r.extensionName===this.extensionName&&(s.type==="node:create"&&this._addExtensionProperty(r),s.type==="node:dispose"&&this._removeExtensionProperty(r))};const t=e.getGraph();t.addEventListener("node:create",this._listener),t.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const e=this.document.getGraph();e.removeEventListener("node:create",this._listener),e.removeEventListener("node:dispose",this._listener);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(e){return this.properties.add(e),this}_removeExtensionProperty(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}V.EXTENSION_NAME=void 0;class Sn{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const n=this.jsonDoc.json.textures[t.index];if(n.sampler===void 0)return;const s=this.jsonDoc.json.samplers[n.sampler];s.magFilter!==void 0&&e.setMagFilter(s.magFilter),s.minFilter!==void 0&&e.setMinFilter(s.minFilter),s.wrapS!==void 0&&e.setWrapS(s.wrapS),s.wrapT!==void 0&&e.setWrapT(s.wrapT)}}const ss={logger:re.DEFAULT_INSTANCE,extensions:[],dependencies:{}},bn=new Set([g.BUFFER,g.TEXTURE,g.MATERIAL,g.MESH,g.PRIMITIVE,g.NODE,g.SCENE]);class Mn{static read(e,t=ss){const n=J({},ss,t),{json:s}=e,r=new We().setLogger(n.logger);this.validate(e,n);const o=new Sn(e),a=s.asset,c=r.getRoot().getAsset();a.copyright&&(c.copyright=a.copyright),a.extras&&(c.extras=a.extras),s.extras!==void 0&&r.getRoot().setExtras(J({},s.extras));const u=s.extensionsUsed||[],l=s.extensionsRequired||[];n.extensions.sort((f,T)=>f.EXTENSION_NAME>T.EXTENSION_NAME?1:-1);for(const f of n.extensions)if(u.includes(f.EXTENSION_NAME)){const T=r.createExtension(f).setRequired(l.includes(f.EXTENSION_NAME)),R=T.prereadTypes.filter(w=>!bn.has(w));R.length&&n.logger.warn(`Preread hooks for some types (${R.join()}), requested by extension ${T.extensionName}, are unsupported. Please file an issue or a PR.`);for(const w of T.readDependencies)T.install(w,n.dependencies[w])}const d=s.buffers||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.BUFFER)).forEach(f=>f.preread(o,g.BUFFER)),o.buffers=d.map(f=>{const T=r.createBuffer(f.name);return f.extras&&T.setExtras(f.extras),f.uri&&f.uri.indexOf("__")!==0&&T.setURI(f.uri),T});const x=s.bufferViews||[];o.bufferViewBuffers=x.map((f,T)=>{if(!o.bufferViews[T]){const R=e.json.buffers[f.buffer],w=R.uri?e.resources[R.uri]:e.resources[je],C=f.byteOffset||0;o.bufferViews[T]=F.toView(w,C,f.byteLength)}return o.buffers[f.buffer]});const p=s.accessors||[];o.accessors=p.map(f=>{const T=o.bufferViewBuffers[f.bufferView],R=r.createAccessor(f.name,T).setType(f.type);return f.extras&&R.setExtras(f.extras),f.normalized!==void 0&&R.setNormalized(f.normalized),f.bufferView===void 0||R.setArray(dt(f,o)),R});const I=s.images||[],S=s.textures||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.TEXTURE)).forEach(f=>f.preread(o,g.TEXTURE)),o.textures=I.map(f=>{const T=r.createTexture(f.name);if(f.extras&&T.setExtras(f.extras),f.bufferView!==void 0){const R=s.bufferViews[f.bufferView],w=e.json.buffers[R.buffer],C=w.uri?e.resources[w.uri]:e.resources[je],N=R.byteOffset||0,M=R.byteLength,D=C.slice(N,N+M);T.setImage(D)}else f.uri!==void 0&&(T.setImage(e.resources[f.uri]),f.uri.indexOf("__")!==0&&T.setURI(f.uri));if(f.mimeType!==void 0)T.setMimeType(f.mimeType);else if(f.uri){const R=ke.extension(f.uri);T.setMimeType(he.extensionToMimeType(R))}return T}),r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.MATERIAL)).forEach(f=>f.preread(o,g.MATERIAL));const _=s.materials||[];o.materials=_.map(f=>{const T=r.createMaterial(f.name);f.extras&&T.setExtras(f.extras),f.alphaMode!==void 0&&T.setAlphaMode(f.alphaMode),f.alphaCutoff!==void 0&&T.setAlphaCutoff(f.alphaCutoff),f.doubleSided!==void 0&&T.setDoubleSided(f.doubleSided);const R=f.pbrMetallicRoughness||{};if(R.baseColorFactor!==void 0&&T.setBaseColorFactor(R.baseColorFactor),f.emissiveFactor!==void 0&&T.setEmissiveFactor(f.emissiveFactor),R.metallicFactor!==void 0&&T.setMetallicFactor(R.metallicFactor),R.roughnessFactor!==void 0&&T.setRoughnessFactor(R.roughnessFactor),R.baseColorTexture!==void 0){const w=R.baseColorTexture,C=o.textures[S[w.index].source];T.setBaseColorTexture(C),o.setTextureInfo(T.getBaseColorTextureInfo(),w)}if(f.emissiveTexture!==void 0){const w=f.emissiveTexture,C=o.textures[S[w.index].source];T.setEmissiveTexture(C),o.setTextureInfo(T.getEmissiveTextureInfo(),w)}if(f.normalTexture!==void 0){const w=f.normalTexture,C=o.textures[S[w.index].source];T.setNormalTexture(C),o.setTextureInfo(T.getNormalTextureInfo(),w),f.normalTexture.scale!==void 0&&T.setNormalScale(f.normalTexture.scale)}if(f.occlusionTexture!==void 0){const w=f.occlusionTexture,C=o.textures[S[w.index].source];T.setOcclusionTexture(C),o.setTextureInfo(T.getOcclusionTextureInfo(),w),f.occlusionTexture.strength!==void 0&&T.setOcclusionStrength(f.occlusionTexture.strength)}if(R.metallicRoughnessTexture!==void 0){const w=R.metallicRoughnessTexture,C=o.textures[S[w.index].source];T.setMetallicRoughnessTexture(C),o.setTextureInfo(T.getMetallicRoughnessTextureInfo(),w)}return T}),r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.MESH)).forEach(f=>f.preread(o,g.MESH));const h=s.meshes||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.PRIMITIVE)).forEach(f=>f.preread(o,g.PRIMITIVE)),o.meshes=h.map(f=>{const T=r.createMesh(f.name);return f.extras&&T.setExtras(f.extras),f.weights!==void 0&&T.setWeights(f.weights),(f.primitives||[]).forEach(w=>{const C=r.createPrimitive();w.extras&&C.setExtras(w.extras),w.material!==void 0&&C.setMaterial(o.materials[w.material]),w.mode!==void 0&&C.setMode(w.mode);for(const[D,v]of Object.entries(w.attributes||{}))C.setAttribute(D,o.accessors[v]);w.indices!==void 0&&C.setIndices(o.accessors[w.indices]);const N=f.extras&&f.extras.targetNames||[];(w.targets||[]).forEach((D,v)=>{const U=N[v]||v.toString(),P=r.createPrimitiveTarget(U);for(const[Q,W]of Object.entries(D))P.setAttribute(Q,o.accessors[W]);C.addTarget(P)}),T.addPrimitive(C)}),T});const O=s.cameras||[];o.cameras=O.map(f=>{const T=r.createCamera(f.name).setType(f.type);if(f.extras&&T.setExtras(f.extras),f.type===Be.Type.PERSPECTIVE){const R=f.perspective;T.setYFov(R.yfov),T.setZNear(R.znear),R.zfar!==void 0&&T.setZFar(R.zfar),R.aspectRatio!==void 0&&T.setAspectRatio(R.aspectRatio)}else{const R=f.orthographic;T.setZNear(R.znear).setZFar(R.zfar).setXMag(R.xmag).setYMag(R.ymag)}return T});const E=s.nodes||[];r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.NODE)).forEach(f=>f.preread(o,g.NODE)),o.nodes=E.map(f=>{const T=r.createNode(f.name);if(f.extras&&T.setExtras(f.extras),f.translation!==void 0&&T.setTranslation(f.translation),f.rotation!==void 0&&T.setRotation(f.rotation),f.scale!==void 0&&T.setScale(f.scale),f.matrix!==void 0){const R=[0,0,0],w=[0,0,0,1],C=[1,1,1];L.decompose(f.matrix,R,w,C),T.setTranslation(R),T.setRotation(w),T.setScale(C)}return f.weights!==void 0&&T.setWeights(f.weights),T});const A=s.skins||[];o.skins=A.map(f=>{const T=r.createSkin(f.name);f.extras&&T.setExtras(f.extras),f.inverseBindMatrices!==void 0&&T.setInverseBindMatrices(o.accessors[f.inverseBindMatrices]),f.skeleton!==void 0&&T.setSkeleton(o.nodes[f.skeleton]);for(const R of f.joints)T.addJoint(o.nodes[R]);return T}),E.map((f,T)=>{const R=o.nodes[T];(f.children||[]).forEach(C=>R.addChild(o.nodes[C])),f.mesh!==void 0&&R.setMesh(o.meshes[f.mesh]),f.camera!==void 0&&R.setCamera(o.cameras[f.camera]),f.skin!==void 0&&R.setSkin(o.skins[f.skin])});const m=s.animations||[];o.animations=m.map(f=>{const T=r.createAnimation(f.name);f.extras&&T.setExtras(f.extras);const w=(f.samplers||[]).map(N=>{const M=r.createAnimationSampler().setInput(o.accessors[N.input]).setOutput(o.accessors[N.output]).setInterpolation(N.interpolation||Ve.Interpolation.LINEAR);return N.extras&&M.setExtras(N.extras),T.addSampler(M),M});return(f.channels||[]).forEach(N=>{const M=r.createAnimationChannel().setSampler(w[N.sampler]).setTargetPath(N.target.path);N.target.node!==void 0&&M.setTargetNode(o.nodes[N.target.node]),N.extras&&M.setExtras(N.extras),T.addChannel(M)}),T});const y=s.scenes||[];return r.getRoot().listExtensionsUsed().filter(f=>f.prereadTypes.includes(g.SCENE)).forEach(f=>f.preread(o,g.SCENE)),o.scenes=y.map(f=>{const T=r.createScene(f.name);return f.extras&&T.setExtras(f.extras),(f.nodes||[]).map(w=>o.nodes[w]).forEach(w=>T.addChild(w)),T}),s.scene!==void 0&&r.getRoot().setDefaultScene(o.scenes[s.scene]),r.getRoot().listExtensionsUsed().forEach(f=>f.read(o)),p.forEach((f,T)=>{const R=o.accessors[T],w=!!f.sparse,C=!f.bufferView&&!R.getArray();(w||C)&&R.setSparse(!0).setArray(Cn(f,o))}),r}static validate(e,t){const n=e.json;if(n.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${n.asset.version}".`);if(n.extensionsRequired){for(const s of n.extensionsRequired)if(!t.extensions.find(r=>r.EXTENSION_NAME===s))throw new Error(`Missing required extension, "${s}".`)}if(n.extensionsUsed)for(const s of n.extensionsUsed)t.extensions.find(r=>r.EXTENSION_NAME===s)||t.logger.warn(`Missing optional extension, "${s}".`)}}function On(i,e){const t=e.jsonDoc,n=e.bufferViews[i.bufferView],s=t.json.bufferViews[i.bufferView],r=ot[i.componentType],o=b.getElementSize(i.type),a=r.BYTES_PER_ELEMENT,c=i.byteOffset||0,u=new r(i.count*o),l=new DataView(n.buffer,n.byteOffset,n.byteLength),d=s.byteStride;for(let x=0;x<i.count;x++)for(let p=0;p<o;p++){const I=c+x*d+p*a;let S;switch(i.componentType){case b.ComponentType.FLOAT:S=l.getFloat32(I,!0);break;case b.ComponentType.UNSIGNED_INT:S=l.getUint32(I,!0);break;case b.ComponentType.UNSIGNED_SHORT:S=l.getUint16(I,!0);break;case b.ComponentType.UNSIGNED_BYTE:S=l.getUint8(I);break;case b.ComponentType.SHORT:S=l.getInt16(I,!0);break;case b.ComponentType.BYTE:S=l.getInt8(I);break;default:throw new Error(`Unexpected componentType "${i.componentType}".`)}u[x*o+p]=S}return u}function dt(i,e){const t=e.jsonDoc,n=e.bufferViews[i.bufferView],s=t.json.bufferViews[i.bufferView],r=ot[i.componentType],o=b.getElementSize(i.type),a=r.BYTES_PER_ELEMENT,c=o*a;if(s.byteStride!==void 0&&s.byteStride!==c)return On(i,e);const u=n.byteOffset+(i.byteOffset||0),l=i.count*o*a;return new r(n.buffer.slice(u,u+l))}function Cn(i,e){const t=ot[i.componentType],n=b.getElementSize(i.type);let s;i.bufferView!==void 0?s=dt(i,e):s=new t(i.count*n);const r=i.sparse;if(!r)return s;const o=r.count,a=J({},i,r.indices,{count:o,type:"SCALAR"}),c=J({},i,r.values,{count:o}),u=dt(a,e),l=dt(c,e);for(let d=0;d<a.count;d++)for(let x=0;x<n;x++)s[u[d]*n+x]=l[d*n+x];return s}var Ye;(function(i){i[i.ARRAY_BUFFER=34962]="ARRAY_BUFFER",i[i.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(Ye||(Ye={}));class le{constructor(e,t,n){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=e,this.jsonDoc=t,this.options=n;const s=e.getRoot(),r=s.listBuffers().length,o=s.listTextures().length;this.bufferURIGenerator=new ns(r>1,()=>n.basename||"buffer"),this.imageURIGenerator=new ns(o>1,a=>Dn(e,a)||n.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const n={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},s=JSON.stringify(n);this.samplerDefIndexMap.has(s)||(this.samplerDefIndexMap.set(s,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(n));const r={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(s)},o=JSON.stringify(r);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(r));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this._doc.getGraph().listParentEdges(e).some(s=>s.getName()==="attributes"&&s.getAttributes().key==="POSITION"||s.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,n){if(this.options.format===Me.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const s=he.mimeTypeToExtension(n.getMimeType());e.uri=this.imageURIGenerator.createURI(n,s),this.assignResourceURI(e.uri,t,!1)}}assignResourceURI(e,t,n){const s=this.jsonDoc.resources;if(!(e in s)){s[e]=t;return}if(t===s[e]){this.logger.warn(`Duplicate resource URI, "${e}".`);return}const r=`Resource URI "${e}" already assigned to different data.`;if(!n){this.logger.warn(r);return}throw new Error(r)}getAccessorUsage(e){const t=this._accessorUsageMap.get(e);if(t)return t;if(e.getSparse())return te.SPARSE;for(const n of this._doc.getGraph().listParentEdges(e)){const{usage:s}=n.getAttributes();if(s)return s;n.getParent().propertyType!==g.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${n.getName()}".`)}return te.OTHER}addAccessorToUsageGroup(e,t){const n=this._accessorUsageMap.get(e);if(n&&n!==t)throw new Error(`Accessor with usage "${n}" cannot be reused as "${t}".`);return this._accessorUsageMap.set(e,t),this}}le.BufferViewTarget=Ye,le.BufferViewUsage=te,le.USAGE_TO_TARGET={[te.ARRAY_BUFFER]:Ye.ARRAY_BUFFER,[te.ELEMENT_ARRAY_BUFFER]:Ye.ELEMENT_ARRAY_BUFFER};class ns{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const n=this.basename(e);return this.counter[n]=this.counter[n]||1,`${n}_${this.counter[n]++}.${t}`}else return`${this.basename(e)}.${t}`}}function Dn(i,e){const t=i.getGraph().listParentEdges(e).find(n=>n.getParent()!==i.getRoot());return t?t.getName().replace(/texture$/i,""):""}const{BufferViewUsage:gt}=le,{UNSIGNED_INT:vn,UNSIGNED_SHORT:Fn,UNSIGNED_BYTE:Un}=b.ComponentType,Bn=new Set([g.ACCESSOR,g.BUFFER,g.MATERIAL,g.MESH]);class Ln{static write(e,t){const n=e.getGraph(),s=e.getRoot(),r={asset:J({generator:`glTF-Transform ${kt}`},s.getAsset()),extras:J({},s.getExtras())},o={json:r,resources:{}},a=new le(e,o,t),c=t.logger||re.DEFAULT_INSTANCE,u=new Set(t.extensions.map(h=>h.EXTENSION_NAME)),l=e.getRoot().listExtensionsUsed().filter(h=>u.has(h.extensionName)).sort((h,O)=>h.extensionName>O.extensionName?1:-1),d=e.getRoot().listExtensionsRequired().filter(h=>u.has(h.extensionName)).sort((h,O)=>h.extensionName>O.extensionName?1:-1);l.length<e.getRoot().listExtensionsUsed().length&&c.warn("Some extensions were not registered for I/O, and will not be written.");for(const h of l){const O=h.prewriteTypes.filter(E=>!Bn.has(E));O.length&&c.warn(`Prewrite hooks for some types (${O.join()}), requested by extension ${h.extensionName}, are unsupported. Please file an issue or a PR.`);for(const E of h.writeDependencies)h.install(E,t.dependencies[E])}function x(h,O,E,A){const m=[];let y=0;for(const R of h){const w=a.createAccessorDef(R);w.bufferView=r.bufferViews.length;const C=R.getArray(),N=F.pad(F.toView(C));w.byteOffset=y,y+=N.byteLength,m.push(N),a.accessorIndexMap.set(R,r.accessors.length),r.accessors.push(w)}const f=F.concat(m),T={buffer:O,byteOffset:E,byteLength:f.byteLength};return A&&(T.target=A),r.bufferViews.push(T),{buffers:m,byteLength:y}}function p(h,O,E){const A=h[0].getCount();let m=0;for(const w of h){const C=a.createAccessorDef(w);C.bufferView=r.bufferViews.length,C.byteOffset=m;const N=w.getElementSize(),M=w.getComponentSize();m+=F.padNumber(N*M),a.accessorIndexMap.set(w,r.accessors.length),r.accessors.push(C)}const y=A*m,f=new ArrayBuffer(y),T=new DataView(f);for(let w=0;w<A;w++){let C=0;for(const N of h){const M=N.getElementSize(),D=N.getComponentSize(),v=N.getComponentType(),U=N.getArray();for(let P=0;P<M;P++){const Q=w*m+C+P*D,W=U[w*M+P];switch(v){case b.ComponentType.FLOAT:T.setFloat32(Q,W,!0);break;case b.ComponentType.BYTE:T.setInt8(Q,W);break;case b.ComponentType.SHORT:T.setInt16(Q,W,!0);break;case b.ComponentType.UNSIGNED_BYTE:T.setUint8(Q,W);break;case b.ComponentType.UNSIGNED_SHORT:T.setUint16(Q,W,!0);break;case b.ComponentType.UNSIGNED_INT:T.setUint32(Q,W,!0);break;default:throw new Error("Unexpected component type: "+v)}}C+=F.padNumber(M*D)}}const R={buffer:O,byteOffset:E,byteLength:y,byteStride:m,target:le.BufferViewTarget.ARRAY_BUFFER};return r.bufferViews.push(R),{byteLength:y,buffers:[new Uint8Array(f)]}}function I(h,O,E){const A=[];let m=0;const y=new Map;let f=-1/0,T=!1;for(const v of h){const U=a.createAccessorDef(v);r.accessors.push(U),a.accessorIndexMap.set(v,r.accessors.length-1);const P=[],Q=[],W=[],Lt=new Array(v.getElementSize()).fill(0);for(let ve=0,Pt=v.getCount();ve<Pt;ve++)if(v.getElement(ve,W),!L.eq(W,Lt,0)){f=Math.max(ve,f),P.push(ve);for(let rt=0;rt<W.length;rt++)Q.push(W[rt])}const $e=P.length,Xe={accessorDef:U,count:$e};if(y.set(v,Xe),$e===0)continue;$e>v.getCount()/2&&(T=!0);const Et=ot[v.getComponentType()];Xe.indices=P,Xe.values=new Et(Q)}if(!Number.isFinite(f))return{buffers:A,byteLength:m};T&&c.warn("Some sparse accessors have >50% non-zero elements, which may increase file size.");const R=f<255?Uint8Array:f<65535?Uint16Array:Uint32Array,w=f<255?Un:f<65535?Fn:vn,C={buffer:O,byteOffset:E+m,byteLength:0};for(const v of h){const U=y.get(v);if(U.count===0)continue;U.indicesByteOffset=C.byteLength;const P=F.pad(F.toView(new R(U.indices)));A.push(P),m+=P.byteLength,C.byteLength+=P.byteLength}r.bufferViews.push(C);const N=r.bufferViews.length-1,M={buffer:O,byteOffset:E+m,byteLength:0};for(const v of h){const U=y.get(v);if(U.count===0)continue;U.valuesByteOffset=M.byteLength;const P=F.pad(F.toView(U.values));A.push(P),m+=P.byteLength,M.byteLength+=P.byteLength}r.bufferViews.push(M);const D=r.bufferViews.length-1;for(const v of h){const U=y.get(v);U.count!==0&&(U.accessorDef.sparse={count:U.count,indices:{bufferView:N,byteOffset:U.indicesByteOffset,componentType:w},values:{bufferView:D,byteOffset:U.valuesByteOffset}})}return{buffers:A,byteLength:m}}if(r.accessors=[],r.bufferViews=[],r.samplers=[],r.textures=[],r.images=s.listTextures().map((h,O)=>{const E=a.createPropertyDef(h);h.getMimeType()&&(E.mimeType=h.getMimeType());const A=h.getImage();return A&&a.createImageData(E,A,h),a.imageIndexMap.set(h,O),E}),l.filter(h=>h.prewriteTypes.includes(g.ACCESSOR)).forEach(h=>h.prewrite(a,g.ACCESSOR)),s.listAccessors().forEach(h=>{const O=a.accessorUsageGroupedByParent,E=a.accessorParents;if(a.accessorIndexMap.has(h))return;const A=a.getAccessorUsage(h);if(a.addAccessorToUsageGroup(h,A),O.has(A)){const m=n.listParents(h).find(y=>y.propertyType!==g.ROOT);E.set(h,m)}}),l.filter(h=>h.prewriteTypes.includes(g.BUFFER)).forEach(h=>h.prewrite(a,g.BUFFER)),(s.listAccessors().length>0||a.otherBufferViews.size>0||s.listTextures().length>0&&t.format===Me.GLB)&&s.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");r.buffers=[],s.listBuffers().forEach((h,O)=>{const E=a.createPropertyDef(h),A=a.accessorUsageGroupedByParent,m=h.listParents().filter(M=>M instanceof b),y=new Set(m.map(M=>a.accessorParents.get(M))),f=new Map(Array.from(y).map((M,D)=>[M,D])),T={};for(const M of m){var R;if(a.accessorIndexMap.has(M))continue;const D=a.getAccessorUsage(M);let v=D;if(A.has(D)){const U=a.accessorParents.get(M);v+=`:${f.get(U)}`}T[R=v]||(T[R]={usage:D,accessors:[]}),T[v].accessors.push(M)}const w=[],C=r.buffers.length;let N=0;for(const{usage:M,accessors:D}of Object.values(T))if(M===gt.ARRAY_BUFFER&&t.vertexLayout===it.INTERLEAVED){const v=p(D,C,N);N+=v.byteLength;for(const U of v.buffers)w.push(U)}else if(M===gt.ARRAY_BUFFER)for(const v of D){const U=p([v],C,N);N+=U.byteLength;for(const P of U.buffers)w.push(P)}else if(M===gt.SPARSE){const v=I(D,C,N);N+=v.byteLength;for(const U of v.buffers)w.push(U)}else if(M===gt.ELEMENT_ARRAY_BUFFER){const v=le.BufferViewTarget.ELEMENT_ARRAY_BUFFER,U=x(D,C,N,v);N+=U.byteLength;for(const P of U.buffers)w.push(P)}else{const v=x(D,C,N);N+=v.byteLength;for(const U of v.buffers)w.push(U)}if(a.imageBufferViews.length&&O===0){for(let M=0;M<a.imageBufferViews.length;M++)if(r.bufferViews[r.images[M].bufferView].byteOffset=N,N+=a.imageBufferViews[M].byteLength,w.push(a.imageBufferViews[M]),N%8){const D=8-N%8;N+=D,w.push(new Uint8Array(D))}}if(a.otherBufferViews.has(h))for(const M of a.otherBufferViews.get(h))r.bufferViews.push({buffer:C,byteOffset:N,byteLength:M.byteLength}),a.otherBufferViewsIndexMap.set(M,r.bufferViews.length-1),N+=M.byteLength,w.push(M);if(N){let M;t.format===Me.GLB?M=je:(M=a.bufferURIGenerator.createURI(h,"bin"),E.uri=M),E.byteLength=N,a.assignResourceURI(M,F.concat(w),!0)}r.buffers.push(E),a.bufferIndexMap.set(h,O)}),s.listAccessors().find(h=>!h.getBuffer())&&c.warn("Skipped writing one or more Accessors: no Buffer assigned."),l.filter(h=>h.prewriteTypes.includes(g.MATERIAL)).forEach(h=>h.prewrite(a,g.MATERIAL)),r.materials=s.listMaterials().map((h,O)=>{const E=a.createPropertyDef(h);if(h.getAlphaMode()!==Le.AlphaMode.OPAQUE&&(E.alphaMode=h.getAlphaMode()),h.getAlphaMode()===Le.AlphaMode.MASK&&(E.alphaCutoff=h.getAlphaCutoff()),h.getDoubleSided()&&(E.doubleSided=!0),E.pbrMetallicRoughness={},L.eq(h.getBaseColorFactor(),[1,1,1,1])||(E.pbrMetallicRoughness.baseColorFactor=h.getBaseColorFactor()),L.eq(h.getEmissiveFactor(),[0,0,0])||(E.emissiveFactor=h.getEmissiveFactor()),h.getRoughnessFactor()!==1&&(E.pbrMetallicRoughness.roughnessFactor=h.getRoughnessFactor()),h.getMetallicFactor()!==1&&(E.pbrMetallicRoughness.metallicFactor=h.getMetallicFactor()),h.getBaseColorTexture()){const A=h.getBaseColorTexture(),m=h.getBaseColorTextureInfo();E.pbrMetallicRoughness.baseColorTexture=a.createTextureInfoDef(A,m)}if(h.getEmissiveTexture()){const A=h.getEmissiveTexture(),m=h.getEmissiveTextureInfo();E.emissiveTexture=a.createTextureInfoDef(A,m)}if(h.getNormalTexture()){const A=h.getNormalTexture(),m=h.getNormalTextureInfo(),y=a.createTextureInfoDef(A,m);h.getNormalScale()!==1&&(y.scale=h.getNormalScale()),E.normalTexture=y}if(h.getOcclusionTexture()){const A=h.getOcclusionTexture(),m=h.getOcclusionTextureInfo(),y=a.createTextureInfoDef(A,m);h.getOcclusionStrength()!==1&&(y.strength=h.getOcclusionStrength()),E.occlusionTexture=y}if(h.getMetallicRoughnessTexture()){const A=h.getMetallicRoughnessTexture(),m=h.getMetallicRoughnessTextureInfo();E.pbrMetallicRoughness.metallicRoughnessTexture=a.createTextureInfoDef(A,m)}return a.materialIndexMap.set(h,O),E}),l.filter(h=>h.prewriteTypes.includes(g.MESH)).forEach(h=>h.prewrite(a,g.MESH)),r.meshes=s.listMeshes().map((h,O)=>{const E=a.createPropertyDef(h);let A=null;return E.primitives=h.listPrimitives().map(m=>{const y={attributes:{}};y.mode=m.getMode();const f=m.getMaterial();f&&(y.material=a.materialIndexMap.get(f)),Object.keys(m.getExtras()).length&&(y.extras=m.getExtras());const T=m.getIndices();T&&(y.indices=a.accessorIndexMap.get(T));for(const R of m.listSemantics())y.attributes[R]=a.accessorIndexMap.get(m.getAttribute(R));for(const R of m.listTargets()){const w={};for(const C of R.listSemantics())w[C]=a.accessorIndexMap.get(R.getAttribute(C));y.targets=y.targets||[],y.targets.push(w)}return m.listTargets().length&&!A&&(A=m.listTargets().map(R=>R.getName())),y}),h.getWeights().length&&(E.weights=h.getWeights()),A&&(E.extras=E.extras||{},E.extras.targetNames=A),a.meshIndexMap.set(h,O),E}),r.cameras=s.listCameras().map((h,O)=>{const E=a.createPropertyDef(h);if(E.type=h.getType(),E.type===Be.Type.PERSPECTIVE){E.perspective={znear:h.getZNear(),zfar:h.getZFar(),yfov:h.getYFov()};const A=h.getAspectRatio();A!==null&&(E.perspective.aspectRatio=A)}else E.orthographic={znear:h.getZNear(),zfar:h.getZFar(),xmag:h.getXMag(),ymag:h.getYMag()};return a.cameraIndexMap.set(h,O),E}),r.nodes=s.listNodes().map((h,O)=>{const E=a.createPropertyDef(h);return L.eq(h.getTranslation(),[0,0,0])||(E.translation=h.getTranslation()),L.eq(h.getRotation(),[0,0,0,1])||(E.rotation=h.getRotation()),L.eq(h.getScale(),[1,1,1])||(E.scale=h.getScale()),h.getWeights().length&&(E.weights=h.getWeights()),a.nodeIndexMap.set(h,O),E}),r.skins=s.listSkins().map((h,O)=>{const E=a.createPropertyDef(h),A=h.getInverseBindMatrices();A&&(E.inverseBindMatrices=a.accessorIndexMap.get(A));const m=h.getSkeleton();return m&&(E.skeleton=a.nodeIndexMap.get(m)),E.joints=h.listJoints().map(y=>a.nodeIndexMap.get(y)),a.skinIndexMap.set(h,O),E}),s.listNodes().forEach((h,O)=>{const E=r.nodes[O],A=h.getMesh();A&&(E.mesh=a.meshIndexMap.get(A));const m=h.getCamera();m&&(E.camera=a.cameraIndexMap.get(m));const y=h.getSkin();y&&(E.skin=a.skinIndexMap.get(y)),h.listChildren().length>0&&(E.children=h.listChildren().map(f=>a.nodeIndexMap.get(f)))}),r.animations=s.listAnimations().map((h,O)=>{const E=a.createPropertyDef(h),A=new Map;return E.samplers=h.listSamplers().map((m,y)=>{const f=a.createPropertyDef(m);return f.input=a.accessorIndexMap.get(m.getInput()),f.output=a.accessorIndexMap.get(m.getOutput()),f.interpolation=m.getInterpolation(),A.set(m,y),f}),E.channels=h.listChannels().map(m=>{const y=a.createPropertyDef(m);return y.sampler=A.get(m.getSampler()),y.target={node:a.nodeIndexMap.get(m.getTargetNode()),path:m.getTargetPath()},y}),a.animationIndexMap.set(h,O),E}),r.scenes=s.listScenes().map((h,O)=>{const E=a.createPropertyDef(h);return E.nodes=h.listChildren().map(A=>a.nodeIndexMap.get(A)),a.sceneIndexMap.set(h,O),E});const _=s.getDefaultScene();return _&&(r.scene=s.listScenes().indexOf(_)),r.extensionsUsed=l.map(h=>h.extensionName),r.extensionsRequired=d.map(h=>h.extensionName),l.forEach(h=>h.write(a)),Pn(r),o}}function Pn(i){const e=[];for(const t in i){const n=i[t];(Array.isArray(n)&&n.length===0||n===null||n===""||n&&typeof n=="object"&&Object.keys(n).length===0)&&e.push(t)}for(const t of e)delete i[t]}var pt;(function(i){i[i.JSON=1313821514]="JSON",i[i.BIN=5130562]="BIN"})(pt||(pt={}));class jn{constructor(){this._logger=re.DEFAULT_INSTANCE,this._extensions=new Set,this._dependencies={},this._vertexLayout=it.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this._logger=e,this}registerExtensions(e){for(const t of e)this._extensions.add(t),t.register();return this}registerDependencies(e){return Object.assign(this._dependencies,e),this}setVertexLayout(e){return this._vertexLayout=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const n=rs(t)?this._binaryToJSON(t):{json:JSON.parse(F.decodeText(t)),resources:{}};return await this._readResourcesExternal(n,this.dirname(e)),this._readResourcesInternal(n),n}async readJSON(e){return e=this._copyJSON(e),this._readResourcesInternal(e),Mn.read(e,{extensions:Array.from(this._extensions),dependencies:this._dependencies,logger:this._logger})}async binaryToJSON(e){const t=this._binaryToJSON(F.assertView(e));this._readResourcesInternal(t);const n=t.json;if(n.buffers&&n.buffers.some(s=>kn(t,s)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(n.images&&n.images.some(s=>Vn(t,s)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(F.assertView(e)))}async writeJSON(e,t={}){if(t.format===Me.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return Ln.write(e,{format:t.format||Me.GLTF,basename:t.basename||"",logger:this._logger,vertexLayout:this._vertexLayout,dependencies:J({},this._dependencies),extensions:Array.from(this._extensions)})}async writeBinary(e){const{json:t,resources:n}=await this.writeJSON(e,{format:Me.GLB}),s=new Uint32Array([1179937895,2,12]),r=JSON.stringify(t),o=F.pad(F.encodeText(r),32),a=F.toView(new Uint32Array([o.byteLength,1313821514])),c=F.concat([a,o]);s[s.length-1]+=c.byteLength;const u=Object.values(n)[0];if(!u||!u.byteLength)return F.concat([F.toView(s),c]);const l=F.pad(u,0),d=F.toView(new Uint32Array([l.byteLength,5130562])),x=F.concat([d,l]);return s[s.length-1]+=x.byteLength,F.concat([F.toView(s),c,x])}async _readResourcesExternal(e,t){var n=this;const s=e.json.images||[],r=e.json.buffers||[],o=[...s,...r].map(async function(a){const c=a.uri;if(!c||c.match(/data:/))return Promise.resolve();e.resources[c]=await n.readURI(n.resolve(t,c),"view"),n.lastReadBytes+=e.resources[c].byteLength});await Promise.all(o)}_readResourcesInternal(e){function t(r){if(r.uri){if(r.uri in e.resources){F.assertView(e.resources[r.uri]);return}if(r.uri.match(/data:/)){const o=`__${In()}.${ke.extension(r.uri)}`;e.resources[o]=F.createBufferFromDataURI(r.uri),r.uri=o}}}(e.json.images||[]).forEach(r=>{if(r.bufferView===void 0&&r.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(r)}),(e.json.buffers||[]).forEach(t)}_copyJSON(e){const{images:t,buffers:n}=e.json;return e={json:J({},e.json),resources:J({},e.resources)},t&&(e.json.images=t.map(s=>J({},s))),n&&(e.json.buffers=n.map(s=>J({},s))),e}_binaryToJSON(e){if(!rs(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==pt.JSON)throw new Error("Missing required GLB JSON chunk.");const n=20,s=t[0],r=F.decodeText(F.toView(e,n,s)),o=JSON.parse(r),a=n+s;if(e.byteLength<=a)return{json:o,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+a,2);if(c[1]!==pt.BIN)return{json:o,resources:{}};const u=c[0],l=F.toView(e,a+8,u);return{json:o,resources:{[je]:l}}}}function kn(i,e){return e.uri!==void 0&&!(e.uri in i.resources)}function Vn(i,e){return e.uri!==void 0&&!(e.uri in i.resources)&&e.bufferView===void 0}function rs(i){if(i.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(i.buffer,i.byteOffset,3);return e[0]===1179937895&&e[1]===2}class Gn extends jn{constructor(e=qe.DEFAULT_INIT){super(),this._fetchConfig=void 0,this._fetchConfig=e}async readURI(e,t){const n=await fetch(e,this._fetchConfig);switch(t){case"view":return new Uint8Array(await n.arrayBuffer());case"text":return n.text()}}resolve(e,t){return qe.resolve(e,t)}dirname(e){return qe.dirname(e)}}const Hn=0,zn=0,$n=0,Xn=2,Kn=0,qn=163,Wn=166,Yn=0,Jn=2,Zn=1,Qn=64,er=0;function tr(){return{vkFormat:er,typeSize:1,pixelWidth:0,pixelHeight:0,pixelDepth:0,layerCount:0,faceCount:1,levelCount:0,supercompressionScheme:Hn,levels:[],dataFormatDescriptor:[{vendorId:$n,descriptorType:zn,versionNumber:Xn,colorModel:Kn,colorPrimaries:Zn,transferFunction:Jn,flags:Yn,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],keyValue:{},globalData:null}}class Je{constructor(e,t,n,s){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=s,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),n=e+2**32*t;return this._offset+=8,n}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){const n=this._offset;let s=0;for(;this._dataView.getUint8(this._offset)!==t&&s<e;)s++,this._offset++;return s<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,s)}}const Z=[171,75,84,88,32,50,48,187,13,10,26,10];function is(i){return new TextDecoder().decode(i)}function bt(i){const e=new Uint8Array(i.buffer,i.byteOffset,Z.length);if(e[0]!==Z[0]||e[1]!==Z[1]||e[2]!==Z[2]||e[3]!==Z[3]||e[4]!==Z[4]||e[5]!==Z[5]||e[6]!==Z[6]||e[7]!==Z[7]||e[8]!==Z[8]||e[9]!==Z[9]||e[10]!==Z[10]||e[11]!==Z[11])throw new Error("Missing KTX 2.0 identifier.");const t=tr(),n=17*Uint32Array.BYTES_PER_ELEMENT,s=new Je(i,Z.length,n,!0);t.vkFormat=s._nextUint32(),t.typeSize=s._nextUint32(),t.pixelWidth=s._nextUint32(),t.pixelHeight=s._nextUint32(),t.pixelDepth=s._nextUint32(),t.layerCount=s._nextUint32(),t.faceCount=s._nextUint32(),t.levelCount=s._nextUint32(),t.supercompressionScheme=s._nextUint32();const r=s._nextUint32(),o=s._nextUint32(),a=s._nextUint32(),c=s._nextUint32(),u=s._nextUint64(),l=s._nextUint64(),d=Math.max(t.levelCount,1)*3*8,x=new Je(i,Z.length+n,d,!0);for(let ee=0,se=Math.max(t.levelCount,1);ee<se;ee++)t.levels.push({levelData:new Uint8Array(i.buffer,i.byteOffset+x._nextUint64(),x._nextUint64()),uncompressedByteLength:x._nextUint64()});const p=new Je(i,r,o,!0);p._skip(4);const I=p._nextUint16(),S=p._nextUint16(),_=p._nextUint16(),h=p._nextUint16(),O=p._nextUint8(),E=p._nextUint8(),A=p._nextUint8(),m=p._nextUint8(),y=[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],f=[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],R={vendorId:I,descriptorType:S,versionNumber:_,colorModel:O,colorPrimaries:E,transferFunction:A,flags:m,texelBlockDimension:y,bytesPlane:f,samples:[]},N=(h/4-6)/4;for(let ee=0;ee<N;ee++){const se={bitOffset:p._nextUint16(),bitLength:p._nextUint8(),channelType:p._nextUint8(),samplePosition:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],sampleLower:Number.NEGATIVE_INFINITY,sampleUpper:Number.POSITIVE_INFINITY};se.channelType&Qn?(se.sampleLower=p._nextInt32(),se.sampleUpper=p._nextInt32()):(se.sampleLower=p._nextUint32(),se.sampleUpper=p._nextUint32()),R.samples[ee]=se}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(R);const M=new Je(i,a,c,!0);for(;M._offset<c;){const ee=M._nextUint32(),se=M._scan(ee),yt=is(se);if(t.keyValue[yt]=M._nextUint8Array(ee-se.byteLength-1),yt.match(/^ktx/i)){const nn=is(t.keyValue[yt]);t.keyValue[yt]=nn.substring(0,nn.lastIndexOf("\0"))}const Ki=ee%4?4-ee%4:0;M._skip(Ki)}if(l<=0)return t;const D=new Je(i,u,l,!0),v=D._nextUint16(),U=D._nextUint16(),P=D._nextUint32(),Q=D._nextUint32(),W=D._nextUint32(),Lt=D._nextUint32(),$e=[];for(let ee=0,se=Math.max(t.levelCount,1);ee<se;ee++)$e.push({imageFlags:D._nextUint32(),rgbSliceByteOffset:D._nextUint32(),rgbSliceByteLength:D._nextUint32(),alphaSliceByteOffset:D._nextUint32(),alphaSliceByteLength:D._nextUint32()});const Xe=u+D._offset,Et=Xe+P,ve=Et+Q,Pt=ve+W,rt=new Uint8Array(i.buffer,i.byteOffset+Xe,P),zi=new Uint8Array(i.buffer,i.byteOffset+Et,Q),$i=new Uint8Array(i.buffer,i.byteOffset+ve,W),Xi=new Uint8Array(i.buffer,i.byteOffset+Pt,Lt);return t.globalData={endpointCount:v,selectorCount:U,imageDescs:$e,endpointsData:rt,selectorsData:zi,tablesData:$i,extendedData:Xi},t}const de="EXT_mesh_gpu_instancing",K="EXT_meshopt_compression",Ze="EXT_texture_webp",Qe="EXT_texture_avif",G="KHR_draco_mesh_compression",ie="KHR_lights_punctual",ge="KHR_materials_anisotropy",pe="KHR_materials_clearcoat",me="KHR_materials_diffuse_transmission",xe="KHR_materials_dispersion",Te="KHR_materials_emissive_strength",Ee="KHR_materials_ior",ye="KHR_materials_iridescence",Re="KHR_materials_pbrSpecularGlossiness",Ie="KHR_materials_sheen",we="KHR_materials_specular",Ae="KHR_materials_transmission",Ce="KHR_materials_unlit",Ne="KHR_materials_volume",q="KHR_materials_variants",os="KHR_mesh_quantization",et="KHR_texture_basisu",_e="KHR_texture_transform",oe="KHR_xmp_json_ld",Mt="INSTANCE_ATTRIBUTE";class as extends H{init(){this.extensionName=de,this.propertyType="InstancedMesh",this.parentTypes=[g.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new ue})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:Mt})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}as.EXTENSION_NAME=de;class sr extends V{constructor(...e){super(...e),this.extensionName=de,this.provideTypes=[g.NODE],this.prewriteTypes=[g.ACCESSOR]}createInstancedMesh(){return new as(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[de])return;const o=s.extensions[de],a=this.createInstancedMesh();for(const c in o.attributes)a.setAttribute(c,e.accessors[o.attributes[c]]);e.nodes[r].setExtension(de,a)}),this}prewrite(e){e.accessorUsageGroupedByParent.add(Mt);for(const t of this.properties)for(const n of t.listAttributes())e.addAccessorToUsageGroup(n,Mt);return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach(n=>{const s=n.getExtension(de);if(s){const r=e.nodeIndexMap.get(n),o=t.json.nodes[r],a={attributes:{}};s.listSemantics().forEach(c=>{const u=s.getAttribute(c);a.attributes[c]=e.accessorIndexMap.get(u)}),o.extensions=o.extensions||{},o.extensions[de]=a}}),this}}sr.EXTENSION_NAME=de;function Se(){return Se=Object.assign?Object.assign.bind():function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)({}).hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},Se.apply(null,arguments)}var tt;(function(i){i.QUANTIZE="quantize",i.FILTER="filter"})(tt||(tt={}));var Ge;(function(i){i.ATTRIBUTES="ATTRIBUTES",i.TRIANGLES="TRIANGLES",i.INDICES="INDICES"})(Ge||(Ge={}));var z;(function(i){i.NONE="NONE",i.OCTAHEDRAL="OCTAHEDRAL",i.QUATERNION="QUATERNION",i.EXPONENTIAL="EXPONENTIAL"})(z||(z={}));function nr(i){return!i.extensions||!i.extensions[K]?!1:!!i.extensions[K].fallback}const{BYTE:rr,SHORT:cs,FLOAT:ir}=b.ComponentType,{encodeNormalizedInt:us,decodeNormalizedInt:Ot}=L;function or(i,e,t,n){const{filter:s,bits:r}=n,o={array:i.getArray(),byteStride:i.getElementSize()*i.getComponentSize(),componentType:i.getComponentType(),normalized:i.getNormalized()};if(t!==Ge.ATTRIBUTES)return o;if(s!==z.NONE){let a=i.getNormalized()?ar(i):new Float32Array(o.array);switch(s){case z.EXPONENTIAL:o.byteStride=i.getElementSize()*4,o.componentType=ir,o.normalized=!1,o.array=e.encodeFilterExp(a,i.getCount(),o.byteStride,r);break;case z.OCTAHEDRAL:o.byteStride=r>8?8:4,o.componentType=r>8?cs:rr,o.normalized=!0,a=i.getElementSize()===3?ur(a):a,o.array=e.encodeFilterOct(a,i.getCount(),o.byteStride,r);break;case z.QUATERNION:o.byteStride=8,o.componentType=cs,o.normalized=!0,o.array=e.encodeFilterQuat(a,i.getCount(),o.byteStride,r);break;default:throw new Error("Invalid filter.")}o.min=i.getMin([]),o.max=i.getMax([]),i.getNormalized()&&(o.min=o.min.map(c=>Ot(c,i.getComponentType())),o.max=o.max.map(c=>Ot(c,i.getComponentType()))),o.normalized&&(o.min=o.min.map(c=>us(c,o.componentType)),o.max=o.max.map(c=>us(c,o.componentType)))}else o.byteStride%4&&(o.array=cr(o.array,i.getElementSize()),o.byteStride=o.array.byteLength/i.getCount());return o}function ar(i){const e=i.getComponentType(),t=i.getArray(),n=new Float32Array(t.length);for(let s=0;s<t.length;s++)n[s]=Ot(t[s],e);return n}function cr(i,e){const n=F.padNumber(i.BYTES_PER_ELEMENT*e)/i.BYTES_PER_ELEMENT,s=i.length/e,r=new i.constructor(s*n);for(let o=0;o*e<i.length;o++)for(let a=0;a<e;a++)r[o*n+a]=i[o*e+a];return r}function ur(i){const e=new Float32Array(i.length*4/3);for(let t=0,n=i.length/3;t<n;t++)e[t*4]=i[t*3],e[t*4+1]=i[t*3+1],e[t*4+2]=i[t*3+2];return e}function fr(i,e){return e===le.BufferViewUsage.ELEMENT_ARRAY_BUFFER?i.listParents().some(n=>n instanceof fe&&n.getMode()===fe.Mode.TRIANGLES)?Ge.TRIANGLES:Ge.INDICES:Ge.ATTRIBUTES}function hr(i,e){const t=e.getGraph().listParentEdges(i).filter(n=>!(n.getParent()instanceof ts));for(const n of t){const s=n.getName(),r=n.getAttributes().key||"",o=n.getParent().propertyType===g.PRIMITIVE_TARGET;if(s==="indices")return{filter:z.NONE};if(s==="attributes"){if(r==="POSITION")return{filter:z.NONE};if(r==="TEXCOORD_0")return{filter:z.NONE};if(r.startsWith("JOINTS_"))return{filter:z.NONE};if(r.startsWith("WEIGHTS_"))return{filter:z.NONE};if(r==="NORMAL"||r==="TANGENT")return o?{filter:z.NONE}:{filter:z.OCTAHEDRAL,bits:8}}if(s==="output"){const a=fs(i);return a==="rotation"?{filter:z.QUATERNION,bits:16}:a==="translation"?{filter:z.EXPONENTIAL,bits:12}:a==="scale"?{filter:z.EXPONENTIAL,bits:12}:{filter:z.NONE}}if(s==="input")return{filter:z.NONE};if(s==="inverseBindMatrices")return{filter:z.NONE}}return{filter:z.NONE}}function fs(i){for(const e of i.listParents())if(e instanceof Ve){for(const t of e.listParents())if(t instanceof ut)return t.getTargetPath()}return null}const hs={method:tt.QUANTIZE};class ls extends V{constructor(...e){super(...e),this.extensionName=K,this.prereadTypes=[g.BUFFER,g.PRIMITIVE],this.prewriteTypes=[g.BUFFER,g.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=hs,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return e==="meshopt.decoder"&&(this._decoder=t),e==="meshopt.encoder"&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=Se({},hs,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${K}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${K}]: Missing WASM support.`)}return t===g.BUFFER?this._prereadBuffers(e):t===g.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[K])return;const o=s.extensions[K],a=o.byteOffset||0,c=o.byteLength||0,u=o.count,l=o.byteStride,d=new Uint8Array(u*l),x=t.json.buffers[o.buffer],p=x.uri?t.resources[x.uri]:t.resources[je],I=F.toView(p,a,c);this._decoder.decodeGltfBuffer(d,u,l,I,o.mode,o.filter),e.bufferViews[r]=d})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(s=>{if(!s.extensions||!s.extensions[K])return;const r=s.extensions[K],o=e.buffers[r.buffer],a=e.buffers[s.buffer],c=t.json.buffers[s.buffer];nr(c)&&this._decoderFallbackBufferMap.set(a,o)})}read(e){if(!this.isRequired())return this;for(const[t,n]of this._decoderFallbackBufferMap){for(const s of t.listParents())s instanceof b&&s.swap(t,n);t.dispose()}return this}prewrite(e,t){return t===g.ACCESSOR?this._prewriteAccessors(e):t===g.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,n=this._encoder,s=this._encoderOptions,r=this.document.getGraph(),o=this.document.createBuffer(),a=this.document.getRoot().listBuffers().indexOf(o);let c=1;const u=new Map,l=d=>{for(const x of r.listParents(d)){if(x.propertyType===g.ROOT)continue;let p=u.get(d);return p===void 0&&u.set(d,p=c++),p}return-1};this._encoderFallbackBuffer=o,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const d of this.document.getRoot().listAccessors()){if(fs(d)==="weights"||d.getSparse())continue;const x=e.getAccessorUsage(d),p=e.accessorUsageGroupedByParent.has(x)?l(d):null,I=fr(d,x),S=s.method===tt.FILTER?hr(d,this.document):{filter:z.NONE},_=or(d,n,I,S),{array:h,byteStride:O}=_,E=d.getBuffer();if(!E)throw new Error(`${K}: Missing buffer for accessor.`);const A=this.document.getRoot().listBuffers().indexOf(E),m=[x,p,I,S.filter,O,A].join(":");let y=this._encoderBufferViews[m],f=this._encoderBufferViewData[m],T=this._encoderBufferViewAccessors[m];(!y||!f)&&(T=this._encoderBufferViewAccessors[m]=[],f=this._encoderBufferViewData[m]=[],y=this._encoderBufferViews[m]={buffer:a,target:le.USAGE_TO_TARGET[x],byteOffset:0,byteLength:0,byteStride:x===le.BufferViewUsage.ARRAY_BUFFER?O:void 0,extensions:{[K]:{buffer:A,byteOffset:0,byteLength:0,mode:I,filter:S.filter!==z.NONE?S.filter:void 0,byteStride:O,count:0}}});const R=e.createAccessorDef(d);R.componentType=_.componentType,R.normalized=_.normalized,R.byteOffset=y.byteLength,R.min&&_.min&&(R.min=_.min),R.max&&_.max&&(R.max=_.max),e.accessorIndexMap.set(d,t.accessors.length),t.accessors.push(R),T.push(R),f.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength)),y.byteLength+=h.byteLength,y.extensions.EXT_meshopt_compression.count+=d.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const n in this._encoderBufferViews){const s=this._encoderBufferViews[n],r=this._encoderBufferViewData[n],o=this.document.getRoot().listBuffers()[s.extensions[K].buffer],a=e.otherBufferViews.get(o)||[],{count:c,byteStride:u,mode:l}=s.extensions[K],d=F.concat(r),x=t.encodeGltfBuffer(d,c,u,l),p=F.pad(x);s.extensions[K].byteLength=x.byteLength,r.length=0,r.push(p),a.push(p),e.otherBufferViews.set(o,a)}}write(e){let t=0;for(const o in this._encoderBufferViews){const a=this._encoderBufferViews[o],c=this._encoderBufferViewData[o][0],u=e.otherBufferViewsIndexMap.get(c),l=this._encoderBufferViewAccessors[o];for(const I of l)I.bufferView=u;const d=e.jsonDoc.json.bufferViews[u],x=d.byteOffset||0;Object.assign(d,a),d.byteOffset=t;const p=d.extensions[K];p.byteOffset=x,t+=F.padNumber(a.byteLength)}const n=this._encoderFallbackBuffer,s=e.bufferIndexMap.get(n),r=e.jsonDoc.json.buffers[s];return r.byteLength=t,r.extensions={[K]:{fallback:!0}},n.dispose(),this}}ls.EXTENSION_NAME=K,ls.EncoderMethod=tt;class lr{match(e){return e.length>=12&&F.decodeText(e.slice(4,12))==="ftypavif"}getSize(e){if(!this.match(e))return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let n=ds(t,0);if(!n)return null;let s=n.end;for(;n=ds(t,s);)if(n.type==="meta")s=n.start+4;else if(n.type==="iprp"||n.type==="ipco")s=n.start;else{if(n.type==="ispe")return[t.getUint32(n.start+4),t.getUint32(n.start+8)];if(n.type==="mdat")break;s=n.end}return null}getChannels(e){return 4}}class dr extends V{constructor(...e){super(...e),this.extensionName=Qe,this.prereadTypes=[g.TEXTURE]}static register(){he.registerFormat("image/avif",new lr)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(n=>{n.extensions&&n.extensions[Qe]&&(n.source=n.extensions[Qe].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(n=>{if(n.getMimeType()==="image/avif"){const s=e.imageIndexMap.get(n);(t.json.textures||[]).forEach(o=>{o.source===s&&(o.extensions=o.extensions||{},o.extensions[Qe]={source:o.source},delete o.source)})}}),this}}dr.EXTENSION_NAME=Qe;function ds(i,e){if(i.byteLength<4+e)return null;const t=i.getUint32(e);return i.byteLength<t+e||t<8?null:{type:F.decodeText(new Uint8Array(i.buffer,i.byteOffset+e+4,4)),start:e+8,end:e+t}}class gr{match(e){return e.length>=12&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80}getSize(e){const t=F.decodeText(e.slice(0,4)),n=F.decodeText(e.slice(8,12));if(t!=="RIFF"||n!=="WEBP")return null;const s=new DataView(e.buffer,e.byteOffset);let r=12;for(;r<s.byteLength;){const o=F.decodeText(new Uint8Array([s.getUint8(r),s.getUint8(r+1),s.getUint8(r+2),s.getUint8(r+3)])),a=s.getUint32(r+4,!0);if(o==="VP8 "){const c=s.getInt16(r+14,!0)&16383,u=s.getInt16(r+16,!0)&16383;return[c,u]}else if(o==="VP8L"){const c=s.getUint8(r+9),u=s.getUint8(r+10),l=s.getUint8(r+11),d=s.getUint8(r+12),x=1+((u&63)<<8|c),p=1+((d&15)<<10|l<<2|(u&192)>>6);return[x,p]}r+=8+a+a%2}return null}getChannels(e){return 4}}class pr extends V{constructor(...e){super(...e),this.extensionName=Ze,this.prereadTypes=[g.TEXTURE]}static register(){he.registerFormat("image/webp",new gr)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(n=>{n.extensions&&n.extensions[Ze]&&(n.source=n.extensions[Ze].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(n=>{if(n.getMimeType()==="image/webp"){const s=e.imageIndexMap.get(n);(t.json.textures||[]).forEach(o=>{o.source===s&&(o.extensions=o.extensions||{},o.extensions[Ze]={source:o.source},delete o.source)})}}),this}}pr.EXTENSION_NAME=Ze;let X,gs,ps;function mr(i,e){const t=new X.DecoderBuffer;try{if(t.Init(e,e.length),i.GetEncodedGeometryType(t)!==X.TRIANGULAR_MESH)throw new Error(`[${G}] Unknown geometry type.`);const s=new X.Mesh;if(!i.DecodeBufferToMesh(t,s).ok()||s.ptr===0)throw new Error(`[${G}] Decoding failure.`);return s}finally{X.destroy(t)}}function xr(i,e){const n=e.num_faces()*3;let s,r;if(e.num_points()<=65534){const o=n*Uint16Array.BYTES_PER_ELEMENT;s=X._malloc(o),i.GetTrianglesUInt16Array(e,o,s),r=new Uint16Array(X.HEAPU16.buffer,s,n).slice()}else{const o=n*Uint32Array.BYTES_PER_ELEMENT;s=X._malloc(o),i.GetTrianglesUInt32Array(e,o,s),r=new Uint32Array(X.HEAPU32.buffer,s,n).slice()}return X._free(s),r}function Tr(i,e,t,n){const s=ps[n.componentType],r=gs[n.componentType],o=t.num_components(),c=e.num_points()*o,u=c*r.BYTES_PER_ELEMENT,l=X._malloc(u);i.GetAttributeDataArrayForAllPoints(e,t,s,u,l);const d=new r(X.HEAPF32.buffer,l,c).slice();return X._free(l),d}function Er(i){X=i,gs={[b.ComponentType.FLOAT]:Float32Array,[b.ComponentType.UNSIGNED_INT]:Uint32Array,[b.ComponentType.UNSIGNED_SHORT]:Uint16Array,[b.ComponentType.UNSIGNED_BYTE]:Uint8Array,[b.ComponentType.SHORT]:Int16Array,[b.ComponentType.BYTE]:Int8Array},ps={[b.ComponentType.FLOAT]:X.DT_FLOAT32,[b.ComponentType.UNSIGNED_INT]:X.DT_UINT32,[b.ComponentType.UNSIGNED_SHORT]:X.DT_UINT16,[b.ComponentType.UNSIGNED_BYTE]:X.DT_UINT8,[b.ComponentType.SHORT]:X.DT_INT16,[b.ComponentType.BYTE]:X.DT_INT8}}let ae;var st;(function(i){i[i.EDGEBREAKER=1]="EDGEBREAKER",i[i.SEQUENTIAL=0]="SEQUENTIAL"})(st||(st={}));var ce;(function(i){i.POSITION="POSITION",i.NORMAL="NORMAL",i.COLOR="COLOR",i.TEX_COORD="TEX_COORD",i.GENERIC="GENERIC"})(ce||(ce={}));const ms={[ce.POSITION]:14,[ce.NORMAL]:10,[ce.COLOR]:8,[ce.TEX_COORD]:12,[ce.GENERIC]:12},xs={decodeSpeed:5,encodeSpeed:5,method:st.EDGEBREAKER,quantizationBits:ms,quantizationVolume:"mesh"};function yr(i){ae=i}function Rr(i,e=xs){const t=Se({},xs,e);t.quantizationBits=Se({},ms,e.quantizationBits);const n=new ae.MeshBuilder,s=new ae.Mesh,r=new ae.ExpertEncoder(s),o={},a=new ae.DracoInt8Array,c=i.listTargets().length>0;let u=!1;for(const S of i.listSemantics()){const _=i.getAttribute(S);if(_.getSparse()){u=!0;continue}const h=Ir(S),O=wr(n,_.getComponentType(),s,ae[h],_.getCount(),_.getElementSize(),_.getArray());if(O===-1)throw new Error(`Error compressing "${S}" attribute.`);if(o[S]=O,t.quantizationVolume==="mesh"||S!=="POSITION")r.SetAttributeQuantization(O,t.quantizationBits[h]);else if(typeof t.quantizationVolume=="object"){const{quantizationVolume:E}=t,A=Math.max(E.max[0]-E.min[0],E.max[1]-E.min[1],E.max[2]-E.min[2]);r.SetAttributeExplicitQuantization(O,t.quantizationBits[h],_.getElementSize(),E.min,A)}else throw new Error("Invalid quantization volume state.")}const l=i.getIndices();if(!l)throw new Ct("Primitive must have indices.");n.AddFacesToMesh(s,l.getCount()/3,l.getArray()),r.SetSpeedOptions(t.encodeSpeed,t.decodeSpeed),r.SetTrackEncodedProperties(!0),t.method===st.SEQUENTIAL||c||u?r.SetEncodingMethod(ae.MESH_SEQUENTIAL_ENCODING):r.SetEncodingMethod(ae.MESH_EDGEBREAKER_ENCODING);const d=r.EncodeToDracoBuffer(!(c||u),a);if(d<=0)throw new Ct("Error applying Draco compression.");const x=new Uint8Array(d);for(let S=0;S<d;++S)x[S]=a.GetValue(S);const p=r.GetNumberOfEncodedPoints(),I=r.GetNumberOfEncodedFaces()*3;return ae.destroy(a),ae.destroy(s),ae.destroy(n),ae.destroy(r),{numVertices:p,numIndices:I,data:x,attributeIDs:o}}function Ir(i){return i==="POSITION"?ce.POSITION:i==="NORMAL"?ce.NORMAL:i.startsWith("COLOR_")?ce.COLOR:i.startsWith("TEXCOORD_")?ce.TEX_COORD:ce.GENERIC}function wr(i,e,t,n,s,r,o){switch(e){case b.ComponentType.UNSIGNED_BYTE:return i.AddUInt8Attribute(t,n,s,r,o);case b.ComponentType.BYTE:return i.AddInt8Attribute(t,n,s,r,o);case b.ComponentType.UNSIGNED_SHORT:return i.AddUInt16Attribute(t,n,s,r,o);case b.ComponentType.SHORT:return i.AddInt16Attribute(t,n,s,r,o);case b.ComponentType.UNSIGNED_INT:return i.AddUInt32Attribute(t,n,s,r,o);case b.ComponentType.FLOAT:return i.AddFloatAttribute(t,n,s,r,o);default:throw new Error(`Unexpected component type, "${e}".`)}}class Ct extends Error{}class Ts extends V{constructor(...e){super(...e),this.extensionName=G,this.prereadTypes=[g.PRIMITIVE],this.prewriteTypes=[g.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return e==="draco3d.decoder"&&(this._decoderModule=t,Er(this._decoderModule)),e==="draco3d.encoder"&&(this._encoderModule=t,yr(this._encoderModule)),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${G}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),n=e.jsonDoc,s=new Map;try{const r=n.json.meshes||[];for(const o of r)for(const a of o.primitives){if(!a.extensions||!a.extensions[G])continue;const c=a.extensions[G];let[u,l]=s.get(c.bufferView)||[];if(!l||!u){const d=n.json.bufferViews[c.bufferView],x=n.json.buffers[d.buffer],p=x.uri?n.resources[x.uri]:n.resources[je],I=d.byteOffset||0,S=d.byteLength,_=F.toView(p,I,S);u=new this._decoderModule.Decoder,l=mr(u,_),s.set(c.bufferView,[u,l]),t.debug(`[${G}] Decompressed ${_.byteLength} bytes.`)}for(const d in c.attributes){const x=e.jsonDoc.json.accessors[a.attributes[d]],p=u.GetAttributeByUniqueId(l,c.attributes[d]),I=Tr(u,l,p,x);e.accessors[a.attributes[d]].setArray(I)}a.indices!==void 0&&e.accessors[a.indices].setArray(xr(u,l))}}finally{for(const[r,o]of Array.from(s.values()))this._decoderModule.destroy(r),this._decoderModule.destroy(o)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${G}] Please install extension dependency, "draco3d.encoder".`);const n=this.document.getLogger();n.debug(`[${G}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const s=Ar(this.document),r=new Map;let o="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?n.warn(`[${G}]: quantizationVolume=scene requires exactly 1 scene.`):o=fn(this.document.getRoot().listScenes().pop()));for(const a of Array.from(s.keys())){const c=s.get(a);if(!c)throw new Error("Unexpected primitive.");if(r.has(c)){r.set(c,r.get(c));continue}const u=a.getIndices(),l=e.jsonDoc.json.accessors;let d;try{d=Rr(a,Se({},this._encoderOptions,{quantizationVolume:o}))}catch(I){if(I instanceof Ct){n.warn(`[${G}]: ${I.message} Skipping primitive compression.`);continue}throw I}r.set(c,d);const x=e.createAccessorDef(u);x.count=d.numIndices,e.accessorIndexMap.set(u,l.length),l.push(x),d.numVertices>65534&&b.getComponentSize(x.componentType)<=2?x.componentType=b.ComponentType.UNSIGNED_INT:d.numVertices>254&&b.getComponentSize(x.componentType)<=1&&(x.componentType=b.ComponentType.UNSIGNED_SHORT);for(const I of a.listSemantics()){const S=a.getAttribute(I);if(d.attributeIDs[I]===void 0)continue;const _=e.createAccessorDef(S);_.count=d.numVertices,e.accessorIndexMap.set(S,l.length),l.push(_)}const p=a.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(p)||e.otherBufferViews.set(p,[]),e.otherBufferViews.get(p).push(d.data)}return n.debug(`[${G}] Compressed ${s.size} primitives.`),e.extensionData[G]={primitiveHashMap:s,primitiveEncodingMap:r},this}write(e){const t=e.extensionData[G];for(const n of this.document.getRoot().listMeshes()){const s=e.jsonDoc.json.meshes[e.meshIndexMap.get(n)];for(let r=0;r<n.listPrimitives().length;r++){const o=n.listPrimitives()[r],a=s.primitives[r],c=t.primitiveHashMap.get(o);if(!c)continue;const u=t.primitiveEncodingMap.get(c);u&&(a.extensions=a.extensions||{},a.extensions[G]={bufferView:e.otherBufferViewsIndexMap.get(u.data),attributes:u.attributeIDs})}}if(!t.primitiveHashMap.size){const n=e.jsonDoc.json;n.extensionsUsed=(n.extensionsUsed||[]).filter(s=>s!==G),n.extensionsRequired=(n.extensionsRequired||[]).filter(s=>s!==G)}return this}}Ts.EXTENSION_NAME=G,Ts.EncoderMethod=st;function Ar(i){const e=i.getLogger(),t=new Set,n=new Set;let s=0,r=0;for(const d of i.getRoot().listMeshes())for(const x of d.listPrimitives())x.getIndices()?x.getMode()!==fe.Mode.TRIANGLES?(n.add(x),r++):t.add(x):(n.add(x),s++);s>0&&e.warn(`[${G}] Skipping Draco compression of ${s} non-indexed primitives.`),r>0&&e.warn(`[${G}] Skipping Draco compression of ${r} non-TRIANGLES primitives.`);const o=i.getRoot().listAccessors(),a=new Map;for(let d=0;d<o.length;d++)a.set(o[d],d);const c=new Map,u=new Set,l=new Map;for(const d of Array.from(t)){let x=Es(d,a);if(u.has(x)){l.set(d,x);continue}if(c.has(d.getIndices())){const p=d.getIndices(),I=p.clone();a.set(I,i.getRoot().listAccessors().length-1),d.swap(p,I)}for(const p of d.listAttributes())if(c.has(p)){const I=p.clone();a.set(I,i.getRoot().listAccessors().length-1),d.swap(p,I)}x=Es(d,a),u.add(x),l.set(d,x),c.set(d.getIndices(),x);for(const p of d.listAttributes())c.set(p,x)}for(const d of Array.from(c.keys())){const x=new Set(d.listParents().map(p=>p.propertyType));if(x.size!==2||!x.has(g.PRIMITIVE)||!x.has(g.ROOT))throw new Error(`[${G}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const d of Array.from(t)){const x=l.get(d),p=d.getIndices();if(c.get(p)!==x||d.listAttributes().some(I=>c.get(I)!==x))throw new Error(`[${G}] Draco primitives must share all, or no, accessors.`)}for(const d of Array.from(n)){const x=d.getIndices();if(c.has(x)||d.listAttributes().some(p=>c.has(p)))throw new Error(`[${G}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return l}function Es(i,e){const t=[],n=i.getIndices();t.push(e.get(n));for(const s of i.listAttributes())t.push(e.get(s));return t.sort().join("|")}class He extends H{init(){this.extensionName=ie,this.propertyType="Light",this.parentTypes=[g.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:He.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}He.EXTENSION_NAME=ie,He.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};class Nr extends V{constructor(...e){super(...e),this.extensionName=ie}createLight(e=""){return new He(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ie])return this;const r=(t.json.extensions[ie].lights||[]).map(o=>{var a,c;const u=this.createLight().setName(o.name||"").setType(o.type);return o.color!==void 0&&u.setColor(o.color),o.intensity!==void 0&&u.setIntensity(o.intensity),o.range!==void 0&&u.setRange(o.range),((a=o.spot)==null?void 0:a.innerConeAngle)!==void 0&&u.setInnerConeAngle(o.spot.innerConeAngle),((c=o.spot)==null?void 0:c.outerConeAngle)!==void 0&&u.setOuterConeAngle(o.spot.outerConeAngle),u});return t.json.nodes.forEach((o,a)=>{if(!o.extensions||!o.extensions[ie])return;const c=o.extensions[ie];e.nodes[a].setExtension(ie,r[c.light])}),this}write(e){const t=e.jsonDoc;if(this.properties.size===0)return this;const n=[],s=new Map;for(const r of this.properties){const o=r,a={type:o.getType()};L.eq(o.getColor(),[1,1,1])||(a.color=o.getColor()),o.getIntensity()!==1&&(a.intensity=o.getIntensity()),o.getRange()!=null&&(a.range=o.getRange()),o.getName()&&(a.name=o.getName()),o.getType()===He.Type.SPOT&&(a.spot={innerConeAngle:o.getInnerConeAngle(),outerConeAngle:o.getOuterConeAngle()}),n.push(a),s.set(o,n.length-1)}return this.document.getRoot().listNodes().forEach(r=>{const o=r.getExtension(ie);if(o){const a=e.nodeIndexMap.get(r),c=t.json.nodes[a];c.extensions=c.extensions||{},c.extensions[ie]={light:s.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[ie]={lights:n},this}}Nr.EXTENSION_NAME=ie;const{R:_r,G:Sr,B:br}=ne;class ys extends H{init(){this.extensionName=ge,this.propertyType="Anisotropy",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new j(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(e){return this.set("anisotropyStrength",e)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(e){return this.set("anisotropyRotation",e)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(e){return this.setRef("anisotropyTexture",e,{channels:_r|Sr|br})}}ys.EXTENSION_NAME=ge;class Mr extends V{constructor(...e){super(...e),this.extensionName=ge,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createAnisotropy(){return new ys(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[ge]){const a=this.createAnisotropy();e.materials[o].setExtension(ge,a);const c=r.extensions[ge];if(c.anisotropyStrength!==void 0&&a.setAnisotropyStrength(c.anisotropyStrength),c.anisotropyRotation!==void 0&&a.setAnisotropyRotation(c.anisotropyRotation),c.anisotropyTexture!==void 0){const u=c.anisotropyTexture,l=e.textures[s[u.index].source];a.setAnisotropyTexture(l),e.setTextureInfo(a.getAnisotropyTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(ge);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[ge]={};if(s.getAnisotropyStrength()>0&&(a.anisotropyStrength=s.getAnisotropyStrength()),s.getAnisotropyRotation()!==0&&(a.anisotropyRotation=s.getAnisotropyRotation()),s.getAnisotropyTexture()){const c=s.getAnisotropyTexture(),u=s.getAnisotropyTextureInfo();a.anisotropyTexture=e.createTextureInfoDef(c,u)}}}),this}}Mr.EXTENSION_NAME=ge;const{R:Rs,G:Is,B:Or}=ne;class ws extends H{init(){this.extensionName=pe,this.propertyType="Clearcoat",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new j(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new j(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new j(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:Rs})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:Is})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:Rs|Is|Or})}}ws.EXTENSION_NAME=pe;class Cr extends V{constructor(...e){super(...e),this.extensionName=pe,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createClearcoat(){return new ws(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[pe]){const a=this.createClearcoat();e.materials[o].setExtension(pe,a);const c=r.extensions[pe];if(c.clearcoatFactor!==void 0&&a.setClearcoatFactor(c.clearcoatFactor),c.clearcoatRoughnessFactor!==void 0&&a.setClearcoatRoughnessFactor(c.clearcoatRoughnessFactor),c.clearcoatTexture!==void 0){const u=c.clearcoatTexture,l=e.textures[s[u.index].source];a.setClearcoatTexture(l),e.setTextureInfo(a.getClearcoatTextureInfo(),u)}if(c.clearcoatRoughnessTexture!==void 0){const u=c.clearcoatRoughnessTexture,l=e.textures[s[u.index].source];a.setClearcoatRoughnessTexture(l),e.setTextureInfo(a.getClearcoatRoughnessTextureInfo(),u)}if(c.clearcoatNormalTexture!==void 0){const u=c.clearcoatNormalTexture,l=e.textures[s[u.index].source];a.setClearcoatNormalTexture(l),e.setTextureInfo(a.getClearcoatNormalTextureInfo(),u),u.scale!==void 0&&a.setClearcoatNormalScale(u.scale)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(pe);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[pe]={clearcoatFactor:s.getClearcoatFactor(),clearcoatRoughnessFactor:s.getClearcoatRoughnessFactor()};if(s.getClearcoatTexture()){const c=s.getClearcoatTexture(),u=s.getClearcoatTextureInfo();a.clearcoatTexture=e.createTextureInfoDef(c,u)}if(s.getClearcoatRoughnessTexture()){const c=s.getClearcoatRoughnessTexture(),u=s.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=e.createTextureInfoDef(c,u)}if(s.getClearcoatNormalTexture()){const c=s.getClearcoatNormalTexture(),u=s.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=e.createTextureInfoDef(c,u),s.getClearcoatNormalScale()!==1&&(a.clearcoatNormalTexture.scale=s.getClearcoatNormalScale())}}}),this}}Cr.EXTENSION_NAME=pe;const{R:Dr,G:vr,B:Fr,A:Ur}=ne;class As extends H{init(){this.extensionName=me,this.propertyType="DiffuseTransmission",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseTransmissionFactor:0,diffuseTransmissionTexture:null,diffuseTransmissionTextureInfo:new j(this.graph,"diffuseTransmissionTextureInfo"),diffuseTransmissionColorFactor:[1,1,1],diffuseTransmissionColorTexture:null,diffuseTransmissionColorTextureInfo:new j(this.graph,"diffuseTransmissionColorTextureInfo")})}getDiffuseTransmissionFactor(){return this.get("diffuseTransmissionFactor")}setDiffuseTransmissionFactor(e){return this.set("diffuseTransmissionFactor",e)}getDiffuseTransmissionTexture(){return this.getRef("diffuseTransmissionTexture")}getDiffuseTransmissionTextureInfo(){return this.getRef("diffuseTransmissionTexture")?this.getRef("diffuseTransmissionTextureInfo"):null}setDiffuseTransmissionTexture(e){return this.setRef("diffuseTransmissionTexture",e,{channels:Ur})}getDiffuseTransmissionColorFactor(){return this.get("diffuseTransmissionColorFactor")}setDiffuseTransmissionColorFactor(e){return this.set("diffuseTransmissionColorFactor",e)}getDiffuseTransmissionColorTexture(){return this.getRef("diffuseTransmissionColorTexture")}getDiffuseTransmissionColorTextureInfo(){return this.getRef("diffuseTransmissionColorTexture")?this.getRef("diffuseTransmissionColorTextureInfo"):null}setDiffuseTransmissionColorTexture(e){return this.setRef("diffuseTransmissionColorTexture",e,{channels:Dr|vr|Fr})}}As.EXTENSION_NAME=me;class Br extends V{constructor(...e){super(...e),this.extensionName=me}createDiffuseTransmission(){return new As(this.document.getGraph())}read(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[me]){const a=this.createDiffuseTransmission();e.materials[o].setExtension(me,a);const c=r.extensions[me];if(c.diffuseTransmissionFactor!==void 0&&a.setDiffuseTransmissionFactor(c.diffuseTransmissionFactor),c.diffuseTransmissionColorFactor!==void 0&&a.setDiffuseTransmissionColorFactor(c.diffuseTransmissionColorFactor),c.diffuseTransmissionTexture!==void 0){const u=c.diffuseTransmissionTexture,l=e.textures[s[u.index].source];a.setDiffuseTransmissionTexture(l),e.setTextureInfo(a.getDiffuseTransmissionTextureInfo(),u)}if(c.diffuseTransmissionColorTexture!==void 0){const u=c.diffuseTransmissionColorTexture,l=e.textures[s[u.index].source];a.setDiffuseTransmissionColorTexture(l),e.setTextureInfo(a.getDiffuseTransmissionColorTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;for(const n of this.document.getRoot().listMaterials()){const s=n.getExtension(me);if(!s)continue;const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[me]={diffuseTransmissionFactor:s.getDiffuseTransmissionFactor(),diffuseTransmissionColorFactor:s.getDiffuseTransmissionColorFactor()};if(s.getDiffuseTransmissionTexture()){const c=s.getDiffuseTransmissionTexture(),u=s.getDiffuseTransmissionTextureInfo();a.diffuseTransmissionTexture=e.createTextureInfoDef(c,u)}if(s.getDiffuseTransmissionColorTexture()){const c=s.getDiffuseTransmissionColorTexture(),u=s.getDiffuseTransmissionColorTextureInfo();a.diffuseTransmissionColorTexture=e.createTextureInfoDef(c,u)}}return this}}Br.EXTENSION_NAME=me;class Ns extends H{init(){this.extensionName=xe,this.propertyType="Dispersion",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{dispersion:0})}getDispersion(){return this.get("dispersion")}setDispersion(e){return this.set("dispersion",e)}}Ns.EXTENSION_NAME=xe;class Lr extends V{constructor(...e){super(...e),this.extensionName=xe,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createDispersion(){return new Ns(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{if(s.extensions&&s.extensions[xe]){const o=this.createDispersion();e.materials[r].setExtension(xe,o);const a=s.extensions[xe];a.dispersion!==void 0&&o.setDispersion(a.dispersion)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(xe);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[xe]={dispersion:s.getDispersion()}}}),this}}Lr.EXTENSION_NAME=xe;class _s extends H{init(){this.extensionName=Te,this.propertyType="EmissiveStrength",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}}_s.EXTENSION_NAME=Te;class Pr extends V{constructor(...e){super(...e),this.extensionName=Te,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createEmissiveStrength(){return new _s(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{if(s.extensions&&s.extensions[Te]){const o=this.createEmissiveStrength();e.materials[r].setExtension(Te,o);const a=s.extensions[Te];a.emissiveStrength!==void 0&&o.setEmissiveStrength(a.emissiveStrength)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Te);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[Te]={emissiveStrength:s.getEmissiveStrength()}}}),this}}Pr.EXTENSION_NAME=Te;class Ss extends H{init(){this.extensionName=Ee,this.propertyType="IOR",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}Ss.EXTENSION_NAME=Ee;class jr extends V{constructor(...e){super(...e),this.extensionName=Ee,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createIOR(){return new Ss(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{if(s.extensions&&s.extensions[Ee]){const o=this.createIOR();e.materials[r].setExtension(Ee,o);const a=s.extensions[Ee];a.ior!==void 0&&o.setIOR(a.ior)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ee);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[Ee]={ior:s.getIOR()}}}),this}}jr.EXTENSION_NAME=Ee;const{R:kr,G:Vr}=ne;class bs extends H{init(){this.extensionName=ye,this.propertyType="Iridescence",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new j(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new j(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:kr})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:Vr})}}bs.EXTENSION_NAME=ye;class Gr extends V{constructor(...e){super(...e),this.extensionName=ye,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createIridescence(){return new bs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[ye]){const a=this.createIridescence();e.materials[o].setExtension(ye,a);const c=r.extensions[ye];if(c.iridescenceFactor!==void 0&&a.setIridescenceFactor(c.iridescenceFactor),c.iridescenceIor!==void 0&&a.setIridescenceIOR(c.iridescenceIor),c.iridescenceThicknessMinimum!==void 0&&a.setIridescenceThicknessMinimum(c.iridescenceThicknessMinimum),c.iridescenceThicknessMaximum!==void 0&&a.setIridescenceThicknessMaximum(c.iridescenceThicknessMaximum),c.iridescenceTexture!==void 0){const u=c.iridescenceTexture,l=e.textures[s[u.index].source];a.setIridescenceTexture(l),e.setTextureInfo(a.getIridescenceTextureInfo(),u)}if(c.iridescenceThicknessTexture!==void 0){const u=c.iridescenceThicknessTexture,l=e.textures[s[u.index].source];a.setIridescenceThicknessTexture(l),e.setTextureInfo(a.getIridescenceThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(ye);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[ye]={};if(s.getIridescenceFactor()>0&&(a.iridescenceFactor=s.getIridescenceFactor()),s.getIridescenceIOR()!==1.3&&(a.iridescenceIor=s.getIridescenceIOR()),s.getIridescenceThicknessMinimum()!==100&&(a.iridescenceThicknessMinimum=s.getIridescenceThicknessMinimum()),s.getIridescenceThicknessMaximum()!==400&&(a.iridescenceThicknessMaximum=s.getIridescenceThicknessMaximum()),s.getIridescenceTexture()){const c=s.getIridescenceTexture(),u=s.getIridescenceTextureInfo();a.iridescenceTexture=e.createTextureInfoDef(c,u)}if(s.getIridescenceThicknessTexture()){const c=s.getIridescenceThicknessTexture(),u=s.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}Gr.EXTENSION_NAME=ye;const{R:Ms,G:Os,B:Cs,A:Ds}=ne;class vs extends H{init(){this.extensionName=Re,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new j(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new j(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:Ms|Os|Cs|Ds,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:Ms|Os|Cs|Ds})}}vs.EXTENSION_NAME=Re;class Hr extends V{constructor(...e){super(...e),this.extensionName=Re,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createPBRSpecularGlossiness(){return new vs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Re]){const a=this.createPBRSpecularGlossiness();e.materials[o].setExtension(Re,a);const c=r.extensions[Re];if(c.diffuseFactor!==void 0&&a.setDiffuseFactor(c.diffuseFactor),c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.glossinessFactor!==void 0&&a.setGlossinessFactor(c.glossinessFactor),c.diffuseTexture!==void 0){const u=c.diffuseTexture,l=e.textures[s[u.index].source];a.setDiffuseTexture(l),e.setTextureInfo(a.getDiffuseTextureInfo(),u)}if(c.specularGlossinessTexture!==void 0){const u=c.specularGlossinessTexture,l=e.textures[s[u.index].source];a.setSpecularGlossinessTexture(l),e.setTextureInfo(a.getSpecularGlossinessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Re);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Re]={diffuseFactor:s.getDiffuseFactor(),specularFactor:s.getSpecularFactor(),glossinessFactor:s.getGlossinessFactor()};if(s.getDiffuseTexture()){const c=s.getDiffuseTexture(),u=s.getDiffuseTextureInfo();a.diffuseTexture=e.createTextureInfoDef(c,u)}if(s.getSpecularGlossinessTexture()){const c=s.getSpecularGlossinessTexture(),u=s.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=e.createTextureInfoDef(c,u)}}}),this}}Hr.EXTENSION_NAME=Re;const{R:zr,G:$r,B:Xr,A:Kr}=ne;class Fs extends H{init(){this.extensionName=Ie,this.propertyType="Sheen",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new j(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new j(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:zr|$r|Xr,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:Kr})}}Fs.EXTENSION_NAME=Ie;class qr extends V{constructor(...e){super(...e),this.extensionName=Ie,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createSheen(){return new Fs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Ie]){const a=this.createSheen();e.materials[o].setExtension(Ie,a);const c=r.extensions[Ie];if(c.sheenColorFactor!==void 0&&a.setSheenColorFactor(c.sheenColorFactor),c.sheenRoughnessFactor!==void 0&&a.setSheenRoughnessFactor(c.sheenRoughnessFactor),c.sheenColorTexture!==void 0){const u=c.sheenColorTexture,l=e.textures[s[u.index].source];a.setSheenColorTexture(l),e.setTextureInfo(a.getSheenColorTextureInfo(),u)}if(c.sheenRoughnessTexture!==void 0){const u=c.sheenRoughnessTexture,l=e.textures[s[u.index].source];a.setSheenRoughnessTexture(l),e.setTextureInfo(a.getSheenRoughnessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ie);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Ie]={sheenColorFactor:s.getSheenColorFactor(),sheenRoughnessFactor:s.getSheenRoughnessFactor()};if(s.getSheenColorTexture()){const c=s.getSheenColorTexture(),u=s.getSheenColorTextureInfo();a.sheenColorTexture=e.createTextureInfoDef(c,u)}if(s.getSheenRoughnessTexture()){const c=s.getSheenRoughnessTexture(),u=s.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=e.createTextureInfoDef(c,u)}}}),this}}qr.EXTENSION_NAME=Ie;const{R:Wr,G:Yr,B:Jr,A:Zr}=ne;class Us extends H{init(){this.extensionName=we,this.propertyType="Specular",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new j(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new j(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:Zr})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:Wr|Yr|Jr,isColor:!0})}}Us.EXTENSION_NAME=we;class Qr extends V{constructor(...e){super(...e),this.extensionName=we,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createSpecular(){return new Us(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[we]){const a=this.createSpecular();e.materials[o].setExtension(we,a);const c=r.extensions[we];if(c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.specularColorFactor!==void 0&&a.setSpecularColorFactor(c.specularColorFactor),c.specularTexture!==void 0){const u=c.specularTexture,l=e.textures[s[u.index].source];a.setSpecularTexture(l),e.setTextureInfo(a.getSpecularTextureInfo(),u)}if(c.specularColorTexture!==void 0){const u=c.specularColorTexture,l=e.textures[s[u.index].source];a.setSpecularColorTexture(l),e.setTextureInfo(a.getSpecularColorTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(we);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[we]={};if(s.getSpecularFactor()!==1&&(a.specularFactor=s.getSpecularFactor()),L.eq(s.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=s.getSpecularColorFactor()),s.getSpecularTexture()){const c=s.getSpecularTexture(),u=s.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(c,u)}if(s.getSpecularColorTexture()){const c=s.getSpecularColorTexture(),u=s.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(c,u)}}}),this}}Qr.EXTENSION_NAME=we;const{R:ei}=ne;class Bs extends H{init(){this.extensionName=Ae,this.propertyType="Transmission",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new j(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:ei})}}Bs.EXTENSION_NAME=Ae;class ti extends V{constructor(...e){super(...e),this.extensionName=Ae,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createTransmission(){return new Bs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Ae]){const a=this.createTransmission();e.materials[o].setExtension(Ae,a);const c=r.extensions[Ae];if(c.transmissionFactor!==void 0&&a.setTransmissionFactor(c.transmissionFactor),c.transmissionTexture!==void 0){const u=c.transmissionTexture,l=e.textures[s[u.index].source];a.setTransmissionTexture(l),e.setTextureInfo(a.getTransmissionTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ae);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Ae]={transmissionFactor:s.getTransmissionFactor()};if(s.getTransmissionTexture()){const c=s.getTransmissionTexture(),u=s.getTransmissionTextureInfo();a.transmissionTexture=e.createTextureInfoDef(c,u)}}}),this}}ti.EXTENSION_NAME=Ae;class Ls extends H{init(){this.extensionName=Ce,this.propertyType="Unlit",this.parentTypes=[g.MATERIAL]}}Ls.EXTENSION_NAME=Ce;class si extends V{constructor(...e){super(...e),this.extensionName=Ce,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createUnlit(){return new Ls(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((n,s)=>{n.extensions&&n.extensions[Ce]&&e.materials[s].setExtension(Ce,this.createUnlit())}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{if(n.getExtension(Ce)){const s=e.materialIndexMap.get(n),r=t.json.materials[s];r.extensions=r.extensions||{},r.extensions[Ce]={}}}),this}}si.EXTENSION_NAME=Ce;class Ps extends H{init(){this.extensionName=q,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:new k})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}Ps.EXTENSION_NAME=q;class js extends H{init(){this.extensionName=q,this.propertyType="MappingList",this.parentTypes=[g.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:new k})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}js.EXTENSION_NAME=q;class Dt extends H{init(){this.extensionName=q,this.propertyType="Variant",this.parentTypes=["MappingList"]}}Dt.EXTENSION_NAME=q;class ni extends V{constructor(...e){super(...e),this.extensionName=q}createMappingList(){return new js(this.document.getGraph())}createVariant(e=""){return new Dt(this.document.getGraph(),e)}createMapping(){return new Ps(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(e=>e instanceof Dt)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[q])return this;const r=(t.json.extensions[q].variants||[]).map(a=>this.createVariant().setName(a.name||""));return(t.json.meshes||[]).forEach((a,c)=>{const u=e.meshes[c];(a.primitives||[]).forEach((d,x)=>{if(!d.extensions||!d.extensions[q])return;const p=this.createMappingList(),I=d.extensions[q];for(const S of I.mappings){const _=this.createMapping();S.material!==void 0&&_.setMaterial(e.materials[S.material]);for(const h of S.variants||[])_.addVariant(r[h]);p.addMapping(_)}u.listPrimitives()[x].setExtension(q,p)})}),this}write(e){const t=e.jsonDoc,n=this.listVariants();if(!n.length)return this;const s=[],r=new Map;for(const o of n)r.set(o,s.length),s.push(e.createPropertyDef(o));for(const o of this.document.getRoot().listMeshes()){const a=e.meshIndexMap.get(o);o.listPrimitives().forEach((c,u)=>{const l=c.getExtension(q);if(!l)return;const d=e.jsonDoc.json.meshes[a].primitives[u],x=l.listMappings().map(p=>{const I=e.createPropertyDef(p),S=p.getMaterial();return S&&(I.material=e.materialIndexMap.get(S)),I.variants=p.listVariants().map(_=>r.get(_)),I});d.extensions=d.extensions||{},d.extensions[q]={mappings:x}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[q]={variants:s},this}}ni.EXTENSION_NAME=q;const{G:ri}=ne;class ks extends H{init(){this.extensionName=Ne,this.propertyType="Volume",this.parentTypes=[g.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new j(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:ri})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}}ks.EXTENSION_NAME=Ne;class ii extends V{constructor(...e){super(...e),this.extensionName=Ne,this.prereadTypes=[g.MESH],this.prewriteTypes=[g.MESH]}createVolume(){return new ks(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,n=t.json.materials||[],s=t.json.textures||[];return n.forEach((r,o)=>{if(r.extensions&&r.extensions[Ne]){const a=this.createVolume();e.materials[o].setExtension(Ne,a);const c=r.extensions[Ne];if(c.thicknessFactor!==void 0&&a.setThicknessFactor(c.thicknessFactor),c.attenuationDistance!==void 0&&a.setAttenuationDistance(c.attenuationDistance),c.attenuationColor!==void 0&&a.setAttenuationColor(c.attenuationColor),c.thicknessTexture!==void 0){const u=c.thicknessTexture,l=e.textures[s[u.index].source];a.setThicknessTexture(l),e.setTextureInfo(a.getThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(n=>{const s=n.getExtension(Ne);if(s){const r=e.materialIndexMap.get(n),o=t.json.materials[r];o.extensions=o.extensions||{};const a=o.extensions[Ne]={};if(s.getThicknessFactor()>0&&(a.thicknessFactor=s.getThicknessFactor()),Number.isFinite(s.getAttenuationDistance())&&(a.attenuationDistance=s.getAttenuationDistance()),L.eq(s.getAttenuationColor(),[1,1,1])||(a.attenuationColor=s.getAttenuationColor()),s.getThicknessTexture()){const c=s.getThicknessTexture(),u=s.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}ii.EXTENSION_NAME=Ne;class oi extends V{constructor(...e){super(...e),this.extensionName=os}read(e){return this}write(e){return this}}oi.EXTENSION_NAME=os;class ai{match(e){return e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10}getSize(e){const t=bt(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const n=bt(e).dataFormatDescriptor[0];if(n.colorModel===qn)return n.samples.length===2&&(n.samples[1].channelType&15)===15?4:3;if(n.colorModel===Wn)return(n.samples[0].channelType&15)===3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${n.colorModel}".`)}getVRAMByteLength(e){const t=bt(e),n=this.getChannels(e)>3;let s=0;for(let r=0;r<t.levels.length;r++){const o=t.levels[r];if(o.uncompressedByteLength)s+=o.uncompressedByteLength;else{const a=Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,r))),c=Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,r))),u=n?16:8;s+=a/4*(c/4)*u}}return s}}class ci extends V{constructor(...e){super(...e),this.extensionName=et,this.prereadTypes=[g.TEXTURE]}static register(){he.registerFormat("image/ktx2",new ai)}preread(e){return e.jsonDoc.json.textures.forEach(t=>{if(t.extensions&&t.extensions[et]){const n=t.extensions[et];t.source=n.source}}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(n=>{if(n.getMimeType()==="image/ktx2"){const s=e.imageIndexMap.get(n);t.json.textures.forEach(r=>{r.source===s&&(r.extensions=r.extensions||{},r.extensions[et]={source:r.source},delete r.source)})}}),this}}ci.EXTENSION_NAME=et;class Vs extends H{init(){this.extensionName=_e,this.propertyType="Transform",this.parentTypes=[g.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}}Vs.EXTENSION_NAME=_e;class Gs extends V{constructor(...e){super(...e),this.extensionName=_e}createTransform(){return new Vs(this.document.getGraph())}read(e){for(const[t,n]of Array.from(e.textureInfos.entries())){if(!n.extensions||!n.extensions[_e])continue;const s=this.createTransform(),r=n.extensions[_e];r.offset!==void 0&&s.setOffset(r.offset),r.rotation!==void 0&&s.setRotation(r.rotation),r.scale!==void 0&&s.setScale(r.scale),r.texCoord!==void 0&&s.setTexCoord(r.texCoord),t.setExtension(_e,s)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[n,s]of t){const r=n.getExtension(_e);if(!r)continue;s.extensions=s.extensions||{};const o={},a=L.eq;a(r.getOffset(),[0,0])||(o.offset=r.getOffset()),r.getRotation()!==0&&(o.rotation=r.getRotation()),a(r.getScale(),[1,1])||(o.scale=r.getScale()),r.getTexCoord()!=null&&(o.texCoord=r.getTexCoord()),s.extensions[_e]=o}return this}}Gs.EXTENSION_NAME=_e;const ui=[g.ROOT,g.SCENE,g.NODE,g.MESH,g.MATERIAL,g.TEXTURE,g.ANIMATION];class Hs extends H{init(){this.extensionName=oe,this.propertyType="Packet",this.parentTypes=ui}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",Se({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const n=Se({},this.get("properties"));return t?n[e]=t:delete n[e],this.set("properties",n)}toJSONLD(){const e=vt(this.get("context")),t=vt(this.get("properties"));return Se({"@context":e},t)}fromJSONLD(e){e=vt(e);const t=e["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`${oe}: Missing context for term, "${e}".`)}}Hs.EXTENSION_NAME=oe;function vt(i){return JSON.parse(JSON.stringify(i))}class fi extends V{constructor(...e){super(...e),this.extensionName=oe}createPacket(){return new Hs(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const n=(t=e.jsonDoc.json.extensions)==null?void 0:t[oe];if(!n||!n.packets)return this;const s=e.jsonDoc.json,r=this.document.getRoot(),o=n.packets.map(u=>this.createPacket().fromJSONLD(u)),a=[[s.asset],s.scenes,s.nodes,s.meshes,s.materials,s.images,s.animations],c=[[r],r.listScenes(),r.listNodes(),r.listMeshes(),r.listMaterials(),r.listTextures(),r.listAnimations()];for(let u=0;u<a.length;u++){const l=a[u]||[];for(let d=0;d<l.length;d++){const x=l[d];if(x.extensions&&x.extensions[oe]){const p=x.extensions[oe];c[u][d].setExtension(oe,o[p.packet])}}}return this}write(e){const{json:t}=e.jsonDoc,n=[];for(const s of this.properties){n.push(s.toJSONLD());for(const r of s.listParents()){let o;switch(r.propertyType){case g.ROOT:o=t.asset;break;case g.SCENE:o=t.scenes[e.sceneIndexMap.get(r)];break;case g.NODE:o=t.nodes[e.nodeIndexMap.get(r)];break;case g.MESH:o=t.meshes[e.meshIndexMap.get(r)];break;case g.MATERIAL:o=t.materials[e.materialIndexMap.get(r)];break;case g.TEXTURE:o=t.images[e.imageIndexMap.get(r)];break;case g.ANIMATION:o=t.animations[e.animationIndexMap.get(r)];break;default:o=null,this.document.getLogger().warn(`[${oe}]: Unsupported parent property, "${r.propertyType}"`);break}o&&(o.extensions=o.extensions||{},o.extensions[oe]={packet:n.length-1})}}return n.length>0&&(t.extensions=t.extensions||{},t.extensions[oe]={packets:n}),this}}fi.EXTENSION_NAME=oe;function Ft(){return Ft=Object.assign?Object.assign.bind():function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)({}).hasOwnProperty.call(t,n)&&(i[n]=t[n])}return i},Ft.apply(null,arguments)}const{POINTS:qi,LINES:Wi,LINE_STRIP:Yi,LINE_LOOP:Ji,TRIANGLES:Zi,TRIANGLE_STRIP:Qi,TRIANGLE_FAN:eo}=fe.Mode;function hi(i,e){return Object.defineProperty(e,"name",{value:i}),e}var mt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});var zs;(function(i){i.RENDER="render",i.RENDER_CACHED="render-cached",i.UPLOAD="upload",i.UPLOAD_NAIVE="upload-naive",i.DISTINCT="distinct",i.DISTINCT_POSITION="distinct-position",i.UNUSED="unused"})(zs||(zs={}));function li(){var i=new mt(3);return mt!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}(function(){var i=li();return function(e,t,n,s,r,o){var a,c;for(t||(t=3),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,a=n;a<c;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],r(i,i,o),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2];return e}})();const{FLOAT:to}=b.ComponentType,{LINES:so,LINE_STRIP:no,LINE_LOOP:ro,TRIANGLES:io,TRIANGLE_STRIP:oo,TRIANGLE_FAN:ao}=fe.Mode;g.ACCESSOR,g.MESH,g.TEXTURE,g.MATERIAL,g.SKIN;const{TEXTURE_INFO:$s,ROOT:co}=g;function di(i,e,t){t||(t=Xs(i,e));for(const n of e.getRoot().listExtensionsUsed()){const s=i.createExtension(n.constructor);n.isRequired()&&s.setRequired(!0)}return gi(i,e,pi(e),t)}function gi(i,e,t,n){n||(n=Xs(i,e));const s=new Map;for(const r of t)!s.has(r)&&r.propertyType!==$s&&s.set(r,n(r));for(const[r,o]of s.entries())o.copy(r,n);return s}function Xs(i,e){const t=new Map([[e.getRoot(),i.getRoot()]]);return n=>{if(n.propertyType===$s)return n;let s=t.get(n);if(!s){const r=n.constructor;s=new r(i.getGraph()),t.set(n,s)}return s}}function pi(i){const e=new Set;for(const t of i.getGraph().listEdges())e.add(t.getChild());return Array.from(e)}function mi(){var i=new mt(4);return mt!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}(function(){var i=mi();return function(e,t,n,s,r,o){var a,c;for(t||(t=4),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,a=n;a<c;a+=t)i[0]=e[a],i[1]=e[a+1],i[2]=e[a+2],i[3]=e[a+3],r(i,i,o),e[a]=i[0],e[a+1]=i[1],e[a+2]=i[2],e[a+3]=i[3];return e}})(),g.NODE,g.SKIN,g.MESH,g.CAMERA,g.PRIMITIVE,g.PRIMITIVE_TARGET,g.ANIMATION,g.MATERIAL,g.TEXTURE,g.ACCESSOR,g.BUFFER;const{LINE_STRIP:uo,LINE_LOOP:fo,TRIANGLE_STRIP:ho,TRIANGLE_FAN:lo}=fe.Mode,{ROOT:go,NODE:po,MESH:mo,PRIMITIVE:xo,ACCESSOR:To}=g,{TRANSLATION:Eo,ROTATION:yo,SCALE:Ro,WEIGHTS:Io}=ut.TargetPath;Ft({level:"high"},{pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0,cleanup:!0});var Ks;(function(i){i[i.STEP=0]="STEP",i[i.LERP=1]="LERP",i[i.SLERP=2]="SLERP"})(Ks||(Ks={})),Promise.resolve();const{POINTS:Ao,LINES:No,LINE_STRIP:_o,LINE_LOOP:So,TRIANGLES:bo,TRIANGLE_STRIP:Mo,TRIANGLE_FAN:Oo}=fe.Mode;var Ut;(function(i){i.LANCZOS3="lanczos3",i.LANCZOS2="lanczos2"})(Ut||(Ut={})),Ut.LANCZOS3;const qs="unpartition",xi={};function Ti(i=xi){return hi(qs,async e=>{const t=e.getLogger(),n=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(s=>s.setBuffer(n)),e.getRoot().listBuffers().forEach((s,r)=>r>0?s.dispose():null),t.debug(`${qs}: Complete.`)})}class ${constructor(e=0,t=0,n=0,s=0,r=!1,o=void 0){this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=e,this._height=t,this._x=n,this._y=s,this._data={},this._rot=r,this._allowRotation=o}static Collide(e,t){return e.collide(t)}static Contain(e,t){return e.contain(t)}area(){return this.width*this.height}collide(e){return e.x<this.x+this.width&&e.x+e.width>this.x&&e.y<this.y+this.height&&e.y+e.height>this.y}contain(e){return e.x>=this.x&&e.y>=this.y&&e.x+e.width<=this.x+this.width&&e.y+e.height<=this.y+this.height}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._dirty++)}get height(){return this._height}set height(e){e!==this._height&&(this._height=e,this._dirty++)}get x(){return this._x}set x(e){e!==this._x&&(this._x=e,this._dirty++)}get y(){return this._y}set y(e){e!==this._y&&(this._y=e,this._dirty++)}get rot(){return this._rot}set rot(e){if(this._allowRotation!==!1&&this._rot!==e){const t=this.width;this.width=this.height,this.height=t,this._rot=e,this._dirty++}}get allowRotation(){return this._allowRotation}set allowRotation(e){this._allowRotation!==e&&(this._allowRotation=e,this._dirty++)}get data(){return this._data}set data(e){e===null||e===this._data||(this._data=e,typeof e=="object"&&e.hasOwnProperty("allowRotation")&&(this._allowRotation=e.allowRotation),this._dirty++)}get dirty(){return this._dirty>0}setDirty(e=!0){this._dirty=e?this._dirty+1:0}}class Ws{constructor(){this._dirty=0}get dirty(){return this._dirty>0||this.rects.some(e=>e.dirty)}setDirty(e=!0){if(this._dirty=e?this._dirty+1:0,!e)for(let t of this.rects)t.setDirty&&t.setDirty(!1)}}class ze extends Ws{constructor(e=xt,t=xt,n=0,s={}){super(),this.maxWidth=e,this.maxHeight=t,this.padding=n,this.freeRects=[],this.rects=[],this.verticalExpand=!1,this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:De.MAX_EDGE},this.options=Object.assign(Object.assign({},this.options),s),this.width=this.options.smart?0:e,this.height=this.options.smart?0:t,this.border=this.options.border?this.options.border:0,this.freeRects.push(new $(this.maxWidth+this.padding-this.border*2,this.maxHeight+this.padding-this.border*2,this.border,this.border)),this.stage=new $(this.width,this.height)}add(...e){let t,n;if(e.length===1){if(typeof e[0]!="object")throw new Error("MacrectsBin.add(): Wrong parameters");n=e[0];let r=n.data&&n.data.tag?n.data.tag:n.tag?n.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==r)return}else{if(t=e.length>2?e[2]:null,this.options.tag&&this.options.exclusiveTag&&(t&&this.tag!==t.tag||!t&&this.tag))return;n=new $(e[0],e[1]),n.data=t,n.setDirty(!1)}const s=this.place(n);return s&&this.rects.push(s),s}repack(){let e=[];this.reset(),this.rects.sort((t,n)=>{const s=Math.max(n.width,n.height)-Math.max(t.width,t.height);return s===0&&t.hash&&n.hash?t.hash>n.hash?-1:1:s});for(let t of this.rects)this.place(t)||e.push(t);for(let t of e)this.rects.splice(this.rects.indexOf(t),1);return e.length>0?e:void 0}reset(e=!1,t=!1){e&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],t&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new $(this.maxWidth+this.padding-this.border*2,this.maxHeight+this.padding-this.border*2,this.border,this.border)],this.stage=new $(this.width,this.height),this._dirty=0}clone(){let e=new ze(this.maxWidth,this.maxHeight,this.padding,this.options);for(let t of this.rects)e.add(t);return e}place(e){let t=e.data&&e.data.tag?e.data.tag:e.tag?e.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==t)return;let n,s;if(e.hasOwnProperty("_allowRotation")&&e.allowRotation!==void 0?s=e.allowRotation:s=this.options.allowRotation,n=this.findNode(e.width+this.padding,e.height+this.padding,s),n){this.updateBinSize(n);let r=this.freeRects.length,o=0;for(;o<r;)this.splitNode(this.freeRects[o],n)&&(this.freeRects.splice(o,1),r--,o--),o++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,e.x=n.x,e.y=n.y,e.rot===void 0&&(e.rot=!1),e.rot=n.rot?!e.rot:e.rot,this._dirty++,e}else if(this.verticalExpand){if(this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(e)}else if(this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(e)}findNode(e,t,n){let s=Number.MAX_VALUE,r,o,a;for(let c in this.freeRects)o=this.freeRects[c],o.width>=e&&o.height>=t&&(r=this.options.logic===De.MAX_AREA?o.width*o.height-e*t:Math.min(o.width-e,o.height-t),r<s&&(a=new $(e,t,o.x,o.y),s=r)),n&&o.width>=t&&o.height>=e&&(r=this.options.logic===De.MAX_AREA?o.width*o.height-t*e:Math.min(o.height-e,o.width-t),r<s&&(a=new $(t,e,o.x,o.y,!0),s=r));return a}splitNode(e,t){if(!e.collide(t))return!1;if(t.x<e.x+e.width&&t.x+t.width>e.x){if(t.y>e.y&&t.y<e.y+e.height){let n=new $(e.width,t.y-e.y,e.x,e.y);this.freeRects.push(n)}if(t.y+t.height<e.y+e.height){let n=new $(e.width,e.y+e.height-(t.y+t.height),e.x,t.y+t.height);this.freeRects.push(n)}}if(t.y<e.y+e.height&&t.y+t.height>e.y){if(t.x>e.x&&t.x<e.x+e.width){let n=new $(t.x-e.x,e.height,e.x,e.y);this.freeRects.push(n)}if(t.x+t.width<e.x+e.width){let n=new $(e.x+e.width-(t.x+t.width),e.height,t.x+t.width,e.y);this.freeRects.push(n)}}return!0}pruneFreeList(){let e=0,t=0,n=this.freeRects.length;for(;e<n;){t=e+1;let s=this.freeRects[e];for(;t<n;){let r=this.freeRects[t];if(r.contain(s)){this.freeRects.splice(e,1),e--,n--;break}s.contain(r)&&(this.freeRects.splice(t,1),t--,n--),t++}e++}}updateBinSize(e){if(!this.options.smart||this.stage.contain(e))return!1;let t=Math.max(this.width,e.x+e.width-this.padding+this.border),n=Math.max(this.height,e.y+e.height-this.padding+this.border);if(this.options.allowRotation){const s=Math.max(this.width,e.x+e.height-this.padding+this.border),r=Math.max(this.height,e.y+e.width-this.padding+this.border);s*r<t*n&&(t=s,n=r)}return this.options.pot&&(t=Math.pow(2,Math.ceil(Math.log(t)*Math.LOG2E)),n=Math.pow(2,Math.ceil(Math.log(n)*Math.LOG2E))),this.options.square&&(t=n=Math.max(t,n)),t>this.maxWidth+this.padding||n>this.maxHeight+this.padding?!1:(this.expandFreeRects(t+this.padding,n+this.padding),this.width=this.stage.width=t,this.height=this.stage.height=n,!0)}expandFreeRects(e,t){this.freeRects.forEach((n,s)=>{n.x+n.width>=Math.min(this.width+this.padding-this.border,e)&&(n.width=e-n.x-this.border),n.y+n.height>=Math.min(this.height+this.padding-this.border,t)&&(n.height=t-n.y-this.border)},this),this.freeRects.push(new $(e-this.width-this.padding,t-this.border*2,this.width+this.padding-this.border,this.border)),this.freeRects.push(new $(e-this.border*2,t-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter(n=>!(n.width<=0||n.height<=0||n.x<this.border||n.y<this.border)),this.pruneFreeList()}}class nt extends Ws{constructor(...e){if(super(),this.rects=[],e.length===1){if(typeof e[0]!="object")throw new Error("OversizedElementBin: Wrong parameters");const t=e[0];this.rects=[t],this.width=t.width,this.height=t.height,this.data=t.data,t.oversized=!0}else{this.width=e[0],this.height=e[1],this.data=e.length>2?e[2]:null;const t=new $(this.width,this.height);t.oversized=!0,t.data=this.data,this.rects.push(t)}this.freeRects=[],this.maxWidth=this.width,this.maxHeight=this.height,this.options={smart:!1,pot:!1,square:!1}}add(){}reset(e=!1){}repack(){}clone(){return new nt(this.rects[0])}}const xt=4096;var De;(function(i){i[i.MAX_AREA=0]="MAX_AREA",i[i.MAX_EDGE=1]="MAX_EDGE"})(De||(De={}));class Ei{constructor(e=xt,t=xt,n=0,s={}){this.width=e,this.height=t,this.padding=n,this.options={smart:!0,pot:!0,square:!1,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:De.MAX_EDGE},this._currentBinIndex=0,this.bins=[],this.options=Object.assign(Object.assign({},this.options),s)}add(...e){if(e.length===1){if(typeof e[0]!="object")throw new Error("MacrectsPacker.add(): Wrong parameters");const t=e[0];if(t.width>this.width||t.height>this.height)this.bins.push(new nt(t));else if(!this.bins.slice(this._currentBinIndex).find(s=>s.add(t)!==void 0)){let s=new ze(this.width,this.height,this.padding,this.options),r=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;this.options.tag&&r&&(s.tag=r),s.add(t),this.bins.push(s)}return t}else{const t=new $(e[0],e[1]);if(e.length>2&&(t.data=e[2]),t.width>this.width||t.height>this.height)this.bins.push(new nt(t));else if(!this.bins.slice(this._currentBinIndex).find(s=>s.add(t)!==void 0)){let s=new ze(this.width,this.height,this.padding,this.options);this.options.tag&&t.data.tag&&(s.tag=t.data.tag),s.add(t),this.bins.push(s)}return t}}addArray(e){if(!this.options.tag||this.options.exclusiveTag)this.sort(e,this.options.logic).forEach(t=>this.add(t));else{if(e.length===0)return;e.sort((r,o)=>{const a=r.data&&r.data.tag?r.data.tag:r.tag?r.tag:void 0,c=o.data&&o.data.tag?o.data.tag:o.tag?o.tag:void 0;return c===void 0?-1:a===void 0?1:c>a?-1:1});let t,n=0;if(!this.bins.slice(this._currentBinIndex).find((r,o)=>{let a=r.clone();for(let c=n;c<e.length;c++){const u=e[c],l=u.data&&u.data.tag?u.data.tag:u.tag?u.tag:void 0;if(c===0&&(t=l),l!==t)return t=l,this.sort(e.slice(n,c),this.options.logic).forEach(d=>r.add(d)),n=c,this.addArray(e.slice(c)),!0;if(l===void 0)return this.sort(e.slice(c),this.options.logic).forEach(d=>this.add(d)),n=e.length,!0;if(a.add(u)===void 0)return this.sort(e.slice(n,c),this.options.logic).forEach(d=>r.add(d)),n=c,!1}return this.sort(e.slice(n),this.options.logic).forEach(c=>r.add(c)),!0})){const r=e[n],o=new ze(this.width,this.height,this.padding,this.options),a=r.data&&r.data.tag?r.data.tag:r.tag?r.tag:void 0;this.options.tag&&this.options.exclusiveTag&&a&&(o.tag=a),this.bins.push(o),o.add(r),n++,this.addArray(e.slice(n))}}}reset(){this.bins=[],this._currentBinIndex=0}repack(e=!0){if(e){let n=[];for(let s of this.bins)if(s.dirty){let r=s.repack();r&&n.push(...r)}this.addArray(n);return}if(!this.dirty)return;const t=this.rects;this.reset(),this.addArray(t)}next(){return this._currentBinIndex=this.bins.length,this._currentBinIndex}load(e){e.forEach((t,n)=>{if(t.maxWidth>this.width||t.maxHeight>this.height)this.bins.push(new nt(t.width,t.height,{}));else{let s=new ze(this.width,this.height,this.padding,t.options);s.freeRects.splice(0),t.freeRects.forEach((r,o)=>{s.freeRects.push(new $(r.width,r.height,r.x,r.y))}),s.width=t.width,s.height=t.height,t.tag&&(s.tag=t.tag),this.bins[n]=s}},this)}save(){let e=[];return this.bins.forEach(t=>{let n={width:t.width,height:t.height,maxWidth:t.maxWidth,maxHeight:t.maxHeight,freeRects:[],rects:[],options:t.options};t.tag&&(n=Object.assign(Object.assign({},n),{tag:t.tag})),t.freeRects.forEach(s=>{n.freeRects.push({x:s.x,y:s.y,width:s.width,height:s.height})}),e.push(n)}),e}sort(e,t=De.MAX_EDGE){return e.slice().sort((n,s)=>{const r=t===De.MAX_EDGE?Math.max(s.width,s.height)-Math.max(n.width,n.height):s.width*s.height-n.width*n.height;return r===0&&n.hash&&s.hash?n.hash>s.hash?-1:1:r})}get currentBinIndex(){return this._currentBinIndex}get dirty(){return this.bins.some(e=>e.dirty)}get rects(){let e=[];for(let t of this.bins)e.push(...t.rects);return e}}self.onmessage=async i=>{const{files:e=[],opts:t={}}=i.data||{};if(!e.length){Ys("No files provided");return}try{const n=await Promise.all(e.map(async x=>new Uint8Array(await x.arrayBuffer()))),s=new Gn().registerExtensions([Gs]),r=[];for(let x=0;x<n.length;x++)try{const p=await s.readBinary(n[x]);p&&r.push(p)}catch(p){throw new Error(`Failed to read GLB at index ${x}: ${p.message||p}`)}if(!r.length)throw new Error("No GLB documents could be read.");const o=r.findIndex(x=>!x||typeof x.getRoot!="function");if(o!==-1)throw new Error(`Document at index ${o} is invalid (missing getRoot)`);const a=r[0];try{for(let x=1;x<r.length;x++)di(a,r[x])}catch(x){throw new Error(`Failed to merge documents: ${x.message||x}`)}const{layoutInfo:c,atlasTextures:u}=await Ii(a,t);await Ci(a,u),Vi(a),await a.transform(Ti()),await ji(a);const l=await s.writeBinary(a),d=Ri(l);self.postMessage({glb:d,layout:c})}catch(n){Ys(yi(n))}};function Ys(i){self.postMessage({error:i})}function yi(i){if(!i)return"Unknown error";if(i instanceof Error){const e=i.constructor?.name||"Error",t=i.stack?` | stack: ${i.stack}`:"";return`[${e}] ${i.message}${t}`}return String(i)}function Ri(i){const e=new Uint8Array(i);let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function Ii(i,e){const t=["basecolor","normal","orm","emissive"],n=[],s={};let r=null;for(const o of t){const a=await Ai(i,o,e,r);a&&(n.push(a.layoutInfo),s[o]=a.atlasTexRefs[a.atlasTexRefs.length-1],r||(r={rects:a.rects,size:a.size}))}return{layoutInfo:n,atlasTextures:s}}function wi(i){const e={basecolor:s=>s.getBaseColorTexture(),normal:s=>s.getNormalTexture(),orm:s=>s.getMetallicRoughnessTexture()||s.getOcclusionTexture(),emissive:s=>s.getEmissiveTexture()}[i],t={basecolor:(s,r)=>s.setBaseColorTexture(r),normal:(s,r)=>s.setNormalTexture(r),orm:(s,r)=>{s.setMetallicRoughnessTexture(r),s.setOcclusionTexture(r)},emissive:(s,r)=>s.setEmissiveTexture(r)}[i],n={basecolor:s=>s.getBaseColorTextureInfo(),normal:s=>s.getNormalTextureInfo(),orm:s=>s.getMetallicRoughnessTextureInfo()||s.getOcclusionTextureInfo(),emissive:s=>s.getEmissiveTextureInfo()}[i];return{getter:e,setter:t,texInfoSetter:n}}async function Ai(i,e,t,n){const{getter:s,setter:r,texInfoSetter:o}=wi(e);if(!s||!r)return null;const a=Number(t.maxSize)||4096,c=Number(t.padding??0),u=Number(t.quality??85),l=(t[`format${e==="basecolor"?"Basecolor":e[0].toUpperCase()+e.slice(1)}`]||"webp").toLowerCase(),d=Number(t.texcoord??0),x=i.getRoot().listMaterials(),p=[],I=new Map;for(const m of x){const y=s(m);let f=y&&y.getImage?y.getImage():null,T=0,R=0;if(f){const N=await _i(f);T=N.width,R=N.height}else f=await tn(e,256,256),T=256,R=256;const w={texture:y,buffer:f,width:T,height:R,materials:[m]};p.push(w);const C=m.getName?m.getName():null;C&&I.set(C,w)}if(!p.length&&!n)return null;let S;n?S=n.rects.map((m,y)=>{const f=m.data?.materials||m.materials||[],R=Gi(f,p)||Hi(f,I)||I.values().next().value||p[y%Math.max(p.length,1)]||{buffer:null,width:m.width,height:m.height,materials:f};return{id:y,width:m.width,height:m.height,data:R,x:m.x,y:m.y}}):S=p.map((m,y)=>({id:y,width:m.width,height:m.height,data:m}));let _,h;if(n){const m=n.size||{};h=Math.max(m.width||0,m.height||0)||a,_=[{width:h,height:h,rects:S.map(y=>({x:y.x??0,y:y.y??0,width:y.width,height:y.height,data:y.data,materials:y.data.materials||[]}))}]}else{const m=Mi(S,a,c);h=m.size,_=m.bins}const O=new Map,E={map:e,atlases:[],uvDiagnostics:[]},A=[];for(let m=0;m<_.length;m++){const y=_[m],f=[];for(const N of y.rects){let M=N.data.buffer;M||(M=await tn(e,N.width,N.height));const D=await Si(N.width,N.height,M);f.push({input:D,left:N.x,top:N.y,width:N.width,height:N.height})}const{image:T,mime:R}=await bi(y.width,y.height,f,l,u),w=await sn(T),C=i.createTexture(`Atlas_${e}_${m}`);try{C.setImage(w).setMimeType(R)}catch(N){const M=w?.constructor?.name??typeof w;throw new Error(`Failed to set atlas image (${M}, map=${e}): ${N.message||N}`)}A.push(C),y.rects.forEach(N=>{(N.data.materials||N.materials||[]).forEach(D=>{const v=o,P=(v?v(D):null)?.getTexCoord()??0;O.set(D,{rect:N,binIndex:m,texCoordIndex:P,tex:C})})}),E.atlases.push({width:y.width,height:y.height,rects:y.rects.map(N=>({x:N.x,y:N.y,width:N.width,height:N.height,materials:(N.data.materials||N.materials||[]).map(M=>M.getName?.()||"mat")})),count:y.rects.length,entries:p.length,packInputCount:S.length})}if(!n){const y=i.getRoot().listMeshes();for(const f of y)f.listPrimitives().forEach(T=>{const R=T.getMaterial();if(!R)return;const w=O.get(R);if(!w)return;const C=d||w.texCoordIndex||0,N=T.getAttribute(`TEXCOORD_${C}`);if(!N)return;const M=N.clone();Ni(M,w.rect,h),T.setAttribute("TEXCOORD_0",M),["TEXCOORD_1","TEXCOORD_2","TEXCOORD_3"].forEach(D=>T.setAttribute(D,null))})}return O.forEach((m,y)=>{r(y,m.tex);const f=o(y);f&&f.setTexCoord(0)}),{layoutInfo:E,atlasTexRefs:A,rects:_[0]?.rects||[],size:{width:_[0]?.width||h,height:_[0]?.height||h},debug:{entries:p.length,packInput:S.length}}}function Ni(i,e,t){const n=i.getArray(),s=t?1/t:1;for(let r=0;r<n.length;r+=2){const o=n[r],a=n[r+1];n[r]=(e.x+o*e.width)*s,n[r+1]=(e.y+a*e.height)*s}return i}async function _i(i){const e=i instanceof Blob?i:new Blob([i]),t=await createImageBitmap(e),{width:n,height:s}=t;return t.close(),{width:n,height:s}}async function Si(i,e,t){const n=t instanceof Blob?t:new Blob([t]),s=await createImageBitmap(n),r=new OffscreenCanvas(i,e),o=r.getContext("2d");o.clearRect(0,0,i,e),o.drawImage(s,0,0,i,e);const a=await r.convertToBlob({type:"image/png"});return s.close(),a}async function bi(i,e,t,n,s){const r=new OffscreenCanvas(i,e),o=r.getContext("2d");o.clearRect(0,0,i,e);for(const l of t){const d=await createImageBitmap(l.input);o.drawImage(d,l.left,l.top,l.width??d.width,l.height??d.height),d.close()}let a="image/png";n==="webp"?a="image/webp":(n==="jpeg"||n==="jpg")&&(a="image/jpeg");const u=await(await r.convertToBlob({type:a,quality:Math.min(Math.max(s/100,0),1)})).arrayBuffer();return{image:new Uint8Array(u),mime:a}}function Mi(i,e,t){const n=[1,.85,.75,.65,.5,.35,.25,.2,.15,.1];for(const s of n){const r=i.map(a=>({...a,width:Math.max(1,Math.floor(a.width*s)),height:Math.max(1,Math.floor(a.height*s))}));let o=Oi(Math.max(...r.map(a=>Math.max(a.width,a.height))));for(o=Math.min(o,e);;){const a=new Ei(o,o,t,{smart:!0,pot:!0,square:!0});if(a.addArray(r),a.bins.length===1&&a.bins[0].rects.length===r.length){const c=a.bins[0];return{size:o,bins:[{width:o,height:o,rects:c.rects.map(u=>({x:u.x,y:u.y,width:u.width,height:u.height,data:u.data,materials:u.data.materials||[]}))}]}}if(o>=e)break;o=Math.min(e,o*2)}}throw new Error(`Could not pack all textures into a single atlas <= ${e}px even after downscaling.`)}function Oi(i){let e=1;for(;e<i;)e<<=1;return e}async function Ci(i,e={}){const t=i.getRoot(),n=t.listScenes(),s=n[0]||t.createScene("Scene"),r=i.createMaterial("Atlas_Merged");e.basecolor&&r.setBaseColorTexture(e.basecolor),e.normal&&r.setNormalTexture(e.normal),e.orm&&(r.setMetallicRoughnessTexture(e.orm),r.setOcclusionTexture(e.orm)),e.emissive&&r.setEmissiveTexture(e.emissive);const o=i.createMesh("Merged"),a=i.createNode("MergedNode").setMesh(o);for(const u of n){const l=u.listChildren().slice();for(const d of l)Js(d,o,r,i),u.removeChild(d)}s.addChild(a);for(const u of t.listMeshes())u!==o&&u.dispose();for(const u of t.listMaterials())u!==r&&u.dispose();for(const u of t.listNodes())u!==a&&u.dispose();n.forEach((u,l)=>{l!==0&&u.dispose()});const c=n[0]||s;c.listChildren().includes(a)||c.addChild(a),Di(o,i)}function Di(i,e){const t=i.listPrimitives();if(t.length<=1)return;const n=e.createPrimitive();let s=0;const r=[],o=[],a=[],c=[],u=[];for(const S of t){const _=S.getAttribute("POSITION");if(!_)continue;const h=S.getAttribute("NORMAL"),O=S.getAttribute("TANGENT"),E=S.getAttribute("TEXCOORD_0"),A=S.getIndices();if(Tt(_,r,3),h&&Tt(h,o,3),O&&Tt(O,a,4),E&&Tt(E,c,2),A){const m=A.getArray();for(let y=0;y<m.length;y++)u.push(m[y]+s);s+=_.getCount()}else{const m=_.getCount();for(let y=0;y<m;y++)u.push(y+s);s+=m}}if(!r.length||!u.length)return;const l=(S,_)=>e.createAccessor().setType(_).setArray(new Float32Array(S));n.setAttribute("POSITION",l(r,"VEC3")),o.length===r.length&&n.setAttribute("NORMAL",l(o,"VEC3")),a.length===r.length/3*4&&n.setAttribute("TANGENT",l(a,"VEC4")),c.length===r.length/3*2&&n.setAttribute("TEXCOORD_0",l(c,"VEC2"));const d=u.length>65535?Uint32Array:Uint16Array,x=new d(u),p=e.createAccessor().setType("SCALAR").setArray(x);n.setIndices(p);const I=t[0].getMaterial();I&&n.setMaterial(I),i.listPrimitives().forEach(S=>i.removePrimitive(S)),i.addPrimitive(n)}function Tt(i,e,t){const n=i.getArray();for(let s=0;s<n.length;s+=t)for(let r=0;r<t;r++)e.push(n[s+r])}function Js(i,e,t,n,s){const r=i.getMatrix?i.getMatrix():null,o=s?Pi(s,r||Bt()):r||Bt(),a=i.getMesh?i.getMesh():null;if(a)for(const c of a.listPrimitives()){const u=vi(c,o,n);u.setMaterial(t),e.addPrimitive(u)}for(const c of i.listChildren?i.listChildren():[])Js(c,e,t,n,o)}function vi(i,e,t){const n=t.createPrimitive(),s=i.getIndices();return s&&n.setIndices(s.clone()),["POSITION","NORMAL","TANGENT","TEXCOORD_0"].forEach(o=>{const a=i.getAttribute(o);if(!a)return;let c=a;o==="POSITION"?c=Fi(a,e,t):o==="NORMAL"?c=Ui(a,e,t):o==="TANGENT"?c=Bi(a,e,t):c=a.clone(),n.setAttribute(o,c)}),n}function Fi(i,e,t){const n=i.getArray(),s=new Float32Array(n.length);for(let r=0;r<n.length;r+=3){const o=Li([n[r],n[r+1],n[r+2]],e);s[r]=o[0],s[r+1]=o[1],s[r+2]=o[2]}return t.createAccessor().setType("VEC3").setArray(s)}function Ui(i,e,t){const n=i.getArray(),s=Qs(e),r=new Float32Array(n.length);for(let o=0;o<n.length;o+=3){const a=Zs([n[o],n[o+1],n[o+2]],s);en(a),r[o]=a[0],r[o+1]=a[1],r[o+2]=a[2]}return t.createAccessor().setType("VEC3").setArray(r)}function Bi(i,e,t){const n=i.getArray(),s=Qs(e),r=new Float32Array(n.length);for(let o=0;o<n.length;o+=4){const a=Zs([n[o],n[o+1],n[o+2]],s);en(a),r[o]=a[0],r[o+1]=a[1],r[o+2]=a[2],r[o+3]=n[o+3]}return t.createAccessor().setType("VEC4").setArray(r)}function Li(i,e){const t=i[0],n=i[1],s=i[2],r=1/(e[3]*t+e[7]*n+e[11]*s+e[15]);return[(e[0]*t+e[4]*n+e[8]*s+e[12])*r,(e[1]*t+e[5]*n+e[9]*s+e[13])*r,(e[2]*t+e[6]*n+e[10]*s+e[14])*r]}function Zs(i,e){const t=i[0],n=i[1],s=i[2];return[e[0]*t+e[4]*n+e[8]*s,e[1]*t+e[5]*n+e[9]*s,e[2]*t+e[6]*n+e[10]*s]}function Qs(i){const e=i[0],t=i[1],n=i[2],s=i[4],r=i[5],o=i[6],a=i[8],c=i[9],u=i[10],l=u*r-o*c,d=-u*s+o*a,x=c*s-r*a;let p=e*l+t*d+n*x;if(!p)return Bt();p=1/p;const I=new Float32Array(16);return I[0]=l*p,I[1]=(-u*t+n*c)*p,I[2]=(o*t-n*r)*p,I[3]=0,I[4]=d*p,I[5]=(u*e-n*a)*p,I[6]=(-o*e+n*s)*p,I[7]=0,I[8]=x*p,I[9]=(-c*e+t*a)*p,I[10]=(r*e-t*s)*p,I[11]=0,I[12]=0,I[13]=0,I[14]=0,I[15]=1,I}function Pi(i,e){const t=new Float32Array(16);for(let n=0;n<4;n++)for(let s=0;s<4;s++)t[n*4+s]=i[0*4+s]*e[n*4+0]+i[1*4+s]*e[n*4+1]+i[2*4+s]*e[n*4+2]+i[3*4+s]*e[n*4+3];return t}function en(i){const e=Math.hypot(i[0],i[1],i[2])||1;i[0]/=e,i[1]/=e,i[2]/=e}function Bt(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}async function tn(i,e,t){let n=[0,0,0,255];i==="basecolor"?n=[255,255,255,255]:i==="normal"?n=[128,128,255,255]:i==="orm"?n=[255,255,255,255]:i==="emissive"&&(n=[0,0,0,255]);const s=new OffscreenCanvas(e,t),r=s.getContext("2d");r.fillStyle=`rgba(${n[0]},${n[1]},${n[2]},${n[3]/255})`,r.fillRect(0,0,e,t);const o=await s.convertToBlob({type:"image/png"});return new Uint8Array(await o.arrayBuffer())}async function sn(i){if(i instanceof Uint8Array)return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(i instanceof Blob)return new Uint8Array(await i.arrayBuffer());if(typeof i?.arrayBuffer=="function"){const t=await i.arrayBuffer();return new Uint8Array(t)}if(ki(i)){const t=new OffscreenCanvas(i.width,i.height);t.getContext("2d").drawImage(i,0,0);const s=await t.convertToBlob({type:"image/png"});return new Uint8Array(await s.arrayBuffer())}if(i&&i.buffer&&i.buffer instanceof ArrayBuffer)return new Uint8Array(i.buffer);const e=i&&i.constructor?i.constructor.name:typeof i;throw new Error(`Method requires Uint8Array parameter; received ${e}`)}async function ji(i){const e=i.getRoot().listTextures();for(const t of e){const n=t.getImage();if(n&&!(n instanceof Uint8Array))try{const s=await sn(n);t.setImage(s)}catch(s){const r=t.getName?t.getName():"(unnamed)",o=n&&n.constructor?n.constructor.name:typeof n;throw new Error(`Texture "${r}" image type ${o} failed to coerce: ${s.message}`)}}}function ki(i){return i&&typeof i=="object"&&"close"in i&&"width"in i&&"height"in i}function Vi(i){const e=new Set;for(const n of i.getRoot().listMaterials()){const s=n.getBaseColorTexture(),r=n.getNormalTexture(),o=n.getMetallicRoughnessTexture(),a=n.getOcclusionTexture(),c=n.getEmissiveTexture();[s,r,o,a,c].forEach(u=>u&&e.add(u))}i.getRoot().listTextures().forEach(n=>{e.has(n)||n.dispose()})}function Gi(i,e){if(!i||!e)return null;for(const t of i){const n=typeof t=="string"?t:typeof t?.getName=="function"?t.getName():null;for(const s of e)if(s.materials&&s.materials.some(r=>{if(r===t)return!0;const o=typeof r=="string"?r:typeof r?.getName=="function"?r.getName():null;return n&&o&&o===n}))return s}return null}function Hi(i,e){if(!i||!e)return null;for(const t of i){const n=typeof t=="string"?t:typeof t?.getName=="function"?t.getName():null;if(n&&e.has(n))return e.get(n)}return null}})();
