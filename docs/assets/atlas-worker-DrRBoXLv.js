(function(){"use strict";class qt{constructor(){this._listeners={}}addEventListener(e,t){const s=this._listeners;return s[e]===void 0&&(s[e]=[]),s[e].indexOf(t)===-1&&s[e].push(t),this}removeEventListener(e,t){const r=this._listeners[e];if(r!==void 0){const i=r.indexOf(t);i!==-1&&r.splice(i,1)}return this}dispatchEvent(e){const s=this._listeners[e.type];if(s!==void 0){const r=s.slice(0);for(let i=0,o=r.length;i<o;i++)r[i].call(this,e)}return this}dispose(){for(const e in this._listeners)delete this._listeners[e]}}class Pe{constructor(e,t,s,r={}){if(this._name=void 0,this._parent=void 0,this._child=void 0,this._attributes=void 0,this._disposed=!1,this._name=e,this._parent=t,this._child=s,this._attributes=r,!t.isOnGraph(s))throw new Error("Cannot connect disconnected graphs.")}getName(){return this._name}getParent(){return this._parent}getChild(){return this._child}setChild(e){return this._child=e,this}getAttributes(){return this._attributes}dispose(){this._disposed||(this._parent._destroyRef(this),this._disposed=!0)}isDisposed(){return this._disposed}}class Rn extends qt{constructor(...e){super(...e),this._emptySet=new Set,this._edges=new Set,this._parentEdges=new Map,this._childEdges=new Map}listEdges(){return Array.from(this._edges)}listParentEdges(e){return Array.from(this._childEdges.get(e)||this._emptySet)}listParents(e){const t=new Set;for(const s of this.listParentEdges(e))t.add(s.getParent());return Array.from(t)}listChildEdges(e){return Array.from(this._parentEdges.get(e)||this._emptySet)}listChildren(e){const t=new Set;for(const s of this.listChildEdges(e))t.add(s.getChild());return Array.from(t)}disconnectParents(e,t){for(const s of this.listParentEdges(e))(!t||t(s.getParent()))&&s.dispose();return this}_createEdge(e,t,s,r){const i=new Pe(e,t,s,r);this._edges.add(i);const o=i.getParent();this._parentEdges.has(o)||this._parentEdges.set(o,new Set),this._parentEdges.get(o).add(i);const a=i.getChild();return this._childEdges.has(a)||this._childEdges.set(a,new Set),this._childEdges.get(a).add(i),i}_destroyEdge(e){return this._edges.delete(e),this._parentEdges.get(e.getParent()).delete(e),this._childEdges.get(e.getChild()).delete(e),this}}function Ye(){return Ye=Object.assign||function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},Ye.apply(this,arguments)}class ve{constructor(e){if(this.list=[],e)for(const t of e)this.list.push(t)}add(e){this.list.push(e)}remove(e){const t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)}removeChild(e){const t=[];for(const s of this.list)s.getChild()===e&&t.push(s);for(const s of t)this.remove(s);return t}listRefsByChild(e){const t=[];for(const s of this.list)s.getChild()===e&&t.push(s);return t}values(){return this.list}}class V{constructor(e){if(this.set=new Set,this.map=new Map,e)for(const t of e)this.add(t)}add(e){const t=e.getChild();this.removeChild(t),this.set.add(e),this.map.set(t,e)}remove(e){this.set.delete(e),this.map.delete(e.getChild())}removeChild(e){const t=this.map.get(e)||null;return t&&this.remove(t),t}getRefByChild(e){return this.map.get(e)||null}values(){return Array.from(this.set)}}class he{constructor(e){this.map={},e&&Object.assign(this.map,e)}set(e,t){this.map[e]=t}delete(e){delete this.map[e]}get(e){return this.map[e]||null}keys(){return Object.keys(this.map)}values(){return Object.values(this.map)}}const U=Symbol("attributes"),Ue=Symbol("immutableKeys");class At extends qt{constructor(e){super(),this._disposed=!1,this.graph=void 0,this[U]=void 0,this[Ue]=void 0,this.graph=e,this[Ue]=new Set,this[U]=this._createAttributes()}getDefaults(){return{}}_createAttributes(){const e=this.getDefaults(),t={};for(const s in e){const r=e[s];if(r instanceof At){const i=this.graph._createEdge(s,this,r);this[Ue].add(s),t[s]=i}else t[s]=r}return t}isOnGraph(e){return this.graph===e.graph}isDisposed(){return this._disposed}dispose(){this._disposed||(this.graph.listChildEdges(this).forEach(e=>e.dispose()),this.graph.disconnectParents(this),this._disposed=!0,this.dispatchEvent({type:"dispose"}))}detach(){return this.graph.disconnectParents(this),this}swap(e,t){for(const s in this[U]){const r=this[U][s];if(r instanceof Pe){const i=r;i.getChild()===e&&this.setRef(s,t,i.getAttributes())}else if(r instanceof ve)for(const i of r.listRefsByChild(e)){const o=i.getAttributes();this.removeRef(s,e),this.addRef(s,t,o)}else if(r instanceof V){const i=r.getRefByChild(e);if(i){const o=i.getAttributes();this.removeRef(s,e),this.addRef(s,t,o)}}else if(r instanceof he)for(const i of r.keys()){const o=r.get(i);o.getChild()===e&&this.setRefMap(s,i,t,o.getAttributes())}}return this}get(e){return this[U][e]}set(e,t){return this[U][e]=t,this.dispatchEvent({type:"change",attribute:e})}getRef(e){const t=this[U][e];return t?t.getChild():null}setRef(e,t,s){if(this[Ue].has(e))throw new Error(`Cannot overwrite immutable attribute, "${e}".`);const r=this[U][e];if(r&&r.dispose(),!t)return this;const i=this.graph._createEdge(e,this,t,s);return this[U][e]=i,this.dispatchEvent({type:"change",attribute:e})}listRefs(e){return this.assertRefList(e).values().map(s=>s.getChild())}addRef(e,t,s){const r=this.graph._createEdge(e,this,t,s);return this.assertRefList(e).add(r),this.dispatchEvent({type:"change",attribute:e})}removeRef(e,t){const s=this.assertRefList(e);if(s instanceof ve)for(const r of s.listRefsByChild(t))r.dispose();else{const r=s.getRefByChild(t);r&&r.dispose()}return this}assertRefList(e){const t=this[U][e];if(t instanceof ve||t instanceof V)return t;throw new Error(`Expected RefList or RefSet for attribute "${e}"`)}listRefMapKeys(e){return this.assertRefMap(e).keys()}listRefMapValues(e){return this.assertRefMap(e).values().map(t=>t.getChild())}getRefMap(e,t){const r=this.assertRefMap(e).get(t);return r?r.getChild():null}setRefMap(e,t,s,r){const i=this.assertRefMap(e),o=i.get(t);if(o&&o.dispose(),!s)return this;r=Object.assign(r||{},{key:t});const a=this.graph._createEdge(e,this,s,Ye({},r,{key:t}));return i.set(t,a),this.dispatchEvent({type:"change",attribute:e,key:t})}assertRefMap(e){const t=this[U][e];if(t instanceof he)return t;throw new Error(`Expected RefMap for attribute "${e}"`)}dispatchEvent(e){return super.dispatchEvent(Ye({},e,{target:this})),this.graph.dispatchEvent(Ye({},e,{target:this,type:`node:${e.type}`})),this}_destroyRef(e){const t=e.getName();if(this[U][t]===e)this[U][t]=null,this[Ue].has(t)&&e.getChild().dispose();else if(this[U][t]instanceof ve)this[U][t].remove(e);else if(this[U][t]instanceof V)this[U][t].remove(e);else if(this[U][t]instanceof he){const s=this[U][t];for(const r of s.keys())s.get(r)===e&&s.delete(r)}else return;this.graph._destroyEdge(e),this.dispatchEvent({type:"change",attribute:t})}}const Kt="v4.2.1",Ve="@glb.bin";var m;(function(n){n.ACCESSOR="Accessor",n.ANIMATION="Animation",n.ANIMATION_CHANNEL="AnimationChannel",n.ANIMATION_SAMPLER="AnimationSampler",n.BUFFER="Buffer",n.CAMERA="Camera",n.MATERIAL="Material",n.MESH="Mesh",n.PRIMITIVE="Primitive",n.PRIMITIVE_TARGET="PrimitiveTarget",n.NODE="Node",n.ROOT="Root",n.SCENE="Scene",n.SKIN="Skin",n.TEXTURE="Texture",n.TEXTURE_INFO="TextureInfo"})(m||(m={}));var ut;(function(n){n.INTERLEAVED="interleaved",n.SEPARATE="separate"})(ut||(ut={}));var te;(function(n){n.ARRAY_BUFFER="ARRAY_BUFFER",n.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",n.INVERSE_BIND_MATRICES="INVERSE_BIND_MATRICES",n.OTHER="OTHER",n.SPARSE="SPARSE"})(te||(te={}));var ne;(function(n){n[n.R=4096]="R",n[n.G=256]="G",n[n.B=16]="B",n[n.A=1]="A"})(ne||(ne={}));var Ce;(function(n){n.GLTF="GLTF",n.GLB="GLB"})(Ce||(Ce={}));const ft={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};class F{static createBufferFromDataURI(e){if(typeof Buffer>"u"){const t=atob(e.split(",")[1]),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);return s}else{const t=e.split(",")[1],s=e.indexOf("base64")>=0;return Buffer.from(t,s?"base64":"utf8")}}static encodeText(e){return new TextEncoder().encode(e)}static decodeText(e){return new TextDecoder().decode(e)}static concat(e){let t=0;for(const i of e)t+=i.byteLength;const s=new Uint8Array(t);let r=0;for(const i of e)s.set(i,r),r+=i.byteLength;return s}static pad(e,t=0){const s=this.padNumber(e.byteLength);if(s===e.byteLength)return e;const r=new Uint8Array(s);if(r.set(e),t!==0)for(let i=e.byteLength;i<s;i++)r[i]=t;return r}static padNumber(e){return Math.ceil(e/4)*4}static equals(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;let s=e.byteLength;for(;s--;)if(e[s]!==t[s])return!1;return!0}static toView(e,t=0,s=1/0){return new Uint8Array(e.buffer,e.byteOffset+t,Math.min(e.byteLength,s))}static assertView(e){if(e&&!ArrayBuffer.isView(e))throw new Error(`Method requires Uint8Array parameter; received "${typeof e}".`);return e}}class _n{static hexToFactor(e,t){e=Math.floor(e);const s=t;return s[0]=(e>>16&255)/255,s[1]=(e>>8&255)/255,s[2]=(e&255)/255,this.convertSRGBToLinear(t,t)}static factorToHex(e){const t=[...e],[s,r,i]=this.convertLinearToSRGB(e,t);return s*255<<16^r*255<<8^i*255<<0}static convertSRGBToLinear(e,t){const s=e,r=t;for(let i=0;i<3;i++)r[i]=s[i]<.04045?s[i]*.0773993808:Math.pow(s[i]*.9478672986+.0521327014,2.4);return t}static convertLinearToSRGB(e,t){const s=e,r=t;for(let i=0;i<3;i++)r[i]=s[i]<.0031308?s[i]*12.92:1.055*Math.pow(s[i],.41666)-.055;return t}}class wn{match(e){return e.length>=3&&e[0]===255&&e[1]===216&&e[2]===255}getSize(e){let t=new DataView(e.buffer,e.byteOffset+4),s,r;for(;t.byteLength;){if(s=t.getUint16(0,!1),bn(t,s),r=t.getUint8(s+1),r===192||r===193||r===194)return[t.getUint16(s+7,!1),t.getUint16(s+5,!1)];t=new DataView(e.buffer,t.byteOffset+s+2)}throw new TypeError("Invalid JPG, no size found")}getChannels(e){return 3}}class ht{match(e){return e.length>=8&&e[0]===137&&e[1]===80&&e[2]===78&&e[3]===71&&e[4]===13&&e[5]===10&&e[6]===26&&e[7]===10}getSize(e){const t=new DataView(e.buffer,e.byteOffset);return F.decodeText(e.slice(12,16))===ht.PNG_FRIED_CHUNK_NAME?[t.getUint32(32,!1),t.getUint32(36,!1)]:[t.getUint32(16,!1),t.getUint32(20,!1)]}getChannels(e){return 4}}ht.PNG_FRIED_CHUNK_NAME="CgBI";class le{static registerFormat(e,t){this.impls[e]=t}static getMimeType(e){for(const t in this.impls)if(this.impls[t].match(e))return t;return null}static getSize(e,t){return this.impls[t]?this.impls[t].getSize(e):null}static getChannels(e,t){return this.impls[t]?this.impls[t].getChannels(e):null}static getVRAMByteLength(e,t){if(!this.impls[t])return null;if(this.impls[t].getVRAMByteLength)return this.impls[t].getVRAMByteLength(e);let s=0;const r=4,i=this.getSize(e,t);if(!i)return null;for(;i[0]>1||i[1]>1;)s+=i[0]*i[1]*r,i[0]=Math.max(Math.floor(i[0]/2),1),i[1]=Math.max(Math.floor(i[1]/2),1);return s+=1*1*r,s}static mimeTypeToExtension(e){return e==="image/jpeg"?"jpg":e.split("/").pop()}static extensionToMimeType(e){return e==="jpg"?"image/jpeg":e?`image/${e}`:""}}le.impls={"image/jpeg":new wn,"image/png":new ht};function bn(n,e){if(e>n.byteLength)throw new TypeError("Corrupt JPG, exceeded buffer limits");if(n.getUint8(e)!==255)throw new TypeError("Invalid JPG, marker table corrupted");return n}class ke{static basename(e){const t=e.split(/[\\/]/).pop();return t.substring(0,t.lastIndexOf("."))}static extension(e){if(e.startsWith("data:image/")){const t=e.match(/data:(image\/\w+)/)[1];return le.mimeTypeToExtension(t)}else{if(e.startsWith("data:model/gltf+json"))return"gltf";if(e.startsWith("data:model/gltf-binary"))return"glb";if(e.startsWith("data:application/"))return"bin"}return e.split(/[\\/]/).pop().split(/[.]/).pop()}}var Nt=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});function An(){var n=new Nt(3);return Nt!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function Mt(n){var e=n[0],t=n[1],s=n[2];return Math.hypot(e,t,s)}function Nn(n,e,t){var s=e[0],r=e[1],i=e[2],o=t[3]*s+t[7]*r+t[11]*i+t[15];return o=o||1,n[0]=(t[0]*s+t[4]*r+t[8]*i+t[12])/o,n[1]=(t[1]*s+t[5]*r+t[9]*i+t[13])/o,n[2]=(t[2]*s+t[6]*r+t[10]*i+t[14])/o,n}(function(){var n=An();return function(e,t,s,r,i,o){var a,c;for(t||(t=3),s||(s=0),r?c=Math.min(r*t+s,e.length):c=e.length,a=s;a<c;a+=t)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],i(n,n,o),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2];return e}})();function Mn(n){const e=Wt(),t=n.propertyType===m.NODE?[n]:n.listChildren();for(const s of t)s.traverse(r=>{const i=r.getMesh();if(!i)return;const o=Sn(i,r.getWorldMatrix());o.min.every(isFinite)&&o.max.every(isFinite)&&(St(o.min,e),St(o.max,e))});return e}function Sn(n,e){const t=Wt();for(const s of n.listPrimitives()){const r=s.getAttribute("POSITION"),i=s.getIndices();if(!r)continue;let o=[0,0,0],a=[0,0,0];for(let c=0,u=i?i.getCount():r.getCount();c<u;c++){const h=i?i.getScalar(c):c;o=r.getElement(h,o),a=Nn(a,o,e),St(a,t)}}return t}function St(n,e){for(let t=0;t<3;t++)e.min[t]=Math.min(n[t],e.min[t]),e.max[t]=Math.max(n[t],e.max[t])}function Wt(){return{min:[1/0,1/0,1/0],max:[-1/0,-1/0,-1/0]}}const Yt="https://null.example";class Je{static dirname(e){const t=e.lastIndexOf("/");return t===-1?"./":e.substring(0,t+1)}static basename(e){return ke.basename(new URL(e,Yt).pathname)}static extension(e){return ke.extension(new URL(e,Yt).pathname)}static resolve(e,t){if(!this.isRelativePath(t))return t;const s=e.split("/"),r=t.split("/");s.pop();for(let i=0;i<r.length;i++)r[i]!=="."&&(r[i]===".."?s.pop():s.push(r[i]));return s.join("/")}static isAbsoluteURL(e){return this.PROTOCOL_REGEXP.test(e)}static isRelativePath(e){return!/^(?:[a-zA-Z]+:)?\//.test(e)}}Je.DEFAULT_INIT={},Je.PROTOCOL_REGEXP=/^[a-zA-Z]+:\/\//;function Jt(n){return Object.prototype.toString.call(n)==="[object Object]"}function Le(n){if(Jt(n)===!1)return!1;const e=n.constructor;if(e===void 0)return!0;const t=e.prototype;return!(Jt(t)===!1||Object.hasOwn(t,"isPrototypeOf")===!1)}var vt,Ct;(function(n){n[n.SILENT=4]="SILENT",n[n.ERROR=3]="ERROR",n[n.WARN=2]="WARN",n[n.INFO=1]="INFO",n[n.DEBUG=0]="DEBUG"})(Ct||(Ct={}));class re{constructor(e){this.verbosity=void 0,this.verbosity=e}debug(e){this.verbosity<=re.Verbosity.DEBUG&&console.debug(e)}info(e){this.verbosity<=re.Verbosity.INFO&&console.info(e)}warn(e){this.verbosity<=re.Verbosity.WARN&&console.warn(e)}error(e){this.verbosity<=re.Verbosity.ERROR&&console.error(e)}}vt=re,re.Verbosity=Ct,re.DEFAULT_INSTANCE=new vt(vt.Verbosity.INFO);function vn(n){var e=n[0],t=n[1],s=n[2],r=n[3],i=n[4],o=n[5],a=n[6],c=n[7],u=n[8],h=n[9],d=n[10],f=n[11],l=n[12],E=n[13],_=n[14],x=n[15],p=e*o-t*i,M=e*a-s*i,I=e*c-r*i,b=t*a-s*o,T=t*c-r*o,R=s*c-r*a,g=u*E-h*l,y=u*_-d*l,w=u*x-f*l,A=h*_-d*E,C=h*x-f*E,N=d*x-f*_;return p*N-M*C+I*A+b*w-T*y+R*g}function Cn(n,e,t){var s=e[0],r=e[1],i=e[2],o=e[3],a=e[4],c=e[5],u=e[6],h=e[7],d=e[8],f=e[9],l=e[10],E=e[11],_=e[12],x=e[13],p=e[14],M=e[15],I=t[0],b=t[1],T=t[2],R=t[3];return n[0]=I*s+b*a+T*d+R*_,n[1]=I*r+b*c+T*f+R*x,n[2]=I*i+b*u+T*l+R*p,n[3]=I*o+b*h+T*E+R*M,I=t[4],b=t[5],T=t[6],R=t[7],n[4]=I*s+b*a+T*d+R*_,n[5]=I*r+b*c+T*f+R*x,n[6]=I*i+b*u+T*l+R*p,n[7]=I*o+b*h+T*E+R*M,I=t[8],b=t[9],T=t[10],R=t[11],n[8]=I*s+b*a+T*d+R*_,n[9]=I*r+b*c+T*f+R*x,n[10]=I*i+b*u+T*l+R*p,n[11]=I*o+b*h+T*E+R*M,I=t[12],b=t[13],T=t[14],R=t[15],n[12]=I*s+b*a+T*d+R*_,n[13]=I*r+b*c+T*f+R*x,n[14]=I*i+b*u+T*l+R*p,n[15]=I*o+b*h+T*E+R*M,n}function On(n,e){var t=e[0],s=e[1],r=e[2],i=e[4],o=e[5],a=e[6],c=e[8],u=e[9],h=e[10];return n[0]=Math.hypot(t,s,r),n[1]=Math.hypot(i,o,a),n[2]=Math.hypot(c,u,h),n}function Dn(n,e){var t=new Nt(3);On(t,e);var s=1/t[0],r=1/t[1],i=1/t[2],o=e[0]*s,a=e[1]*r,c=e[2]*i,u=e[4]*s,h=e[5]*r,d=e[6]*i,f=e[8]*s,l=e[9]*r,E=e[10]*i,_=o+h+E,x=0;return _>0?(x=Math.sqrt(_+1)*2,n[3]=.25*x,n[0]=(d-l)/x,n[1]=(f-c)/x,n[2]=(a-u)/x):o>h&&o>E?(x=Math.sqrt(1+o-h-E)*2,n[3]=(d-l)/x,n[0]=.25*x,n[1]=(a+u)/x,n[2]=(f+c)/x):h>E?(x=Math.sqrt(1+h-o-E)*2,n[3]=(f-c)/x,n[0]=(a+u)/x,n[1]=.25*x,n[2]=(d+l)/x):(x=Math.sqrt(1+E-o-h)*2,n[3]=(a-u)/x,n[0]=(f+c)/x,n[1]=(d+l)/x,n[2]=.25*x),n}class j{static identity(e){return e}static eq(e,t,s=1e-5){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(Math.abs(e[r]-t[r])>s)return!1;return!0}static clamp(e,t,s){return e<t?t:e>s?s:e}static decodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return e/65535;case 5121:return e/255;case 5122:return Math.max(e/32767,-1);case 5120:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}static encodeNormalizedInt(e,t){switch(t){case 5126:return e;case 5123:return Math.round(j.clamp(e,0,1)*65535);case 5121:return Math.round(j.clamp(e,0,1)*255);case 5122:return Math.round(j.clamp(e,-1,1)*32767);case 5120:return Math.round(j.clamp(e,-1,1)*127);default:throw new Error("Invalid component type.")}}static decompose(e,t,s,r){let i=Mt([e[0],e[1],e[2]]);const o=Mt([e[4],e[5],e[6]]),a=Mt([e[8],e[9],e[10]]);vn(e)<0&&(i=-i),t[0]=e[12],t[1]=e[13],t[2]=e[14];const u=e.slice(),h=1/i,d=1/o,f=1/a;u[0]*=h,u[1]*=h,u[2]*=h,u[4]*=d,u[5]*=d,u[6]*=d,u[8]*=f,u[9]*=f,u[10]*=f,Dn(s,u),r[0]=i,r[1]=o,r[2]=a}static compose(e,t,s,r){const i=r,o=t[0],a=t[1],c=t[2],u=t[3],h=o+o,d=a+a,f=c+c,l=o*h,E=o*d,_=o*f,x=a*d,p=a*f,M=c*f,I=u*h,b=u*d,T=u*f,R=s[0],g=s[1],y=s[2];return i[0]=(1-(x+M))*R,i[1]=(E+T)*R,i[2]=(_-b)*R,i[3]=0,i[4]=(E-T)*g,i[5]=(1-(l+M))*g,i[6]=(p+I)*g,i[7]=0,i[8]=(_+b)*y,i[9]=(p-I)*y,i[10]=(1-(l+x))*y,i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i}}function Fn(n,e){if(!!n!=!!e)return!1;const t=n.getChild(),s=e.getChild();return t===s||t.equals(s)}function Bn(n,e){if(!!n!=!!e)return!1;const t=n.values(),s=e.values();if(t.length!==s.length)return!1;for(let r=0;r<t.length;r++){const i=t[r],o=s[r];if(i.getChild()!==o.getChild()&&!i.getChild().equals(o.getChild()))return!1}return!0}function Un(n,e){if(!!n!=!!e)return!1;const t=n.keys(),s=e.keys();if(t.length!==s.length)return!1;for(const r of t){const i=n.get(r),o=e.get(r);if(!!i!=!!o)return!1;const a=i.getChild(),c=o.getChild();if(a!==c&&!a.equals(c))return!1}return!0}function Zt(n,e){if(n===e)return!0;if(!!n!=!!e||!n||!e||n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(n[t]!==e[t])return!1;return!0}function Qt(n,e){if(n===e)return!0;if(!!n!=!!e)return!1;if(!Le(n)||!Le(e))return n===e;const t=n,s=e;let r=0,i=0,o;for(o in t)r++;for(o in s)i++;if(r!==i)return!1;for(o in t){const a=t[o],c=s[o];if(lt(a)&&lt(c)){if(!Zt(a,c))return!1}else if(Le(a)&&Le(c)){if(!Qt(a,c))return!1}else if(a!==c)return!1}return!0}function lt(n){return Array.isArray(n)||ArrayBuffer.isView(n)}const es="23456789abdegjkmnpqrvwxyzABDEGJKMNPQRVWXYZ",Ln=999,jn=6,ts=new Set,Pn=function(){let e="";for(let t=0;t<jn;t++)e+=es.charAt(Math.floor(Math.random()*es.length));return e},Vn=function(){for(let e=0;e<Ln;e++){const t=Pn();if(!ts.has(t))return ts.add(t),t}return""},Oe=n=>n,kn=new Set;class Ot extends At{constructor(e,t=""){super(e),this[U].name=t,this.init(),this.dispatchEvent({type:"create"})}getGraph(){return this.graph}getDefaults(){return Object.assign(super.getDefaults(),{name:"",extras:{}})}set(e,t){return Array.isArray(t)&&(t=t.slice()),super.set(e,t)}getName(){return this.get("name")}setName(e){return this.set("name",e)}getExtras(){return this.get("extras")}setExtras(e){return this.set("extras",e)}clone(){const e=this.constructor;return new e(this.graph).copy(this,Oe)}copy(e,t=Oe){for(const s in this[U]){const r=this[U][s];if(r instanceof Pe)this[Ue].has(s)||r.dispose();else if(r instanceof ve||r instanceof V)for(const i of r.values())i.dispose();else if(r instanceof he)for(const i of r.values())i.dispose()}for(const s in e[U]){const r=this[U][s],i=e[U][s];if(i instanceof Pe)this[Ue].has(s)?r.getChild().copy(t(i.getChild()),t):this.setRef(s,t(i.getChild()),i.getAttributes());else if(i instanceof V||i instanceof ve)for(const o of i.values())this.addRef(s,t(o.getChild()),o.getAttributes());else if(i instanceof he)for(const o of i.keys()){const a=i.get(o);this.setRefMap(s,o,t(a.getChild()),a.getAttributes())}else Le(i)?this[U][s]=JSON.parse(JSON.stringify(i)):Array.isArray(i)||i instanceof ArrayBuffer||ArrayBuffer.isView(i)?this[U][s]=i.slice():this[U][s]=i}return this}equals(e,t=kn){if(this===e)return!0;if(this.propertyType!==e.propertyType)return!1;for(const s in this[U]){if(t.has(s))continue;const r=this[U][s],i=e[U][s];if(r instanceof Pe||i instanceof Pe){if(!Fn(r,i))return!1}else if(r instanceof V||i instanceof V||r instanceof ve||i instanceof ve){if(!Bn(r,i))return!1}else if(r instanceof he||i instanceof he){if(!Un(r,i))return!1}else if(Le(r)||Le(i)){if(!Qt(r,i))return!1}else if(lt(r)||lt(i)){if(!Zt(r,i))return!1}else if(r!==i)return!1}return!0}detach(){return this.graph.disconnectParents(this,e=>e.propertyType!=="Root"),this}listParents(){return this.graph.listParents(this)}}class Y extends Ot{getDefaults(){return Object.assign(super.getDefaults(),{extensions:new he})}getExtension(e){return this.getRefMap("extensions",e)}setExtension(e,t){return t&&t._validateParent(this),this.setRefMap("extensions",e,t)}listExtensions(){return this.listRefMapValues("extensions")}}class S extends Y{init(){this.propertyType=m.ACCESSOR}getDefaults(){return Object.assign(super.getDefaults(),{array:null,type:S.Type.SCALAR,componentType:S.ComponentType.FLOAT,normalized:!1,sparse:!1,buffer:null})}static getElementSize(e){switch(e){case S.Type.SCALAR:return 1;case S.Type.VEC2:return 2;case S.Type.VEC3:return 3;case S.Type.VEC4:return 4;case S.Type.MAT2:return 4;case S.Type.MAT3:return 9;case S.Type.MAT4:return 16;default:throw new Error("Unexpected type: "+e)}}static getComponentSize(e){switch(e){case S.ComponentType.BYTE:return 1;case S.ComponentType.UNSIGNED_BYTE:return 1;case S.ComponentType.SHORT:return 2;case S.ComponentType.UNSIGNED_SHORT:return 2;case S.ComponentType.UNSIGNED_INT:return 4;case S.ComponentType.FLOAT:return 4;default:throw new Error("Unexpected component type: "+e)}}getMinNormalized(e){const t=this.getNormalized(),s=this.getElementSize(),r=this.getComponentType();if(this.getMin(e),t)for(let i=0;i<s;i++)e[i]=j.decodeNormalizedInt(e[i],r);return e}getMin(e){const t=this.getArray(),s=this.getCount(),r=this.getElementSize();for(let i=0;i<r;i++)e[i]=1/0;for(let i=0;i<s*r;i+=r)for(let o=0;o<r;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.min(e[o],a))}return e}getMaxNormalized(e){const t=this.getNormalized(),s=this.getElementSize(),r=this.getComponentType();if(this.getMax(e),t)for(let i=0;i<s;i++)e[i]=j.decodeNormalizedInt(e[i],r);return e}getMax(e){const t=this.get("array"),s=this.getCount(),r=this.getElementSize();for(let i=0;i<r;i++)e[i]=-1/0;for(let i=0;i<s*r;i+=r)for(let o=0;o<r;o++){const a=t[i+o];Number.isFinite(a)&&(e[o]=Math.max(e[o],a))}return e}getCount(){const e=this.get("array");return e?e.length/this.getElementSize():0}getType(){return this.get("type")}setType(e){return this.set("type",e)}getElementSize(){return S.getElementSize(this.get("type"))}getComponentSize(){return this.get("array").BYTES_PER_ELEMENT}getComponentType(){return this.get("componentType")}getNormalized(){return this.get("normalized")}setNormalized(e){return this.set("normalized",e)}getScalar(e){const t=this.getElementSize(),s=this.getComponentType(),r=this.getArray();return this.getNormalized()?j.decodeNormalizedInt(r[e*t],s):r[e*t]}setScalar(e,t){const s=this.getElementSize(),r=this.getComponentType(),i=this.getArray();return this.getNormalized()?i[e*s]=j.encodeNormalizedInt(t,r):i[e*s]=t,this}getElement(e,t){const s=this.getNormalized(),r=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<r;a++)s?t[a]=j.decodeNormalizedInt(o[e*r+a],i):t[a]=o[e*r+a];return t}setElement(e,t){const s=this.getNormalized(),r=this.getElementSize(),i=this.getComponentType(),o=this.getArray();for(let a=0;a<r;a++)s?o[e*r+a]=j.encodeNormalizedInt(t[a],i):o[e*r+a]=t[a];return this}getSparse(){return this.get("sparse")}setSparse(e){return this.set("sparse",e)}getBuffer(){return this.getRef("buffer")}setBuffer(e){return this.setRef("buffer",e)}getArray(){return this.get("array")}setArray(e){return this.set("componentType",e?Gn(e):S.ComponentType.FLOAT),this.set("array",e),this}getByteLength(){const e=this.get("array");return e?e.byteLength:0}}S.Type={SCALAR:"SCALAR",VEC2:"VEC2",VEC3:"VEC3",VEC4:"VEC4",MAT2:"MAT2",MAT3:"MAT3",MAT4:"MAT4"},S.ComponentType={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,UNSIGNED_INT:5125,FLOAT:5126};function Gn(n){switch(n.constructor){case Float32Array:return S.ComponentType.FLOAT;case Uint32Array:return S.ComponentType.UNSIGNED_INT;case Uint16Array:return S.ComponentType.UNSIGNED_SHORT;case Uint8Array:return S.ComponentType.UNSIGNED_BYTE;case Int16Array:return S.ComponentType.SHORT;case Int8Array:return S.ComponentType.BYTE;default:throw new Error("Unknown accessor componentType.")}}class ss extends Y{init(){this.propertyType=m.ANIMATION}getDefaults(){return Object.assign(super.getDefaults(),{channels:new V,samplers:new V})}addChannel(e){return this.addRef("channels",e)}removeChannel(e){return this.removeRef("channels",e)}listChannels(){return this.listRefs("channels")}addSampler(e){return this.addRef("samplers",e)}removeSampler(e){return this.removeRef("samplers",e)}listSamplers(){return this.listRefs("samplers")}}class Ze extends Y{init(){this.propertyType=m.ANIMATION_CHANNEL}getDefaults(){return Object.assign(super.getDefaults(),{targetPath:null,targetNode:null,sampler:null})}getTargetPath(){return this.get("targetPath")}setTargetPath(e){return this.set("targetPath",e)}getTargetNode(){return this.getRef("targetNode")}setTargetNode(e){return this.setRef("targetNode",e)}getSampler(){return this.getRef("sampler")}setSampler(e){return this.setRef("sampler",e)}}Ze.TargetPath={TRANSLATION:"translation",ROTATION:"rotation",SCALE:"scale",WEIGHTS:"weights"};class Ge extends Y{init(){this.propertyType=m.ANIMATION_SAMPLER}getDefaultAttributes(){return Object.assign(super.getDefaults(),{interpolation:Ge.Interpolation.LINEAR,input:null,output:null})}getInterpolation(){return this.get("interpolation")}setInterpolation(e){return this.set("interpolation",e)}getInput(){return this.getRef("input")}setInput(e){return this.setRef("input",e,{usage:te.OTHER})}getOutput(){return this.getRef("output")}setOutput(e){return this.setRef("output",e,{usage:te.OTHER})}}Ge.Interpolation={LINEAR:"LINEAR",STEP:"STEP",CUBICSPLINE:"CUBICSPLINE"};class ns extends Y{init(){this.propertyType=m.BUFFER}getDefaults(){return Object.assign(super.getDefaults(),{uri:""})}getURI(){return this.get("uri")}setURI(e){return this.set("uri",e)}}class je extends Y{init(){this.propertyType=m.CAMERA}getDefaults(){return Object.assign(super.getDefaults(),{type:je.Type.PERSPECTIVE,znear:.1,zfar:100,aspectRatio:null,yfov:Math.PI*2*50/360,xmag:1,ymag:1})}getType(){return this.get("type")}setType(e){return this.set("type",e)}getZNear(){return this.get("znear")}setZNear(e){return this.set("znear",e)}getZFar(){return this.get("zfar")}setZFar(e){return this.set("zfar",e)}getAspectRatio(){return this.get("aspectRatio")}setAspectRatio(e){return this.set("aspectRatio",e)}getYFov(){return this.get("yfov")}setYFov(e){return this.set("yfov",e)}getXMag(){return this.get("xmag")}setXMag(e){return this.set("xmag",e)}getYMag(){return this.get("ymag")}setYMag(e){return this.set("ymag",e)}}je.Type={PERSPECTIVE:"perspective",ORTHOGRAPHIC:"orthographic"};class G extends Ot{_validateParent(e){if(!this.parentTypes.includes(e.propertyType))throw new Error(`Parent "${e.propertyType}" invalid for child "${this.propertyType}".`)}}G.EXTENSION_NAME=void 0;class L extends Y{init(){this.propertyType=m.TEXTURE_INFO}getDefaults(){return Object.assign(super.getDefaults(),{texCoord:0,magFilter:null,minFilter:null,wrapS:L.WrapMode.REPEAT,wrapT:L.WrapMode.REPEAT})}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}getMagFilter(){return this.get("magFilter")}setMagFilter(e){return this.set("magFilter",e)}getMinFilter(){return this.get("minFilter")}setMinFilter(e){return this.set("minFilter",e)}getWrapS(){return this.get("wrapS")}setWrapS(e){return this.set("wrapS",e)}getWrapT(){return this.get("wrapT")}setWrapT(e){return this.set("wrapT",e)}}L.WrapMode={CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},L.MagFilter={NEAREST:9728,LINEAR:9729},L.MinFilter={NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987};const{R:gt,G:dt,B:pt,A:Hn}=ne;class de extends Y{init(){this.propertyType=m.MATERIAL}getDefaults(){return Object.assign(super.getDefaults(),{alphaMode:de.AlphaMode.OPAQUE,alphaCutoff:.5,doubleSided:!1,baseColorFactor:[1,1,1,1],baseColorTexture:null,baseColorTextureInfo:new L(this.graph,"baseColorTextureInfo"),emissiveFactor:[0,0,0],emissiveTexture:null,emissiveTextureInfo:new L(this.graph,"emissiveTextureInfo"),normalScale:1,normalTexture:null,normalTextureInfo:new L(this.graph,"normalTextureInfo"),occlusionStrength:1,occlusionTexture:null,occlusionTextureInfo:new L(this.graph,"occlusionTextureInfo"),roughnessFactor:1,metallicFactor:1,metallicRoughnessTexture:null,metallicRoughnessTextureInfo:new L(this.graph,"metallicRoughnessTextureInfo")})}getDoubleSided(){return this.get("doubleSided")}setDoubleSided(e){return this.set("doubleSided",e)}getAlpha(){return this.get("baseColorFactor")[3]}setAlpha(e){const t=this.get("baseColorFactor").slice();return t[3]=e,this.set("baseColorFactor",t)}getAlphaMode(){return this.get("alphaMode")}setAlphaMode(e){return this.set("alphaMode",e)}getAlphaCutoff(){return this.get("alphaCutoff")}setAlphaCutoff(e){return this.set("alphaCutoff",e)}getBaseColorFactor(){return this.get("baseColorFactor")}setBaseColorFactor(e){return this.set("baseColorFactor",e)}getBaseColorTexture(){return this.getRef("baseColorTexture")}getBaseColorTextureInfo(){return this.getRef("baseColorTexture")?this.getRef("baseColorTextureInfo"):null}setBaseColorTexture(e){return this.setRef("baseColorTexture",e,{channels:gt|dt|pt|Hn,isColor:!0})}getEmissiveFactor(){return this.get("emissiveFactor")}setEmissiveFactor(e){return this.set("emissiveFactor",e)}getEmissiveTexture(){return this.getRef("emissiveTexture")}getEmissiveTextureInfo(){return this.getRef("emissiveTexture")?this.getRef("emissiveTextureInfo"):null}setEmissiveTexture(e){return this.setRef("emissiveTexture",e,{channels:gt|dt|pt,isColor:!0})}getNormalScale(){return this.get("normalScale")}setNormalScale(e){return this.set("normalScale",e)}getNormalTexture(){return this.getRef("normalTexture")}getNormalTextureInfo(){return this.getRef("normalTexture")?this.getRef("normalTextureInfo"):null}setNormalTexture(e){return this.setRef("normalTexture",e,{channels:gt|dt|pt})}getOcclusionStrength(){return this.get("occlusionStrength")}setOcclusionStrength(e){return this.set("occlusionStrength",e)}getOcclusionTexture(){return this.getRef("occlusionTexture")}getOcclusionTextureInfo(){return this.getRef("occlusionTexture")?this.getRef("occlusionTextureInfo"):null}setOcclusionTexture(e){return this.setRef("occlusionTexture",e,{channels:gt})}getRoughnessFactor(){return this.get("roughnessFactor")}setRoughnessFactor(e){return this.set("roughnessFactor",e)}getMetallicFactor(){return this.get("metallicFactor")}setMetallicFactor(e){return this.set("metallicFactor",e)}getMetallicRoughnessTexture(){return this.getRef("metallicRoughnessTexture")}getMetallicRoughnessTextureInfo(){return this.getRef("metallicRoughnessTexture")?this.getRef("metallicRoughnessTextureInfo"):null}setMetallicRoughnessTexture(e){return this.setRef("metallicRoughnessTexture",e,{channels:dt|pt})}}de.AlphaMode={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};class rs extends Y{init(){this.propertyType=m.MESH}getDefaults(){return Object.assign(super.getDefaults(),{weights:[],primitives:new V})}addPrimitive(e){return this.addRef("primitives",e)}removePrimitive(e){return this.removeRef("primitives",e)}listPrimitives(){return this.listRefs("primitives")}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}}class is extends Y{init(){this.propertyType=m.NODE}getDefaults(){return Object.assign(super.getDefaults(),{translation:[0,0,0],rotation:[0,0,0,1],scale:[1,1,1],weights:[],camera:null,mesh:null,skin:null,children:new V})}copy(e,t=Oe){if(t===Oe)throw new Error("Node cannot be copied.");return super.copy(e,t)}getTranslation(){return this.get("translation")}getRotation(){return this.get("rotation")}getScale(){return this.get("scale")}setTranslation(e){return this.set("translation",e)}setRotation(e){return this.set("rotation",e)}setScale(e){return this.set("scale",e)}getMatrix(){return j.compose(this.get("translation"),this.get("rotation"),this.get("scale"),[])}setMatrix(e){const t=this.get("translation").slice(),s=this.get("rotation").slice(),r=this.get("scale").slice();return j.decompose(e,t,s,r),this.set("translation",t).set("rotation",s).set("scale",r)}getWorldTranslation(){const e=[0,0,0];return j.decompose(this.getWorldMatrix(),e,[0,0,0,1],[1,1,1]),e}getWorldRotation(){const e=[0,0,0,1];return j.decompose(this.getWorldMatrix(),[0,0,0],e,[1,1,1]),e}getWorldScale(){const e=[1,1,1];return j.decompose(this.getWorldMatrix(),[0,0,0],[0,0,0,1],e),e}getWorldMatrix(){const e=[];for(let r=this;r!=null;r=r.getParentNode())e.push(r);let t;const s=e.pop().getMatrix();for(;t=e.pop();)Cn(s,s,t.getMatrix());return s}addChild(e){const t=e.getParentNode();t&&t.removeChild(e);for(const s of e.listParents())s.propertyType===m.SCENE&&s.removeChild(e);return this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}getParentNode(){for(const e of this.listParents())if(e.propertyType===m.NODE)return e;return null}getMesh(){return this.getRef("mesh")}setMesh(e){return this.setRef("mesh",e)}getCamera(){return this.getRef("camera")}setCamera(e){return this.setRef("camera",e)}getSkin(){return this.getRef("skin")}setSkin(e){return this.setRef("skin",e)}getWeights(){return this.get("weights")}setWeights(e){return this.set("weights",e)}traverse(e){e(this);for(const t of this.listChildren())t.traverse(e);return this}}class ie extends Y{init(){this.propertyType=m.PRIMITIVE}getDefaults(){return Object.assign(super.getDefaults(),{mode:ie.Mode.TRIANGLES,material:null,indices:null,attributes:new he,targets:new V})}getIndices(){return this.getRef("indices")}setIndices(e){return this.setRef("indices",e,{usage:te.ELEMENT_ARRAY_BUFFER})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:te.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}getMode(){return this.get("mode")}setMode(e){return this.set("mode",e)}listTargets(){return this.listRefs("targets")}addTarget(e){return this.addRef("targets",e)}removeTarget(e){return this.removeRef("targets",e)}}ie.Mode={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class zn extends Ot{init(){this.propertyType=m.PRIMITIVE_TARGET}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new he})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:te.ARRAY_BUFFER})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}function J(){return J=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)({}).hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},J.apply(null,arguments)}class Dt extends Y{init(){this.propertyType=m.SCENE}getDefaults(){return Object.assign(super.getDefaults(),{children:new V})}copy(e,t=Oe){if(t===Oe)throw new Error("Scene cannot be copied.");return super.copy(e,t)}addChild(e){const t=e.getParentNode();return t&&t.removeChild(e),this.addRef("children",e)}removeChild(e){return this.removeRef("children",e)}listChildren(){return this.listRefs("children")}traverse(e){for(const t of this.listChildren())t.traverse(e);return this}}class os extends Y{init(){this.propertyType=m.SKIN}getDefaults(){return Object.assign(super.getDefaults(),{skeleton:null,inverseBindMatrices:null,joints:new V})}getSkeleton(){return this.getRef("skeleton")}setSkeleton(e){return this.setRef("skeleton",e)}getInverseBindMatrices(){return this.getRef("inverseBindMatrices")}setInverseBindMatrices(e){return this.setRef("inverseBindMatrices",e,{usage:te.INVERSE_BIND_MATRICES})}addJoint(e){return this.addRef("joints",e)}removeJoint(e){return this.removeRef("joints",e)}listJoints(){return this.listRefs("joints")}}class Qe extends Y{init(){this.propertyType=m.TEXTURE}getDefaults(){return Object.assign(super.getDefaults(),{image:null,mimeType:"",uri:""})}getMimeType(){return this.get("mimeType")||le.extensionToMimeType(ke.extension(this.get("uri")))}setMimeType(e){return this.set("mimeType",e)}getURI(){return this.get("uri")}setURI(e){this.set("uri",e);const t=le.extensionToMimeType(ke.extension(e));return t&&this.set("mimeType",t),this}getImage(){return this.get("image")}setImage(e){return this.set("image",F.assertView(e))}getSize(){const e=this.get("image");return e?le.getSize(e,this.getMimeType()):null}}class Ft extends Y{init(){this.propertyType=m.ROOT}getDefaults(){return Object.assign(super.getDefaults(),{asset:{generator:`glTF-Transform ${Kt}`,version:"2.0"},defaultScene:null,accessors:new V,animations:new V,buffers:new V,cameras:new V,materials:new V,meshes:new V,nodes:new V,scenes:new V,skins:new V,textures:new V})}constructor(e){super(e),this._extensions=new Set,e.addEventListener("node:create",t=>{this._addChildOfRoot(t.target)})}clone(){throw new Error("Root cannot be cloned.")}copy(e,t=Oe){if(t===Oe)throw new Error("Root cannot be copied.");this.set("asset",J({},e.get("asset"))),this.setName(e.getName()),this.setExtras(J({},e.getExtras())),this.setDefaultScene(e.getDefaultScene()?t(e.getDefaultScene()):null);for(const s of e.listRefMapKeys("extensions")){const r=e.getExtension(s);this.setExtension(s,t(r))}return this}_addChildOfRoot(e){return e instanceof Dt?this.addRef("scenes",e):e instanceof is?this.addRef("nodes",e):e instanceof je?this.addRef("cameras",e):e instanceof os?this.addRef("skins",e):e instanceof rs?this.addRef("meshes",e):e instanceof de?this.addRef("materials",e):e instanceof Qe?this.addRef("textures",e):e instanceof ss?this.addRef("animations",e):e instanceof S?this.addRef("accessors",e):e instanceof ns&&this.addRef("buffers",e),this}getAsset(){return this.get("asset")}listExtensionsUsed(){return Array.from(this._extensions)}listExtensionsRequired(){return this.listExtensionsUsed().filter(e=>e.isRequired())}_enableExtension(e){return this._extensions.add(e),this}_disableExtension(e){return this._extensions.delete(e),this}listScenes(){return this.listRefs("scenes")}setDefaultScene(e){return this.setRef("defaultScene",e)}getDefaultScene(){return this.getRef("defaultScene")}listNodes(){return this.listRefs("nodes")}listCameras(){return this.listRefs("cameras")}listSkins(){return this.listRefs("skins")}listMeshes(){return this.listRefs("meshes")}listMaterials(){return this.listRefs("materials")}listTextures(){return this.listRefs("textures")}listAnimations(){return this.listRefs("animations")}listAccessors(){return this.listRefs("accessors")}listBuffers(){return this.listRefs("buffers")}}class He{static fromGraph(e){return He._GRAPH_DOCUMENTS.get(e)||null}constructor(){this._graph=new Rn,this._root=new Ft(this._graph),this._logger=re.DEFAULT_INSTANCE,He._GRAPH_DOCUMENTS.set(this._graph,this)}getRoot(){return this._root}getGraph(){return this._graph}getLogger(){return this._logger}setLogger(e){return this._logger=e,this}clone(){throw new Error("Use 'cloneDocument(source)' from '@gltf-transform/functions'.")}merge(e){throw new Error("Use 'mergeDocuments(target, source)' from '@gltf-transform/functions'.")}async transform(...e){const t=e.map(s=>s.name);for(const s of e)await s(this,{stack:t});return this}createExtension(e){const t=e.EXTENSION_NAME;return this.getRoot().listExtensionsUsed().find(r=>r.extensionName===t)||new e(this)}createScene(e=""){return new Dt(this._graph,e)}createNode(e=""){return new is(this._graph,e)}createCamera(e=""){return new je(this._graph,e)}createSkin(e=""){return new os(this._graph,e)}createMesh(e=""){return new rs(this._graph,e)}createPrimitive(){return new ie(this._graph)}createPrimitiveTarget(e=""){return new zn(this._graph,e)}createMaterial(e=""){return new de(this._graph,e)}createTexture(e=""){return new Qe(this._graph,e)}createAnimation(e=""){return new ss(this._graph,e)}createAnimationChannel(e=""){return new Ze(this._graph,e)}createAnimationSampler(e=""){return new Ge(this._graph,e)}createAccessor(e="",t=null){return t||(t=this.getRoot().listBuffers()[0]),new S(this._graph,e).setBuffer(t)}createBuffer(e=""){return new ns(this._graph,e)}}He._GRAPH_DOCUMENTS=new WeakMap;class k{constructor(e){this.extensionName="",this.prereadTypes=[],this.prewriteTypes=[],this.readDependencies=[],this.writeDependencies=[],this.document=void 0,this.required=!1,this.properties=new Set,this._listener=void 0,this.document=e,e.getRoot()._enableExtension(this),this._listener=s=>{const r=s,i=r.target;i instanceof G&&i.extensionName===this.extensionName&&(r.type==="node:create"&&this._addExtensionProperty(i),r.type==="node:dispose"&&this._removeExtensionProperty(i))};const t=e.getGraph();t.addEventListener("node:create",this._listener),t.addEventListener("node:dispose",this._listener)}dispose(){this.document.getRoot()._disableExtension(this);const e=this.document.getGraph();e.removeEventListener("node:create",this._listener),e.removeEventListener("node:dispose",this._listener);for(const t of this.properties)t.dispose()}static register(){}isRequired(){return this.required}setRequired(e){return this.required=e,this}listProperties(){return Array.from(this.properties)}_addExtensionProperty(e){return this.properties.add(e),this}_removeExtensionProperty(e){return this.properties.delete(e),this}install(e,t){return this}preread(e,t){return this}prewrite(e,t){return this}}k.EXTENSION_NAME=void 0;class $n{constructor(e){this.jsonDoc=void 0,this.buffers=[],this.bufferViews=[],this.bufferViewBuffers=[],this.accessors=[],this.textures=[],this.textureInfos=new Map,this.materials=[],this.meshes=[],this.cameras=[],this.nodes=[],this.skins=[],this.animations=[],this.scenes=[],this.jsonDoc=e}setTextureInfo(e,t){this.textureInfos.set(e,t),t.texCoord!==void 0&&e.setTexCoord(t.texCoord),t.extras!==void 0&&e.setExtras(t.extras);const s=this.jsonDoc.json.textures[t.index];if(s.sampler===void 0)return;const r=this.jsonDoc.json.samplers[s.sampler];r.magFilter!==void 0&&e.setMagFilter(r.magFilter),r.minFilter!==void 0&&e.setMinFilter(r.minFilter),r.wrapS!==void 0&&e.setWrapS(r.wrapS),r.wrapT!==void 0&&e.setWrapT(r.wrapT)}}const as={logger:re.DEFAULT_INSTANCE,extensions:[],dependencies:{}},Xn=new Set([m.BUFFER,m.TEXTURE,m.MATERIAL,m.MESH,m.PRIMITIVE,m.NODE,m.SCENE]);class qn{static read(e,t=as){const s=J({},as,t),{json:r}=e,i=new He().setLogger(s.logger);this.validate(e,s);const o=new $n(e),a=r.asset,c=i.getRoot().getAsset();a.copyright&&(c.copyright=a.copyright),a.extras&&(c.extras=a.extras),r.extras!==void 0&&i.getRoot().setExtras(J({},r.extras));const u=r.extensionsUsed||[],h=r.extensionsRequired||[];s.extensions.sort((g,y)=>g.EXTENSION_NAME>y.EXTENSION_NAME?1:-1);for(const g of s.extensions)if(u.includes(g.EXTENSION_NAME)){const y=i.createExtension(g).setRequired(h.includes(g.EXTENSION_NAME)),w=y.prereadTypes.filter(A=>!Xn.has(A));w.length&&s.logger.warn(`Preread hooks for some types (${w.join()}), requested by extension ${y.extensionName}, are unsupported. Please file an issue or a PR.`);for(const A of y.readDependencies)y.install(A,s.dependencies[A])}const d=r.buffers||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.BUFFER)).forEach(g=>g.preread(o,m.BUFFER)),o.buffers=d.map(g=>{const y=i.createBuffer(g.name);return g.extras&&y.setExtras(g.extras),g.uri&&g.uri.indexOf("__")!==0&&y.setURI(g.uri),y});const f=r.bufferViews||[];o.bufferViewBuffers=f.map((g,y)=>{if(!o.bufferViews[y]){const w=e.json.buffers[g.buffer],A=w.uri?e.resources[w.uri]:e.resources[Ve],C=g.byteOffset||0;o.bufferViews[y]=F.toView(A,C,g.byteLength)}return o.buffers[g.buffer]});const l=r.accessors||[];o.accessors=l.map(g=>{const y=o.bufferViewBuffers[g.bufferView],w=i.createAccessor(g.name,y).setType(g.type);return g.extras&&w.setExtras(g.extras),g.normalized!==void 0&&w.setNormalized(g.normalized),g.bufferView===void 0||w.setArray(mt(g,o)),w});const E=r.images||[],_=r.textures||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.TEXTURE)).forEach(g=>g.preread(o,m.TEXTURE)),o.textures=E.map(g=>{const y=i.createTexture(g.name);if(g.extras&&y.setExtras(g.extras),g.bufferView!==void 0){const w=r.bufferViews[g.bufferView],A=e.json.buffers[w.buffer],C=A.uri?e.resources[A.uri]:e.resources[Ve],N=w.byteOffset||0,v=w.byteLength,O=C.slice(N,N+v);y.setImage(O)}else g.uri!==void 0&&(y.setImage(e.resources[g.uri]),g.uri.indexOf("__")!==0&&y.setURI(g.uri));if(g.mimeType!==void 0)y.setMimeType(g.mimeType);else if(g.uri){const w=ke.extension(g.uri);y.setMimeType(le.extensionToMimeType(w))}return y}),i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.MATERIAL)).forEach(g=>g.preread(o,m.MATERIAL));const x=r.materials||[];o.materials=x.map(g=>{const y=i.createMaterial(g.name);g.extras&&y.setExtras(g.extras),g.alphaMode!==void 0&&y.setAlphaMode(g.alphaMode),g.alphaCutoff!==void 0&&y.setAlphaCutoff(g.alphaCutoff),g.doubleSided!==void 0&&y.setDoubleSided(g.doubleSided);const w=g.pbrMetallicRoughness||{};if(w.baseColorFactor!==void 0&&y.setBaseColorFactor(w.baseColorFactor),g.emissiveFactor!==void 0&&y.setEmissiveFactor(g.emissiveFactor),w.metallicFactor!==void 0&&y.setMetallicFactor(w.metallicFactor),w.roughnessFactor!==void 0&&y.setRoughnessFactor(w.roughnessFactor),w.baseColorTexture!==void 0){const A=w.baseColorTexture,C=o.textures[_[A.index].source];y.setBaseColorTexture(C),o.setTextureInfo(y.getBaseColorTextureInfo(),A)}if(g.emissiveTexture!==void 0){const A=g.emissiveTexture,C=o.textures[_[A.index].source];y.setEmissiveTexture(C),o.setTextureInfo(y.getEmissiveTextureInfo(),A)}if(g.normalTexture!==void 0){const A=g.normalTexture,C=o.textures[_[A.index].source];y.setNormalTexture(C),o.setTextureInfo(y.getNormalTextureInfo(),A),g.normalTexture.scale!==void 0&&y.setNormalScale(g.normalTexture.scale)}if(g.occlusionTexture!==void 0){const A=g.occlusionTexture,C=o.textures[_[A.index].source];y.setOcclusionTexture(C),o.setTextureInfo(y.getOcclusionTextureInfo(),A),g.occlusionTexture.strength!==void 0&&y.setOcclusionStrength(g.occlusionTexture.strength)}if(w.metallicRoughnessTexture!==void 0){const A=w.metallicRoughnessTexture,C=o.textures[_[A.index].source];y.setMetallicRoughnessTexture(C),o.setTextureInfo(y.getMetallicRoughnessTextureInfo(),A)}return y}),i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.MESH)).forEach(g=>g.preread(o,m.MESH));const p=r.meshes||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.PRIMITIVE)).forEach(g=>g.preread(o,m.PRIMITIVE)),o.meshes=p.map(g=>{const y=i.createMesh(g.name);return g.extras&&y.setExtras(g.extras),g.weights!==void 0&&y.setWeights(g.weights),(g.primitives||[]).forEach(A=>{const C=i.createPrimitive();A.extras&&C.setExtras(A.extras),A.material!==void 0&&C.setMaterial(o.materials[A.material]),A.mode!==void 0&&C.setMode(A.mode);for(const[O,D]of Object.entries(A.attributes||{}))C.setAttribute(O,o.accessors[D]);A.indices!==void 0&&C.setIndices(o.accessors[A.indices]);const N=g.extras&&g.extras.targetNames||[];(A.targets||[]).forEach((O,D)=>{const B=N[D]||D.toString(),P=i.createPrimitiveTarget(B);for(const[Q,W]of Object.entries(O))P.setAttribute(Q,o.accessors[W]);C.addTarget(P)}),y.addPrimitive(C)}),y});const M=r.cameras||[];o.cameras=M.map(g=>{const y=i.createCamera(g.name).setType(g.type);if(g.extras&&y.setExtras(g.extras),g.type===je.Type.PERSPECTIVE){const w=g.perspective;y.setYFov(w.yfov),y.setZNear(w.znear),w.zfar!==void 0&&y.setZFar(w.zfar),w.aspectRatio!==void 0&&y.setAspectRatio(w.aspectRatio)}else{const w=g.orthographic;y.setZNear(w.znear).setZFar(w.zfar).setXMag(w.xmag).setYMag(w.ymag)}return y});const I=r.nodes||[];i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.NODE)).forEach(g=>g.preread(o,m.NODE)),o.nodes=I.map(g=>{const y=i.createNode(g.name);if(g.extras&&y.setExtras(g.extras),g.translation!==void 0&&y.setTranslation(g.translation),g.rotation!==void 0&&y.setRotation(g.rotation),g.scale!==void 0&&y.setScale(g.scale),g.matrix!==void 0){const w=[0,0,0],A=[0,0,0,1],C=[1,1,1];j.decompose(g.matrix,w,A,C),y.setTranslation(w),y.setRotation(A),y.setScale(C)}return g.weights!==void 0&&y.setWeights(g.weights),y});const b=r.skins||[];o.skins=b.map(g=>{const y=i.createSkin(g.name);g.extras&&y.setExtras(g.extras),g.inverseBindMatrices!==void 0&&y.setInverseBindMatrices(o.accessors[g.inverseBindMatrices]),g.skeleton!==void 0&&y.setSkeleton(o.nodes[g.skeleton]);for(const w of g.joints)y.addJoint(o.nodes[w]);return y}),I.map((g,y)=>{const w=o.nodes[y];(g.children||[]).forEach(C=>w.addChild(o.nodes[C])),g.mesh!==void 0&&w.setMesh(o.meshes[g.mesh]),g.camera!==void 0&&w.setCamera(o.cameras[g.camera]),g.skin!==void 0&&w.setSkin(o.skins[g.skin])});const T=r.animations||[];o.animations=T.map(g=>{const y=i.createAnimation(g.name);g.extras&&y.setExtras(g.extras);const A=(g.samplers||[]).map(N=>{const v=i.createAnimationSampler().setInput(o.accessors[N.input]).setOutput(o.accessors[N.output]).setInterpolation(N.interpolation||Ge.Interpolation.LINEAR);return N.extras&&v.setExtras(N.extras),y.addSampler(v),v});return(g.channels||[]).forEach(N=>{const v=i.createAnimationChannel().setSampler(A[N.sampler]).setTargetPath(N.target.path);N.target.node!==void 0&&v.setTargetNode(o.nodes[N.target.node]),N.extras&&v.setExtras(N.extras),y.addChannel(v)}),y});const R=r.scenes||[];return i.getRoot().listExtensionsUsed().filter(g=>g.prereadTypes.includes(m.SCENE)).forEach(g=>g.preread(o,m.SCENE)),o.scenes=R.map(g=>{const y=i.createScene(g.name);return g.extras&&y.setExtras(g.extras),(g.nodes||[]).map(A=>o.nodes[A]).forEach(A=>y.addChild(A)),y}),r.scene!==void 0&&i.getRoot().setDefaultScene(o.scenes[r.scene]),i.getRoot().listExtensionsUsed().forEach(g=>g.read(o)),l.forEach((g,y)=>{const w=o.accessors[y],A=!!g.sparse,C=!g.bufferView&&!w.getArray();(A||C)&&w.setSparse(!0).setArray(Wn(g,o))}),i}static validate(e,t){const s=e.json;if(s.asset.version!=="2.0")throw new Error(`Unsupported glTF version, "${s.asset.version}".`);if(s.extensionsRequired){for(const r of s.extensionsRequired)if(!t.extensions.find(i=>i.EXTENSION_NAME===r))throw new Error(`Missing required extension, "${r}".`)}if(s.extensionsUsed)for(const r of s.extensionsUsed)t.extensions.find(i=>i.EXTENSION_NAME===r)||t.logger.warn(`Missing optional extension, "${r}".`)}}function Kn(n,e){const t=e.jsonDoc,s=e.bufferViews[n.bufferView],r=t.json.bufferViews[n.bufferView],i=ft[n.componentType],o=S.getElementSize(n.type),a=i.BYTES_PER_ELEMENT,c=n.byteOffset||0,u=new i(n.count*o),h=new DataView(s.buffer,s.byteOffset,s.byteLength),d=r.byteStride;for(let f=0;f<n.count;f++)for(let l=0;l<o;l++){const E=c+f*d+l*a;let _;switch(n.componentType){case S.ComponentType.FLOAT:_=h.getFloat32(E,!0);break;case S.ComponentType.UNSIGNED_INT:_=h.getUint32(E,!0);break;case S.ComponentType.UNSIGNED_SHORT:_=h.getUint16(E,!0);break;case S.ComponentType.UNSIGNED_BYTE:_=h.getUint8(E);break;case S.ComponentType.SHORT:_=h.getInt16(E,!0);break;case S.ComponentType.BYTE:_=h.getInt8(E);break;default:throw new Error(`Unexpected componentType "${n.componentType}".`)}u[f*o+l]=_}return u}function mt(n,e){const t=e.jsonDoc,s=e.bufferViews[n.bufferView],r=t.json.bufferViews[n.bufferView],i=ft[n.componentType],o=S.getElementSize(n.type),a=i.BYTES_PER_ELEMENT,c=o*a;if(r.byteStride!==void 0&&r.byteStride!==c)return Kn(n,e);const u=s.byteOffset+(n.byteOffset||0),h=n.count*o*a;return new i(s.buffer.slice(u,u+h))}function Wn(n,e){const t=ft[n.componentType],s=S.getElementSize(n.type);let r;n.bufferView!==void 0?r=mt(n,e):r=new t(n.count*s);const i=n.sparse;if(!i)return r;const o=i.count,a=J({},n,i.indices,{count:o,type:"SCALAR"}),c=J({},n,i.values,{count:o}),u=mt(a,e),h=mt(c,e);for(let d=0;d<a.count;d++)for(let f=0;f<s;f++)r[u[d]*s+f]=h[d*s+f];return r}var et;(function(n){n[n.ARRAY_BUFFER=34962]="ARRAY_BUFFER",n[n.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"})(et||(et={}));class ge{constructor(e,t,s){this._doc=void 0,this.jsonDoc=void 0,this.options=void 0,this.accessorIndexMap=new Map,this.animationIndexMap=new Map,this.bufferIndexMap=new Map,this.cameraIndexMap=new Map,this.skinIndexMap=new Map,this.materialIndexMap=new Map,this.meshIndexMap=new Map,this.nodeIndexMap=new Map,this.imageIndexMap=new Map,this.textureDefIndexMap=new Map,this.textureInfoDefMap=new Map,this.samplerDefIndexMap=new Map,this.sceneIndexMap=new Map,this.imageBufferViews=[],this.otherBufferViews=new Map,this.otherBufferViewsIndexMap=new Map,this.extensionData={},this.bufferURIGenerator=void 0,this.imageURIGenerator=void 0,this.logger=void 0,this._accessorUsageMap=new Map,this.accessorUsageGroupedByParent=new Set(["ARRAY_BUFFER"]),this.accessorParents=new Map,this._doc=e,this.jsonDoc=t,this.options=s;const r=e.getRoot(),i=r.listBuffers().length,o=r.listTextures().length;this.bufferURIGenerator=new cs(i>1,()=>s.basename||"buffer"),this.imageURIGenerator=new cs(o>1,a=>Yn(e,a)||s.basename||"texture"),this.logger=e.getLogger()}createTextureInfoDef(e,t){const s={magFilter:t.getMagFilter()||void 0,minFilter:t.getMinFilter()||void 0,wrapS:t.getWrapS(),wrapT:t.getWrapT()},r=JSON.stringify(s);this.samplerDefIndexMap.has(r)||(this.samplerDefIndexMap.set(r,this.jsonDoc.json.samplers.length),this.jsonDoc.json.samplers.push(s));const i={source:this.imageIndexMap.get(e),sampler:this.samplerDefIndexMap.get(r)},o=JSON.stringify(i);this.textureDefIndexMap.has(o)||(this.textureDefIndexMap.set(o,this.jsonDoc.json.textures.length),this.jsonDoc.json.textures.push(i));const a={index:this.textureDefIndexMap.get(o)};return t.getTexCoord()!==0&&(a.texCoord=t.getTexCoord()),Object.keys(t.getExtras()).length>0&&(a.extras=t.getExtras()),this.textureInfoDefMap.set(t,a),a}createPropertyDef(e){const t={};return e.getName()&&(t.name=e.getName()),Object.keys(e.getExtras()).length>0&&(t.extras=e.getExtras()),t}createAccessorDef(e){const t=this.createPropertyDef(e);return t.type=e.getType(),t.componentType=e.getComponentType(),t.count=e.getCount(),this._doc.getGraph().listParentEdges(e).some(r=>r.getName()==="attributes"&&r.getAttributes().key==="POSITION"||r.getName()==="input")&&(t.max=e.getMax([]).map(Math.fround),t.min=e.getMin([]).map(Math.fround)),e.getNormalized()&&(t.normalized=e.getNormalized()),t}createImageData(e,t,s){if(this.options.format===Ce.GLB)this.imageBufferViews.push(t),e.bufferView=this.jsonDoc.json.bufferViews.length,this.jsonDoc.json.bufferViews.push({buffer:0,byteOffset:-1,byteLength:t.byteLength});else{const r=le.mimeTypeToExtension(s.getMimeType());e.uri=this.imageURIGenerator.createURI(s,r),this.assignResourceURI(e.uri,t,!1)}}assignResourceURI(e,t,s){const r=this.jsonDoc.resources;if(!(e in r)){r[e]=t;return}if(t===r[e]){this.logger.warn(`Duplicate resource URI, "${e}".`);return}const i=`Resource URI "${e}" already assigned to different data.`;if(!s){this.logger.warn(i);return}throw new Error(i)}getAccessorUsage(e){const t=this._accessorUsageMap.get(e);if(t)return t;if(e.getSparse())return te.SPARSE;for(const s of this._doc.getGraph().listParentEdges(e)){const{usage:r}=s.getAttributes();if(r)return r;s.getParent().propertyType!==m.ROOT&&this.logger.warn(`Missing attribute ".usage" on edge, "${s.getName()}".`)}return te.OTHER}addAccessorToUsageGroup(e,t){const s=this._accessorUsageMap.get(e);if(s&&s!==t)throw new Error(`Accessor with usage "${s}" cannot be reused as "${t}".`);return this._accessorUsageMap.set(e,t),this}}ge.BufferViewTarget=et,ge.BufferViewUsage=te,ge.USAGE_TO_TARGET={[te.ARRAY_BUFFER]:et.ARRAY_BUFFER,[te.ELEMENT_ARRAY_BUFFER]:et.ELEMENT_ARRAY_BUFFER};class cs{constructor(e,t){this.multiple=void 0,this.basename=void 0,this.counter={},this.multiple=e,this.basename=t}createURI(e,t){if(e.getURI())return e.getURI();if(this.multiple){const s=this.basename(e);return this.counter[s]=this.counter[s]||1,`${s}_${this.counter[s]++}.${t}`}else return`${this.basename(e)}.${t}`}}function Yn(n,e){const t=n.getGraph().listParentEdges(e).find(s=>s.getParent()!==n.getRoot());return t?t.getName().replace(/texture$/i,""):""}const{BufferViewUsage:Tt}=ge,{UNSIGNED_INT:Jn,UNSIGNED_SHORT:Zn,UNSIGNED_BYTE:Qn}=S.ComponentType,er=new Set([m.ACCESSOR,m.BUFFER,m.MATERIAL,m.MESH]);class tr{static write(e,t){const s=e.getGraph(),r=e.getRoot(),i={asset:J({generator:`glTF-Transform ${Kt}`},r.getAsset()),extras:J({},r.getExtras())},o={json:i,resources:{}},a=new ge(e,o,t),c=t.logger||re.DEFAULT_INSTANCE,u=new Set(t.extensions.map(p=>p.EXTENSION_NAME)),h=e.getRoot().listExtensionsUsed().filter(p=>u.has(p.extensionName)).sort((p,M)=>p.extensionName>M.extensionName?1:-1),d=e.getRoot().listExtensionsRequired().filter(p=>u.has(p.extensionName)).sort((p,M)=>p.extensionName>M.extensionName?1:-1);h.length<e.getRoot().listExtensionsUsed().length&&c.warn("Some extensions were not registered for I/O, and will not be written.");for(const p of h){const M=p.prewriteTypes.filter(I=>!er.has(I));M.length&&c.warn(`Prewrite hooks for some types (${M.join()}), requested by extension ${p.extensionName}, are unsupported. Please file an issue or a PR.`);for(const I of p.writeDependencies)p.install(I,t.dependencies[I])}function f(p,M,I,b){const T=[];let R=0;for(const w of p){const A=a.createAccessorDef(w);A.bufferView=i.bufferViews.length;const C=w.getArray(),N=F.pad(F.toView(C));A.byteOffset=R,R+=N.byteLength,T.push(N),a.accessorIndexMap.set(w,i.accessors.length),i.accessors.push(A)}const g=F.concat(T),y={buffer:M,byteOffset:I,byteLength:g.byteLength};return b&&(y.target=b),i.bufferViews.push(y),{buffers:T,byteLength:R}}function l(p,M,I){const b=p[0].getCount();let T=0;for(const A of p){const C=a.createAccessorDef(A);C.bufferView=i.bufferViews.length,C.byteOffset=T;const N=A.getElementSize(),v=A.getComponentSize();T+=F.padNumber(N*v),a.accessorIndexMap.set(A,i.accessors.length),i.accessors.push(C)}const R=b*T,g=new ArrayBuffer(R),y=new DataView(g);for(let A=0;A<b;A++){let C=0;for(const N of p){const v=N.getElementSize(),O=N.getComponentSize(),D=N.getComponentType(),B=N.getArray();for(let P=0;P<v;P++){const Q=A*T+C+P*O,W=B[A*v+P];switch(D){case S.ComponentType.FLOAT:y.setFloat32(Q,W,!0);break;case S.ComponentType.BYTE:y.setInt8(Q,W);break;case S.ComponentType.SHORT:y.setInt16(Q,W,!0);break;case S.ComponentType.UNSIGNED_BYTE:y.setUint8(Q,W);break;case S.ComponentType.UNSIGNED_SHORT:y.setUint16(Q,W,!0);break;case S.ComponentType.UNSIGNED_INT:y.setUint32(Q,W,!0);break;default:throw new Error("Unexpected component type: "+D)}}C+=F.padNumber(v*O)}}const w={buffer:M,byteOffset:I,byteLength:R,byteStride:T,target:ge.BufferViewTarget.ARRAY_BUFFER};return i.bufferViews.push(w),{byteLength:R,buffers:[new Uint8Array(g)]}}function E(p,M,I){const b=[];let T=0;const R=new Map;let g=-1/0,y=!1;for(const D of p){const B=a.createAccessorDef(D);i.accessors.push(B),a.accessorIndexMap.set(D,i.accessors.length-1);const P=[],Q=[],W=[],$t=new Array(D.getElementSize()).fill(0);for(let Be=0,Xt=D.getCount();Be<Xt;Be++)if(D.getElement(Be,W),!j.eq(W,$t,0)){g=Math.max(Be,g),P.push(Be);for(let ct=0;ct<W.length;ct++)Q.push(W[ct])}const Ke=P.length,We={accessorDef:B,count:Ke};if(R.set(D,We),Ke===0)continue;Ke>D.getCount()/2&&(y=!0);const wt=ft[D.getComponentType()];We.indices=P,We.values=new wt(Q)}if(!Number.isFinite(g))return{buffers:b,byteLength:T};y&&c.warn("Some sparse accessors have >50% non-zero elements, which may increase file size.");const w=g<255?Uint8Array:g<65535?Uint16Array:Uint32Array,A=g<255?Qn:g<65535?Zn:Jn,C={buffer:M,byteOffset:I+T,byteLength:0};for(const D of p){const B=R.get(D);if(B.count===0)continue;B.indicesByteOffset=C.byteLength;const P=F.pad(F.toView(new w(B.indices)));b.push(P),T+=P.byteLength,C.byteLength+=P.byteLength}i.bufferViews.push(C);const N=i.bufferViews.length-1,v={buffer:M,byteOffset:I+T,byteLength:0};for(const D of p){const B=R.get(D);if(B.count===0)continue;B.valuesByteOffset=v.byteLength;const P=F.pad(F.toView(B.values));b.push(P),T+=P.byteLength,v.byteLength+=P.byteLength}i.bufferViews.push(v);const O=i.bufferViews.length-1;for(const D of p){const B=R.get(D);B.count!==0&&(B.accessorDef.sparse={count:B.count,indices:{bufferView:N,byteOffset:B.indicesByteOffset,componentType:A},values:{bufferView:O,byteOffset:B.valuesByteOffset}})}return{buffers:b,byteLength:T}}if(i.accessors=[],i.bufferViews=[],i.samplers=[],i.textures=[],i.images=r.listTextures().map((p,M)=>{const I=a.createPropertyDef(p);p.getMimeType()&&(I.mimeType=p.getMimeType());const b=p.getImage();return b&&a.createImageData(I,b,p),a.imageIndexMap.set(p,M),I}),h.filter(p=>p.prewriteTypes.includes(m.ACCESSOR)).forEach(p=>p.prewrite(a,m.ACCESSOR)),r.listAccessors().forEach(p=>{const M=a.accessorUsageGroupedByParent,I=a.accessorParents;if(a.accessorIndexMap.has(p))return;const b=a.getAccessorUsage(p);if(a.addAccessorToUsageGroup(p,b),M.has(b)){const T=s.listParents(p).find(R=>R.propertyType!==m.ROOT);I.set(p,T)}}),h.filter(p=>p.prewriteTypes.includes(m.BUFFER)).forEach(p=>p.prewrite(a,m.BUFFER)),(r.listAccessors().length>0||a.otherBufferViews.size>0||r.listTextures().length>0&&t.format===Ce.GLB)&&r.listBuffers().length===0)throw new Error("Buffer required for Document resources, but none was found.");i.buffers=[],r.listBuffers().forEach((p,M)=>{const I=a.createPropertyDef(p),b=a.accessorUsageGroupedByParent,T=p.listParents().filter(v=>v instanceof S),R=new Set(T.map(v=>a.accessorParents.get(v))),g=new Map(Array.from(R).map((v,O)=>[v,O])),y={};for(const v of T){var w;if(a.accessorIndexMap.has(v))continue;const O=a.getAccessorUsage(v);let D=O;if(b.has(O)){const B=a.accessorParents.get(v);D+=`:${g.get(B)}`}y[w=D]||(y[w]={usage:O,accessors:[]}),y[D].accessors.push(v)}const A=[],C=i.buffers.length;let N=0;for(const{usage:v,accessors:O}of Object.values(y))if(v===Tt.ARRAY_BUFFER&&t.vertexLayout===ut.INTERLEAVED){const D=l(O,C,N);N+=D.byteLength;for(const B of D.buffers)A.push(B)}else if(v===Tt.ARRAY_BUFFER)for(const D of O){const B=l([D],C,N);N+=B.byteLength;for(const P of B.buffers)A.push(P)}else if(v===Tt.SPARSE){const D=E(O,C,N);N+=D.byteLength;for(const B of D.buffers)A.push(B)}else if(v===Tt.ELEMENT_ARRAY_BUFFER){const D=ge.BufferViewTarget.ELEMENT_ARRAY_BUFFER,B=f(O,C,N,D);N+=B.byteLength;for(const P of B.buffers)A.push(P)}else{const D=f(O,C,N);N+=D.byteLength;for(const B of D.buffers)A.push(B)}if(a.imageBufferViews.length&&M===0){for(let v=0;v<a.imageBufferViews.length;v++)if(i.bufferViews[i.images[v].bufferView].byteOffset=N,N+=a.imageBufferViews[v].byteLength,A.push(a.imageBufferViews[v]),N%8){const O=8-N%8;N+=O,A.push(new Uint8Array(O))}}if(a.otherBufferViews.has(p))for(const v of a.otherBufferViews.get(p))i.bufferViews.push({buffer:C,byteOffset:N,byteLength:v.byteLength}),a.otherBufferViewsIndexMap.set(v,i.bufferViews.length-1),N+=v.byteLength,A.push(v);if(N){let v;t.format===Ce.GLB?v=Ve:(v=a.bufferURIGenerator.createURI(p,"bin"),I.uri=v),I.byteLength=N,a.assignResourceURI(v,F.concat(A),!0)}i.buffers.push(I),a.bufferIndexMap.set(p,M)}),r.listAccessors().find(p=>!p.getBuffer())&&c.warn("Skipped writing one or more Accessors: no Buffer assigned."),h.filter(p=>p.prewriteTypes.includes(m.MATERIAL)).forEach(p=>p.prewrite(a,m.MATERIAL)),i.materials=r.listMaterials().map((p,M)=>{const I=a.createPropertyDef(p);if(p.getAlphaMode()!==de.AlphaMode.OPAQUE&&(I.alphaMode=p.getAlphaMode()),p.getAlphaMode()===de.AlphaMode.MASK&&(I.alphaCutoff=p.getAlphaCutoff()),p.getDoubleSided()&&(I.doubleSided=!0),I.pbrMetallicRoughness={},j.eq(p.getBaseColorFactor(),[1,1,1,1])||(I.pbrMetallicRoughness.baseColorFactor=p.getBaseColorFactor()),j.eq(p.getEmissiveFactor(),[0,0,0])||(I.emissiveFactor=p.getEmissiveFactor()),p.getRoughnessFactor()!==1&&(I.pbrMetallicRoughness.roughnessFactor=p.getRoughnessFactor()),p.getMetallicFactor()!==1&&(I.pbrMetallicRoughness.metallicFactor=p.getMetallicFactor()),p.getBaseColorTexture()){const b=p.getBaseColorTexture(),T=p.getBaseColorTextureInfo();I.pbrMetallicRoughness.baseColorTexture=a.createTextureInfoDef(b,T)}if(p.getEmissiveTexture()){const b=p.getEmissiveTexture(),T=p.getEmissiveTextureInfo();I.emissiveTexture=a.createTextureInfoDef(b,T)}if(p.getNormalTexture()){const b=p.getNormalTexture(),T=p.getNormalTextureInfo(),R=a.createTextureInfoDef(b,T);p.getNormalScale()!==1&&(R.scale=p.getNormalScale()),I.normalTexture=R}if(p.getOcclusionTexture()){const b=p.getOcclusionTexture(),T=p.getOcclusionTextureInfo(),R=a.createTextureInfoDef(b,T);p.getOcclusionStrength()!==1&&(R.strength=p.getOcclusionStrength()),I.occlusionTexture=R}if(p.getMetallicRoughnessTexture()){const b=p.getMetallicRoughnessTexture(),T=p.getMetallicRoughnessTextureInfo();I.pbrMetallicRoughness.metallicRoughnessTexture=a.createTextureInfoDef(b,T)}return a.materialIndexMap.set(p,M),I}),h.filter(p=>p.prewriteTypes.includes(m.MESH)).forEach(p=>p.prewrite(a,m.MESH)),i.meshes=r.listMeshes().map((p,M)=>{const I=a.createPropertyDef(p);let b=null;return I.primitives=p.listPrimitives().map(T=>{const R={attributes:{}};R.mode=T.getMode();const g=T.getMaterial();g&&(R.material=a.materialIndexMap.get(g)),Object.keys(T.getExtras()).length&&(R.extras=T.getExtras());const y=T.getIndices();y&&(R.indices=a.accessorIndexMap.get(y));for(const w of T.listSemantics())R.attributes[w]=a.accessorIndexMap.get(T.getAttribute(w));for(const w of T.listTargets()){const A={};for(const C of w.listSemantics())A[C]=a.accessorIndexMap.get(w.getAttribute(C));R.targets=R.targets||[],R.targets.push(A)}return T.listTargets().length&&!b&&(b=T.listTargets().map(w=>w.getName())),R}),p.getWeights().length&&(I.weights=p.getWeights()),b&&(I.extras=I.extras||{},I.extras.targetNames=b),a.meshIndexMap.set(p,M),I}),i.cameras=r.listCameras().map((p,M)=>{const I=a.createPropertyDef(p);if(I.type=p.getType(),I.type===je.Type.PERSPECTIVE){I.perspective={znear:p.getZNear(),zfar:p.getZFar(),yfov:p.getYFov()};const b=p.getAspectRatio();b!==null&&(I.perspective.aspectRatio=b)}else I.orthographic={znear:p.getZNear(),zfar:p.getZFar(),xmag:p.getXMag(),ymag:p.getYMag()};return a.cameraIndexMap.set(p,M),I}),i.nodes=r.listNodes().map((p,M)=>{const I=a.createPropertyDef(p);return j.eq(p.getTranslation(),[0,0,0])||(I.translation=p.getTranslation()),j.eq(p.getRotation(),[0,0,0,1])||(I.rotation=p.getRotation()),j.eq(p.getScale(),[1,1,1])||(I.scale=p.getScale()),p.getWeights().length&&(I.weights=p.getWeights()),a.nodeIndexMap.set(p,M),I}),i.skins=r.listSkins().map((p,M)=>{const I=a.createPropertyDef(p),b=p.getInverseBindMatrices();b&&(I.inverseBindMatrices=a.accessorIndexMap.get(b));const T=p.getSkeleton();return T&&(I.skeleton=a.nodeIndexMap.get(T)),I.joints=p.listJoints().map(R=>a.nodeIndexMap.get(R)),a.skinIndexMap.set(p,M),I}),r.listNodes().forEach((p,M)=>{const I=i.nodes[M],b=p.getMesh();b&&(I.mesh=a.meshIndexMap.get(b));const T=p.getCamera();T&&(I.camera=a.cameraIndexMap.get(T));const R=p.getSkin();R&&(I.skin=a.skinIndexMap.get(R)),p.listChildren().length>0&&(I.children=p.listChildren().map(g=>a.nodeIndexMap.get(g)))}),i.animations=r.listAnimations().map((p,M)=>{const I=a.createPropertyDef(p),b=new Map;return I.samplers=p.listSamplers().map((T,R)=>{const g=a.createPropertyDef(T);return g.input=a.accessorIndexMap.get(T.getInput()),g.output=a.accessorIndexMap.get(T.getOutput()),g.interpolation=T.getInterpolation(),b.set(T,R),g}),I.channels=p.listChannels().map(T=>{const R=a.createPropertyDef(T);return R.sampler=b.get(T.getSampler()),R.target={node:a.nodeIndexMap.get(T.getTargetNode()),path:T.getTargetPath()},R}),a.animationIndexMap.set(p,M),I}),i.scenes=r.listScenes().map((p,M)=>{const I=a.createPropertyDef(p);return I.nodes=p.listChildren().map(b=>a.nodeIndexMap.get(b)),a.sceneIndexMap.set(p,M),I});const x=r.getDefaultScene();return x&&(i.scene=r.listScenes().indexOf(x)),i.extensionsUsed=h.map(p=>p.extensionName),i.extensionsRequired=d.map(p=>p.extensionName),h.forEach(p=>p.write(a)),sr(i),o}}function sr(n){const e=[];for(const t in n){const s=n[t];(Array.isArray(s)&&s.length===0||s===null||s===""||s&&typeof s=="object"&&Object.keys(s).length===0)&&e.push(t)}for(const t of e)delete n[t]}var xt;(function(n){n[n.JSON=1313821514]="JSON",n[n.BIN=5130562]="BIN"})(xt||(xt={}));class nr{constructor(){this._logger=re.DEFAULT_INSTANCE,this._extensions=new Set,this._dependencies={},this._vertexLayout=ut.INTERLEAVED,this.lastReadBytes=0,this.lastWriteBytes=0}setLogger(e){return this._logger=e,this}registerExtensions(e){for(const t of e)this._extensions.add(t),t.register();return this}registerDependencies(e){return Object.assign(this._dependencies,e),this}setVertexLayout(e){return this._vertexLayout=e,this}async read(e){return await this.readJSON(await this.readAsJSON(e))}async readAsJSON(e){const t=await this.readURI(e,"view");this.lastReadBytes=t.byteLength;const s=us(t)?this._binaryToJSON(t):{json:JSON.parse(F.decodeText(t)),resources:{}};return await this._readResourcesExternal(s,this.dirname(e)),this._readResourcesInternal(s),s}async readJSON(e){return e=this._copyJSON(e),this._readResourcesInternal(e),qn.read(e,{extensions:Array.from(this._extensions),dependencies:this._dependencies,logger:this._logger})}async binaryToJSON(e){const t=this._binaryToJSON(F.assertView(e));this._readResourcesInternal(t);const s=t.json;if(s.buffers&&s.buffers.some(r=>rr(t,r)))throw new Error("Cannot resolve external buffers with binaryToJSON().");if(s.images&&s.images.some(r=>ir(t,r)))throw new Error("Cannot resolve external images with binaryToJSON().");return t}async readBinary(e){return this.readJSON(await this.binaryToJSON(F.assertView(e)))}async writeJSON(e,t={}){if(t.format===Ce.GLB&&e.getRoot().listBuffers().length>1)throw new Error("GLB must have 01 buffers.");return tr.write(e,{format:t.format||Ce.GLTF,basename:t.basename||"",logger:this._logger,vertexLayout:this._vertexLayout,dependencies:J({},this._dependencies),extensions:Array.from(this._extensions)})}async writeBinary(e){const{json:t,resources:s}=await this.writeJSON(e,{format:Ce.GLB}),r=new Uint32Array([1179937895,2,12]),i=JSON.stringify(t),o=F.pad(F.encodeText(i),32),a=F.toView(new Uint32Array([o.byteLength,1313821514])),c=F.concat([a,o]);r[r.length-1]+=c.byteLength;const u=Object.values(s)[0];if(!u||!u.byteLength)return F.concat([F.toView(r),c]);const h=F.pad(u,0),d=F.toView(new Uint32Array([h.byteLength,5130562])),f=F.concat([d,h]);return r[r.length-1]+=f.byteLength,F.concat([F.toView(r),c,f])}async _readResourcesExternal(e,t){var s=this;const r=e.json.images||[],i=e.json.buffers||[],o=[...r,...i].map(async function(a){const c=a.uri;if(!c||c.match(/data:/))return Promise.resolve();e.resources[c]=await s.readURI(s.resolve(t,c),"view"),s.lastReadBytes+=e.resources[c].byteLength});await Promise.all(o)}_readResourcesInternal(e){function t(i){if(i.uri){if(i.uri in e.resources){F.assertView(e.resources[i.uri]);return}if(i.uri.match(/data:/)){const o=`__${Vn()}.${ke.extension(i.uri)}`;e.resources[o]=F.createBufferFromDataURI(i.uri),i.uri=o}}}(e.json.images||[]).forEach(i=>{if(i.bufferView===void 0&&i.uri===void 0)throw new Error("Missing resource URI or buffer view.");t(i)}),(e.json.buffers||[]).forEach(t)}_copyJSON(e){const{images:t,buffers:s}=e.json;return e={json:J({},e.json),resources:J({},e.resources)},t&&(e.json.images=t.map(r=>J({},r))),s&&(e.json.buffers=s.map(r=>J({},r))),e}_binaryToJSON(e){if(!us(e))throw new Error("Invalid glTF 2.0 binary.");const t=new Uint32Array(e.buffer,e.byteOffset+12,2);if(t[1]!==xt.JSON)throw new Error("Missing required GLB JSON chunk.");const s=20,r=t[0],i=F.decodeText(F.toView(e,s,r)),o=JSON.parse(i),a=s+r;if(e.byteLength<=a)return{json:o,resources:{}};const c=new Uint32Array(e.buffer,e.byteOffset+a,2);if(c[1]!==xt.BIN)return{json:o,resources:{}};const u=c[0],h=F.toView(e,a+8,u);return{json:o,resources:{[Ve]:h}}}}function rr(n,e){return e.uri!==void 0&&!(e.uri in n.resources)}function ir(n,e){return e.uri!==void 0&&!(e.uri in n.resources)&&e.bufferView===void 0}function us(n){if(n.byteLength<3*Uint32Array.BYTES_PER_ELEMENT)return!1;const e=new Uint32Array(n.buffer,n.byteOffset,3);return e[0]===1179937895&&e[1]===2}class or extends nr{constructor(e=Je.DEFAULT_INIT){super(),this._fetchConfig=void 0,this._fetchConfig=e}async readURI(e,t){const s=await fetch(e,this._fetchConfig);switch(t){case"view":return new Uint8Array(await s.arrayBuffer());case"text":return s.text()}}resolve(e,t){return Je.resolve(e,t)}dirname(e){return Je.dirname(e)}}function ar(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function cr(n){for(var e=new Array(n),t=0;t<n;++t)e[t]=t;return e}var ur=cr;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var fr=function(n){return n!=null&&(fs(n)||hr(n)||!!n._isBuffer)};function fs(n){return!!n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n)}function hr(n){return typeof n.readFloatLE=="function"&&typeof n.slice=="function"&&fs(n.slice(0,0))}var lr=ur,gr=fr,dr=typeof Float64Array<"u";function pr(n,e){return n[0]-e[0]}function mr(){var n=this.stride,e=new Array(n.length),t;for(t=0;t<e.length;++t)e[t]=[Math.abs(n[t]),t];e.sort(pr);var s=new Array(e.length);for(t=0;t<s.length;++t)s[t]=e[t][1];return s}function Tr(n,e){var t=["View",e,"d",n].join("");e<0&&(t="View_Nil"+n);var s=n==="generic";if(e===-1){var r="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+n+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}",_=new Function(r);return _()}else if(e===0){var r="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+n+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(s?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(s?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}",_=new Function("TrivialArray",r);return _(yt[n][0])}var r=["'use strict'"],i=lr(e),o=i.map(function(x){return"i"+x}),a="this.offset+"+i.map(function(x){return"this.stride["+x+"]*i"+x}).join("+"),c=i.map(function(x){return"b"+x}).join(","),u=i.map(function(x){return"c"+x}).join(",");r.push("function "+t+"(a,"+c+","+u+",d){this.data=a","this.shape=["+c+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+n+"'","proto.dimension="+e),r.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+i.map(function(x){return"this.shape["+x+"]"}).join("*"),"}})"),e===1?r.push("proto.order=[0]"):(r.push("Object.defineProperty(proto,'order',{get:"),e<4?(r.push("function "+t+"_order(){"),e===2?r.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):e===3&&r.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):r.push("ORDER})")),r.push("proto.set=function "+t+"_set("+o.join(",")+",v){"),s?r.push("return this.data.set("+a+",v)}"):r.push("return this.data["+a+"]=v}"),r.push("proto.get=function "+t+"_get("+o.join(",")+"){"),s?r.push("return this.data.get("+a+")}"):r.push("return this.data["+a+"]}"),r.push("proto.index=function "+t+"_index(",o.join(),"){return "+a+"}"),r.push("proto.hi=function "+t+"_hi("+o.join(",")+"){return new "+t+"(this.data,"+i.map(function(x){return["(typeof i",x,"!=='number'||i",x,"<0)?this.shape[",x,"]:i",x,"|0"].join("")}).join(",")+","+i.map(function(x){return"this.stride["+x+"]"}).join(",")+",this.offset)}");var h=i.map(function(x){return"a"+x+"=this.shape["+x+"]"}),d=i.map(function(x){return"c"+x+"=this.stride["+x+"]"});r.push("proto.lo=function "+t+"_lo("+o.join(",")+"){var b=this.offset,d=0,"+h.join(",")+","+d.join(","));for(var f=0;f<e;++f)r.push("if(typeof i"+f+"==='number'&&i"+f+">=0){d=i"+f+"|0;b+=c"+f+"*d;a"+f+"-=d}");r.push("return new "+t+"(this.data,"+i.map(function(x){return"a"+x}).join(",")+","+i.map(function(x){return"c"+x}).join(",")+",b)}"),r.push("proto.step=function "+t+"_step("+o.join(",")+"){var "+i.map(function(x){return"a"+x+"=this.shape["+x+"]"}).join(",")+","+i.map(function(x){return"b"+x+"=this.stride["+x+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var f=0;f<e;++f)r.push("if(typeof i"+f+"==='number'){d=i"+f+"|0;if(d<0){c+=b"+f+"*(a"+f+"-1);a"+f+"=ceil(-a"+f+"/d)}else{a"+f+"=ceil(a"+f+"/d)}b"+f+"*=d}");r.push("return new "+t+"(this.data,"+i.map(function(x){return"a"+x}).join(",")+","+i.map(function(x){return"b"+x}).join(",")+",c)}");for(var l=new Array(e),E=new Array(e),f=0;f<e;++f)l[f]="a[i"+f+"]",E[f]="b[i"+f+"]";r.push("proto.transpose=function "+t+"_transpose("+o+"){"+o.map(function(x,p){return x+"=("+x+"===undefined?"+p+":"+x+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+l.join(",")+","+E.join(",")+",this.offset)}"),r.push("proto.pick=function "+t+"_pick("+o+"){var a=[],b=[],c=this.offset");for(var f=0;f<e;++f)r.push("if(typeof i"+f+"==='number'&&i"+f+">=0){c=(c+this.stride["+f+"]*i"+f+")|0}else{a.push(this.shape["+f+"]);b.push(this.stride["+f+"])}");r.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),r.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+i.map(function(x){return"shape["+x+"]"}).join(",")+","+i.map(function(x){return"stride["+x+"]"}).join(",")+",offset)}");var _=new Function("CTOR_LIST","ORDER",r.join(`
`));return _(yt[n],mr)}function xr(n){if(gr(n))return"buffer";if(dr)switch(Object.prototype.toString.call(n)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(n)?"array":"generic"}var yt={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function yr(n,e,t,s){if(n===void 0){var u=yt.array[0];return u([])}else typeof n=="number"&&(n=[n]);e===void 0&&(e=[n.length]);var r=e.length;if(t===void 0){t=new Array(r);for(var i=r-1,o=1;i>=0;--i)t[i]=o,o*=e[i]}if(s===void 0){s=0;for(var i=0;i<r;++i)t[i]<0&&(s-=(e[i]-1)*t[i])}for(var a=xr(n),c=yt[a];c.length<=r+1;)c.push(Tr(a,c.length-1));var u=c[r+1];return u(n,e,t,s)}var Er=yr,Ir=ar(Er),Rr={};function _r(n,e){for(var t=1,s=n.length,r=n[0],i=n[0],o=1;o<s;++o)if(i=r,r=n[o],e(r,i)){if(o===t){t++;continue}n[t++]=r}return n.length=t,n}function wr(n){for(var e=1,t=n.length,s=n[0],r=n[0],i=1;i<t;++i,r=s)if(r=s,s=n[i],s!==r){if(i===e){e++;continue}n[e++]=s}return n.length=e,n}function br(n,e,t){return n.length===0?n:e?(t||n.sort(e),_r(n,e)):(t||n.sort(),wr(n))}var Ar=br,Nr=Ar;function hs(n,e,t){var s=n.length,r=e.arrayArgs.length,i=e.indexArgs.length>0,o=[],a=[],c=0,u=0,h,d;for(h=0;h<s;++h)a.push(["i",h,"=0"].join(""));for(d=0;d<r;++d)for(h=0;h<s;++h)u=c,c=n[h],h===0?a.push(["d",d,"s",h,"=t",d,"p",c].join("")):a.push(["d",d,"s",h,"=(t",d,"p",c,"-s",u,"*t",d,"p",u,")"].join(""));for(a.length>0&&o.push("var "+a.join(",")),h=s-1;h>=0;--h)c=n[h],o.push(["for(i",h,"=0;i",h,"<s",c,";++i",h,"){"].join(""));for(o.push(t),h=0;h<s;++h){for(u=c,c=n[h],d=0;d<r;++d)o.push(["p",d,"+=d",d,"s",h].join(""));i&&(h>0&&o.push(["index[",u,"]-=s",u].join("")),o.push(["++index[",c,"]"].join(""))),o.push("}")}return o.join(`
`)}function Mr(n,e,t,s){for(var r=e.length,i=t.arrayArgs.length,o=t.blockSize,a=t.indexArgs.length>0,c=[],u=0;u<i;++u)c.push(["var offset",u,"=p",u].join(""));for(var u=n;u<r;++u)c.push(["for(var j"+u+"=SS[",e[u],"]|0;j",u,">0;){"].join("")),c.push(["if(j",u,"<",o,"){"].join("")),c.push(["s",e[u],"=j",u].join("")),c.push(["j",u,"=0"].join("")),c.push(["}else{s",e[u],"=",o].join("")),c.push(["j",u,"-=",o,"}"].join("")),a&&c.push(["index[",e[u],"]=j",u].join(""));for(var u=0;u<i;++u){for(var h=["offset"+u],d=n;d<r;++d)h.push(["j",d,"*t",u,"p",e[d]].join(""));c.push(["p",u,"=(",h.join("+"),")"].join(""))}c.push(hs(e,t,s));for(var u=n;u<r;++u)c.push("}");return c.join(`
`)}function Sr(n){for(var e=0,t=n[0].length;e<t;){for(var s=1;s<n.length;++s)if(n[s][e]!==n[0][e])return e;++e}return e}function Bt(n,e,t){for(var s=n.body,r=[],i=[],o=0;o<n.args.length;++o){var a=n.args[o];if(!(a.count<=0)){var c=new RegExp(a.name,"g"),u="",h=e.arrayArgs.indexOf(o);switch(e.argTypes[o]){case"offset":var d=e.offsetArgIndex.indexOf(o),f=e.offsetArgs[d];h=f.array,u="+q"+d;case"array":u="p"+h+u;var l="l"+o,E="a"+h;if(e.arrayBlockIndices[h]===0)a.count===1?t[h]==="generic"?a.lvalue?(r.push(["var ",l,"=",E,".get(",u,")"].join("")),s=s.replace(c,l),i.push([E,".set(",u,",",l,")"].join(""))):s=s.replace(c,[E,".get(",u,")"].join("")):s=s.replace(c,[E,"[",u,"]"].join("")):t[h]==="generic"?(r.push(["var ",l,"=",E,".get(",u,")"].join("")),s=s.replace(c,l),a.lvalue&&i.push([E,".set(",u,",",l,")"].join(""))):(r.push(["var ",l,"=",E,"[",u,"]"].join("")),s=s.replace(c,l),a.lvalue&&i.push([E,"[",u,"]=",l].join("")));else{for(var _=[a.name],x=[u],p=0;p<Math.abs(e.arrayBlockIndices[h]);p++)_.push("\\s*\\[([^\\]]+)\\]"),x.push("$"+(p+1)+"*t"+h+"b"+p);if(c=new RegExp(_.join(""),"g"),u=x.join("+"),t[h]==="generic")throw new Error("cwise: Generic arrays not supported in combination with blocks!");s=s.replace(c,[E,"[",u,"]"].join(""))}break;case"scalar":s=s.replace(c,"Y"+e.scalarArgs.indexOf(o));break;case"index":s=s.replace(c,"index");break;case"shape":s=s.replace(c,"shape");break}}}return[r.join(`
`),s,i.join(`
`)].join(`
`).trim()}function vr(n){for(var e=new Array(n.length),t=!0,s=0;s<n.length;++s){var r=n[s],i=r.match(/\d+/);i?i=i[0]:i="",r.charAt(0)===0?e[s]="u"+r.charAt(1)+i:e[s]=r.charAt(0)+i,s>0&&(t=t&&e[s]===e[s-1])}return t?e[0]:e.join("")}function Cr(n,e){for(var t=e[1].length-Math.abs(n.arrayBlockIndices[0])|0,s=new Array(n.arrayArgs.length),r=new Array(n.arrayArgs.length),i=0;i<n.arrayArgs.length;++i)r[i]=e[2*i],s[i]=e[2*i+1];for(var o=[],a=[],c=[],u=[],h=[],i=0;i<n.arrayArgs.length;++i){n.arrayBlockIndices[i]<0?(c.push(0),u.push(t),o.push(t),a.push(t+n.arrayBlockIndices[i])):(c.push(n.arrayBlockIndices[i]),u.push(n.arrayBlockIndices[i]+t),o.push(0),a.push(n.arrayBlockIndices[i]));for(var d=[],f=0;f<s[i].length;f++)c[i]<=s[i][f]&&s[i][f]<u[i]&&d.push(s[i][f]-c[i]);h.push(d)}for(var l=["SS"],E=["'use strict'"],_=[],f=0;f<t;++f)_.push(["s",f,"=SS[",f,"]"].join(""));for(var i=0;i<n.arrayArgs.length;++i){l.push("a"+i),l.push("t"+i),l.push("p"+i);for(var f=0;f<t;++f)_.push(["t",i,"p",f,"=t",i,"[",c[i]+f,"]"].join(""));for(var f=0;f<Math.abs(n.arrayBlockIndices[i]);++f)_.push(["t",i,"b",f,"=t",i,"[",o[i]+f,"]"].join(""))}for(var i=0;i<n.scalarArgs.length;++i)l.push("Y"+i);if(n.shapeArgs.length>0&&_.push("shape=SS.slice(0)"),n.indexArgs.length>0){for(var x=new Array(t),i=0;i<t;++i)x[i]="0";_.push(["index=[",x.join(","),"]"].join(""))}for(var i=0;i<n.offsetArgs.length;++i){for(var p=n.offsetArgs[i],M=[],f=0;f<p.offset.length;++f)p.offset[f]!==0&&(p.offset[f]===1?M.push(["t",p.array,"p",f].join("")):M.push([p.offset[f],"*t",p.array,"p",f].join("")));M.length===0?_.push("q"+i+"=0"):_.push(["q",i,"=",M.join("+")].join(""))}var I=Nr([].concat(n.pre.thisVars).concat(n.body.thisVars).concat(n.post.thisVars));_=_.concat(I),_.length>0&&E.push("var "+_.join(","));for(var i=0;i<n.arrayArgs.length;++i)E.push("p"+i+"|=0");n.pre.body.length>3&&E.push(Bt(n.pre,n,r));var b=Bt(n.body,n,r),T=Sr(h);T<t?E.push(Mr(T,h[0],n,b)):E.push(hs(h[0],n,b)),n.post.body.length>3&&E.push(Bt(n.post,n,r)),n.debug&&console.log("-----Generated cwise routine for ",e,`:
`+E.join(`
`)+`
----------`);var R=[n.funcName||"unnamed","_cwise_loop_",s[0].join("s"),"m",T,vr(r)].join(""),g=new Function(["function ",R,"(",l.join(","),"){",E.join(`
`),"} return ",R].join(""));return g()}var Or=Cr,Dr=Or;function Fr(n){var e=["'use strict'","var CACHED={}"],t=[],s=n.funcName+"_cwise_thunk";e.push(["return function ",s,"(",n.shimArgs.join(","),"){"].join(""));for(var r=[],i=[],o=[["array",n.arrayArgs[0],".shape.slice(",Math.max(0,n.arrayBlockIndices[0]),n.arrayBlockIndices[0]<0?","+n.arrayBlockIndices[0]+")":")"].join("")],a=[],c=[],u=0;u<n.arrayArgs.length;++u){var h=n.arrayArgs[u];t.push(["t",h,"=array",h,".dtype,","r",h,"=array",h,".order"].join("")),r.push("t"+h),r.push("r"+h),i.push("t"+h),i.push("r"+h+".join()"),o.push("array"+h+".data"),o.push("array"+h+".stride"),o.push("array"+h+".offset|0"),u>0&&(a.push("array"+n.arrayArgs[0]+".shape.length===array"+h+".shape.length+"+(Math.abs(n.arrayBlockIndices[0])-Math.abs(n.arrayBlockIndices[u]))),c.push("array"+n.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,n.arrayBlockIndices[0])+"]===array"+h+".shape[shapeIndex+"+Math.max(0,n.arrayBlockIndices[u])+"]"))}n.arrayArgs.length>1&&(e.push("if (!("+a.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+n.arrayArgs[0]+".shape.length-"+Math.abs(n.arrayBlockIndices[0])+"; shapeIndex-->0;) {"),e.push("if (!("+c.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}"));for(var u=0;u<n.scalarArgs.length;++u)o.push("scalar"+n.scalarArgs[u]);t.push(["type=[",i.join(","),"].join()"].join("")),t.push("proc=CACHED[type]"),e.push("var "+t.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",r.join(","),"])}","return proc(",o.join(","),")}"].join("")),n.debug&&console.log(`-----Generated thunk:
`+e.join(`
`)+`
----------`);var d=new Function("compile",e.join(`
`));return d(Dr.bind(void 0,n))}var Br=Fr,Ur=Br;function Lr(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}function jr(n){var e=new Lr;e.pre=n.pre,e.body=n.body,e.post=n.post;var t=n.args.slice(0);e.argTypes=t;for(var s=0;s<t.length;++s){var r=t[s];if(r==="array"||typeof r=="object"&&r.blockIndices){if(e.argTypes[s]="array",e.arrayArgs.push(s),e.arrayBlockIndices.push(r.blockIndices?r.blockIndices:0),e.shimArgs.push("array"+s),s<e.pre.args.length&&e.pre.args[s].count>0)throw new Error("cwise: pre() block may not reference array args");if(s<e.post.args.length&&e.post.args[s].count>0)throw new Error("cwise: post() block may not reference array args")}else if(r==="scalar")e.scalarArgs.push(s),e.shimArgs.push("scalar"+s);else if(r==="index"){if(e.indexArgs.push(s),s<e.pre.args.length&&e.pre.args[s].count>0)throw new Error("cwise: pre() block may not reference array index");if(s<e.body.args.length&&e.body.args[s].lvalue)throw new Error("cwise: body() block may not write to array index");if(s<e.post.args.length&&e.post.args[s].count>0)throw new Error("cwise: post() block may not reference array index")}else if(r==="shape"){if(e.shapeArgs.push(s),s<e.pre.args.length&&e.pre.args[s].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(s<e.body.args.length&&e.body.args[s].lvalue)throw new Error("cwise: body() block may not write to array shape");if(s<e.post.args.length&&e.post.args[s].lvalue)throw new Error("cwise: post() block may not write to array shape")}else if(typeof r=="object"&&r.offset)e.argTypes[s]="offset",e.offsetArgs.push({array:r.array,offset:r.offset}),e.offsetArgIndex.push(s);else throw new Error("cwise: Unknown argument type "+t[s])}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>t.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>t.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>t.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!n.printCode||!!n.debug,e.funcName=n.funcName||"cwise",e.blockSize=n.blockSize||64,Ur(e)}var Pr=jr;(function(n){var e=Pr,t={body:"",args:[],thisVars:[],localVars:[]};function s(f){if(!f)return t;for(var l=0;l<f.args.length;++l){var E=f.args[l];l===0?f.args[l]={name:E,lvalue:!0,rvalue:!!f.rvalue,count:f.count||1}:f.args[l]={name:E,lvalue:!1,rvalue:!0,count:1}}return f.thisVars||(f.thisVars=[]),f.localVars||(f.localVars=[]),f}function r(f){return e({args:f.args,pre:s(f.pre),body:s(f.body),post:s(f.proc),funcName:f.funcName})}function i(f){for(var l=[],E=0;E<f.args.length;++E)l.push("a"+E);var _=new Function("P",["return function ",f.funcName,"_ndarrayops(",l.join(","),") {P(",l.join(","),");return a0}"].join(""));return _(r(f))}var o={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};(function(){for(var f in o){var l=o[f];n[f]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+l+"c"},funcName:f}),n[f+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a"+l+"=b"},funcName:f+"eq"}),n[f+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+l+"s"},funcName:f+"s"}),n[f+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a"+l+"=s"},funcName:f+"seq"})}})();var a={not:"!",bnot:"~",neg:"-",recip:"1.0/"};(function(){for(var f in a){var l=a[f];n[f]=i({args:["array","array"],body:{args:["a","b"],body:"a="+l+"b"},funcName:f}),n[f+"eq"]=i({args:["array"],body:{args:["a"],body:"a="+l+"a"},funcName:f+"eq"})}})();var c={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};(function(){for(var f in c){var l=c[f];n[f]=i({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+l+"c"},funcName:f}),n[f+"s"]=i({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+l+"s"},funcName:f+"s"}),n[f+"eq"]=i({args:["array","array"],body:{args:["a","b"],body:"a=a"+l+"b"},funcName:f+"eq"}),n[f+"seq"]=i({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+l+"s"},funcName:f+"seq"})}})();var u=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];(function(){for(var f=0;f<u.length;++f){var l=u[f];n[l]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:l}),n[l+"eq"]=i({args:["array"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},funcName:l+"eq"})}})();var h=["max","min","atan2","pow"];(function(){for(var f=0;f<h.length;++f){var l=h[f];n[l]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:l}),n[l+"s"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:l+"s"}),n[l+"eq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:l+"eq"}),n[l+"seq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:l+"seq"})}})();var d=["atan2","pow"];(function(){for(var f=0;f<d.length;++f){var l=d[f];n[l+"op"]=i({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:l+"op"}),n[l+"ops"]=i({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:l+"ops"}),n[l+"opeq"]=i({args:["array","array"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:l+"opeq"}),n[l+"opseq"]=i({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+l,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:l+"opseq"})}})(),n.any=e({args:["array"],pre:t,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),n.all=e({args:["array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),n.sum=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),n.prod=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),n.norm2squared=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),n.norm2=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),n.norminf=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),n.norm1=e({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),n.sup=e({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),n.inf=e({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),n.argmin=e({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),n.argmax=e({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),n.random=i({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),n.assign=i({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),n.assigns=i({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),n.equals=e({args:["array","array"],pre:t,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})})(Rr);function Vr(n,e){if(!(n instanceof Uint8Array))throw new Error("[ndarray-pixels] Input must be Uint8Array or Buffer.");const t=new Blob([n],{type:e});return createImageBitmap(t,{premultiplyAlpha:"none",colorSpaceConversion:"none"}).then(s=>{const i=new OffscreenCanvas(s.width,s.height).getContext("2d");i.drawImage(s,0,0);const o=i.getImageData(0,0,s.width,s.height);return Ir(new Uint8Array(o.data),[s.width,s.height,4],[4,4*s.width,1],0)})}async function kr(n,e){return Vr(n,e)}const Gr=0,Hr=0,zr=0,$r=2,Xr=0,qr=163,Kr=166,Wr=0,Yr=2,Jr=1,Zr=64,Qr=0;function ei(){return{vkFormat:Qr,typeSize:1,pixelWidth:0,pixelHeight:0,pixelDepth:0,layerCount:0,faceCount:1,levelCount:0,supercompressionScheme:Gr,levels:[],dataFormatDescriptor:[{vendorId:zr,descriptorType:Hr,versionNumber:$r,colorModel:Xr,colorPrimaries:Jr,transferFunction:Yr,flags:Wr,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],keyValue:{},globalData:null}}class tt{constructor(e,t,s,r){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,s),this._littleEndian=r,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),s=e+2**32*t;return this._offset+=8,s}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t=0){const s=this._offset;let r=0;for(;this._dataView.getUint8(this._offset)!==t&&r<e;)r++,this._offset++;return r<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+s,r)}}const Z=[171,75,84,88,32,50,48,187,13,10,26,10];function ls(n){return new TextDecoder().decode(n)}function Ut(n){const e=new Uint8Array(n.buffer,n.byteOffset,Z.length);if(e[0]!==Z[0]||e[1]!==Z[1]||e[2]!==Z[2]||e[3]!==Z[3]||e[4]!==Z[4]||e[5]!==Z[5]||e[6]!==Z[6]||e[7]!==Z[7]||e[8]!==Z[8]||e[9]!==Z[9]||e[10]!==Z[10]||e[11]!==Z[11])throw new Error("Missing KTX 2.0 identifier.");const t=ei(),s=17*Uint32Array.BYTES_PER_ELEMENT,r=new tt(n,Z.length,s,!0);t.vkFormat=r._nextUint32(),t.typeSize=r._nextUint32(),t.pixelWidth=r._nextUint32(),t.pixelHeight=r._nextUint32(),t.pixelDepth=r._nextUint32(),t.layerCount=r._nextUint32(),t.faceCount=r._nextUint32(),t.levelCount=r._nextUint32(),t.supercompressionScheme=r._nextUint32();const i=r._nextUint32(),o=r._nextUint32(),a=r._nextUint32(),c=r._nextUint32(),u=r._nextUint64(),h=r._nextUint64(),d=Math.max(t.levelCount,1)*3*8,f=new tt(n,Z.length+s,d,!0);for(let ee=0,se=Math.max(t.levelCount,1);ee<se;ee++)t.levels.push({levelData:new Uint8Array(n.buffer,n.byteOffset+f._nextUint64(),f._nextUint64()),uncompressedByteLength:f._nextUint64()});const l=new tt(n,i,o,!0);l._skip(4);const E=l._nextUint16(),_=l._nextUint16(),x=l._nextUint16(),p=l._nextUint16(),M=l._nextUint8(),I=l._nextUint8(),b=l._nextUint8(),T=l._nextUint8(),R=[l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8()],g=[l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8()],w={vendorId:E,descriptorType:_,versionNumber:x,colorModel:M,colorPrimaries:I,transferFunction:b,flags:T,texelBlockDimension:R,bytesPlane:g,samples:[]},N=(p/4-6)/4;for(let ee=0;ee<N;ee++){const se={bitOffset:l._nextUint16(),bitLength:l._nextUint8(),channelType:l._nextUint8(),samplePosition:[l._nextUint8(),l._nextUint8(),l._nextUint8(),l._nextUint8()],sampleLower:Number.NEGATIVE_INFINITY,sampleUpper:Number.POSITIVE_INFINITY};se.channelType&Zr?(se.sampleLower=l._nextInt32(),se.sampleUpper=l._nextInt32()):(se.sampleLower=l._nextUint32(),se.sampleUpper=l._nextUint32()),w.samples[ee]=se}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(w);const v=new tt(n,a,c,!0);for(;v._offset<c;){const ee=v._nextUint32(),se=v._scan(ee),bt=ls(se);if(t.keyValue[bt]=v._nextUint8Array(ee-se.byteLength-1),bt.match(/^ktx/i)){const In=ls(t.keyValue[bt]);t.keyValue[bt]=In.substring(0,In.lastIndexOf("\0"))}const la=ee%4?4-ee%4:0;v._skip(la)}if(h<=0)return t;const O=new tt(n,u,h,!0),D=O._nextUint16(),B=O._nextUint16(),P=O._nextUint32(),Q=O._nextUint32(),W=O._nextUint32(),$t=O._nextUint32(),Ke=[];for(let ee=0,se=Math.max(t.levelCount,1);ee<se;ee++)Ke.push({imageFlags:O._nextUint32(),rgbSliceByteOffset:O._nextUint32(),rgbSliceByteLength:O._nextUint32(),alphaSliceByteOffset:O._nextUint32(),alphaSliceByteLength:O._nextUint32()});const We=u+O._offset,wt=We+P,Be=wt+Q,Xt=Be+W,ct=new Uint8Array(n.buffer,n.byteOffset+We,P),ua=new Uint8Array(n.buffer,n.byteOffset+wt,Q),fa=new Uint8Array(n.buffer,n.byteOffset+Be,W),ha=new Uint8Array(n.buffer,n.byteOffset+Xt,$t);return t.globalData={endpointCount:D,selectorCount:B,imageDescs:Ke,endpointsData:ct,selectorsData:ua,tablesData:fa,extendedData:ha},t}const pe="EXT_mesh_gpu_instancing",q="EXT_meshopt_compression",st="EXT_texture_webp",nt="EXT_texture_avif",H="KHR_draco_mesh_compression",oe="KHR_lights_punctual",me="KHR_materials_anisotropy",Te="KHR_materials_clearcoat",xe="KHR_materials_diffuse_transmission",ye="KHR_materials_dispersion",Ee="KHR_materials_emissive_strength",Ie="KHR_materials_ior",Re="KHR_materials_iridescence",_e="KHR_materials_pbrSpecularGlossiness",we="KHR_materials_sheen",be="KHR_materials_specular",Ae="KHR_materials_transmission",De="KHR_materials_unlit",Ne="KHR_materials_volume",K="KHR_materials_variants",gs="KHR_mesh_quantization",rt="KHR_texture_basisu",Me="KHR_texture_transform",ae="KHR_xmp_json_ld",Lt="INSTANCE_ATTRIBUTE";class ds extends G{init(){this.extensionName=pe,this.propertyType="InstancedMesh",this.parentTypes=[m.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{attributes:new he})}getAttribute(e){return this.getRefMap("attributes",e)}setAttribute(e,t){return this.setRefMap("attributes",e,t,{usage:Lt})}listAttributes(){return this.listRefMapValues("attributes")}listSemantics(){return this.listRefMapKeys("attributes")}}ds.EXTENSION_NAME=pe;class ti extends k{constructor(...e){super(...e),this.extensionName=pe,this.provideTypes=[m.NODE],this.prewriteTypes=[m.ACCESSOR]}createInstancedMesh(){return new ds(this.document.getGraph())}read(e){return(e.jsonDoc.json.nodes||[]).forEach((r,i)=>{if(!r.extensions||!r.extensions[pe])return;const o=r.extensions[pe],a=this.createInstancedMesh();for(const c in o.attributes)a.setAttribute(c,e.accessors[o.attributes[c]]);e.nodes[i].setExtension(pe,a)}),this}prewrite(e){e.accessorUsageGroupedByParent.add(Lt);for(const t of this.properties)for(const s of t.listAttributes())e.addAccessorToUsageGroup(s,Lt);return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listNodes().forEach(s=>{const r=s.getExtension(pe);if(r){const i=e.nodeIndexMap.get(s),o=t.json.nodes[i],a={attributes:{}};r.listSemantics().forEach(c=>{const u=r.getAttribute(c);a.attributes[c]=e.accessorIndexMap.get(u)}),o.extensions=o.extensions||{},o.extensions[pe]=a}}),this}}ti.EXTENSION_NAME=pe;function Se(){return Se=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)({}).hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},Se.apply(null,arguments)}var it;(function(n){n.QUANTIZE="quantize",n.FILTER="filter"})(it||(it={}));var ze;(function(n){n.ATTRIBUTES="ATTRIBUTES",n.TRIANGLES="TRIANGLES",n.INDICES="INDICES"})(ze||(ze={}));var z;(function(n){n.NONE="NONE",n.OCTAHEDRAL="OCTAHEDRAL",n.QUATERNION="QUATERNION",n.EXPONENTIAL="EXPONENTIAL"})(z||(z={}));function si(n){return!n.extensions||!n.extensions[q]?!1:!!n.extensions[q].fallback}const{BYTE:ni,SHORT:ps,FLOAT:ri}=S.ComponentType,{encodeNormalizedInt:ms,decodeNormalizedInt:jt}=j;function ii(n,e,t,s){const{filter:r,bits:i}=s,o={array:n.getArray(),byteStride:n.getElementSize()*n.getComponentSize(),componentType:n.getComponentType(),normalized:n.getNormalized()};if(t!==ze.ATTRIBUTES)return o;if(r!==z.NONE){let a=n.getNormalized()?oi(n):new Float32Array(o.array);switch(r){case z.EXPONENTIAL:o.byteStride=n.getElementSize()*4,o.componentType=ri,o.normalized=!1,o.array=e.encodeFilterExp(a,n.getCount(),o.byteStride,i);break;case z.OCTAHEDRAL:o.byteStride=i>8?8:4,o.componentType=i>8?ps:ni,o.normalized=!0,a=n.getElementSize()===3?ci(a):a,o.array=e.encodeFilterOct(a,n.getCount(),o.byteStride,i);break;case z.QUATERNION:o.byteStride=8,o.componentType=ps,o.normalized=!0,o.array=e.encodeFilterQuat(a,n.getCount(),o.byteStride,i);break;default:throw new Error("Invalid filter.")}o.min=n.getMin([]),o.max=n.getMax([]),n.getNormalized()&&(o.min=o.min.map(c=>jt(c,n.getComponentType())),o.max=o.max.map(c=>jt(c,n.getComponentType()))),o.normalized&&(o.min=o.min.map(c=>ms(c,o.componentType)),o.max=o.max.map(c=>ms(c,o.componentType)))}else o.byteStride%4&&(o.array=ai(o.array,n.getElementSize()),o.byteStride=o.array.byteLength/n.getCount());return o}function oi(n){const e=n.getComponentType(),t=n.getArray(),s=new Float32Array(t.length);for(let r=0;r<t.length;r++)s[r]=jt(t[r],e);return s}function ai(n,e){const s=F.padNumber(n.BYTES_PER_ELEMENT*e)/n.BYTES_PER_ELEMENT,r=n.length/e,i=new n.constructor(r*s);for(let o=0;o*e<n.length;o++)for(let a=0;a<e;a++)i[o*s+a]=n[o*e+a];return i}function ci(n){const e=new Float32Array(n.length*4/3);for(let t=0,s=n.length/3;t<s;t++)e[t*4]=n[t*3],e[t*4+1]=n[t*3+1],e[t*4+2]=n[t*3+2];return e}function ui(n,e){return e===ge.BufferViewUsage.ELEMENT_ARRAY_BUFFER?n.listParents().some(s=>s instanceof ie&&s.getMode()===ie.Mode.TRIANGLES)?ze.TRIANGLES:ze.INDICES:ze.ATTRIBUTES}function fi(n,e){const t=e.getGraph().listParentEdges(n).filter(s=>!(s.getParent()instanceof Ft));for(const s of t){const r=s.getName(),i=s.getAttributes().key||"",o=s.getParent().propertyType===m.PRIMITIVE_TARGET;if(r==="indices")return{filter:z.NONE};if(r==="attributes"){if(i==="POSITION")return{filter:z.NONE};if(i==="TEXCOORD_0")return{filter:z.NONE};if(i.startsWith("JOINTS_"))return{filter:z.NONE};if(i.startsWith("WEIGHTS_"))return{filter:z.NONE};if(i==="NORMAL"||i==="TANGENT")return o?{filter:z.NONE}:{filter:z.OCTAHEDRAL,bits:8}}if(r==="output"){const a=Ts(n);return a==="rotation"?{filter:z.QUATERNION,bits:16}:a==="translation"?{filter:z.EXPONENTIAL,bits:12}:a==="scale"?{filter:z.EXPONENTIAL,bits:12}:{filter:z.NONE}}if(r==="input")return{filter:z.NONE};if(r==="inverseBindMatrices")return{filter:z.NONE}}return{filter:z.NONE}}function Ts(n){for(const e of n.listParents())if(e instanceof Ge){for(const t of e.listParents())if(t instanceof Ze)return t.getTargetPath()}return null}const xs={method:it.QUANTIZE};class ys extends k{constructor(...e){super(...e),this.extensionName=q,this.prereadTypes=[m.BUFFER,m.PRIMITIVE],this.prewriteTypes=[m.BUFFER,m.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=xs,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return e==="meshopt.decoder"&&(this._decoder=t),e==="meshopt.encoder"&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=Se({},xs,e),this}preread(e,t){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${q}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${q}]: Missing WASM support.`)}return t===m.BUFFER?this._prereadBuffers(e):t===m.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((r,i)=>{if(!r.extensions||!r.extensions[q])return;const o=r.extensions[q],a=o.byteOffset||0,c=o.byteLength||0,u=o.count,h=o.byteStride,d=new Uint8Array(u*h),f=t.json.buffers[o.buffer],l=f.uri?t.resources[f.uri]:t.resources[Ve],E=F.toView(l,a,c);this._decoder.decodeGltfBuffer(d,u,h,E,o.mode,o.filter),e.bufferViews[i]=d})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(r=>{if(!r.extensions||!r.extensions[q])return;const i=r.extensions[q],o=e.buffers[i.buffer],a=e.buffers[r.buffer],c=t.json.buffers[r.buffer];si(c)&&this._decoderFallbackBufferMap.set(a,o)})}read(e){if(!this.isRequired())return this;for(const[t,s]of this._decoderFallbackBufferMap){for(const r of t.listParents())r instanceof S&&r.swap(t,s);t.dispose()}return this}prewrite(e,t){return t===m.ACCESSOR?this._prewriteAccessors(e):t===m.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,s=this._encoder,r=this._encoderOptions,i=this.document.getGraph(),o=this.document.createBuffer(),a=this.document.getRoot().listBuffers().indexOf(o);let c=1;const u=new Map,h=d=>{for(const f of i.listParents(d)){if(f.propertyType===m.ROOT)continue;let l=u.get(d);return l===void 0&&u.set(d,l=c++),l}return-1};this._encoderFallbackBuffer=o,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const d of this.document.getRoot().listAccessors()){if(Ts(d)==="weights"||d.getSparse())continue;const f=e.getAccessorUsage(d),l=e.accessorUsageGroupedByParent.has(f)?h(d):null,E=ui(d,f),_=r.method===it.FILTER?fi(d,this.document):{filter:z.NONE},x=ii(d,s,E,_),{array:p,byteStride:M}=x,I=d.getBuffer();if(!I)throw new Error(`${q}: Missing buffer for accessor.`);const b=this.document.getRoot().listBuffers().indexOf(I),T=[f,l,E,_.filter,M,b].join(":");let R=this._encoderBufferViews[T],g=this._encoderBufferViewData[T],y=this._encoderBufferViewAccessors[T];(!R||!g)&&(y=this._encoderBufferViewAccessors[T]=[],g=this._encoderBufferViewData[T]=[],R=this._encoderBufferViews[T]={buffer:a,target:ge.USAGE_TO_TARGET[f],byteOffset:0,byteLength:0,byteStride:f===ge.BufferViewUsage.ARRAY_BUFFER?M:void 0,extensions:{[q]:{buffer:b,byteOffset:0,byteLength:0,mode:E,filter:_.filter!==z.NONE?_.filter:void 0,byteStride:M,count:0}}});const w=e.createAccessorDef(d);w.componentType=x.componentType,w.normalized=x.normalized,w.byteOffset=R.byteLength,w.min&&x.min&&(w.min=x.min),w.max&&x.max&&(w.max=x.max),e.accessorIndexMap.set(d,t.accessors.length),t.accessors.push(w),y.push(w),g.push(new Uint8Array(p.buffer,p.byteOffset,p.byteLength)),R.byteLength+=p.byteLength,R.extensions.EXT_meshopt_compression.count+=d.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const s in this._encoderBufferViews){const r=this._encoderBufferViews[s],i=this._encoderBufferViewData[s],o=this.document.getRoot().listBuffers()[r.extensions[q].buffer],a=e.otherBufferViews.get(o)||[],{count:c,byteStride:u,mode:h}=r.extensions[q],d=F.concat(i),f=t.encodeGltfBuffer(d,c,u,h),l=F.pad(f);r.extensions[q].byteLength=f.byteLength,i.length=0,i.push(l),a.push(l),e.otherBufferViews.set(o,a)}}write(e){let t=0;for(const o in this._encoderBufferViews){const a=this._encoderBufferViews[o],c=this._encoderBufferViewData[o][0],u=e.otherBufferViewsIndexMap.get(c),h=this._encoderBufferViewAccessors[o];for(const E of h)E.bufferView=u;const d=e.jsonDoc.json.bufferViews[u],f=d.byteOffset||0;Object.assign(d,a),d.byteOffset=t;const l=d.extensions[q];l.byteOffset=f,t+=F.padNumber(a.byteLength)}const s=this._encoderFallbackBuffer,r=e.bufferIndexMap.get(s),i=e.jsonDoc.json.buffers[r];return i.byteLength=t,i.extensions={[q]:{fallback:!0}},s.dispose(),this}}ys.EXTENSION_NAME=q,ys.EncoderMethod=it;class hi{match(e){return e.length>=12&&F.decodeText(e.slice(4,12))==="ftypavif"}getSize(e){if(!this.match(e))return null;const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let s=Es(t,0);if(!s)return null;let r=s.end;for(;s=Es(t,r);)if(s.type==="meta")r=s.start+4;else if(s.type==="iprp"||s.type==="ipco")r=s.start;else{if(s.type==="ispe")return[t.getUint32(s.start+4),t.getUint32(s.start+8)];if(s.type==="mdat")break;r=s.end}return null}getChannels(e){return 4}}class li extends k{constructor(...e){super(...e),this.extensionName=nt,this.prereadTypes=[m.TEXTURE]}static register(){le.registerFormat("image/avif",new hi)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(s=>{s.extensions&&s.extensions[nt]&&(s.source=s.extensions[nt].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(s=>{if(s.getMimeType()==="image/avif"){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach(o=>{o.source===r&&(o.extensions=o.extensions||{},o.extensions[nt]={source:o.source},delete o.source)})}}),this}}li.EXTENSION_NAME=nt;function Es(n,e){if(n.byteLength<4+e)return null;const t=n.getUint32(e);return n.byteLength<t+e||t<8?null:{type:F.decodeText(new Uint8Array(n.buffer,n.byteOffset+e+4,4)),start:e+8,end:e+t}}class gi{match(e){return e.length>=12&&e[8]===87&&e[9]===69&&e[10]===66&&e[11]===80}getSize(e){const t=F.decodeText(e.slice(0,4)),s=F.decodeText(e.slice(8,12));if(t!=="RIFF"||s!=="WEBP")return null;const r=new DataView(e.buffer,e.byteOffset);let i=12;for(;i<r.byteLength;){const o=F.decodeText(new Uint8Array([r.getUint8(i),r.getUint8(i+1),r.getUint8(i+2),r.getUint8(i+3)])),a=r.getUint32(i+4,!0);if(o==="VP8 "){const c=r.getInt16(i+14,!0)&16383,u=r.getInt16(i+16,!0)&16383;return[c,u]}else if(o==="VP8L"){const c=r.getUint8(i+9),u=r.getUint8(i+10),h=r.getUint8(i+11),d=r.getUint8(i+12),f=1+((u&63)<<8|c),l=1+((d&15)<<10|h<<2|(u&192)>>6);return[f,l]}i+=8+a+a%2}return null}getChannels(e){return 4}}class di extends k{constructor(...e){super(...e),this.extensionName=st,this.prereadTypes=[m.TEXTURE]}static register(){le.registerFormat("image/webp",new gi)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(s=>{s.extensions&&s.extensions[st]&&(s.source=s.extensions[st].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(s=>{if(s.getMimeType()==="image/webp"){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach(o=>{o.source===r&&(o.extensions=o.extensions||{},o.extensions[st]={source:o.source},delete o.source)})}}),this}}di.EXTENSION_NAME=st;let X,Is,Rs;function pi(n,e){const t=new X.DecoderBuffer;try{if(t.Init(e,e.length),n.GetEncodedGeometryType(t)!==X.TRIANGULAR_MESH)throw new Error(`[${H}] Unknown geometry type.`);const r=new X.Mesh;if(!n.DecodeBufferToMesh(t,r).ok()||r.ptr===0)throw new Error(`[${H}] Decoding failure.`);return r}finally{X.destroy(t)}}function mi(n,e){const s=e.num_faces()*3;let r,i;if(e.num_points()<=65534){const o=s*Uint16Array.BYTES_PER_ELEMENT;r=X._malloc(o),n.GetTrianglesUInt16Array(e,o,r),i=new Uint16Array(X.HEAPU16.buffer,r,s).slice()}else{const o=s*Uint32Array.BYTES_PER_ELEMENT;r=X._malloc(o),n.GetTrianglesUInt32Array(e,o,r),i=new Uint32Array(X.HEAPU32.buffer,r,s).slice()}return X._free(r),i}function Ti(n,e,t,s){const r=Rs[s.componentType],i=Is[s.componentType],o=t.num_components(),c=e.num_points()*o,u=c*i.BYTES_PER_ELEMENT,h=X._malloc(u);n.GetAttributeDataArrayForAllPoints(e,t,r,u,h);const d=new i(X.HEAPF32.buffer,h,c).slice();return X._free(h),d}function xi(n){X=n,Is={[S.ComponentType.FLOAT]:Float32Array,[S.ComponentType.UNSIGNED_INT]:Uint32Array,[S.ComponentType.UNSIGNED_SHORT]:Uint16Array,[S.ComponentType.UNSIGNED_BYTE]:Uint8Array,[S.ComponentType.SHORT]:Int16Array,[S.ComponentType.BYTE]:Int8Array},Rs={[S.ComponentType.FLOAT]:X.DT_FLOAT32,[S.ComponentType.UNSIGNED_INT]:X.DT_UINT32,[S.ComponentType.UNSIGNED_SHORT]:X.DT_UINT16,[S.ComponentType.UNSIGNED_BYTE]:X.DT_UINT8,[S.ComponentType.SHORT]:X.DT_INT16,[S.ComponentType.BYTE]:X.DT_INT8}}let ce;var ot;(function(n){n[n.EDGEBREAKER=1]="EDGEBREAKER",n[n.SEQUENTIAL=0]="SEQUENTIAL"})(ot||(ot={}));var ue;(function(n){n.POSITION="POSITION",n.NORMAL="NORMAL",n.COLOR="COLOR",n.TEX_COORD="TEX_COORD",n.GENERIC="GENERIC"})(ue||(ue={}));const _s={[ue.POSITION]:14,[ue.NORMAL]:10,[ue.COLOR]:8,[ue.TEX_COORD]:12,[ue.GENERIC]:12},ws={decodeSpeed:5,encodeSpeed:5,method:ot.EDGEBREAKER,quantizationBits:_s,quantizationVolume:"mesh"};function yi(n){ce=n}function Ei(n,e=ws){const t=Se({},ws,e);t.quantizationBits=Se({},_s,e.quantizationBits);const s=new ce.MeshBuilder,r=new ce.Mesh,i=new ce.ExpertEncoder(r),o={},a=new ce.DracoInt8Array,c=n.listTargets().length>0;let u=!1;for(const _ of n.listSemantics()){const x=n.getAttribute(_);if(x.getSparse()){u=!0;continue}const p=Ii(_),M=Ri(s,x.getComponentType(),r,ce[p],x.getCount(),x.getElementSize(),x.getArray());if(M===-1)throw new Error(`Error compressing "${_}" attribute.`);if(o[_]=M,t.quantizationVolume==="mesh"||_!=="POSITION")i.SetAttributeQuantization(M,t.quantizationBits[p]);else if(typeof t.quantizationVolume=="object"){const{quantizationVolume:I}=t,b=Math.max(I.max[0]-I.min[0],I.max[1]-I.min[1],I.max[2]-I.min[2]);i.SetAttributeExplicitQuantization(M,t.quantizationBits[p],x.getElementSize(),I.min,b)}else throw new Error("Invalid quantization volume state.")}const h=n.getIndices();if(!h)throw new Pt("Primitive must have indices.");s.AddFacesToMesh(r,h.getCount()/3,h.getArray()),i.SetSpeedOptions(t.encodeSpeed,t.decodeSpeed),i.SetTrackEncodedProperties(!0),t.method===ot.SEQUENTIAL||c||u?i.SetEncodingMethod(ce.MESH_SEQUENTIAL_ENCODING):i.SetEncodingMethod(ce.MESH_EDGEBREAKER_ENCODING);const d=i.EncodeToDracoBuffer(!(c||u),a);if(d<=0)throw new Pt("Error applying Draco compression.");const f=new Uint8Array(d);for(let _=0;_<d;++_)f[_]=a.GetValue(_);const l=i.GetNumberOfEncodedPoints(),E=i.GetNumberOfEncodedFaces()*3;return ce.destroy(a),ce.destroy(r),ce.destroy(s),ce.destroy(i),{numVertices:l,numIndices:E,data:f,attributeIDs:o}}function Ii(n){return n==="POSITION"?ue.POSITION:n==="NORMAL"?ue.NORMAL:n.startsWith("COLOR_")?ue.COLOR:n.startsWith("TEXCOORD_")?ue.TEX_COORD:ue.GENERIC}function Ri(n,e,t,s,r,i,o){switch(e){case S.ComponentType.UNSIGNED_BYTE:return n.AddUInt8Attribute(t,s,r,i,o);case S.ComponentType.BYTE:return n.AddInt8Attribute(t,s,r,i,o);case S.ComponentType.UNSIGNED_SHORT:return n.AddUInt16Attribute(t,s,r,i,o);case S.ComponentType.SHORT:return n.AddInt16Attribute(t,s,r,i,o);case S.ComponentType.UNSIGNED_INT:return n.AddUInt32Attribute(t,s,r,i,o);case S.ComponentType.FLOAT:return n.AddFloatAttribute(t,s,r,i,o);default:throw new Error(`Unexpected component type, "${e}".`)}}class Pt extends Error{}class bs extends k{constructor(...e){super(...e),this.extensionName=H,this.prereadTypes=[m.PRIMITIVE],this.prewriteTypes=[m.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return e==="draco3d.decoder"&&(this._decoderModule=t,xi(this._decoderModule)),e==="draco3d.encoder"&&(this._encoderModule=t,yi(this._encoderModule)),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${H}] Please install extension dependency, "draco3d.decoder".`);const t=this.document.getLogger(),s=e.jsonDoc,r=new Map;try{const i=s.json.meshes||[];for(const o of i)for(const a of o.primitives){if(!a.extensions||!a.extensions[H])continue;const c=a.extensions[H];let[u,h]=r.get(c.bufferView)||[];if(!h||!u){const d=s.json.bufferViews[c.bufferView],f=s.json.buffers[d.buffer],l=f.uri?s.resources[f.uri]:s.resources[Ve],E=d.byteOffset||0,_=d.byteLength,x=F.toView(l,E,_);u=new this._decoderModule.Decoder,h=pi(u,x),r.set(c.bufferView,[u,h]),t.debug(`[${H}] Decompressed ${x.byteLength} bytes.`)}for(const d in c.attributes){const f=e.jsonDoc.json.accessors[a.attributes[d]],l=u.GetAttributeByUniqueId(h,c.attributes[d]),E=Ti(u,h,l,f);e.accessors[a.attributes[d]].setArray(E)}a.indices!==void 0&&e.accessors[a.indices].setArray(mi(u,h))}}finally{for(const[i,o]of Array.from(r.values()))this._decoderModule.destroy(i),this._decoderModule.destroy(o)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${H}] Please install extension dependency, "draco3d.encoder".`);const s=this.document.getLogger();s.debug(`[${H}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const r=_i(this.document),i=new Map;let o="mesh";this._encoderOptions.quantizationVolume==="scene"&&(this.document.getRoot().listScenes().length!==1?s.warn(`[${H}]: quantizationVolume=scene requires exactly 1 scene.`):o=Mn(this.document.getRoot().listScenes().pop()));for(const a of Array.from(r.keys())){const c=r.get(a);if(!c)throw new Error("Unexpected primitive.");if(i.has(c)){i.set(c,i.get(c));continue}const u=a.getIndices(),h=e.jsonDoc.json.accessors;let d;try{d=Ei(a,Se({},this._encoderOptions,{quantizationVolume:o}))}catch(E){if(E instanceof Pt){s.warn(`[${H}]: ${E.message} Skipping primitive compression.`);continue}throw E}i.set(c,d);const f=e.createAccessorDef(u);f.count=d.numIndices,e.accessorIndexMap.set(u,h.length),h.push(f),d.numVertices>65534&&S.getComponentSize(f.componentType)<=2?f.componentType=S.ComponentType.UNSIGNED_INT:d.numVertices>254&&S.getComponentSize(f.componentType)<=1&&(f.componentType=S.ComponentType.UNSIGNED_SHORT);for(const E of a.listSemantics()){const _=a.getAttribute(E);if(d.attributeIDs[E]===void 0)continue;const x=e.createAccessorDef(_);x.count=d.numVertices,e.accessorIndexMap.set(_,h.length),h.push(x)}const l=a.getAttribute("POSITION").getBuffer()||this.document.getRoot().listBuffers()[0];e.otherBufferViews.has(l)||e.otherBufferViews.set(l,[]),e.otherBufferViews.get(l).push(d.data)}return s.debug(`[${H}] Compressed ${r.size} primitives.`),e.extensionData[H]={primitiveHashMap:r,primitiveEncodingMap:i},this}write(e){const t=e.extensionData[H];for(const s of this.document.getRoot().listMeshes()){const r=e.jsonDoc.json.meshes[e.meshIndexMap.get(s)];for(let i=0;i<s.listPrimitives().length;i++){const o=s.listPrimitives()[i],a=r.primitives[i],c=t.primitiveHashMap.get(o);if(!c)continue;const u=t.primitiveEncodingMap.get(c);u&&(a.extensions=a.extensions||{},a.extensions[H]={bufferView:e.otherBufferViewsIndexMap.get(u.data),attributes:u.attributeIDs})}}if(!t.primitiveHashMap.size){const s=e.jsonDoc.json;s.extensionsUsed=(s.extensionsUsed||[]).filter(r=>r!==H),s.extensionsRequired=(s.extensionsRequired||[]).filter(r=>r!==H)}return this}}bs.EXTENSION_NAME=H,bs.EncoderMethod=ot;function _i(n){const e=n.getLogger(),t=new Set,s=new Set;let r=0,i=0;for(const d of n.getRoot().listMeshes())for(const f of d.listPrimitives())f.getIndices()?f.getMode()!==ie.Mode.TRIANGLES?(s.add(f),i++):t.add(f):(s.add(f),r++);r>0&&e.warn(`[${H}] Skipping Draco compression of ${r} non-indexed primitives.`),i>0&&e.warn(`[${H}] Skipping Draco compression of ${i} non-TRIANGLES primitives.`);const o=n.getRoot().listAccessors(),a=new Map;for(let d=0;d<o.length;d++)a.set(o[d],d);const c=new Map,u=new Set,h=new Map;for(const d of Array.from(t)){let f=As(d,a);if(u.has(f)){h.set(d,f);continue}if(c.has(d.getIndices())){const l=d.getIndices(),E=l.clone();a.set(E,n.getRoot().listAccessors().length-1),d.swap(l,E)}for(const l of d.listAttributes())if(c.has(l)){const E=l.clone();a.set(E,n.getRoot().listAccessors().length-1),d.swap(l,E)}f=As(d,a),u.add(f),h.set(d,f),c.set(d.getIndices(),f);for(const l of d.listAttributes())c.set(l,f)}for(const d of Array.from(c.keys())){const f=new Set(d.listParents().map(l=>l.propertyType));if(f.size!==2||!f.has(m.PRIMITIVE)||!f.has(m.ROOT))throw new Error(`[${H}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const d of Array.from(t)){const f=h.get(d),l=d.getIndices();if(c.get(l)!==f||d.listAttributes().some(E=>c.get(E)!==f))throw new Error(`[${H}] Draco primitives must share all, or no, accessors.`)}for(const d of Array.from(s)){const f=d.getIndices();if(c.has(f)||d.listAttributes().some(l=>c.has(l)))throw new Error(`[${H}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return h}function As(n,e){const t=[],s=n.getIndices();t.push(e.get(s));for(const r of n.listAttributes())t.push(e.get(r));return t.sort().join("|")}class $e extends G{init(){this.extensionName=oe,this.propertyType="Light",this.parentTypes=[m.NODE]}getDefaults(){return Object.assign(super.getDefaults(),{color:[1,1,1],intensity:1,type:$e.Type.POINT,range:null,innerConeAngle:0,outerConeAngle:Math.PI/4})}getColor(){return this.get("color")}setColor(e){return this.set("color",e)}getIntensity(){return this.get("intensity")}setIntensity(e){return this.set("intensity",e)}getType(){return this.get("type")}setType(e){return this.set("type",e)}getRange(){return this.get("range")}setRange(e){return this.set("range",e)}getInnerConeAngle(){return this.get("innerConeAngle")}setInnerConeAngle(e){return this.set("innerConeAngle",e)}getOuterConeAngle(){return this.get("outerConeAngle")}setOuterConeAngle(e){return this.set("outerConeAngle",e)}}$e.EXTENSION_NAME=oe,$e.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};class wi extends k{constructor(...e){super(...e),this.extensionName=oe}createLight(e=""){return new $e(this.document.getGraph(),e)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[oe])return this;const i=(t.json.extensions[oe].lights||[]).map(o=>{var a,c;const u=this.createLight().setName(o.name||"").setType(o.type);return o.color!==void 0&&u.setColor(o.color),o.intensity!==void 0&&u.setIntensity(o.intensity),o.range!==void 0&&u.setRange(o.range),((a=o.spot)==null?void 0:a.innerConeAngle)!==void 0&&u.setInnerConeAngle(o.spot.innerConeAngle),((c=o.spot)==null?void 0:c.outerConeAngle)!==void 0&&u.setOuterConeAngle(o.spot.outerConeAngle),u});return t.json.nodes.forEach((o,a)=>{if(!o.extensions||!o.extensions[oe])return;const c=o.extensions[oe];e.nodes[a].setExtension(oe,i[c.light])}),this}write(e){const t=e.jsonDoc;if(this.properties.size===0)return this;const s=[],r=new Map;for(const i of this.properties){const o=i,a={type:o.getType()};j.eq(o.getColor(),[1,1,1])||(a.color=o.getColor()),o.getIntensity()!==1&&(a.intensity=o.getIntensity()),o.getRange()!=null&&(a.range=o.getRange()),o.getName()&&(a.name=o.getName()),o.getType()===$e.Type.SPOT&&(a.spot={innerConeAngle:o.getInnerConeAngle(),outerConeAngle:o.getOuterConeAngle()}),s.push(a),r.set(o,s.length-1)}return this.document.getRoot().listNodes().forEach(i=>{const o=i.getExtension(oe);if(o){const a=e.nodeIndexMap.get(i),c=t.json.nodes[a];c.extensions=c.extensions||{},c.extensions[oe]={light:r.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[oe]={lights:s},this}}wi.EXTENSION_NAME=oe;const{R:bi,G:Ai,B:Ni}=ne;class Ns extends G{init(){this.extensionName=me,this.propertyType="Anisotropy",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{anisotropyStrength:0,anisotropyRotation:0,anisotropyTexture:null,anisotropyTextureInfo:new L(this.graph,"anisotropyTextureInfo")})}getAnisotropyStrength(){return this.get("anisotropyStrength")}setAnisotropyStrength(e){return this.set("anisotropyStrength",e)}getAnisotropyRotation(){return this.get("anisotropyRotation")}setAnisotropyRotation(e){return this.set("anisotropyRotation",e)}getAnisotropyTexture(){return this.getRef("anisotropyTexture")}getAnisotropyTextureInfo(){return this.getRef("anisotropyTexture")?this.getRef("anisotropyTextureInfo"):null}setAnisotropyTexture(e){return this.setRef("anisotropyTexture",e,{channels:bi|Ai|Ni})}}Ns.EXTENSION_NAME=me;class Mi extends k{constructor(...e){super(...e),this.extensionName=me,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createAnisotropy(){return new Ns(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[me]){const a=this.createAnisotropy();e.materials[o].setExtension(me,a);const c=i.extensions[me];if(c.anisotropyStrength!==void 0&&a.setAnisotropyStrength(c.anisotropyStrength),c.anisotropyRotation!==void 0&&a.setAnisotropyRotation(c.anisotropyRotation),c.anisotropyTexture!==void 0){const u=c.anisotropyTexture,h=e.textures[r[u.index].source];a.setAnisotropyTexture(h),e.setTextureInfo(a.getAnisotropyTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(me);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[me]={};if(r.getAnisotropyStrength()>0&&(a.anisotropyStrength=r.getAnisotropyStrength()),r.getAnisotropyRotation()!==0&&(a.anisotropyRotation=r.getAnisotropyRotation()),r.getAnisotropyTexture()){const c=r.getAnisotropyTexture(),u=r.getAnisotropyTextureInfo();a.anisotropyTexture=e.createTextureInfoDef(c,u)}}}),this}}Mi.EXTENSION_NAME=me;const{R:Ms,G:Ss,B:Si}=ne;class vs extends G{init(){this.extensionName=Te,this.propertyType="Clearcoat",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{clearcoatFactor:0,clearcoatTexture:null,clearcoatTextureInfo:new L(this.graph,"clearcoatTextureInfo"),clearcoatRoughnessFactor:0,clearcoatRoughnessTexture:null,clearcoatRoughnessTextureInfo:new L(this.graph,"clearcoatRoughnessTextureInfo"),clearcoatNormalScale:1,clearcoatNormalTexture:null,clearcoatNormalTextureInfo:new L(this.graph,"clearcoatNormalTextureInfo")})}getClearcoatFactor(){return this.get("clearcoatFactor")}setClearcoatFactor(e){return this.set("clearcoatFactor",e)}getClearcoatTexture(){return this.getRef("clearcoatTexture")}getClearcoatTextureInfo(){return this.getRef("clearcoatTexture")?this.getRef("clearcoatTextureInfo"):null}setClearcoatTexture(e){return this.setRef("clearcoatTexture",e,{channels:Ms})}getClearcoatRoughnessFactor(){return this.get("clearcoatRoughnessFactor")}setClearcoatRoughnessFactor(e){return this.set("clearcoatRoughnessFactor",e)}getClearcoatRoughnessTexture(){return this.getRef("clearcoatRoughnessTexture")}getClearcoatRoughnessTextureInfo(){return this.getRef("clearcoatRoughnessTexture")?this.getRef("clearcoatRoughnessTextureInfo"):null}setClearcoatRoughnessTexture(e){return this.setRef("clearcoatRoughnessTexture",e,{channels:Ss})}getClearcoatNormalScale(){return this.get("clearcoatNormalScale")}setClearcoatNormalScale(e){return this.set("clearcoatNormalScale",e)}getClearcoatNormalTexture(){return this.getRef("clearcoatNormalTexture")}getClearcoatNormalTextureInfo(){return this.getRef("clearcoatNormalTexture")?this.getRef("clearcoatNormalTextureInfo"):null}setClearcoatNormalTexture(e){return this.setRef("clearcoatNormalTexture",e,{channels:Ms|Ss|Si})}}vs.EXTENSION_NAME=Te;class vi extends k{constructor(...e){super(...e),this.extensionName=Te,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createClearcoat(){return new vs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[Te]){const a=this.createClearcoat();e.materials[o].setExtension(Te,a);const c=i.extensions[Te];if(c.clearcoatFactor!==void 0&&a.setClearcoatFactor(c.clearcoatFactor),c.clearcoatRoughnessFactor!==void 0&&a.setClearcoatRoughnessFactor(c.clearcoatRoughnessFactor),c.clearcoatTexture!==void 0){const u=c.clearcoatTexture,h=e.textures[r[u.index].source];a.setClearcoatTexture(h),e.setTextureInfo(a.getClearcoatTextureInfo(),u)}if(c.clearcoatRoughnessTexture!==void 0){const u=c.clearcoatRoughnessTexture,h=e.textures[r[u.index].source];a.setClearcoatRoughnessTexture(h),e.setTextureInfo(a.getClearcoatRoughnessTextureInfo(),u)}if(c.clearcoatNormalTexture!==void 0){const u=c.clearcoatNormalTexture,h=e.textures[r[u.index].source];a.setClearcoatNormalTexture(h),e.setTextureInfo(a.getClearcoatNormalTextureInfo(),u),u.scale!==void 0&&a.setClearcoatNormalScale(u.scale)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Te);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Te]={clearcoatFactor:r.getClearcoatFactor(),clearcoatRoughnessFactor:r.getClearcoatRoughnessFactor()};if(r.getClearcoatTexture()){const c=r.getClearcoatTexture(),u=r.getClearcoatTextureInfo();a.clearcoatTexture=e.createTextureInfoDef(c,u)}if(r.getClearcoatRoughnessTexture()){const c=r.getClearcoatRoughnessTexture(),u=r.getClearcoatRoughnessTextureInfo();a.clearcoatRoughnessTexture=e.createTextureInfoDef(c,u)}if(r.getClearcoatNormalTexture()){const c=r.getClearcoatNormalTexture(),u=r.getClearcoatNormalTextureInfo();a.clearcoatNormalTexture=e.createTextureInfoDef(c,u),r.getClearcoatNormalScale()!==1&&(a.clearcoatNormalTexture.scale=r.getClearcoatNormalScale())}}}),this}}vi.EXTENSION_NAME=Te;const{R:Ci,G:Oi,B:Di,A:Fi}=ne;class Cs extends G{init(){this.extensionName=xe,this.propertyType="DiffuseTransmission",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseTransmissionFactor:0,diffuseTransmissionTexture:null,diffuseTransmissionTextureInfo:new L(this.graph,"diffuseTransmissionTextureInfo"),diffuseTransmissionColorFactor:[1,1,1],diffuseTransmissionColorTexture:null,diffuseTransmissionColorTextureInfo:new L(this.graph,"diffuseTransmissionColorTextureInfo")})}getDiffuseTransmissionFactor(){return this.get("diffuseTransmissionFactor")}setDiffuseTransmissionFactor(e){return this.set("diffuseTransmissionFactor",e)}getDiffuseTransmissionTexture(){return this.getRef("diffuseTransmissionTexture")}getDiffuseTransmissionTextureInfo(){return this.getRef("diffuseTransmissionTexture")?this.getRef("diffuseTransmissionTextureInfo"):null}setDiffuseTransmissionTexture(e){return this.setRef("diffuseTransmissionTexture",e,{channels:Fi})}getDiffuseTransmissionColorFactor(){return this.get("diffuseTransmissionColorFactor")}setDiffuseTransmissionColorFactor(e){return this.set("diffuseTransmissionColorFactor",e)}getDiffuseTransmissionColorTexture(){return this.getRef("diffuseTransmissionColorTexture")}getDiffuseTransmissionColorTextureInfo(){return this.getRef("diffuseTransmissionColorTexture")?this.getRef("diffuseTransmissionColorTextureInfo"):null}setDiffuseTransmissionColorTexture(e){return this.setRef("diffuseTransmissionColorTexture",e,{channels:Ci|Oi|Di})}}Cs.EXTENSION_NAME=xe;class Bi extends k{constructor(...e){super(...e),this.extensionName=xe}createDiffuseTransmission(){return new Cs(this.document.getGraph())}read(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[xe]){const a=this.createDiffuseTransmission();e.materials[o].setExtension(xe,a);const c=i.extensions[xe];if(c.diffuseTransmissionFactor!==void 0&&a.setDiffuseTransmissionFactor(c.diffuseTransmissionFactor),c.diffuseTransmissionColorFactor!==void 0&&a.setDiffuseTransmissionColorFactor(c.diffuseTransmissionColorFactor),c.diffuseTransmissionTexture!==void 0){const u=c.diffuseTransmissionTexture,h=e.textures[r[u.index].source];a.setDiffuseTransmissionTexture(h),e.setTextureInfo(a.getDiffuseTransmissionTextureInfo(),u)}if(c.diffuseTransmissionColorTexture!==void 0){const u=c.diffuseTransmissionColorTexture,h=e.textures[r[u.index].source];a.setDiffuseTransmissionColorTexture(h),e.setTextureInfo(a.getDiffuseTransmissionColorTextureInfo(),u)}}}),this}write(e){const t=e.jsonDoc;for(const s of this.document.getRoot().listMaterials()){const r=s.getExtension(xe);if(!r)continue;const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[xe]={diffuseTransmissionFactor:r.getDiffuseTransmissionFactor(),diffuseTransmissionColorFactor:r.getDiffuseTransmissionColorFactor()};if(r.getDiffuseTransmissionTexture()){const c=r.getDiffuseTransmissionTexture(),u=r.getDiffuseTransmissionTextureInfo();a.diffuseTransmissionTexture=e.createTextureInfoDef(c,u)}if(r.getDiffuseTransmissionColorTexture()){const c=r.getDiffuseTransmissionColorTexture(),u=r.getDiffuseTransmissionColorTextureInfo();a.diffuseTransmissionColorTexture=e.createTextureInfoDef(c,u)}}return this}}Bi.EXTENSION_NAME=xe;class Os extends G{init(){this.extensionName=ye,this.propertyType="Dispersion",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{dispersion:0})}getDispersion(){return this.get("dispersion")}setDispersion(e){return this.set("dispersion",e)}}Os.EXTENSION_NAME=ye;class Ui extends k{constructor(...e){super(...e),this.extensionName=ye,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createDispersion(){return new Os(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((r,i)=>{if(r.extensions&&r.extensions[ye]){const o=this.createDispersion();e.materials[i].setExtension(ye,o);const a=r.extensions[ye];a.dispersion!==void 0&&o.setDispersion(a.dispersion)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(ye);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{},o.extensions[ye]={dispersion:r.getDispersion()}}}),this}}Ui.EXTENSION_NAME=ye;class Ds extends G{init(){this.extensionName=Ee,this.propertyType="EmissiveStrength",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{emissiveStrength:1})}getEmissiveStrength(){return this.get("emissiveStrength")}setEmissiveStrength(e){return this.set("emissiveStrength",e)}}Ds.EXTENSION_NAME=Ee;class Li extends k{constructor(...e){super(...e),this.extensionName=Ee,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createEmissiveStrength(){return new Ds(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((r,i)=>{if(r.extensions&&r.extensions[Ee]){const o=this.createEmissiveStrength();e.materials[i].setExtension(Ee,o);const a=r.extensions[Ee];a.emissiveStrength!==void 0&&o.setEmissiveStrength(a.emissiveStrength)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ee);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{},o.extensions[Ee]={emissiveStrength:r.getEmissiveStrength()}}}),this}}Li.EXTENSION_NAME=Ee;class Fs extends G{init(){this.extensionName=Ie,this.propertyType="IOR",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{ior:1.5})}getIOR(){return this.get("ior")}setIOR(e){return this.set("ior",e)}}Fs.EXTENSION_NAME=Ie;class ji extends k{constructor(...e){super(...e),this.extensionName=Ie,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createIOR(){return new Fs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((r,i)=>{if(r.extensions&&r.extensions[Ie]){const o=this.createIOR();e.materials[i].setExtension(Ie,o);const a=r.extensions[Ie];a.ior!==void 0&&o.setIOR(a.ior)}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ie);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{},o.extensions[Ie]={ior:r.getIOR()}}}),this}}ji.EXTENSION_NAME=Ie;const{R:Pi,G:Vi}=ne;class Bs extends G{init(){this.extensionName=Re,this.propertyType="Iridescence",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{iridescenceFactor:0,iridescenceTexture:null,iridescenceTextureInfo:new L(this.graph,"iridescenceTextureInfo"),iridescenceIOR:1.3,iridescenceThicknessMinimum:100,iridescenceThicknessMaximum:400,iridescenceThicknessTexture:null,iridescenceThicknessTextureInfo:new L(this.graph,"iridescenceThicknessTextureInfo")})}getIridescenceFactor(){return this.get("iridescenceFactor")}setIridescenceFactor(e){return this.set("iridescenceFactor",e)}getIridescenceTexture(){return this.getRef("iridescenceTexture")}getIridescenceTextureInfo(){return this.getRef("iridescenceTexture")?this.getRef("iridescenceTextureInfo"):null}setIridescenceTexture(e){return this.setRef("iridescenceTexture",e,{channels:Pi})}getIridescenceIOR(){return this.get("iridescenceIOR")}setIridescenceIOR(e){return this.set("iridescenceIOR",e)}getIridescenceThicknessMinimum(){return this.get("iridescenceThicknessMinimum")}setIridescenceThicknessMinimum(e){return this.set("iridescenceThicknessMinimum",e)}getIridescenceThicknessMaximum(){return this.get("iridescenceThicknessMaximum")}setIridescenceThicknessMaximum(e){return this.set("iridescenceThicknessMaximum",e)}getIridescenceThicknessTexture(){return this.getRef("iridescenceThicknessTexture")}getIridescenceThicknessTextureInfo(){return this.getRef("iridescenceThicknessTexture")?this.getRef("iridescenceThicknessTextureInfo"):null}setIridescenceThicknessTexture(e){return this.setRef("iridescenceThicknessTexture",e,{channels:Vi})}}Bs.EXTENSION_NAME=Re;class ki extends k{constructor(...e){super(...e),this.extensionName=Re,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createIridescence(){return new Bs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[Re]){const a=this.createIridescence();e.materials[o].setExtension(Re,a);const c=i.extensions[Re];if(c.iridescenceFactor!==void 0&&a.setIridescenceFactor(c.iridescenceFactor),c.iridescenceIor!==void 0&&a.setIridescenceIOR(c.iridescenceIor),c.iridescenceThicknessMinimum!==void 0&&a.setIridescenceThicknessMinimum(c.iridescenceThicknessMinimum),c.iridescenceThicknessMaximum!==void 0&&a.setIridescenceThicknessMaximum(c.iridescenceThicknessMaximum),c.iridescenceTexture!==void 0){const u=c.iridescenceTexture,h=e.textures[r[u.index].source];a.setIridescenceTexture(h),e.setTextureInfo(a.getIridescenceTextureInfo(),u)}if(c.iridescenceThicknessTexture!==void 0){const u=c.iridescenceThicknessTexture,h=e.textures[r[u.index].source];a.setIridescenceThicknessTexture(h),e.setTextureInfo(a.getIridescenceThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Re);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Re]={};if(r.getIridescenceFactor()>0&&(a.iridescenceFactor=r.getIridescenceFactor()),r.getIridescenceIOR()!==1.3&&(a.iridescenceIor=r.getIridescenceIOR()),r.getIridescenceThicknessMinimum()!==100&&(a.iridescenceThicknessMinimum=r.getIridescenceThicknessMinimum()),r.getIridescenceThicknessMaximum()!==400&&(a.iridescenceThicknessMaximum=r.getIridescenceThicknessMaximum()),r.getIridescenceTexture()){const c=r.getIridescenceTexture(),u=r.getIridescenceTextureInfo();a.iridescenceTexture=e.createTextureInfoDef(c,u)}if(r.getIridescenceThicknessTexture()){const c=r.getIridescenceThicknessTexture(),u=r.getIridescenceThicknessTextureInfo();a.iridescenceThicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}ki.EXTENSION_NAME=Re;const{R:Us,G:Ls,B:js,A:Ps}=ne;class Vs extends G{init(){this.extensionName=_e,this.propertyType="PBRSpecularGlossiness",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{diffuseFactor:[1,1,1,1],diffuseTexture:null,diffuseTextureInfo:new L(this.graph,"diffuseTextureInfo"),specularFactor:[1,1,1],glossinessFactor:1,specularGlossinessTexture:null,specularGlossinessTextureInfo:new L(this.graph,"specularGlossinessTextureInfo")})}getDiffuseFactor(){return this.get("diffuseFactor")}setDiffuseFactor(e){return this.set("diffuseFactor",e)}getDiffuseTexture(){return this.getRef("diffuseTexture")}getDiffuseTextureInfo(){return this.getRef("diffuseTexture")?this.getRef("diffuseTextureInfo"):null}setDiffuseTexture(e){return this.setRef("diffuseTexture",e,{channels:Us|Ls|js|Ps,isColor:!0})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getGlossinessFactor(){return this.get("glossinessFactor")}setGlossinessFactor(e){return this.set("glossinessFactor",e)}getSpecularGlossinessTexture(){return this.getRef("specularGlossinessTexture")}getSpecularGlossinessTextureInfo(){return this.getRef("specularGlossinessTexture")?this.getRef("specularGlossinessTextureInfo"):null}setSpecularGlossinessTexture(e){return this.setRef("specularGlossinessTexture",e,{channels:Us|Ls|js|Ps})}}Vs.EXTENSION_NAME=_e;class Gi extends k{constructor(...e){super(...e),this.extensionName=_e,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createPBRSpecularGlossiness(){return new Vs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[_e]){const a=this.createPBRSpecularGlossiness();e.materials[o].setExtension(_e,a);const c=i.extensions[_e];if(c.diffuseFactor!==void 0&&a.setDiffuseFactor(c.diffuseFactor),c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.glossinessFactor!==void 0&&a.setGlossinessFactor(c.glossinessFactor),c.diffuseTexture!==void 0){const u=c.diffuseTexture,h=e.textures[r[u.index].source];a.setDiffuseTexture(h),e.setTextureInfo(a.getDiffuseTextureInfo(),u)}if(c.specularGlossinessTexture!==void 0){const u=c.specularGlossinessTexture,h=e.textures[r[u.index].source];a.setSpecularGlossinessTexture(h),e.setTextureInfo(a.getSpecularGlossinessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(_e);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[_e]={diffuseFactor:r.getDiffuseFactor(),specularFactor:r.getSpecularFactor(),glossinessFactor:r.getGlossinessFactor()};if(r.getDiffuseTexture()){const c=r.getDiffuseTexture(),u=r.getDiffuseTextureInfo();a.diffuseTexture=e.createTextureInfoDef(c,u)}if(r.getSpecularGlossinessTexture()){const c=r.getSpecularGlossinessTexture(),u=r.getSpecularGlossinessTextureInfo();a.specularGlossinessTexture=e.createTextureInfoDef(c,u)}}}),this}}Gi.EXTENSION_NAME=_e;const{R:Hi,G:zi,B:$i,A:Xi}=ne;class ks extends G{init(){this.extensionName=we,this.propertyType="Sheen",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{sheenColorFactor:[0,0,0],sheenColorTexture:null,sheenColorTextureInfo:new L(this.graph,"sheenColorTextureInfo"),sheenRoughnessFactor:0,sheenRoughnessTexture:null,sheenRoughnessTextureInfo:new L(this.graph,"sheenRoughnessTextureInfo")})}getSheenColorFactor(){return this.get("sheenColorFactor")}setSheenColorFactor(e){return this.set("sheenColorFactor",e)}getSheenColorTexture(){return this.getRef("sheenColorTexture")}getSheenColorTextureInfo(){return this.getRef("sheenColorTexture")?this.getRef("sheenColorTextureInfo"):null}setSheenColorTexture(e){return this.setRef("sheenColorTexture",e,{channels:Hi|zi|$i,isColor:!0})}getSheenRoughnessFactor(){return this.get("sheenRoughnessFactor")}setSheenRoughnessFactor(e){return this.set("sheenRoughnessFactor",e)}getSheenRoughnessTexture(){return this.getRef("sheenRoughnessTexture")}getSheenRoughnessTextureInfo(){return this.getRef("sheenRoughnessTexture")?this.getRef("sheenRoughnessTextureInfo"):null}setSheenRoughnessTexture(e){return this.setRef("sheenRoughnessTexture",e,{channels:Xi})}}ks.EXTENSION_NAME=we;class qi extends k{constructor(...e){super(...e),this.extensionName=we,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createSheen(){return new ks(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[we]){const a=this.createSheen();e.materials[o].setExtension(we,a);const c=i.extensions[we];if(c.sheenColorFactor!==void 0&&a.setSheenColorFactor(c.sheenColorFactor),c.sheenRoughnessFactor!==void 0&&a.setSheenRoughnessFactor(c.sheenRoughnessFactor),c.sheenColorTexture!==void 0){const u=c.sheenColorTexture,h=e.textures[r[u.index].source];a.setSheenColorTexture(h),e.setTextureInfo(a.getSheenColorTextureInfo(),u)}if(c.sheenRoughnessTexture!==void 0){const u=c.sheenRoughnessTexture,h=e.textures[r[u.index].source];a.setSheenRoughnessTexture(h),e.setTextureInfo(a.getSheenRoughnessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(we);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[we]={sheenColorFactor:r.getSheenColorFactor(),sheenRoughnessFactor:r.getSheenRoughnessFactor()};if(r.getSheenColorTexture()){const c=r.getSheenColorTexture(),u=r.getSheenColorTextureInfo();a.sheenColorTexture=e.createTextureInfoDef(c,u)}if(r.getSheenRoughnessTexture()){const c=r.getSheenRoughnessTexture(),u=r.getSheenRoughnessTextureInfo();a.sheenRoughnessTexture=e.createTextureInfoDef(c,u)}}}),this}}qi.EXTENSION_NAME=we;const{R:Ki,G:Wi,B:Yi,A:Ji}=ne;class Gs extends G{init(){this.extensionName=be,this.propertyType="Specular",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{specularFactor:1,specularTexture:null,specularTextureInfo:new L(this.graph,"specularTextureInfo"),specularColorFactor:[1,1,1],specularColorTexture:null,specularColorTextureInfo:new L(this.graph,"specularColorTextureInfo")})}getSpecularFactor(){return this.get("specularFactor")}setSpecularFactor(e){return this.set("specularFactor",e)}getSpecularColorFactor(){return this.get("specularColorFactor")}setSpecularColorFactor(e){return this.set("specularColorFactor",e)}getSpecularTexture(){return this.getRef("specularTexture")}getSpecularTextureInfo(){return this.getRef("specularTexture")?this.getRef("specularTextureInfo"):null}setSpecularTexture(e){return this.setRef("specularTexture",e,{channels:Ji})}getSpecularColorTexture(){return this.getRef("specularColorTexture")}getSpecularColorTextureInfo(){return this.getRef("specularColorTexture")?this.getRef("specularColorTextureInfo"):null}setSpecularColorTexture(e){return this.setRef("specularColorTexture",e,{channels:Ki|Wi|Yi,isColor:!0})}}Gs.EXTENSION_NAME=be;class Zi extends k{constructor(...e){super(...e),this.extensionName=be,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createSpecular(){return new Gs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[be]){const a=this.createSpecular();e.materials[o].setExtension(be,a);const c=i.extensions[be];if(c.specularFactor!==void 0&&a.setSpecularFactor(c.specularFactor),c.specularColorFactor!==void 0&&a.setSpecularColorFactor(c.specularColorFactor),c.specularTexture!==void 0){const u=c.specularTexture,h=e.textures[r[u.index].source];a.setSpecularTexture(h),e.setTextureInfo(a.getSpecularTextureInfo(),u)}if(c.specularColorTexture!==void 0){const u=c.specularColorTexture,h=e.textures[r[u.index].source];a.setSpecularColorTexture(h),e.setTextureInfo(a.getSpecularColorTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(be);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[be]={};if(r.getSpecularFactor()!==1&&(a.specularFactor=r.getSpecularFactor()),j.eq(r.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=r.getSpecularColorFactor()),r.getSpecularTexture()){const c=r.getSpecularTexture(),u=r.getSpecularTextureInfo();a.specularTexture=e.createTextureInfoDef(c,u)}if(r.getSpecularColorTexture()){const c=r.getSpecularColorTexture(),u=r.getSpecularColorTextureInfo();a.specularColorTexture=e.createTextureInfoDef(c,u)}}}),this}}Zi.EXTENSION_NAME=be;const{R:Qi}=ne;class Hs extends G{init(){this.extensionName=Ae,this.propertyType="Transmission",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{transmissionFactor:0,transmissionTexture:null,transmissionTextureInfo:new L(this.graph,"transmissionTextureInfo")})}getTransmissionFactor(){return this.get("transmissionFactor")}setTransmissionFactor(e){return this.set("transmissionFactor",e)}getTransmissionTexture(){return this.getRef("transmissionTexture")}getTransmissionTextureInfo(){return this.getRef("transmissionTexture")?this.getRef("transmissionTextureInfo"):null}setTransmissionTexture(e){return this.setRef("transmissionTexture",e,{channels:Qi})}}Hs.EXTENSION_NAME=Ae;class eo extends k{constructor(...e){super(...e),this.extensionName=Ae,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createTransmission(){return new Hs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[Ae]){const a=this.createTransmission();e.materials[o].setExtension(Ae,a);const c=i.extensions[Ae];if(c.transmissionFactor!==void 0&&a.setTransmissionFactor(c.transmissionFactor),c.transmissionTexture!==void 0){const u=c.transmissionTexture,h=e.textures[r[u.index].source];a.setTransmissionTexture(h),e.setTextureInfo(a.getTransmissionTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ae);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Ae]={transmissionFactor:r.getTransmissionFactor()};if(r.getTransmissionTexture()){const c=r.getTransmissionTexture(),u=r.getTransmissionTextureInfo();a.transmissionTexture=e.createTextureInfoDef(c,u)}}}),this}}eo.EXTENSION_NAME=Ae;class zs extends G{init(){this.extensionName=De,this.propertyType="Unlit",this.parentTypes=[m.MATERIAL]}}zs.EXTENSION_NAME=De;class to extends k{constructor(...e){super(...e),this.extensionName=De,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createUnlit(){return new zs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){return(e.jsonDoc.json.materials||[]).forEach((s,r)=>{s.extensions&&s.extensions[De]&&e.materials[r].setExtension(De,this.createUnlit())}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{if(s.getExtension(De)){const r=e.materialIndexMap.get(s),i=t.json.materials[r];i.extensions=i.extensions||{},i.extensions[De]={}}}),this}}to.EXTENSION_NAME=De;class $s extends G{init(){this.extensionName=K,this.propertyType="Mapping",this.parentTypes=["MappingList"]}getDefaults(){return Object.assign(super.getDefaults(),{material:null,variants:new V})}getMaterial(){return this.getRef("material")}setMaterial(e){return this.setRef("material",e)}addVariant(e){return this.addRef("variants",e)}removeVariant(e){return this.removeRef("variants",e)}listVariants(){return this.listRefs("variants")}}$s.EXTENSION_NAME=K;class Xs extends G{init(){this.extensionName=K,this.propertyType="MappingList",this.parentTypes=[m.PRIMITIVE]}getDefaults(){return Object.assign(super.getDefaults(),{mappings:new V})}addMapping(e){return this.addRef("mappings",e)}removeMapping(e){return this.removeRef("mappings",e)}listMappings(){return this.listRefs("mappings")}}Xs.EXTENSION_NAME=K;class Vt extends G{init(){this.extensionName=K,this.propertyType="Variant",this.parentTypes=["MappingList"]}}Vt.EXTENSION_NAME=K;class so extends k{constructor(...e){super(...e),this.extensionName=K}createMappingList(){return new Xs(this.document.getGraph())}createVariant(e=""){return new Vt(this.document.getGraph(),e)}createMapping(){return new $s(this.document.getGraph())}listVariants(){return Array.from(this.properties).filter(e=>e instanceof Vt)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[K])return this;const i=(t.json.extensions[K].variants||[]).map(a=>this.createVariant().setName(a.name||""));return(t.json.meshes||[]).forEach((a,c)=>{const u=e.meshes[c];(a.primitives||[]).forEach((d,f)=>{if(!d.extensions||!d.extensions[K])return;const l=this.createMappingList(),E=d.extensions[K];for(const _ of E.mappings){const x=this.createMapping();_.material!==void 0&&x.setMaterial(e.materials[_.material]);for(const p of _.variants||[])x.addVariant(i[p]);l.addMapping(x)}u.listPrimitives()[f].setExtension(K,l)})}),this}write(e){const t=e.jsonDoc,s=this.listVariants();if(!s.length)return this;const r=[],i=new Map;for(const o of s)i.set(o,r.length),r.push(e.createPropertyDef(o));for(const o of this.document.getRoot().listMeshes()){const a=e.meshIndexMap.get(o);o.listPrimitives().forEach((c,u)=>{const h=c.getExtension(K);if(!h)return;const d=e.jsonDoc.json.meshes[a].primitives[u],f=h.listMappings().map(l=>{const E=e.createPropertyDef(l),_=l.getMaterial();return _&&(E.material=e.materialIndexMap.get(_)),E.variants=l.listVariants().map(x=>i.get(x)),E});d.extensions=d.extensions||{},d.extensions[K]={mappings:f}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[K]={variants:r},this}}so.EXTENSION_NAME=K;const{G:no}=ne;class qs extends G{init(){this.extensionName=Ne,this.propertyType="Volume",this.parentTypes=[m.MATERIAL]}getDefaults(){return Object.assign(super.getDefaults(),{thicknessFactor:0,thicknessTexture:null,thicknessTextureInfo:new L(this.graph,"thicknessTexture"),attenuationDistance:1/0,attenuationColor:[1,1,1]})}getThicknessFactor(){return this.get("thicknessFactor")}setThicknessFactor(e){return this.set("thicknessFactor",e)}getThicknessTexture(){return this.getRef("thicknessTexture")}getThicknessTextureInfo(){return this.getRef("thicknessTexture")?this.getRef("thicknessTextureInfo"):null}setThicknessTexture(e){return this.setRef("thicknessTexture",e,{channels:no})}getAttenuationDistance(){return this.get("attenuationDistance")}setAttenuationDistance(e){return this.set("attenuationDistance",e)}getAttenuationColor(){return this.get("attenuationColor")}setAttenuationColor(e){return this.set("attenuationColor",e)}}qs.EXTENSION_NAME=Ne;class ro extends k{constructor(...e){super(...e),this.extensionName=Ne,this.prereadTypes=[m.MESH],this.prewriteTypes=[m.MESH]}createVolume(){return new qs(this.document.getGraph())}read(e){return this}write(e){return this}preread(e){const t=e.jsonDoc,s=t.json.materials||[],r=t.json.textures||[];return s.forEach((i,o)=>{if(i.extensions&&i.extensions[Ne]){const a=this.createVolume();e.materials[o].setExtension(Ne,a);const c=i.extensions[Ne];if(c.thicknessFactor!==void 0&&a.setThicknessFactor(c.thicknessFactor),c.attenuationDistance!==void 0&&a.setAttenuationDistance(c.attenuationDistance),c.attenuationColor!==void 0&&a.setAttenuationColor(c.attenuationColor),c.thicknessTexture!==void 0){const u=c.thicknessTexture,h=e.textures[r[u.index].source];a.setThicknessTexture(h),e.setTextureInfo(a.getThicknessTextureInfo(),u)}}}),this}prewrite(e){const t=e.jsonDoc;return this.document.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Ne);if(r){const i=e.materialIndexMap.get(s),o=t.json.materials[i];o.extensions=o.extensions||{};const a=o.extensions[Ne]={};if(r.getThicknessFactor()>0&&(a.thicknessFactor=r.getThicknessFactor()),Number.isFinite(r.getAttenuationDistance())&&(a.attenuationDistance=r.getAttenuationDistance()),j.eq(r.getAttenuationColor(),[1,1,1])||(a.attenuationColor=r.getAttenuationColor()),r.getThicknessTexture()){const c=r.getThicknessTexture(),u=r.getThicknessTextureInfo();a.thicknessTexture=e.createTextureInfoDef(c,u)}}}),this}}ro.EXTENSION_NAME=Ne;class io extends k{constructor(...e){super(...e),this.extensionName=gs}read(e){return this}write(e){return this}}io.EXTENSION_NAME=gs;class oo{match(e){return e[0]===171&&e[1]===75&&e[2]===84&&e[3]===88&&e[4]===32&&e[5]===50&&e[6]===48&&e[7]===187&&e[8]===13&&e[9]===10&&e[10]===26&&e[11]===10}getSize(e){const t=Ut(e);return[t.pixelWidth,t.pixelHeight]}getChannels(e){const s=Ut(e).dataFormatDescriptor[0];if(s.colorModel===qr)return s.samples.length===2&&(s.samples[1].channelType&15)===15?4:3;if(s.colorModel===Kr)return(s.samples[0].channelType&15)===3?4:3;throw new Error(`Unexpected KTX2 colorModel, "${s.colorModel}".`)}getVRAMByteLength(e){const t=Ut(e),s=this.getChannels(e)>3;let r=0;for(let i=0;i<t.levels.length;i++){const o=t.levels[i];if(o.uncompressedByteLength)r+=o.uncompressedByteLength;else{const a=Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,i))),c=Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,i))),u=s?16:8;r+=a/4*(c/4)*u}}return r}}class ao extends k{constructor(...e){super(...e),this.extensionName=rt,this.prereadTypes=[m.TEXTURE]}static register(){le.registerFormat("image/ktx2",new oo)}preread(e){return e.jsonDoc.json.textures.forEach(t=>{if(t.extensions&&t.extensions[rt]){const s=t.extensions[rt];t.source=s.source}}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.document.getRoot().listTextures().forEach(s=>{if(s.getMimeType()==="image/ktx2"){const r=e.imageIndexMap.get(s);t.json.textures.forEach(i=>{i.source===r&&(i.extensions=i.extensions||{},i.extensions[rt]={source:i.source},delete i.source)})}}),this}}ao.EXTENSION_NAME=rt;class Ks extends G{init(){this.extensionName=Me,this.propertyType="Transform",this.parentTypes=[m.TEXTURE_INFO]}getDefaults(){return Object.assign(super.getDefaults(),{offset:[0,0],rotation:0,scale:[1,1],texCoord:null})}getOffset(){return this.get("offset")}setOffset(e){return this.set("offset",e)}getRotation(){return this.get("rotation")}setRotation(e){return this.set("rotation",e)}getScale(){return this.get("scale")}setScale(e){return this.set("scale",e)}getTexCoord(){return this.get("texCoord")}setTexCoord(e){return this.set("texCoord",e)}}Ks.EXTENSION_NAME=Me;class Ws extends k{constructor(...e){super(...e),this.extensionName=Me}createTransform(){return new Ks(this.document.getGraph())}read(e){for(const[t,s]of Array.from(e.textureInfos.entries())){if(!s.extensions||!s.extensions[Me])continue;const r=this.createTransform(),i=s.extensions[Me];i.offset!==void 0&&r.setOffset(i.offset),i.rotation!==void 0&&r.setRotation(i.rotation),i.scale!==void 0&&r.setScale(i.scale),i.texCoord!==void 0&&r.setTexCoord(i.texCoord),t.setExtension(Me,r)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[s,r]of t){const i=s.getExtension(Me);if(!i)continue;r.extensions=r.extensions||{};const o={},a=j.eq;a(i.getOffset(),[0,0])||(o.offset=i.getOffset()),i.getRotation()!==0&&(o.rotation=i.getRotation()),a(i.getScale(),[1,1])||(o.scale=i.getScale()),i.getTexCoord()!=null&&(o.texCoord=i.getTexCoord()),r.extensions[Me]=o}return this}}Ws.EXTENSION_NAME=Me;const co=[m.ROOT,m.SCENE,m.NODE,m.MESH,m.MATERIAL,m.TEXTURE,m.ANIMATION];class Ys extends G{init(){this.extensionName=ae,this.propertyType="Packet",this.parentTypes=co}getDefaults(){return Object.assign(super.getDefaults(),{context:{},properties:{}})}getContext(){return this.get("context")}setContext(e){return this.set("context",Se({},e))}listProperties(){return Object.keys(this.get("properties"))}getProperty(e){const t=this.get("properties");return e in t?t[e]:null}setProperty(e,t){this._assertContext(e);const s=Se({},this.get("properties"));return t?s[e]=t:delete s[e],this.set("properties",s)}toJSONLD(){const e=kt(this.get("context")),t=kt(this.get("properties"));return Se({"@context":e},t)}fromJSONLD(e){e=kt(e);const t=e["@context"];return t&&this.set("context",t),delete e["@context"],this.set("properties",e)}_assertContext(e){if(!(e.split(":")[0]in this.get("context")))throw new Error(`${ae}: Missing context for term, "${e}".`)}}Ys.EXTENSION_NAME=ae;function kt(n){return JSON.parse(JSON.stringify(n))}class uo extends k{constructor(...e){super(...e),this.extensionName=ae}createPacket(){return new Ys(this.document.getGraph())}listPackets(){return Array.from(this.properties)}read(e){var t;const s=(t=e.jsonDoc.json.extensions)==null?void 0:t[ae];if(!s||!s.packets)return this;const r=e.jsonDoc.json,i=this.document.getRoot(),o=s.packets.map(u=>this.createPacket().fromJSONLD(u)),a=[[r.asset],r.scenes,r.nodes,r.meshes,r.materials,r.images,r.animations],c=[[i],i.listScenes(),i.listNodes(),i.listMeshes(),i.listMaterials(),i.listTextures(),i.listAnimations()];for(let u=0;u<a.length;u++){const h=a[u]||[];for(let d=0;d<h.length;d++){const f=h[d];if(f.extensions&&f.extensions[ae]){const l=f.extensions[ae];c[u][d].setExtension(ae,o[l.packet])}}}return this}write(e){const{json:t}=e.jsonDoc,s=[];for(const r of this.properties){s.push(r.toJSONLD());for(const i of r.listParents()){let o;switch(i.propertyType){case m.ROOT:o=t.asset;break;case m.SCENE:o=t.scenes[e.sceneIndexMap.get(i)];break;case m.NODE:o=t.nodes[e.nodeIndexMap.get(i)];break;case m.MESH:o=t.meshes[e.meshIndexMap.get(i)];break;case m.MATERIAL:o=t.materials[e.materialIndexMap.get(i)];break;case m.TEXTURE:o=t.images[e.imageIndexMap.get(i)];break;case m.ANIMATION:o=t.animations[e.animationIndexMap.get(i)];break;default:o=null,this.document.getLogger().warn(`[${ae}]: Unsupported parent property, "${i.propertyType}"`);break}o&&(o.extensions=o.extensions||{},o.extensions[ae]={packet:s.length-1})}}return s.length>0&&(t.extensions=t.extensions||{},t.extensions[ae]={packets:s}),this}}uo.EXTENSION_NAME=ae;function Et(){return Et=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var s in t)({}).hasOwnProperty.call(t,s)&&(n[s]=t[s])}return n},Et.apply(null,arguments)}const{POINTS:ga,LINES:da,LINE_STRIP:pa,LINE_LOOP:ma,TRIANGLES:Ta,TRIANGLE_STRIP:xa,TRIANGLE_FAN:ya}=ie.Mode;function Js(n,e){return Object.defineProperty(e,"name",{value:n}),e}function fo(n,e){const t=Et({},n);for(const s in e)e[s]!==void 0&&(t[s]=e[s]);return t}function Zs(n){for(const e in n)return!1;return!0}var It=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var Qs;(function(n){n.RENDER="render",n.RENDER_CACHED="render-cached",n.UPLOAD="upload",n.UPLOAD_NAIVE="upload-naive",n.DISTINCT="distinct",n.DISTINCT_POSITION="distinct-position",n.UNUSED="unused"})(Qs||(Qs={}));function ho(){var n=new It(3);return It!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function lo(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n}var go=lo;(function(){var n=ho();return function(e,t,s,r,i,o){var a,c;for(t||(t=3),s||(s=0),r?c=Math.min(r*t+s,e.length):c=e.length,a=s;a<c;a+=t)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],i(n,n,o),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2];return e}})();const{FLOAT:Ea}=S.ComponentType,{LINES:Ia,LINE_STRIP:Ra,LINE_LOOP:_a,TRIANGLES:wa,TRIANGLE_STRIP:ba,TRIANGLE_FAN:Aa}=ie.Mode;m.ACCESSOR,m.MESH,m.TEXTURE,m.MATERIAL,m.SKIN;const{TEXTURE_INFO:en,ROOT:Na}=m;function po(n,e,t){t||(t=tn(n,e));for(const s of e.getRoot().listExtensionsUsed()){const r=n.createExtension(s.constructor);s.isRequired()&&r.setRequired(!0)}return mo(n,e,To(e),t)}function mo(n,e,t,s){s||(s=tn(n,e));const r=new Map;for(const i of t)!r.has(i)&&i.propertyType!==en&&r.set(i,s(i));for(const[i,o]of r.entries())o.copy(i,s);return r}function tn(n,e){const t=new Map([[e.getRoot(),n.getRoot()]]);return s=>{if(s.propertyType===en)return s;let r=t.get(s);if(!r){const i=s.constructor;r=new i(n.getGraph()),t.set(s,r)}return r}}function To(n){const e=new Set;for(const t of n.getGraph().listEdges())e.add(t.getChild());return Array.from(e)}function sn(){var n=new It(4);return It!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function xo(n,e,t){return n[0]=e[0]+t[0],n[1]=e[1]+t[1],n[2]=e[2]+t[2],n[3]=e[3]+t[3],n}function yo(n,e,t){return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n[2]=e[2]-t[2],n[3]=e[3]-t[3],n}function Eo(n,e,t){return n[0]=e[0]*t[0],n[1]=e[1]*t[1],n[2]=e[2]*t[2],n[3]=e[3]*t[3],n}function Io(n,e,t){return n[0]=e[0]*t,n[1]=e[1]*t,n[2]=e[2]*t,n[3]=e[3]*t,n}function Ro(n){var e=n[0],t=n[1],s=n[2],r=n[3];return Math.hypot(e,t,s,r)}var nn=yo,_o=Eo,rn=Ro;(function(){var n=sn();return function(e,t,s,r,i,o){var a,c;for(t||(t=4),s||(s=0),r?c=Math.min(r*t+s,e.length):c=e.length,a=s;a<c;a+=t)n[0]=e[a],n[1]=e[a+1],n[2]=e[a+2],n[3]=e[a+3],i(n,n,o),e[a]=n[0],e[a+1]=n[1],e[a+2]=n[2],e[a+3]=n[3];return e}})();const wo=/color|emissive|diffuse/i;function bo(n){return n.getGraph().listParentEdges(n).some(r=>r.getAttributes().isColor||wo.test(r.getName()))?"srgb":null}function Ao(n){const e=n.getGraph(),t=new Set,s=new Set;function r(i){const o=new Set;for(const a of e.listChildEdges(i))a.getChild()instanceof Qe&&o.add(a.getName()+"Info");for(const a of e.listChildEdges(i)){const c=a.getChild();t.has(c)||(t.add(c),c instanceof L&&o.has(a.getName())?s.add(c):c instanceof G&&r(c))}}return r(n),Array.from(s)}function No(n){const t=He.fromGraph(n.getGraph()).getRoot(),s=n.getGraph().listParentEdges(n).filter(r=>r.getParent()!==t).map(r=>r.getName());return Array.from(new Set(s))}const Xe="prune",Gt=3/255,on={propertyTypes:[m.NODE,m.SKIN,m.MESH,m.CAMERA,m.PRIMITIVE,m.PRIMITIVE_TARGET,m.ANIMATION,m.MATERIAL,m.TEXTURE,m.ACCESSOR,m.BUFFER],keepLeaves:!1,keepAttributes:!1,keepIndices:!1,keepSolidTextures:!1,keepExtras:!1};function Mo(n=on){const e=fo(on,n),t=new Set(e.propertyTypes),s=e.keepExtras;return Js(Xe,async r=>{const i=r.getLogger(),o=r.getRoot(),a=r.getGraph(),c=new So,u=h=>c.dispose(h.target);if(a.addEventListener("node:dispose",u),t.has(m.MESH))for(const h of o.listMeshes())h.listPrimitives().length>0||h.dispose();if(t.has(m.NODE)){if(!e.keepLeaves)for(const h of o.listScenes())cn(a,h,s);for(const h of o.listNodes())fe(h,s)}if(t.has(m.SKIN))for(const h of o.listSkins())fe(h,s);if(t.has(m.MESH))for(const h of o.listMeshes())fe(h,s);if(t.has(m.CAMERA))for(const h of o.listCameras())fe(h,s);if(t.has(m.PRIMITIVE)&&an(a,m.PRIMITIVE,s),t.has(m.PRIMITIVE_TARGET)&&an(a,m.PRIMITIVE_TARGET,s),!e.keepAttributes&&t.has(m.ACCESSOR)){const h=new Map;for(const d of o.listMeshes())for(const f of d.listPrimitives()){const l=f.getMaterial();if(!l)continue;const E=fn(r,f,l),_=vo(f,E);un(f,_),f.listTargets().forEach(x=>un(x,_)),h.has(l)?h.get(l).add(f):h.set(l,new Set([f]))}for(const[d,f]of h)Co(d,Array.from(f))}if(t.has(m.ANIMATION))for(const h of o.listAnimations()){for(const d of h.listChannels())d.getTargetNode()||d.dispose();if(h.listChannels().length)h.listSamplers().forEach(d=>fe(d,s));else{const d=h.listSamplers();fe(h,s),d.forEach(f=>fe(f,s))}}if(t.has(m.MATERIAL)&&o.listMaterials().forEach(h=>fe(h,s)),t.has(m.TEXTURE)&&(o.listTextures().forEach(h=>fe(h,s)),e.keepSolidTextures||await Oo(r)),t.has(m.ACCESSOR)&&o.listAccessors().forEach(h=>fe(h,s)),t.has(m.BUFFER)&&o.listBuffers().forEach(h=>fe(h,s)),a.removeEventListener("node:dispose",u),c.empty())i.debug(`${Xe}: No unused properties found.`);else{const h=c.entries().map(([d,f])=>`${d} (${f})`).join(", ");i.info(`${Xe}: Removed types... ${h}`)}i.debug(`${Xe}: Complete.`)})}class So{constructor(){this.disposed={}}empty(){for(const e in this.disposed)return!1;return!0}entries(){return Object.entries(this.disposed)}dispose(e){this.disposed[e.propertyType]=this.disposed[e.propertyType]||0,this.disposed[e.propertyType]++}}function fe(n,e){const t=n.listParents().filter(r=>!(r instanceof Ft||r instanceof Ze)),s=e&&!Zs(n.getExtras());!t.length&&!s&&n.dispose()}function an(n,e,t){for(const s of n.listEdges()){const r=s.getParent();r.propertyType===e&&fe(r,t)}}function cn(n,e,t){if(e.listChildren().forEach(o=>cn(n,o,t)),e instanceof Dt)return;const s=n.listParentEdges(e).some(o=>{const a=o.getParent().propertyType;return a!==m.ROOT&&a!==m.SCENE&&a!==m.NODE}),r=n.listChildren(e).length===0,i=t&&!Zs(e.getExtras());r&&!s&&!i&&e.dispose()}function un(n,e){for(const t of e)n.setAttribute(t,null)}function vo(n,e){const t=[];for(const s of n.listSemantics())(s==="NORMAL"&&!e.has(s)||s==="TANGENT"&&!e.has(s)||s.startsWith("TEXCOORD_")&&!e.has(s)||s.startsWith("COLOR_")&&s!=="COLOR_0")&&t.push(s);return t}function fn(n,e,t,s=new Set){const i=n.getGraph().listChildEdges(t),o=new Set;for(const u of i)u.getChild()instanceof Qe&&o.add(u.getName());for(const u of i){const h=u.getName(),d=u.getChild();d instanceof L&&o.has(h.replace(/Info$/,""))&&s.add(`TEXCOORD_${d.getTexCoord()}`),d instanceof Qe&&h.match(/normalTexture/i)&&s.add("TANGENT"),d instanceof G&&fn(n,e,d,s)}const a=t instanceof de&&!t.getExtension("KHR_materials_unlit"),c=e.getMode()===ie.Mode.POINTS;return a&&!c&&s.add("NORMAL"),s}function Co(n,e){const t=Ao(n),s=new Set(t.map(c=>c.getTexCoord())),r=Array.from(s).sort(),i=new Map(r.map((c,u)=>[c,u])),o=new Map(r.map((c,u)=>[`TEXCOORD_${c}`,`TEXCOORD_${u}`]));for(const c of t){const u=c.getTexCoord();c.setTexCoord(i.get(u))}for(const c of e){const u=c.listSemantics().filter(h=>h.startsWith("TEXCOORD_")).sort();a(c,u),c.listTargets().forEach(h=>a(h,u))}function a(c,u){for(const h of u){const d=c.getAttribute(h);if(!d)continue;const f=o.get(h);f!==h&&(c.setAttribute(f,d),c.setAttribute(h,null))}}}async function Oo(n){const e=n.getRoot(),t=n.getGraph(),s=n.getLogger(),i=e.listTextures().map(async o=>{var a;const c=await Fo(o);if(!c)return;bo(o)==="srgb"&&_n.convertSRGBToLinear(c,c);const u=o.getName()||o.getURI(),h=(a=o.getSize())==null?void 0:a.join("x"),d=No(o);for(const f of t.listParentEdges(o)){const l=f.getParent();l!==e&&Do(l,c,f.getName(),s)&&f.dispose()}o.listParents().length===1&&(o.dispose(),s.debug(`${Xe}: Removed solid-color texture "${u}" (${h}px ${d.join(", ")})`))});await Promise.all(i)}function Do(n,e,t,s){if(n instanceof de)switch(t){case"baseColorTexture":return n.setBaseColorFactor(_o(e,e,n.getBaseColorFactor())),!0;case"emissiveTexture":return n.setEmissiveFactor(go([0,0,0],e.slice(0,3),n.getEmissiveFactor())),!0;case"occlusionTexture":return Math.abs(e[0]-1)<=Gt;case"metallicRoughnessTexture":return n.setRoughnessFactor(e[1]*n.getRoughnessFactor()),n.setMetallicFactor(e[2]*n.getMetallicFactor()),!0;case"normalTexture":return rn(nn(sn(),e,[.5,.5,1,1]))<=Gt}return s.warn(`${Xe}: Detected single-color ${t} texture. Pruning ${t} not yet supported.`),!1}async function Fo(n){const e=await Bo(n);if(!e)return null;const t=[1/0,1/0,1/0,1/0],s=[-1/0,-1/0,-1/0,-1/0],r=[0,0,0,0],[i,o]=e.shape;for(let a=0;a<i;a++){for(let c=0;c<o;c++)for(let u=0;u<4;u++)t[u]=Math.min(t[u],e.get(a,c,u)),s[u]=Math.max(s[u],e.get(a,c,u));if(rn(nn(r,s,t))/255>Gt)return null}return Io(r,xo(r,s,t),.5/255)}async function Bo(n){try{return await kr(n.getImage(),n.getMimeType())}catch{return null}}const{LINE_STRIP:Ma,LINE_LOOP:Sa,TRIANGLE_STRIP:va,TRIANGLE_FAN:Ca}=ie.Mode,{ROOT:Oa,NODE:Da,MESH:Fa,PRIMITIVE:Ba,ACCESSOR:Ua}=m,{TRANSLATION:La,ROTATION:ja,SCALE:Pa,WEIGHTS:Va}=Ze.TargetPath;Et({level:"high"},{pattern:/.*/,quantizationVolume:"mesh",quantizePosition:14,quantizeNormal:10,quantizeTexcoord:12,quantizeColor:8,quantizeWeight:8,quantizeGeneric:12,normalizeWeights:!0,cleanup:!0});var hn;(function(n){n[n.STEP=0]="STEP",n[n.LERP=1]="LERP",n[n.SLERP=2]="SLERP"})(hn||(hn={})),Promise.resolve();const{POINTS:Ga,LINES:Ha,LINE_STRIP:za,LINE_LOOP:$a,TRIANGLES:Xa,TRIANGLE_STRIP:qa,TRIANGLE_FAN:Ka}=ie.Mode;var Ht;(function(n){n.LANCZOS3="lanczos3",n.LANCZOS2="lanczos2"})(Ht||(Ht={})),Ht.LANCZOS3;const ln="unpartition",Uo={};function Lo(n=Uo){return Js(ln,async e=>{const t=e.getLogger(),s=e.getRoot().listBuffers()[0];e.getRoot().listAccessors().forEach(r=>r.setBuffer(s)),e.getRoot().listBuffers().forEach((r,i)=>i>0?r.dispose():null),t.debug(`${ln}: Complete.`)})}class ${constructor(e=0,t=0,s=0,r=0,i=!1,o=void 0){this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=e,this._height=t,this._x=s,this._y=r,this._data={},this._rot=i,this._allowRotation=o}static Collide(e,t){return e.collide(t)}static Contain(e,t){return e.contain(t)}area(){return this.width*this.height}collide(e){return e.x<this.x+this.width&&e.x+e.width>this.x&&e.y<this.y+this.height&&e.y+e.height>this.y}contain(e){return e.x>=this.x&&e.y>=this.y&&e.x+e.width<=this.x+this.width&&e.y+e.height<=this.y+this.height}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._dirty++)}get height(){return this._height}set height(e){e!==this._height&&(this._height=e,this._dirty++)}get x(){return this._x}set x(e){e!==this._x&&(this._x=e,this._dirty++)}get y(){return this._y}set y(e){e!==this._y&&(this._y=e,this._dirty++)}get rot(){return this._rot}set rot(e){if(this._allowRotation!==!1&&this._rot!==e){const t=this.width;this.width=this.height,this.height=t,this._rot=e,this._dirty++}}get allowRotation(){return this._allowRotation}set allowRotation(e){this._allowRotation!==e&&(this._allowRotation=e,this._dirty++)}get data(){return this._data}set data(e){e===null||e===this._data||(this._data=e,typeof e=="object"&&e.hasOwnProperty("allowRotation")&&(this._allowRotation=e.allowRotation),this._dirty++)}get dirty(){return this._dirty>0}setDirty(e=!0){this._dirty=e?this._dirty+1:0}}class gn{constructor(){this._dirty=0}get dirty(){return this._dirty>0||this.rects.some(e=>e.dirty)}setDirty(e=!0){if(this._dirty=e?this._dirty+1:0,!e)for(let t of this.rects)t.setDirty&&t.setDirty(!1)}}class qe extends gn{constructor(e=Rt,t=Rt,s=0,r={}){super(),this.maxWidth=e,this.maxHeight=t,this.padding=s,this.freeRects=[],this.rects=[],this.verticalExpand=!1,this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:Fe.MAX_EDGE},this.options=Object.assign(Object.assign({},this.options),r),this.width=this.options.smart?0:e,this.height=this.options.smart?0:t,this.border=this.options.border?this.options.border:0,this.freeRects.push(new $(this.maxWidth+this.padding-this.border*2,this.maxHeight+this.padding-this.border*2,this.border,this.border)),this.stage=new $(this.width,this.height)}add(...e){let t,s;if(e.length===1){if(typeof e[0]!="object")throw new Error("MacrectsBin.add(): Wrong parameters");s=e[0];let i=s.data&&s.data.tag?s.data.tag:s.tag?s.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==i)return}else{if(t=e.length>2?e[2]:null,this.options.tag&&this.options.exclusiveTag&&(t&&this.tag!==t.tag||!t&&this.tag))return;s=new $(e[0],e[1]),s.data=t,s.setDirty(!1)}const r=this.place(s);return r&&this.rects.push(r),r}repack(){let e=[];this.reset(),this.rects.sort((t,s)=>{const r=Math.max(s.width,s.height)-Math.max(t.width,t.height);return r===0&&t.hash&&s.hash?t.hash>s.hash?-1:1:r});for(let t of this.rects)this.place(t)||e.push(t);for(let t of e)this.rects.splice(this.rects.indexOf(t),1);return e.length>0?e:void 0}reset(e=!1,t=!1){e&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],t&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new $(this.maxWidth+this.padding-this.border*2,this.maxHeight+this.padding-this.border*2,this.border,this.border)],this.stage=new $(this.width,this.height),this._dirty=0}clone(){let e=new qe(this.maxWidth,this.maxHeight,this.padding,this.options);for(let t of this.rects)e.add(t);return e}place(e){let t=e.data&&e.data.tag?e.data.tag:e.tag?e.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==t)return;let s,r;if(e.hasOwnProperty("_allowRotation")&&e.allowRotation!==void 0?r=e.allowRotation:r=this.options.allowRotation,s=this.findNode(e.width+this.padding,e.height+this.padding,r),s){this.updateBinSize(s);let i=this.freeRects.length,o=0;for(;o<i;)this.splitNode(this.freeRects[o],s)&&(this.freeRects.splice(o,1),i--,o--),o++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,e.x=s.x,e.y=s.y,e.rot===void 0&&(e.rot=!1),e.rot=s.rot?!e.rot:e.rot,this._dirty++,e}else if(this.verticalExpand){if(this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(e)}else if(this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new $(e.width+this.padding,e.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(e)}findNode(e,t,s){let r=Number.MAX_VALUE,i,o,a;for(let c in this.freeRects)o=this.freeRects[c],o.width>=e&&o.height>=t&&(i=this.options.logic===Fe.MAX_AREA?o.width*o.height-e*t:Math.min(o.width-e,o.height-t),i<r&&(a=new $(e,t,o.x,o.y),r=i)),s&&o.width>=t&&o.height>=e&&(i=this.options.logic===Fe.MAX_AREA?o.width*o.height-t*e:Math.min(o.height-e,o.width-t),i<r&&(a=new $(t,e,o.x,o.y,!0),r=i));return a}splitNode(e,t){if(!e.collide(t))return!1;if(t.x<e.x+e.width&&t.x+t.width>e.x){if(t.y>e.y&&t.y<e.y+e.height){let s=new $(e.width,t.y-e.y,e.x,e.y);this.freeRects.push(s)}if(t.y+t.height<e.y+e.height){let s=new $(e.width,e.y+e.height-(t.y+t.height),e.x,t.y+t.height);this.freeRects.push(s)}}if(t.y<e.y+e.height&&t.y+t.height>e.y){if(t.x>e.x&&t.x<e.x+e.width){let s=new $(t.x-e.x,e.height,e.x,e.y);this.freeRects.push(s)}if(t.x+t.width<e.x+e.width){let s=new $(e.x+e.width-(t.x+t.width),e.height,t.x+t.width,e.y);this.freeRects.push(s)}}return!0}pruneFreeList(){let e=0,t=0,s=this.freeRects.length;for(;e<s;){t=e+1;let r=this.freeRects[e];for(;t<s;){let i=this.freeRects[t];if(i.contain(r)){this.freeRects.splice(e,1),e--,s--;break}r.contain(i)&&(this.freeRects.splice(t,1),t--,s--),t++}e++}}updateBinSize(e){if(!this.options.smart||this.stage.contain(e))return!1;let t=Math.max(this.width,e.x+e.width-this.padding+this.border),s=Math.max(this.height,e.y+e.height-this.padding+this.border);if(this.options.allowRotation){const r=Math.max(this.width,e.x+e.height-this.padding+this.border),i=Math.max(this.height,e.y+e.width-this.padding+this.border);r*i<t*s&&(t=r,s=i)}return this.options.pot&&(t=Math.pow(2,Math.ceil(Math.log(t)*Math.LOG2E)),s=Math.pow(2,Math.ceil(Math.log(s)*Math.LOG2E))),this.options.square&&(t=s=Math.max(t,s)),t>this.maxWidth+this.padding||s>this.maxHeight+this.padding?!1:(this.expandFreeRects(t+this.padding,s+this.padding),this.width=this.stage.width=t,this.height=this.stage.height=s,!0)}expandFreeRects(e,t){this.freeRects.forEach((s,r)=>{s.x+s.width>=Math.min(this.width+this.padding-this.border,e)&&(s.width=e-s.x-this.border),s.y+s.height>=Math.min(this.height+this.padding-this.border,t)&&(s.height=t-s.y-this.border)},this),this.freeRects.push(new $(e-this.width-this.padding,t-this.border*2,this.width+this.padding-this.border,this.border)),this.freeRects.push(new $(e-this.border*2,t-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter(s=>!(s.width<=0||s.height<=0||s.x<this.border||s.y<this.border)),this.pruneFreeList()}}class at extends gn{constructor(...e){if(super(),this.rects=[],e.length===1){if(typeof e[0]!="object")throw new Error("OversizedElementBin: Wrong parameters");const t=e[0];this.rects=[t],this.width=t.width,this.height=t.height,this.data=t.data,t.oversized=!0}else{this.width=e[0],this.height=e[1],this.data=e.length>2?e[2]:null;const t=new $(this.width,this.height);t.oversized=!0,t.data=this.data,this.rects.push(t)}this.freeRects=[],this.maxWidth=this.width,this.maxHeight=this.height,this.options={smart:!1,pot:!1,square:!1}}add(){}reset(e=!1){}repack(){}clone(){return new at(this.rects[0])}}const Rt=4096;var Fe;(function(n){n[n.MAX_AREA=0]="MAX_AREA",n[n.MAX_EDGE=1]="MAX_EDGE"})(Fe||(Fe={}));class jo{constructor(e=Rt,t=Rt,s=0,r={}){this.width=e,this.height=t,this.padding=s,this.options={smart:!0,pot:!0,square:!1,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:Fe.MAX_EDGE},this._currentBinIndex=0,this.bins=[],this.options=Object.assign(Object.assign({},this.options),r)}add(...e){if(e.length===1){if(typeof e[0]!="object")throw new Error("MacrectsPacker.add(): Wrong parameters");const t=e[0];if(t.width>this.width||t.height>this.height)this.bins.push(new at(t));else if(!this.bins.slice(this._currentBinIndex).find(r=>r.add(t)!==void 0)){let r=new qe(this.width,this.height,this.padding,this.options),i=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;this.options.tag&&i&&(r.tag=i),r.add(t),this.bins.push(r)}return t}else{const t=new $(e[0],e[1]);if(e.length>2&&(t.data=e[2]),t.width>this.width||t.height>this.height)this.bins.push(new at(t));else if(!this.bins.slice(this._currentBinIndex).find(r=>r.add(t)!==void 0)){let r=new qe(this.width,this.height,this.padding,this.options);this.options.tag&&t.data.tag&&(r.tag=t.data.tag),r.add(t),this.bins.push(r)}return t}}addArray(e){if(!this.options.tag||this.options.exclusiveTag)this.sort(e,this.options.logic).forEach(t=>this.add(t));else{if(e.length===0)return;e.sort((i,o)=>{const a=i.data&&i.data.tag?i.data.tag:i.tag?i.tag:void 0,c=o.data&&o.data.tag?o.data.tag:o.tag?o.tag:void 0;return c===void 0?-1:a===void 0?1:c>a?-1:1});let t,s=0;if(!this.bins.slice(this._currentBinIndex).find((i,o)=>{let a=i.clone();for(let c=s;c<e.length;c++){const u=e[c],h=u.data&&u.data.tag?u.data.tag:u.tag?u.tag:void 0;if(c===0&&(t=h),h!==t)return t=h,this.sort(e.slice(s,c),this.options.logic).forEach(d=>i.add(d)),s=c,this.addArray(e.slice(c)),!0;if(h===void 0)return this.sort(e.slice(c),this.options.logic).forEach(d=>this.add(d)),s=e.length,!0;if(a.add(u)===void 0)return this.sort(e.slice(s,c),this.options.logic).forEach(d=>i.add(d)),s=c,!1}return this.sort(e.slice(s),this.options.logic).forEach(c=>i.add(c)),!0})){const i=e[s],o=new qe(this.width,this.height,this.padding,this.options),a=i.data&&i.data.tag?i.data.tag:i.tag?i.tag:void 0;this.options.tag&&this.options.exclusiveTag&&a&&(o.tag=a),this.bins.push(o),o.add(i),s++,this.addArray(e.slice(s))}}}reset(){this.bins=[],this._currentBinIndex=0}repack(e=!0){if(e){let s=[];for(let r of this.bins)if(r.dirty){let i=r.repack();i&&s.push(...i)}this.addArray(s);return}if(!this.dirty)return;const t=this.rects;this.reset(),this.addArray(t)}next(){return this._currentBinIndex=this.bins.length,this._currentBinIndex}load(e){e.forEach((t,s)=>{if(t.maxWidth>this.width||t.maxHeight>this.height)this.bins.push(new at(t.width,t.height,{}));else{let r=new qe(this.width,this.height,this.padding,t.options);r.freeRects.splice(0),t.freeRects.forEach((i,o)=>{r.freeRects.push(new $(i.width,i.height,i.x,i.y))}),r.width=t.width,r.height=t.height,t.tag&&(r.tag=t.tag),this.bins[s]=r}},this)}save(){let e=[];return this.bins.forEach(t=>{let s={width:t.width,height:t.height,maxWidth:t.maxWidth,maxHeight:t.maxHeight,freeRects:[],rects:[],options:t.options};t.tag&&(s=Object.assign(Object.assign({},s),{tag:t.tag})),t.freeRects.forEach(r=>{s.freeRects.push({x:r.x,y:r.y,width:r.width,height:r.height})}),e.push(s)}),e}sort(e,t=Fe.MAX_EDGE){return e.slice().sort((s,r)=>{const i=t===Fe.MAX_EDGE?Math.max(r.width,r.height)-Math.max(s.width,s.height):r.width*r.height-s.width*s.height;return i===0&&s.hash&&r.hash?s.hash>r.hash?-1:1:i})}get currentBinIndex(){return this._currentBinIndex}get dirty(){return this.bins.some(e=>e.dirty)}get rects(){let e=[];for(let t of this.bins)e.push(...t.rects);return e}}self.onmessage=async n=>{const{files:e=[],opts:t={}}=n.data||{};if(!e.length){dn("No files provided");return}try{const s=await Promise.all(e.map(async f=>new Uint8Array(await f.arrayBuffer()))),r=new or().registerExtensions([Ws]),i=[];for(let f=0;f<s.length;f++)try{const l=await r.readBinary(s[f]);l&&i.push(l)}catch(l){throw new Error(`Failed to read GLB at index ${f}: ${l.message||l}`)}if(!i.length)throw new Error("No GLB documents could be read.");const o=i.findIndex(f=>!f||typeof f.getRoot!="function");if(o!==-1)throw new Error(`Document at index ${o} is invalid (missing getRoot)`);const a=i[0];try{for(let f=1;f<i.length;f++)po(a,i[f])}catch(f){throw new Error(`Failed to merge documents: ${f.message||f}`)}const{layoutInfo:c,atlasTextures:u}=await ko(a,t);await Yo(a,u),oa(a),await a.transform(Lo()),await ra(a),await a.transform(Mo());const h=await r.writeBinary(a),d=Vo(h);self.postMessage({glb:d,layout:c})}catch(s){dn(Po(s))}};function dn(n){self.postMessage({error:n})}function Po(n){if(!n)return"Unknown error";if(n instanceof Error){const e=n.constructor?.name||"Error",t=n.stack?` | stack: ${n.stack}`:"";return`[${e}] ${n.message}${t}`}return String(n)}function Vo(n){const e=new Uint8Array(n);let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return btoa(t)}async function ko(n,e){const t=["basecolor","normal","orm","emissive"],s=[],r={};let i=null;for(const o of t){const a=await Ho(n,o,e,i);a&&(s.push(a.layoutInfo),r[o]=a.atlasTexRefs[a.atlasTexRefs.length-1],i||(i={rects:a.rects,size:a.size}))}return{layoutInfo:s,atlasTextures:r}}function Go(n){const e={basecolor:r=>r.getBaseColorTexture(),normal:r=>r.getNormalTexture(),orm:r=>r.getMetallicRoughnessTexture()||r.getOcclusionTexture(),emissive:r=>r.getEmissiveTexture()}[n],t={basecolor:(r,i)=>r.setBaseColorTexture(i),normal:(r,i)=>r.setNormalTexture(i),orm:(r,i)=>{r.setMetallicRoughnessTexture(i),r.setOcclusionTexture(i)},emissive:(r,i)=>r.setEmissiveTexture(i)}[n],s={basecolor:r=>r.getBaseColorTextureInfo(),normal:r=>r.getNormalTextureInfo(),orm:r=>r.getMetallicRoughnessTextureInfo()||r.getOcclusionTextureInfo(),emissive:r=>r.getEmissiveTextureInfo()}[n];return{getter:e,setter:t,texInfoSetter:s}}async function Ho(n,e,t,s){const{getter:r,setter:i,texInfoSetter:o}=Go(e);if(!r||!i)return null;const a=Number(t.maxSize)||4096,c=Number(t.padding??0),u=Number(t.quality??85),h=(t[`format${e==="basecolor"?"Basecolor":e[0].toUpperCase()+e.slice(1)}`]||"webp").toLowerCase(),d=Number(t.texcoord??0),f=n.getRoot().listMaterials(),l=[],E=new Map;for(const T of f){const R=r(T);let g=R&&R.getImage?R.getImage():null,y=0,w=0;if(g){const N=await $o(g);y=N.width,w=N.height}else g=await yn(e,256,256),y=256,w=256;const A={texture:R,buffer:g,width:y,height:w,materials:[T]};l.push(A);const C=T.getName?T.getName():null;C&&E.set(C,A)}if(!l.length&&!s)return null;let _;s?_=s.rects.map((T,R)=>{const g=T.data?.materials||T.materials||[],w=aa(g,l)||ca(g,E)||E.values().next().value||l[R%Math.max(l.length,1)]||{buffer:null,width:T.width,height:T.height,materials:g};return{id:R,width:T.width,height:T.height,data:w,x:T.x,y:T.y}}):_=l.map((T,R)=>({id:R,width:T.width,height:T.height,data:T}));let x,p;if(s){const T=s.size||{};p=Math.max(T.width||0,T.height||0)||a,x=[{width:p,height:p,rects:_.map(R=>({x:R.x??0,y:R.y??0,width:R.width,height:R.height,data:R.data,materials:R.data.materials||[]}))}]}else{const T=Ko(_,a,c);p=T.size,x=T.bins}const M=new Map,I={map:e,atlases:[],uvDiagnostics:[]},b=[];for(let T=0;T<x.length;T++){const R=x[T],g=[];for(const N of R.rects){let v=N.data.buffer;v||(v=await yn(e,N.width,N.height));const O=await Xo(N.width,N.height,v);g.push({input:O,left:N.x,top:N.y,width:N.width,height:N.height})}const{image:y,mime:w}=await qo(R.width,R.height,g,h,u),A=await En(y),C=n.createTexture(`Atlas_${e}_${T}`);try{C.setImage(A).setMimeType(w)}catch(N){const v=A?.constructor?.name??typeof A;throw new Error(`Failed to set atlas image (${v}, map=${e}): ${N.message||N}`)}b.push(C),R.rects.forEach(N=>{(N.data.materials||N.materials||[]).forEach(O=>{const D=o,P=(D?D(O):null)?.getTexCoord()??0;M.set(O,{rect:N,binIndex:T,texCoordIndex:P,tex:C})})}),I.atlases.push({width:R.width,height:R.height,rects:R.rects.map(N=>({x:N.x,y:N.y,width:N.width,height:N.height,materials:(N.data.materials||N.materials||[]).map(v=>v.getName?.()||"mat")})),count:R.rects.length,entries:l.length,packInputCount:_.length})}if(!s){const R=n.getRoot().listMeshes();for(const g of R)g.listPrimitives().forEach(y=>{const w=y.getMaterial();if(!w)return;const A=M.get(w);if(!A)return;const C=d||A.texCoordIndex||0,N=y.getAttribute(`TEXCOORD_${C}`);if(!N)return;const v=N.clone();zo(v,A.rect,p),y.setAttribute("TEXCOORD_0",v),["TEXCOORD_1","TEXCOORD_2","TEXCOORD_3"].forEach(O=>y.setAttribute(O,null))})}return M.forEach((T,R)=>{i(R,T.tex);const g=o(R);g&&g.setTexCoord(0)}),{layoutInfo:I,atlasTexRefs:b,rects:x[0]?.rects||[],size:{width:x[0]?.width||p,height:x[0]?.height||p},debug:{entries:l.length,packInput:_.length}}}function zo(n,e,t){const s=n.getArray(),r=t?1/t:1;for(let i=0;i<s.length;i+=2){const o=s[i],a=s[i+1];s[i]=(e.x+o*e.width)*r,s[i+1]=(e.y+a*e.height)*r}return n}async function $o(n){const e=n instanceof Blob?n:new Blob([n]),t=await createImageBitmap(e),{width:s,height:r}=t;return t.close(),{width:s,height:r}}async function Xo(n,e,t){const s=t instanceof Blob?t:new Blob([t]),r=await createImageBitmap(s),i=new OffscreenCanvas(n,e),o=i.getContext("2d");o.clearRect(0,0,n,e),o.drawImage(r,0,0,n,e);const a=await i.convertToBlob({type:"image/png"});return r.close(),a}async function qo(n,e,t,s,r){const i=new OffscreenCanvas(n,e),o=i.getContext("2d");o.clearRect(0,0,n,e);for(const h of t){const d=await createImageBitmap(h.input);o.drawImage(d,h.left,h.top,h.width??d.width,h.height??d.height),d.close()}let a="image/png";s==="webp"?a="image/webp":(s==="jpeg"||s==="jpg")&&(a="image/jpeg");const u=await(await i.convertToBlob({type:a,quality:Math.min(Math.max(r/100,0),1)})).arrayBuffer();return{image:new Uint8Array(u),mime:a}}function Ko(n,e,t){const s=[1,.85,.75,.65,.5,.35,.25,.2,.15,.1];for(const r of s){const i=n.map(a=>({...a,width:Math.max(1,Math.floor(a.width*r)),height:Math.max(1,Math.floor(a.height*r))}));let o=Wo(Math.max(...i.map(a=>Math.max(a.width,a.height))));for(o=Math.min(o,e);;){const a=new jo(o,o,t,{smart:!0,pot:!0,square:!0});if(a.addArray(i),a.bins.length===1&&a.bins[0].rects.length===i.length){const c=a.bins[0];return{size:o,bins:[{width:o,height:o,rects:c.rects.map(u=>({x:u.x,y:u.y,width:u.width,height:u.height,data:u.data,materials:u.data.materials||[]}))}]}}if(o>=e)break;o=Math.min(e,o*2)}}throw new Error(`Could not pack all textures into a single atlas <= ${e}px even after downscaling.`)}function Wo(n){let e=1;for(;e<n;)e<<=1;return e}async function Yo(n,e={}){const t=n.getRoot(),s=t.listScenes(),r=s[0]||t.createScene("Scene"),i=n.createMaterial("Atlas_Merged");e.basecolor&&i.setBaseColorTexture(e.basecolor),e.normal&&i.setNormalTexture(e.normal),e.orm&&(i.setMetallicRoughnessTexture(e.orm),i.setOcclusionTexture(e.orm)),e.emissive&&i.setEmissiveTexture(e.emissive);const o=n.createMesh("Merged"),a=n.createNode("MergedNode").setMesh(o);for(const u of s){const h=u.listChildren().slice();for(const d of h)pn(d,o,i,n),u.removeChild(d)}r.addChild(a);for(const u of t.listMeshes())u!==o&&u.dispose();for(const u of t.listMaterials())u!==i&&u.dispose();for(const u of t.listNodes())u!==a&&u.dispose();s.forEach((u,h)=>{h!==0&&u.dispose()});const c=s[0]||r;c.listChildren().includes(a)||c.addChild(a),Jo(o,n)}function Jo(n,e){const t=n.listPrimitives();if(t.length<=1)return;const s=e.createPrimitive();let r=0;const i=[],o=[],a=[],c=[],u=[];for(const _ of t){const x=_.getAttribute("POSITION");if(!x)continue;const p=_.getAttribute("NORMAL"),M=_.getAttribute("TANGENT"),I=_.getAttribute("TEXCOORD_0"),b=_.getIndices();if(_t(x,i,3),p&&_t(p,o,3),M&&_t(M,a,4),I&&_t(I,c,2),b){const T=b.getArray();for(let R=0;R<T.length;R++)u.push(T[R]+r);r+=x.getCount()}else{const T=x.getCount();for(let R=0;R<T;R++)u.push(R+r);r+=T}}if(!i.length||!u.length)return;const h=(_,x)=>e.createAccessor().setType(x).setArray(new Float32Array(_));s.setAttribute("POSITION",h(i,"VEC3")),o.length===i.length&&s.setAttribute("NORMAL",h(o,"VEC3")),a.length===i.length/3*4&&s.setAttribute("TANGENT",h(a,"VEC4")),c.length===i.length/3*2&&s.setAttribute("TEXCOORD_0",h(c,"VEC2"));const d=u.length>65535?Uint32Array:Uint16Array,f=new d(u),l=e.createAccessor().setType("SCALAR").setArray(f);s.setIndices(l);const E=t[0].getMaterial();E&&s.setMaterial(E),n.listPrimitives().forEach(_=>n.removePrimitive(_)),n.addPrimitive(s)}function _t(n,e,t){const s=n.getArray();for(let r=0;r<s.length;r+=t)for(let i=0;i<t;i++)e.push(s[r+i])}function pn(n,e,t,s,r){const i=n.getMatrix?n.getMatrix():null,o=r?na(r,i||zt()):i||zt(),a=n.getMesh?n.getMesh():null;if(a)for(const c of a.listPrimitives()){const u=Zo(c,o,s);u.setMaterial(t),e.addPrimitive(u)}for(const c of n.listChildren?n.listChildren():[])pn(c,e,t,s,o)}function Zo(n,e,t){const s=t.createPrimitive(),r=n.getIndices();return r&&s.setIndices(r.clone()),["POSITION","NORMAL","TANGENT","TEXCOORD_0"].forEach(o=>{const a=n.getAttribute(o);if(!a)return;let c=a;o==="POSITION"?c=Qo(a,e,t):o==="NORMAL"?c=ea(a,e,t):o==="TANGENT"?c=ta(a,e,t):c=a.clone(),s.setAttribute(o,c)}),s}function Qo(n,e,t){const s=n.getArray(),r=new Float32Array(s.length);for(let i=0;i<s.length;i+=3){const o=sa([s[i],s[i+1],s[i+2]],e);r[i]=o[0],r[i+1]=o[1],r[i+2]=o[2]}return t.createAccessor().setType("VEC3").setArray(r)}function ea(n,e,t){const s=n.getArray(),r=Tn(e),i=new Float32Array(s.length);for(let o=0;o<s.length;o+=3){const a=mn([s[o],s[o+1],s[o+2]],r);xn(a),i[o]=a[0],i[o+1]=a[1],i[o+2]=a[2]}return t.createAccessor().setType("VEC3").setArray(i)}function ta(n,e,t){const s=n.getArray(),r=Tn(e),i=new Float32Array(s.length);for(let o=0;o<s.length;o+=4){const a=mn([s[o],s[o+1],s[o+2]],r);xn(a),i[o]=a[0],i[o+1]=a[1],i[o+2]=a[2],i[o+3]=s[o+3]}return t.createAccessor().setType("VEC4").setArray(i)}function sa(n,e){const t=n[0],s=n[1],r=n[2],i=1/(e[3]*t+e[7]*s+e[11]*r+e[15]);return[(e[0]*t+e[4]*s+e[8]*r+e[12])*i,(e[1]*t+e[5]*s+e[9]*r+e[13])*i,(e[2]*t+e[6]*s+e[10]*r+e[14])*i]}function mn(n,e){const t=n[0],s=n[1],r=n[2];return[e[0]*t+e[4]*s+e[8]*r,e[1]*t+e[5]*s+e[9]*r,e[2]*t+e[6]*s+e[10]*r]}function Tn(n){const e=n[0],t=n[1],s=n[2],r=n[4],i=n[5],o=n[6],a=n[8],c=n[9],u=n[10],h=u*i-o*c,d=-u*r+o*a,f=c*r-i*a;let l=e*h+t*d+s*f;if(!l)return zt();l=1/l;const E=new Float32Array(16);return E[0]=h*l,E[1]=(-u*t+s*c)*l,E[2]=(o*t-s*i)*l,E[3]=0,E[4]=d*l,E[5]=(u*e-s*a)*l,E[6]=(-o*e+s*r)*l,E[7]=0,E[8]=f*l,E[9]=(-c*e+t*a)*l,E[10]=(i*e-t*r)*l,E[11]=0,E[12]=0,E[13]=0,E[14]=0,E[15]=1,E}function na(n,e){const t=new Float32Array(16);for(let s=0;s<4;s++)for(let r=0;r<4;r++)t[s*4+r]=n[0*4+r]*e[s*4+0]+n[1*4+r]*e[s*4+1]+n[2*4+r]*e[s*4+2]+n[3*4+r]*e[s*4+3];return t}function xn(n){const e=Math.hypot(n[0],n[1],n[2])||1;n[0]/=e,n[1]/=e,n[2]/=e}function zt(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}async function yn(n,e,t){let s=[0,0,0,255];n==="basecolor"?s=[255,255,255,255]:n==="normal"?s=[128,128,255,255]:n==="orm"?s=[255,255,255,255]:n==="emissive"&&(s=[0,0,0,255]);const r=new OffscreenCanvas(e,t),i=r.getContext("2d");i.fillStyle=`rgba(${s[0]},${s[1]},${s[2]},${s[3]/255})`,i.fillRect(0,0,e,t);const o=await r.convertToBlob({type:"image/png"});return new Uint8Array(await o.arrayBuffer())}async function En(n){if(n instanceof Uint8Array)return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(n instanceof Blob)return new Uint8Array(await n.arrayBuffer());if(typeof n?.arrayBuffer=="function"){const t=await n.arrayBuffer();return new Uint8Array(t)}if(ia(n)){const t=new OffscreenCanvas(n.width,n.height);t.getContext("2d").drawImage(n,0,0);const r=await t.convertToBlob({type:"image/png"});return new Uint8Array(await r.arrayBuffer())}if(n&&n.buffer&&n.buffer instanceof ArrayBuffer)return new Uint8Array(n.buffer);const e=n&&n.constructor?n.constructor.name:typeof n;throw new Error(`Method requires Uint8Array parameter; received ${e}`)}async function ra(n){const e=n.getRoot().listTextures();for(const t of e){const s=t.getImage();if(s&&!(s instanceof Uint8Array))try{const r=await En(s);t.setImage(r)}catch(r){const i=t.getName?t.getName():"(unnamed)",o=s&&s.constructor?s.constructor.name:typeof s;throw new Error(`Texture "${i}" image type ${o} failed to coerce: ${r.message}`)}}}function ia(n){return n&&typeof n=="object"&&"close"in n&&"width"in n&&"height"in n}function oa(n){const e=new Set;for(const s of n.getRoot().listMaterials()){const r=s.getBaseColorTexture(),i=s.getNormalTexture(),o=s.getMetallicRoughnessTexture(),a=s.getOcclusionTexture(),c=s.getEmissiveTexture();[r,i,o,a,c].forEach(u=>u&&e.add(u))}n.getRoot().listTextures().forEach(s=>{e.has(s)||s.dispose()})}function aa(n,e){if(!n||!e)return null;for(const t of n){const s=typeof t=="string"?t:typeof t?.getName=="function"?t.getName():null;for(const r of e)if(r.materials&&r.materials.some(i=>{if(i===t)return!0;const o=typeof i=="string"?i:typeof i?.getName=="function"?i.getName():null;return s&&o&&o===s}))return r}return null}function ca(n,e){if(!n||!e)return null;for(const t of n){const s=typeof t=="string"?t:typeof t?.getName=="function"?t.getName():null;if(s&&e.has(s))return e.get(s)}return null}})();
